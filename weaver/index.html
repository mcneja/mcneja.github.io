<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Weaver Modulation</title>
    <meta name="description" content="Single-sideband tuning simulation, via Weaver modulation" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <style>
      .slider-width
      {
        width: 50em;
      }
    </style>
  </head>
  <link rel="icon" type="image/ico" href="favicon.ico"/>
  <body>
    <table>
      <tr>
        <td>Volume</td>
        <td>
          <input
            class="slider-width"
            type="range"
            id="volume"
            min="0"
            max="2"
            value="1"
            step="any"
            data-action="volume"
          />
        </td>
      </tr>
      <tr>
        <td>Frequency</td>
        <td>
          <input
            class="slider-width"
            type="range"
            id="frequency"
            min="-6000"
            max="6000"
            value="0"
            step="any"
            data-action="frequency"
            list="frequency-markers"
          />
          <datalist id="frequency-markers">
            <option value="-6000"></option>
            <option value="-4500"></option>
            <option value="-3000"></option>
            <option value="-1500"></option>
            <option value="0"></option>
            <option value="1500"></option>
            <option value="3000"></option>
            <option value="4500"></option>
            <option value="6000"></option>
          </datalist>
        </td>
      </tr>
      <tr>
        <td>
          &nbsp;
        </td>
        <td>
          <button
            data-playing="false"
            class="tape-controls-play"
            role="switch"
            aria-checked="false"
          >
            <span>Play/Pause</span>
          </button>
        </td>
      </tr>
    </table>

    <audio src="bob_and_ray_1957_48k.mp3" type="audio/mpeg" preload="auto"></audio>

    <script type="text/javascript">
      console.clear();

      // instigate our audio context
      const audioCtx = new AudioContext();
      audioCtx.audioWorklet.addModule('weaver-modulator.js');

      // load some sound
      const audioElement = document.querySelector("audio");
      let initialized = false;
      let source;

      const playButton = document.querySelector(".tape-controls-play");

      // play pause audio
      playButton.addEventListener(
        "click",
        () => {
          if (!initialized) {
            init();
          }

          // check if context is in suspended state (autoplay policy)
          if (audioCtx.state === "suspended") {
            audioCtx.resume();
          }

          if (playButton.dataset.playing === "false") {
            audioElement.play();
            playButton.dataset.playing = "true";
            // if track is playing pause it
          } else if (playButton.dataset.playing === "true") {
            audioElement.pause();
            playButton.dataset.playing = "false";
          }

          // Toggle the state between play and not playing
          let state = playButton.getAttribute("aria-checked") === "true" ? true : false;
          playButton.setAttribute("aria-checked", state ? "false" : "true");
        },
        false
      );

      // If track ends
      audioElement.addEventListener(
        "ended",
        () => {
          playButton.dataset.playing = "false";
          playButton.setAttribute("aria-checked", "false");
        },
        false
      );

      function init() {
        source = new MediaElementAudioSourceNode(audioCtx, { mediaElement: audioElement });
        const weaver = new AudioWorkletNode(audioCtx, 'weaver-modulator');
        const volume = audioCtx.createGain();

        source.connect(weaver);
        weaver.connect(volume);
        volume.connect(audioCtx.destination);

        const volumeControl = document.querySelector('[data-action="volume"]');
        volumeControl.addEventListener(
          "input",
          () => {
            volume.gain.value = volumeControl.value;
          },
          false
        );

        const frequencyControl = document.querySelector('[data-action="frequency"]');
        frequencyControl.addEventListener(
          "input",
          () => {
            const freqParam = weaver.parameters.get('frequency');
            freqParam.linearRampToValueAtTime(frequencyControl.value, audioCtx.currentTime + 0.1);
          },
          false
        );

        initialized = true;
      }
    </script>
  </body>
</html>
