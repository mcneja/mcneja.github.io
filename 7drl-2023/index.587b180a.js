function t(t,e,o,s){Object.defineProperty(t,e,{get:o,set:s,enumerable:!0,configurable:!0})}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},o={},s={},r=e.parcelRequire550f;let i;var n;let l;var a;function c(t){return Math.floor(Math.random()*t)}function h(t){for(let e=t.length-1;e>0;--e){let o=c(e+1),s=t[e];t[e]=t[o],t[o]=s}}let f;var u;null==r&&((r=function(t){if(t in o)return o[t].exports;if(t in s){var e=s[t];delete s[t];var r={id:t,exports:{}};return o[t]=r,e.call(r.exports,r,r.exports),r.exports}var i=new Error("Cannot find module '"+t+"'");throw i.code="MODULE_NOT_FOUND",i}).register=function(t,e){s[t]=e},e.parcelRequire550f=r),r.register("27Lyk",(function(e,o){var s,r;t(e.exports,"register",(()=>s),(t=>s=t)),t(e.exports,"resolve",(()=>r),(t=>r=t));var i={};s=function(t){for(var e=Object.keys(t),o=0;o<e.length;o++)i[e[o]]=t[e[o]]},r=function(t){var e=i[t];if(null==e)throw new Error("Could not resolve bundle with id "+t);return e}})),r("27Lyk").register(JSON.parse('{"17fSe":"index.587b180a.js","8FZzo":"font.84b63647.png","lW8yX":"tiles.60aa3fc2.png"}')),(n=i||(i={})).create=function(){return[0,0]},n.clone=function(t){return[t[0],t[1]]},n.fromValues=function(t,e){return[t,e]},n.copy=function(t,e){t[0]=e[0],t[1]=e[1]},n.set=function(t,e,o){t[0]=e,t[1]=o},n.add=function(t,e,o){t[0]=e[0]+o[0],t[1]=e[1]+o[1]},n.subtract=function(t,e,o){t[0]=e[0]-o[0],t[1]=e[1]-o[1]},n.multiply=function(t,e,o){t[0]=e[0]*o[0],t[1]=e[1]*o[1]},n.scale=function(t,e,o){t[0]=e[0]*o,t[1]=e[1]*o},n.scaleAndAdd=function(t,e,o,s){t[0]=e[0]+o[0]*s,t[1]=e[1]+o[1]*s},n.distance=function(t,e){const o=t[0]-e[0],s=t[1]-e[1];return Math.hypot(o,s)},n.squaredDistance=function(t,e){const o=t[0]-e[0],s=t[1]-e[1];return o*o+s*s},n.length=function(t){return Math.hypot(t[0],t[1])},n.squaredLength=function(t){const e=t[0],o=t[1];return e*e+o*o},n.negate=function(t,e){t[0]=-e[0],t[1]=-e[1]},n.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},n.lerp=function(t,e,o,s){t[0]=e[0]+s*(o[0]-e[0]),t[1]=e[1]+s*(o[1]-e[1])},n.zero=function(t){t[0]=0,t[1]=0},(a=l||(l={})).create=function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},a.copy=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]},a.ortho=function(t,e,o,s,r,i,n){const l=1/(e-o),a=1/(s-r),c=1/(i-n);t[0]=-2*l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+o)*l,t[13]=(r+s)*a,t[14]=(n+i)*c,t[15]=1},(u=f||(f={}))[u.Patrol=0]="Patrol",u[u.Look=1]="Look",u[u.Listen=2]="Listen",u[u.ChaseVisibleTarget=3]="ChaseVisibleTarget",u[u.MoveToLastSighting=4]="MoveToLastSighting",u[u.MoveToLastSound=5]="MoveToLastSound",u[u.MoveToGuardShout=6]="MoveToGuardShout",u[u.RelightTorch=7]="RelightTorch",u[u.PostRelightTorch=8]="PostRelightTorch";class p{constructor(t,e){this.pos=i.clone(t),this.dir=i.fromValues(1,0),this.mode=f.Patrol,this.hasTorch=!1,this.speaking=!1,this.hasMoved=!1,this.heardThief=!1,this.hearingGuard=!1,this.heardGuard=!1,this.heardGuardPos=i.clone(t),this.goal=i.clone(t),this.modeTimeout=0,this.regionGoal=e.closestRegion(t),this.regionPrev=x,this.updateDirInitial(e)}overheadIcon(){if(!d(this.mode))return this.mode==f.ChaseVisibleTarget?40:39}act(t,e,o){const s=this.mode,r=i.clone(this.pos);switch(d(this.mode)||(this.seesThief(e,t)?(i.copy(this.goal,t.pos),this.mode=f.ChaseVisibleTarget):this.mode===f.ChaseVisibleTarget&&(i.copy(this.goal,t.pos),this.mode=f.MoveToLastSighting,this.modeTimeout=3)),this.mode!==f.ChaseVisibleTarget&&(this.heardGuard&&(this.mode=f.MoveToGuardShout,this.modeTimeout=2+c(4),i.copy(this.goal,this.heardGuardPos)),this.heardThief&&(this.adjacentTo(t.pos)?(this.mode=f.ChaseVisibleTarget,i.copy(this.goal,t.pos)):d(this.mode)?(this.mode=f.Listen,this.modeTimeout=2+c(4),M(this.dir,this.pos,t.pos)):(this.mode=f.MoveToLastSound,this.modeTimeout=2+c(4),i.copy(this.goal,t.pos)))),this.mode){case f.Patrol:this.patrolStep(e,t);break;case f.Look:case f.Listen:this.modeTimeout-=1,0==this.modeTimeout&&(this.mode=f.Patrol);break;case f.ChaseVisibleTarget:this.adjacentTo(t.pos)?(M(this.dir,this.pos,this.goal),s==f.ChaseVisibleTarget&&(t.damagedLastTurn,t.applyDamage(1))):this.moveTowardGoal(e,t);break;case f.MoveToLastSighting:case f.MoveToLastSound:case f.MoveToGuardShout:this.moveTowardGoal(e,t)||(this.modeTimeout-=1),0==this.modeTimeout&&(this.mode=f.Patrol,this.setupGoalRegion(e));break;case f.RelightTorch:this.adjacentTo(this.goal)?(!function(t,e){for(const o of t.items)o.type===A.TorchUnlit&&o.pos[0]===e[0]&&o.pos[1]===e[1]&&(o.type=A.TorchLit)}(e,this.goal),this.mode=f.PostRelightTorch,this.modeTimeout=3):this.moveTowardGoal(e,t)||(this.modeTimeout-=1,0===this.modeTimeout&&(this.mode=f.Patrol,this.setupGoalRegion(e)));break;case f.PostRelightTorch:--this.modeTimeout,this.modeTimeout<=0&&(this.mode=f.Patrol,this.setupGoalRegion(e))}if(this.pos[0]!=r[0]||this.pos[1]!=r[1])if(this.seesThief(e,t))d(this.mode)&&!this.adjacentTo(t.pos)?(this.mode=f.Look,this.modeTimeout=2+c(4)):(i.copy(this.goal,t.pos),M(this.dir,this.pos,this.goal),this.mode=f.ChaseVisibleTarget);else if(this.mode==f.ChaseVisibleTarget)i.copy(this.goal,t.pos),this.mode=f.MoveToLastSighting,this.modeTimeout=3;else if(this.hasTorch&&this.mode===f.Patrol){const t=function(t,e){let o,s=1/0;for(const r of t.items)if(r.type===A.TorchUnlit){const n=i.squaredDistance(r.pos,e);if(n>=s)continue;if(!T(t,e,r.pos))continue;s=n,o=r}return o}(e,this.pos);void 0!==t&&(i.copy(this.goal,t.pos),this.mode=f.RelightTorch,this.modeTimeout=3)}this.heardThief=!1,this.mode==f.ChaseVisibleTarget&&s!=f.ChaseVisibleTarget&&o.push({pos_shouter:this.pos,pos_target:t.pos})}adjacentTo(t){const e=t[0]-this.pos[0],o=t[1]-this.pos[1];return Math.abs(e)<2&&Math.abs(o)<2}seesThief(t,e){const o=i.create();if(i.subtract(o,e.pos,this.pos),i.dot(this.dir,o)<0)return!1;let s=t.cells.at(e.pos[0],e.pos[1]).lit;return!(i.squaredLength(o)>=this.sightCutoff(s))&&(!(e.hidden(t)||!T(t,this.pos,e.pos))||!d(this.mode)&&Math.abs(o[0])<2&&Math.abs(o[1])<2)}cutoffLit(){return d(this.mode)?40:75}cutoffUnlit(){return d(this.mode)?3:33}sightCutoff(t){return t?this.cutoffLit():this.cutoffUnlit()}patrolStep(t,e){const o=this.moveTowardRegion(t,e);if(t.cells.at(this.pos[0],this.pos[1]).region===this.regionGoal){const e=this.regionPrev;this.regionPrev=this.regionGoal,this.regionGoal=t.randomNeighborRegion(this.regionGoal,e)}o&&(this.mode=f.ChaseVisibleTarget,i.copy(this.goal,e.pos),M(this.dir,this.pos,this.goal))}updateDirInitial(t){if(this.regionGoal==x)return;let e=t.computeDistancesToRegion(this.regionGoal);const o=y(t,e,this.pos);M(this.dir,this.pos,o)}moveTowardRegion(t,e){if(this.regionGoal===x)return!1;const o=t.computeDistancesToRegion(this.regionGoal),s=y(t,o,this.pos);return e.pos[0]==s[0]&&e.pos[1]==s[1]||(M(this.dir,this.pos,s),i.copy(this.pos,s),!1)}moveTowardGoal(t,e){const o=t.computeDistancesToPosition(this.goal),s=y(t,o,this.pos);return(s[0]!=this.pos[0]||s[1]!=this.pos[1])&&(M(this.dir,this.pos,s),(e.pos[0]!=s[0]||e.pos[1]!=s[1])&&(i.copy(this.pos,s),!0))}setupGoalRegion(t){const e=t.cells.at(this.pos[0],this.pos[1]).region;this.regionGoal!==x&&e===this.regionPrev||(e===x?this.regionGoal=t.closestRegion(this.pos):(this.regionGoal=t.randomNeighborRegion(e,this.regionPrev),this.regionPrev=e))}}function d(t){return t===f.Patrol||t===f.RelightTorch||t===f.PostRelightTorch}function g(t,e){for(const e of t.guards)e.heardGuard=e.hearingGuard,e.hearingGuard=!1,e.speaking=!1,e.hasMoved=!1;const o=[];for(const s of t.guards)s.act(e,t,o),s.hasMoved=!0;for(const e of o)m(t,e)}function m(t,e){for(const o of t.guardsInEarshot(e.pos_shouter,25))o.pos[0]==e.pos_shouter[0]&&o.pos[1]==e.pos_shouter[1]||(o.hearingGuard=!0,i.copy(o.heardGuardPos,e.pos_shouter))}function y(t,e,o){let s=1/0,r=o;const n=i.fromValues(Math.max(0,o[0]-1),Math.max(0,o[1]-1)),l=i.fromValues(Math.min(t.cells.sizeX,o[0]+2),Math.min(t.cells.sizeY,o[1]+2));for(let a=n[0];a<l[0];++a)for(let c=n[1];c<l[1];++c){const n=e.get(a,c);if(n==1/0)continue;let l=i.fromValues(a,c);t.guardMoveCost(o,l)!=1/0&&(t.cells.at(l[0],l[1]).type!=R.GroundWater&&(t.isGuardAt(l[0],l[1])||n<s&&(s=n,r=l)))}return r}function M(t,e,o){const s=i.create();i.subtract(s,o,e);const r=i.fromValues(-t[1],t[0]);let n=i.dot(t,s),l=i.dot(r,s);Math.abs(n)>=Math.abs(l)?n>=0||i.negate(t,t):Math.abs(l)>Math.abs(n)?l>=0?i.copy(t,r):i.negate(t,r):n>0||(l>=0?i.copy(t,r):i.negate(t,r))}function T(t,e,o){let s=e[0],r=e[1];const i=o[0]-s,n=o[1]-r;let l=Math.abs(i),a=Math.abs(n);const c=i>0?1:-1,h=n>0?1:-1;let f=a-l,u=l+a-1;for(l*=2,a*=2;u>0;){if(f>0?(r+=h,f-=l):(s+=c,f+=a),t.cells.at(s,r).blocksSight)return!1;--u}return!0}const x=-1,v=[i.fromValues(-1,0),i.fromValues(1,0),i.fromValues(0,-1),i.fromValues(0,1)];class b{constructor(t,e,o){this.sizeX=t,this.sizeY=e,this.values=new Uint8Array(t*e),this.fill(o)}fill(t){this.values.fill(t?1:0)}get(t,e){return 0!==this.values[this.sizeX*e+t]}set(t,e,o){this.values[this.sizeX*e+t]=o?1:0}}class S{constructor(t,e,o){this.sizeX=t,this.sizeY=e,this.values=new Int32Array(t*e),this.fill(o)}fill(t){this.values.fill(t)}get(t,e){return this.values[this.sizeX*e+t]}set(t,e,o){this.values[this.sizeX*e+t]=o}}class _{constructor(t,e,o){this.sizeX=t,this.sizeY=e,this.values=new Float64Array(t*e),this.fill(o)}fill(t){this.values.fill(t)}get(t,e){return this.values[this.sizeX*e+t]}set(t,e,o){this.values[this.sizeX*e+t]=o}}let R;var W;(W=R||(R={}))[W.GroundNormal=0]="GroundNormal",W[W.GroundGrass=1]="GroundGrass",W[W.GroundWater=2]="GroundWater",W[W.GroundMarble=3]="GroundMarble",W[W.GroundWood=4]="GroundWood",W[W.GroundWoodCreaky=5]="GroundWoodCreaky",W[W.Wall0000=6]="Wall0000",W[W.Wall0001=7]="Wall0001",W[W.Wall0010=8]="Wall0010",W[W.Wall0011=9]="Wall0011",W[W.Wall0100=10]="Wall0100",W[W.Wall0101=11]="Wall0101",W[W.Wall0110=12]="Wall0110",W[W.Wall0111=13]="Wall0111",W[W.Wall1000=14]="Wall1000",W[W.Wall1001=15]="Wall1001",W[W.Wall1010=16]="Wall1010",W[W.Wall1011=17]="Wall1011",W[W.Wall1100=18]="Wall1100",W[W.Wall1101=19]="Wall1101",W[W.Wall1110=20]="Wall1110",W[W.Wall1111=21]="Wall1111",W[W.OneWayWindowE=22]="OneWayWindowE",W[W.OneWayWindowW=23]="OneWayWindowW",W[W.OneWayWindowN=24]="OneWayWindowN",W[W.OneWayWindowS=25]="OneWayWindowS",W[W.PortcullisNS=26]="PortcullisNS",W[W.PortcullisEW=27]="PortcullisEW",W[W.DoorNS=28]="DoorNS",W[W.DoorEW=29]="DoorEW";class P{constructor(t,e){this.sizeX=t,this.sizeY=e;const o=t*e;this.values=new Array(o);for(let t=0;t<o;++t)this.values[t]={type:R.GroundNormal,moveCost:1/0,region:x,blocksPlayerMove:!1,blocksPlayerSight:!1,blocksSight:!1,blocksSound:!1,hidesPlayer:!1,lit:!1,seen:!1}}at(t,e){const o=this.sizeX*e+t;return console.assert(o>=0),console.assert(o<this.values.length),this.values[o]}}let A;var G;function E(t){switch(t){case A.Chair:return 4;case A.Table:case A.Bush:return 10;case A.Coin:case A.DoorNS:case A.DoorEW:case A.PortcullisNS:case A.PortcullisEW:return 0;case A.TorchUnlit:case A.TorchLit:return 1/0}}(G=A||(A={}))[G.Chair=0]="Chair",G[G.Table=1]="Table",G[G.Bush=2]="Bush",G[G.Coin=3]="Coin",G[G.DoorNS=4]="DoorNS",G[G.DoorEW=5]="DoorEW",G[G.PortcullisNS=6]="PortcullisNS",G[G.PortcullisEW=7]="PortcullisEW",G[G.TorchUnlit=8]="TorchUnlit",G[G.TorchLit=9]="TorchLit";const w=5;class z{constructor(t){this.pos=i.clone(t),this.dir=i.fromValues(0,-1),this.health=w,this.gold=0,this.noisy=!1,this.damagedLastTurn=!1,this.turnsRemainingUnderwater=0}applyDamage(t){this.health-=Math.min(t,this.health),this.damagedLastTurn=!0}hidden(t){if(void 0!==t.guards.find((t=>t.mode==f.ChaseVisibleTarget)))return!1;if(t.cells.at(this.pos[0],this.pos[1]).hidesPlayer)return!0;return t.cells.at(this.pos[0],this.pos[1]).type==R.GroundWater&&this.turnsRemainingUnderwater>0}}const L=[{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}];function C(t,e,o,s){return t*s>e*o}function V(t,e,o){switch(t){case R.OneWayWindowE:return e>0;case R.OneWayWindowW:return e<0;case R.OneWayWindowN:return o>0;case R.OneWayWindowS:return o<0;default:return!0}}const N=[{dx:1,dy:0,cost:2},{dx:-1,dy:0,cost:2},{dx:0,dy:1,cost:2},{dx:0,dy:-1,cost:2},{dx:-1,dy:-1,cost:3},{dx:1,dy:-1,cost:3},{dx:-1,dy:1,cost:3},{dx:1,dy:1,cost:3}];class D{constructor(t){this.cells=t,this.patrolRegions=[],this.patrolRoutes=[],this.patrolRoutesNew=[],this.items=[],this.guards=[],this.playerStartPos=i.create(),this.totalLoot=0}collectLootAt(t,e){let o=0;return this.items=this.items.filter((s=>s.type!=A.Coin||s.pos[0]!=t||s.pos[1]!=e||(++o,!1))),o}collectAllLoot(){let t=0;return this.items=this.items.filter((e=>e.type==A.Coin&&(++t,!0))),t}allSeen(){for(const t of this.cells.values)if(!t.seen)return!1;return!0}percentSeen(){let t=0;for(const e of this.cells.values)e.seen&&++t;return Math.floor(100*t/this.cells.values.length)}markAllSeen(){for(const t of this.cells.values)t.seen=!0}markAllUnseen(){for(const t of this.cells.values)t.seen=!1}recomputeVisibility(t){this.recomputeVisibilityFromPos(t);const e=i.create();for(const o of v)this.playerCanSeeInDirection(t,o)&&(i.add(e,t,o),this.recomputeVisibilityFromPos(e))}recomputeVisibilityFromPos(t){for(const e of L)this.computeVisibility(t[0],t[1],t[0],t[1],e.lx,e.ly,e.rx,e.ry)}playerCanSeeInDirection(t,e){const o=i.create();return i.add(o,t,e),o[0]<0||o[1]<0||o[0]>=this.cells.sizeX||o[1]>=this.cells.sizeY||!!V(this.cells.at(o[0],o[1]).type,e[0],e[1])&&!this.cells.at(o[0],o[1]).blocksPlayerSight}computeVisibility(t,e,o,s,r,i,n,l){if(o<0||s<0||o>=this.cells.sizeX||s>=this.cells.sizeY)return;const a=2*(o-t),c=2*(s-e);if(!(a*a+c*c>1600)&&V(this.cells.at(o,s).type,a,c)&&(this.cells.at(o,s).seen=!0,!this.cells.at(o,s).blocksPlayerSight)){for(let t=0;t<2;++t)for(let e=0;e<2;++e){let h=o+2*t-1,f=s+2*e-1,u=a+2*t-1,p=c+2*e-1;h>=0&&f>=0&&h<this.cells.sizeX&&f<this.cells.sizeY&&!C(r,i,u,p)&&!C(u,p,n,l)&&(this.cells.at(h,f).seen=!0)}for(const h of L){const f=a+h.lx,u=c+h.ly,p=a+h.rx,d=c+h.ry,[g,m]=C(r,i,f,u)?[r,i]:[f,u],[y,M]=C(n,l,p,d)?[p,d]:[n,l];C(y,M,g,m)&&this.computeVisibility(t,e,o+h.nx,s+h.ny,g,m,y,M)}}}computeLighting(){for(const t of this.cells.values)t.lit=!1;for(const t of this.items)t.type==A.TorchLit&&this.castLight(t.pos,180);for(const t of this.guards)t.hasTorch&&this.castLight(t.pos,60)}castLight(t,e){this.cells.at(t[0],t[1]).lit=!0;for(const o of L)this.castLightRecursive(t[0],t[1],t[0]+o.nx,t[1]+o.ny,o.lx,o.ly,o.rx,o.ry,e)}castLightRecursive(t,e,o,s,r,i,n,l,a){if(o<0||s<0||o>=this.cells.sizeX||s>=this.cells.sizeY)return;const c=2*(o-t),h=2*(s-e);if(c**2+h**2>a)return;const f=this.cells.at(o,s);if(f.lit=!0,!f.blocksSight){for(let t=0;t<2;++t)for(let e=0;e<2;++e){let a=o+2*t-1,f=s+2*e-1,u=c+2*t-1,p=h+2*e-1;a>=0&&f>=0&&a<this.cells.sizeX&&f<this.cells.sizeY&&!C(r,i,u,p)&&!C(u,p,n,l)&&(this.cells.at(a,f).lit=!0)}for(const f of L){const u=c+f.lx,p=h+f.ly,d=c+f.rx,g=h+f.ry,[m,y]=C(r,i,u,p)?[r,i]:[u,p],[M,T]=C(n,l,d,g)?[d,g]:[n,l];C(M,T,m,y)&&this.castLightRecursive(t,e,o+f.nx,s+f.ny,m,y,M,T,a)}}}allLootCollected(){return void 0===this.items.find((t=>t.type==A.Coin))}isGuardAt(t,e){return null!=this.guards.find((o=>o.hasMoved&&o.pos[0]==t&&o.pos[1]==e))}randomNeighborRegion(t,e){const o=[];for(const[s,r]of this.patrolRoutes)s===t&&r!==e?o.push(r):r===t&&s!==e&&o.push(s);return 0===o.length?t:o[c(o.length)]}guardMoveCost(t,e){const o=this.cells.at(e[0],e[1]).moveCost;return o===1/0||t[0]==e[0]||t[1]==e[1]||this.cells.at(t[0],e[1]).moveCost!==1/0&&this.cells.at(e[0],t[1]).moveCost!==1/0?o:1/0}closestRegion(t){if(0===this.patrolRegions.length)return x;const e=this.cells.sizeX,o=this.cells.sizeY,s=new _(e,o,1/0),r=[];for(k(r,{priority:0,pos:t});r.length>0;){const t=U(r),n=t.priority,l=t.pos,a=this.cells.at(l[0],l[1]).region;if(a!==x)return a;if(!(n>=s.get(l[0],l[1]))){s.set(l[0],l[1],n);for(const t of N){const a=i.fromValues(l[0]+t.dx,l[1]+t.dy);if(a[0]<0||a[1]<0||a[0]>=e||a[1]>=o)continue;const c=this.guardMoveCost(l,a);if(c==1/0)continue;let h=n+c+t.cost;h<s.get(a[0],a[1])&&k(r,{priority:h,pos:a})}}}return x}computeDistancesToRegion(t){console.assert(t>=0),console.assert(t<this.patrolRegions.length);let e=this.patrolRegions[t];const o=[];for(let t=e.posMin[0];t<e.posMax[0];++t)for(let s=e.posMin[1];s<e.posMax[1];++s){const e=i.fromValues(t,s),r=this.cells.at(t,s).moveCost;o.push({priority:r,pos:e})}return this.computeDistanceField(o)}computeDistancesToPosition(t){return console.assert(t[0]>=0),console.assert(t[1]>=0),console.assert(t[0]<this.cells.sizeX),console.assert(t[1]<this.cells.sizeY),this.computeDistanceField([{priority:0,pos:t}])}computeDistanceField(t){let e=this.cells.sizeX,o=this.cells.sizeY;const s=[],r=new _(e,o,1/0);for(const e of t)k(s,e);for(;s.length>0;){const t=U(s);if(!(t.priority>=r.get(t.pos[0],t.pos[1]))){r.set(t.pos[0],t.pos[1],t.priority);for(const n of N){const l=i.fromValues(t.pos[0]+n.dx,t.pos[1]+n.dy);if(l[0]<0||l[1]<0||l[0]>=e||l[1]>=o)continue;const a=this.guardMoveCost(t.pos,l);if(a==1/0)continue;const c=t.priority+a+n.cost;c<r.get(l[0],l[1])&&k(s,{priority:c,pos:l})}}}return r}guardsInEarshot(t,e){const o=this.coordsInEarshot(t,e);return this.guards.filter((t=>o.has(this.cells.sizeX*t.pos[1]+t.pos[0])))}coordsInEarshot(t,e){let o=this.cells.sizeX,s=this.cells.sizeY;const r=[],n=new _(o,s,1/0),l=new Set;for(k(r,{priority:0,pos:t});r.length>0;){const t=U(r);if(!(t.priority>=n.get(t.pos[0],t.pos[1]))){n.set(t.pos[0],t.pos[1],t.priority),l.add(o*t.pos[1]+t.pos[0]);for(const l of N){const a=i.fromValues(t.pos[0]+l.dx,t.pos[1]+l.dy);if(a[0]<0||a[1]<0||a[0]>=o||a[1]>=s)continue;const c=t.priority+l.cost;c>e||(this.cells.at(a[0],a[1]).blocksSound||c>=n.get(a[0],a[1])||k(r,{priority:c,pos:a}))}}}return l}}function U(t){const e=t[0];t[0]=t[t.length-1],t.pop();let o=0;const s=t.length;for(;;){let e=o;const r=2*o+1;r<s&&t[r].priority<t[e].priority&&(e=r);const i=r+1;if(i<s&&t[i].priority<t[e].priority&&(e=i),e==o)break;[t[o],t[e]]=[t[e],t[o]],o=e}return e}function k(t,e){t.push(e);let o=t.length-1;for(;o>0;){const e=Math.floor((o-1)/2);if(t[o].priority>=t[e].priority)break;[t[o],t[e]]=[t[e],t[o]],o=e}}const X=5,O=5,Y=3;let F;var I;function B(t){let e=H(t);for(let o=0;0===e.patrolRegions.length&&o<100;++o)e=H(t);return e.computeLighting(),e.recomputeVisibility(e.playerStartPos),e}function H(t){const e=function(t){let e=0;const o=Math.min(3,t);for(let t=0;t<o;++t)e+=c(2);return 2*e+3}(t),o=function(t){if(0===t)return 2;{let e=3;const o=Math.min(4,t-1);for(let t=0;t<o;++t)e+=c(2);return e}}(t),s=function(t,e){const o=new b(t,e,!0),s=Math.floor((t+1)/2);for(let t=Math.floor(e*s/4);t>0;--t){const t=c(s),r=c(e);o.set(t,r,!1)}for(let r=0;r<e;++r)for(let e=s;e<t;++e)o.set(e,r,o.get(t-1-e,r));return o}(e,o),[r,n]=function(t,e,o){const s=o.sizeX,r=o.sizeY,i=new S(s+1,r,0),n=new S(s,r+1,0);let l=c(3)-1;for(let t=0;t<r;++t)i.set(0,t,l);l=c(3)-1;for(let t=0;t<r;++t)i.set(s,t,l);l=c(3)-1;for(let t=0;t<s;++t)n.set(t,0,l);l=c(3)-1;for(let t=0;t<s;++t)n.set(t,r,l);for(let t=1;t<s;++t)for(let e=0;e<r;++e)i.set(t,e,c(3)-1);for(let t=0;t<s;++t)for(let e=1;e<r;++e)n.set(t,e,c(3)-1);for(let t=1;t<s;++t)for(let e=1;e<r;++e)0===c(2)?i.set(t,e,i.get(t,e-1)):n.set(t,e,n.get(t-1,e));if(t){if(0==(1&s)){const t=Math.floor(s/2);for(let e=0;e<r;++e)i.set(t,e,0)}for(let t=0;t<Math.floor((s+1)/2);++t)for(let e=0;e<r;++e)i.set(s-t,e,1-i.get(t,e));for(let t=0;t<Math.floor(s/2);++t)for(let e=0;e<r+1;++e)n.set(s-1-t,e,n.get(t,e))}if(e){if(0==(1&r)){const t=r/2;for(let e=0;e<s;++e)n.set(e,t,0)}for(let t=0;t<Math.floor((r+1)/2);++t)for(let e=0;e<s;++e)n.set(e,r-t,1-n.get(e,t));for(let t=0;t<Math.floor(r/2);++t)for(let e=0;e<s+1;++e)i.set(e,r-1-t,i.get(e,t))}let a=Number.MIN_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;for(let t=0;t<r;++t)a=Math.max(a,-i.get(0,t));for(let t=0;t<s;++t)h=Math.max(h,-n.get(t,0));a+=Y,h+=Y;for(let t=0;t<s+1;++t)for(let e=0;e<r;++e){const o=i.get(t,e)+a+t*X;i.set(t,e,o)}for(let t=0;t<s;++t)for(let e=0;e<r+1;++e)n.set(t,e,n.get(t,e)+h+e*O);return[i,n]}(true,false,s),l=function(t,e,o){const s=t.sizeX,r=t.sizeY;let i=0,n=0;for(let t=0;t<r;++t)i=Math.max(i,e.get(s,t));for(let t=0;t<s;++t)n=Math.max(n,o.get(t,r));i+=Y+1,n+=Y+1;const l=new P(i,n);for(let t=0;t<s;++t)for(let s=0;s<r;++s){const r=e.get(t,s),i=e.get(t+1,s)+1,n=o.get(t,s),a=o.get(t,s+1)+1;for(let t=r;t<i;++t)for(let e=n;e<a;++e){l.at(t,e).type=R.GroundGrass}}for(let i=0;i<s;++i)for(let n=0;n<r;++n){const a=t.get(i,n),c=e.get(i,n),h=e.get(i+1,n),f=o.get(i,n),u=o.get(i,n+1);(0==i||a)&&K(l,c,f,u),(i==s-1||a)&&K(l,h,f,u),(0==n||a)&&q(l,c,f,h),(n==r-1||a)&&q(l,c,u,h)}return l}(s,r,n),a=new D(l),[f,u,d]=function(t,e,o,s,r,n,l){const a=s.sizeX,f=s.sizeY,u=new S(a,f,0),p=[];p.push({roomType:F.Exterior,group:0,depth:0,posMin:i.fromValues(0,0),posMax:i.fromValues(0,0),edges:[]});for(let t=0;t<a;++t)for(let e=0;e<f;++e){let o=p.length;u.set(t,e,o),p.push({roomType:s.get(t,e)?F.PublicRoom:F.PublicCourtyard,group:o,depth:0,posMin:i.fromValues(r.get(t,e)+1,n.get(t,e)+1),posMax:i.fromValues(r.get(t+1,e),n.get(t,e+1)),edges:[]})}const d=function(t,e,o,s,r){let n=r.sizeX,l=r.sizeY;const a=[];{const c=[];{const t=[];let e=0;for(let l=0;l<n;++l){let n=o.get(l,e),c=o.get(l+1,e),h=s.get(l,e),f=a.length;t.push(f),a.push({origin:i.fromValues(n+1,h),dir:i.fromValues(1,0),length:c-(n+1),room_left:r.get(l,e),room_right:0,next_matching:f,door:!1,doorOffset:0})}c.push(t)}for(let t=1;t<l;++t){const e=[];for(let l=0;l<n;++l){let c=o.get(l,t),h=o.get(l,t-1),f=o.get(l+1,t),u=o.get(l+1,t-1),p=Math.max(h,c),d=Math.min(u,f),g=s.get(l,t);if(l>0&&h-c>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(c+1,g),dir:i.fromValues(1,0),length:h-(c+1),room_left:r.get(l,t),room_right:r.get(l-1,t-1),next_matching:o,door:!1,doorOffset:0})}if(d-p>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(p+1,g),dir:i.fromValues(1,0),length:d-(p+1),room_left:r.get(l,t),room_right:r.get(l,t-1),next_matching:o,door:!1,doorOffset:0})}if(l+1<n&&f-u>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(u+1,g),dir:i.fromValues(1,0),length:f-(u+1),room_left:r.get(l,t),room_right:r.get(l+1,t-1),next_matching:o,door:!1,doorOffset:0})}}c.push(e)}{const t=[];let e=l;for(let l=0;l<n;++l){let n=o.get(l,e-1),c=o.get(l+1,e-1),h=s.get(l,e),f=a.length;t.push(f),a.push({origin:i.fromValues(n+1,h),dir:i.fromValues(1,0),length:c-(n+1),room_left:0,room_right:r.get(l,e-1),next_matching:f,door:!1,doorOffset:0})}c.push(t)}if(t)for(let t=0;t<c.length;++t){let e=c[t],o=0,s=e.length-1;for(;o<s;){let t=e[o],r=e[s];a[t].next_matching=r,a[r].next_matching=t;{let t=a[r];i.scaleAndAdd(t.origin,t.origin,t.dir,t.length-1),i.negate(t.dir,t.dir),[t.room_left,t.room_right]=[t.room_right,t.room_left]}o+=1,s-=1}}if(e){let t=0,e=c.length-1;for(;t<e;){let o=c[t],s=c[e];console.assert(o.length==s.length);for(let t=0;t<o.length;++t){let e=o[t],r=s[t];a[e].next_matching=r,a[r].next_matching=e}t+=1,e-=1}}}{let c=[];{const t=[];let e=0;for(let n=0;n<l;++n){let l=s.get(e,n),c=s.get(e,n+1),h=o.get(e,n),f=a.length;t.push(f),a.push({origin:i.fromValues(h,l+1),dir:i.fromValues(0,1),length:c-(l+1),room_left:0,room_right:r.get(e,n),next_matching:f,door:!1,doorOffset:0})}c.push(t)}for(let t=1;t<n;++t){const e=[];for(let n=0;n<l;++n){let c=s.get(t-1,n),h=s.get(t,n),f=s.get(t-1,n+1),u=s.get(t,n+1),p=Math.max(c,h),d=Math.min(f,u),g=o.get(t,n);if(n>0&&c-h>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(g,h+1),dir:i.fromValues(0,1),length:c-(h+1),room_left:r.get(t-1,n-1),room_right:r.get(t,n),next_matching:o,door:!1,doorOffset:0})}if(d-p>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(g,p+1),dir:i.fromValues(0,1),length:d-(p+1),room_left:r.get(t-1,n),room_right:r.get(t,n),next_matching:o,door:!1,doorOffset:0})}if(n+1<l&&u-f>1){let o=a.length;e.push(o),a.push({origin:i.fromValues(g,f+1),dir:i.fromValues(0,1),length:u-(f+1),room_left:r.get(t-1,n+1),room_right:r.get(t,n),next_matching:o,door:!1,doorOffset:0})}}c.push(e)}{const t=[];let e=n;for(let n=0;n<l;++n){let l=s.get(e-1,n),c=s.get(e-1,n+1),h=o.get(e,n),f=a.length;a.push({origin:i.fromValues(h,l+1),dir:i.fromValues(0,1),length:c-(l+1),room_left:r.get(e-1,n),room_right:0,next_matching:f,door:!1,doorOffset:0}),t.push(f)}c.push(t)}if(e)for(let t=0;t<c.length;++t){let e=c[t],o=Math.floor(e.length/2);for(let t=0;t<o;++t){let o=e[t],s=e[e.length-1-t];a[o].next_matching=s,a[s].next_matching=o;{let t=a[s];i.scaleAndAdd(t.origin,t.origin,t.dir,t.length-1),i.negate(t.dir,t.dir),[t.room_left,t.room_right]=[t.room_right,t.room_left]}}}if(t){let t=0,e=c.length-1;for(;t<e;){let o=c[t],s=c[e];for(let t=0;t<o.length;++t){let e=o[t],r=s[t];a[e].next_matching=r,a[r].next_matching=e}t+=1,e-=1}}}return a}(e,o,r,n,u);!function(t,e){for(let o=0;o<t.length;++o){const s=t[o];let r=s.room_left,i=s.room_right;e[r].edges.push(o),e[i].edges.push(o)}}(d,p);let g=function(t,e){let o=function(t){const e=[];for(let o=0;o<t.length;++o){let s=t[o].next_matching;s>=o&&(s>o?e.push([o,s]):e.push([o]))}return h(e),e}(e);for(const o of e){let e=o.room_left,s=o.room_right;t[e].roomType==F.PublicCourtyard&&t[s].roomType==F.PublicCourtyard&&(o.door=!0,j(t,t[e].group,t[s].group))}for(const s of o){let o=!1;{let r=e[s[0]],i=r.room_left,n=r.room_right;if(t[i].roomType!=F.PublicRoom||t[n].roomType!=F.PublicRoom)continue;let l=t[i].group,a=t[n].group;(l!=a||Math.random()<.4)&&(r.door=!0,o=!0,j(t,l,a))}if(o)for(let o=1;o<s.length;++o){let r=e[s[o]],i=r.room_left,n=r.room_right,l=t[i].group,a=t[n].group;r.door=!0,j(t,l,a)}}for(const s of o){let o=!1;{let r=e[s[0]],i=r.room_left,n=r.room_right,l=t[i].roomType,a=t[n].roomType;if(l==a)continue;if(l==F.Exterior||a==F.Exterior)continue;let c=t[i].group,h=t[n].group;(c!=h||Math.random()<.4)&&(r.door=!0,o=!0,j(t,c,h))}if(o)for(let o=1;o<s.length;++o){let r=e[s[o]],i=r.room_left,n=r.room_right,l=t[i].group,a=t[n].group;r.door=!0,j(t,l,a)}}let s=i.fromValues(0,0);{let r=function(t,e,o){for(const s of o)for(const o of s){let s=e[o];if(0!=s.dir[0]&&!(s.next_matching>o)){if(s.next_matching==o){if(t[s.room_right].roomType!=F.Exterior)continue}else if(t[s.room_left].roomType!=F.Exterior)continue;return o}}return 0}(t,e,o);s[0]=e[r].origin[0]+e[r].dir[0]*Math.floor(e[r].length/2),s[1]=Y-1,e[r].door=!0;let i=e[r].next_matching;i!=r&&(e[i].next_matching=i,e[r].next_matching=r)}return s}(p,d);return function(t,e,o){let s=o.length;o[0].depth=0;for(let t=1;t<o.length;++t)o[t].depth=s;const r=[];for(let e=0;e<t.sizeX;++e){let s=t.get(e,0);o[s].depth=1,r.push(s)}let i=0;for(;i<r.length;){let t=r[i];for(const i of o[t].edges){let n=e[i];if(!n.door)continue;const l=n.room_left==t?n.room_right:n.room_left;o[l].depth==s&&(o[l].depth=o[t].depth+1,r.push(l))}i+=1}let n=0;for(const t of o)n=Math.max(n,t.depth);const l=Math.floor(t.sizeX*t.sizeY/4);let a=0,c=n;for(;c>0;){for(const t of o)t.roomType!=F.PublicRoom&&t.roomType!=F.PublicCourtyard||t.depth==c&&(t.roomType=t.roomType==F.PublicRoom?F.PrivateRoom:F.PrivateCourtyard,t.roomType==F.PrivateRoom&&(a+=1));if(a>=l)break;c-=1}for(;;){let t=!1;for(let s=0;s<o.length;++s)if(o[s].roomType==F.PublicCourtyard)for(const r of o[s].edges){const i=e[r];if(o[i.room_left!=s?i.room_left:i.room_right].roomType==F.PrivateCourtyard){o[s].roomType=F.PrivateCourtyard,t=!0;break}}if(!t)break}}(u,d,p),function(t,e,o){for(const s of e){const e=t[s.room_left].roomType,r=t[s.room_right].roomType;if(ht(e)&&ht(r))for(let t=0;t<s.length;++t){const e=i.create();i.scaleAndAdd(e,s.origin,s.dir,t),o.cells.at(e[0],e[1]).type=R.GroundGrass}}for(let s=0;s<e.length;++s){const r=e[s],n=t[r.room_left].roomType,l=t[r.room_right].roomType;if(ht(n)&&ht(l))continue;const a=r.next_matching;if(a<s)continue;let h;h=a==s?Math.floor(r.length/2):r.length>2?1+c(r.length-2):c(r.length);let f=[];if(f.push(r),a!=s&&f.push(e[a]),!r.door&&n!=l)if(n==F.Exterior||l==F.Exterior){if(0!=(1&r.length)){let e=Math.floor(r.length/2);for(const s of f){const r=i.create();i.scaleAndAdd(r,s.origin,s.dir,e);let n=i.clone(s.dir);t[s.room_right].roomType==F.Exterior&&i.negate(n,n),o.cells.at(r[0],r[1]).type=it(n)}}}else if(ht(n)||ht(l)){let e=c(2);const s=Math.floor((r.length+1)/2);for(;e<s;){for(const s of f){let r=i.clone(s.dir);ht(t[s.room_right].roomType)&&i.negate(r,r);let n=it(r);const l=i.create();i.scaleAndAdd(l,s.origin,s.dir,e);const a=i.create();i.scaleAndAdd(a,s.origin,s.dir,s.length-(e+1)),o.cells.at(l[0],l[1]).type=n,o.cells.at(a[0],a[1]).type=n}e+=2}}let u=Math.random()<.3333;for(const e of f){if(!e.door)continue;e.doorOffset=h;const s=i.create();i.scaleAndAdd(s,e.origin,e.dir,h);let r=0==e.dir[0];o.cells.at(s[0],s[1]).type=r?R.DoorNS:R.DoorEW;let n=t[e.room_left].roomType,l=t[e.room_right].roomType;n==F.Exterior||l==F.Exterior?(o.cells.at(s[0],s[1]).type=r?R.PortcullisNS:R.PortcullisEW,lt(o,s[0],s[1],r?A.PortcullisNS:A.PortcullisEW)):(n!=F.PrivateRoom||l!=F.PrivateRoom||u)&&(o.cells.at(s[0],s[1]).type=r?R.DoorNS:R.DoorEW,lt(o,s[0],s[1],r?A.DoorNS:A.DoorEW))}}}(p,d,l),function(t,e,o){for(let s=1;s<e.length;++s){const r=e[s];let i;switch(r.roomType){case F.Exterior:i=R.GroundNormal;break;case F.PublicCourtyard:i=R.GroundGrass;break;case F.PublicRoom:i=R.GroundWood;break;case F.PrivateCourtyard:i=R.GroundGrass;break;case F.PrivateRoom:i=R.GroundMarble}for(let e=r.posMin[0];e<r.posMax[0];++e)for(let s=r.posMin[1];s<r.posMax[1];++s)i==R.GroundWood&&t>3&&Math.random()<.02?o.cells.at(e,s).type=R.GroundWoodCreaky:o.cells.at(e,s).type=i;let n=r.posMax[0]-r.posMin[0],l=r.posMax[1]-r.posMin[1];if(ht(r.roomType)){if(n>=5&&l>=5)for(let t=r.posMin[0]+1;t<r.posMax[0]-1;++t)for(let e=r.posMin[1]+1;e<r.posMax[1]-1;++e)o.cells.at(t,e).type=R.GroundWater;else if(n>=2&&l>=2){const t=[A.TorchLit,A.Bush,A.Bush,A.Bush,A.Bush];h(t);const e=[[r.posMin[0],r.posMin[1]],[r.posMax[0]-1,r.posMin[1]],[r.posMin[0],r.posMax[1]-1],[r.posMax[0]-1,r.posMax[1]-1]];for(let s=0;s<e.length;++s){const[r,i]=e[s];o.cells.at(r,i).type==R.GroundGrass&&nt(o,r,i,t[s])}}}else if(r.roomType==F.PublicRoom||r.roomType==F.PrivateRoom)if(n>=5&&l>=5){if(r.roomType==F.PrivateRoom)for(let t=2;t<n-2;++t)for(let e=2;e<l-2;++e)o.cells.at(r.posMin[0]+t,r.posMin[1]+e).type=R.GroundWater;o.cells.at(r.posMin[0]+1,r.posMin[1]+1).type=R.Wall0000,o.cells.at(r.posMax[0]-2,r.posMin[1]+1).type=R.Wall0000,o.cells.at(r.posMin[0]+1,r.posMax[1]-2).type=R.Wall0000,o.cells.at(r.posMax[0]-2,r.posMax[1]-2).type=R.Wall0000}else if(5==n&&l>=3&&(r.roomType==F.PublicRoom||Math.random()<.33333)){const t=new Array(l-2).fill(A.Table);t.push(Math.random()<.25?A.TorchUnlit:A.TorchLit),h(t);for(let e=1;e<l-1;++e)lt(o,r.posMin[0]+1,r.posMin[1]+e,A.Chair),lt(o,r.posMin[0]+2,r.posMin[1]+e,t[e-1]),lt(o,r.posMin[0]+3,r.posMin[1]+e,A.Chair)}else if(5==l&&n>=3&&(r.roomType==F.PublicRoom||Math.random()<.33333)){const t=new Array(n-2).fill(A.Table);t.push(Math.random()<.25?A.TorchUnlit:A.TorchLit),h(t);for(let e=1;e<n-1;++e)lt(o,r.posMin[0]+e,r.posMin[1]+1,A.Chair),lt(o,r.posMin[0]+e,r.posMin[1]+2,t[e-1]),lt(o,r.posMin[0]+e,r.posMin[1]+3,A.Chair)}else if(n>l&&1==(1&l)&&Math.random()<.66667){let t=Math.floor(r.posMin[1]+l/2);const e=r.roomType==F.PublicRoom?A.Table:A.Chair,s=[Math.random()<.25?A.TorchUnlit:A.TorchLit,e];h(s),nt(o,r.posMin[0]+1,t,s[0]),nt(o,r.posMax[0]-2,t,s[1])}else if(l>n&&1==(1&n)&&Math.random()<.66667){let t=Math.floor(r.posMin[0]+n/2);const e=r.roomType==F.PublicRoom?A.Table:A.Chair,s=[Math.random()<.25?A.TorchUnlit:A.TorchLit,e];h(s),nt(o,t,r.posMin[1]+1,s[0]),nt(o,t,r.posMax[1]-2,s[1])}else if(n>3&&l>3){const t=r.roomType==F.PublicRoom?A.Table:A.Chair,e=[Math.random()<.25?A.TorchUnlit:A.TorchLit,t,t,t];h(e),nt(o,r.posMin[0],r.posMin[1],e[0]),nt(o,r.posMax[0]-1,r.posMin[1],e[1]),nt(o,r.posMin[0],r.posMax[1]-1,e[2]),nt(o,r.posMax[0]-1,r.posMax[1]-1,e[3])}}}(t,p,l),[p,d,g]}(t,true,false,s,r,n,a);return i.copy(a.playerStartPos,d),function(t){let e=t.cells.sizeX,o=t.cells.sizeY;for(let s=0;s<e;++s){for(let e=o-Y+1;e<o;++e){if(t.cells.at(s,e).type!=R.GroundNormal)continue;let o=t.cells.at(s,e);o.type=R.GroundGrass,o.seen=!0}0==(1&s)&&Math.random()<.8&&lt(t,s,o-1,A.Bush)}for(let s=Y;s<o-Y+1;++s){for(let e=0;e<Y-1;++e){if(t.cells.at(e,s).type!=R.GroundNormal)continue;let o=t.cells.at(e,s);o.type=R.GroundGrass,o.seen=!0}for(let o=e-Y+1;o<e;++o){if(t.cells.at(o,s).type!=R.GroundNormal)continue;let e=t.cells.at(o,s);e.type=R.GroundGrass,e.seen=!0}0!=(o-s&1)&&(Math.random()<.8&&lt(t,0,s,A.Bush),Math.random()<.8&&lt(t,e-1,s,A.Bush))}}(a),function(t){let e=t.cells.sizeX-1,o=Math.floor(t.cells.sizeX/2);for(let s=Y;s<o;s+=5)t.cells.at(s,1).type=R.Wall0000,t.cells.at(e-s,1).type=R.Wall0000}(a),function(t,e,o){let s=0;for(const e of t)e.roomType!=F.PublicRoom&&e.roomType!=F.PrivateRoom||(s+=1);for(const e of t)e.roomType==F.PrivateRoom&&(Math.random()<.2||at(e.posMin,e.posMax,o));for(const s of t){if(s.roomType!=F.PublicRoom&&s.roomType!=F.PrivateRoom)continue;let t=0;for(const o of s.edges)e[o].door&&(t+=1);t<2&&at(s.posMin,s.posMax,o)}let r=i.fromValues(0,0),n=i.fromValues(o.cells.sizeX,o.cells.sizeY);for(let t=Math.floor(s/4+c(4));t>0;--t)at(r,n,o)}(f,u,a),function(t){for(let e=0;e<t.sizeX;++e)for(let o=0;o<t.sizeY;++o){t.at(e,o).type==R.Wall0000&&(t.at(e,o).type=ut(dt(t,e,o)))}}(l),function(t){let e=t.cells.sizeX,o=t.cells.sizeY;for(let s=0;s<e;++s)for(let e=0;e<o;++e){const o=t.cells.at(s,e),r=o.type,i=r>=R.Wall0000&&r<=R.Wall1111,n=r>=R.OneWayWindowE&&r<=R.OneWayWindowS,l=r==R.GroundWater;o.moveCost=i||n?1/0:l?4096:0,o.blocksPlayerMove=i,o.blocksPlayerSight=i,o.blocksSight=i||n,o.blocksSound=i,o.hidesPlayer=!1}for(const e of t.items){let o=t.cells.at(e.pos[0],e.pos[1]),s=e.type;o.moveCost=Math.max(o.moveCost,E(s)),s!=A.DoorNS&&s!=A.DoorEW||(o.blocksPlayerSight=!0),s!=A.DoorNS&&s!=A.DoorEW&&s!=A.PortcullisNS&&s!=A.PortcullisEW&&s!=A.Bush||(o.blocksSight=!0),s!=A.Table&&s!=A.Bush||(o.hidesPlayer=!0)}}(a),function(t,e,o){const s=Array(e.length).fill(!0);for(let t=0;t<e.length;++t)e[t].roomType==F.Exterior&&(s[t]=!1);for(;;){let t=!1;for(let r=0;r<e.length;++r){if(!s[r])continue;const i=e[r];let n=0;for(const t of i.edges){const e=o[t];if(!e.door)continue;s[e.room_left!=r?e.room_left:e.room_right]&&(n+=1)}n<2&&(s[r]=!1,t=!0)}if(!t)break}const r=Array(e.length).fill(x);for(let o=0;o<e.length;++o)s[o]&&(r[o]=Z(t,e[o].posMin,e[o].posMax));for(const e of o){if(!e.door)continue;let o=r[e.room_left],s=r[e.room_right];o!==x&&s!==x&&J(t,o,s)}}(a,f,u),function(t,e,o){const s=Array(e.length).fill(!1);for(let t=0;t<e.length;++t){const o=e[t].roomType;o===F.Exterior||ht(o)||(s[t]=!0)}const r=Array(e.length),n=Array(e.length);for(let t=0;t<e.length;++t)r[t]=-1,n[t]=-1;const l=[...o];h(l);for(const t of l){if(!t.door)continue;const e=t.room_left,o=t.room_right;s[e]&&s[o]&&(-1==r[e]&&-1==n[o]?(r[e]=o,n[o]=e):-1==r[o]&&-1==n[e]&&(r[o]=e,n[e]=o))}const a=[];for(let o=0;o<e.length;++o){if(!s[o]){a.push(e[o].posMin);continue}const r=et(t,e[o]);a.push(r)}for(let l=0;l<e.length;++l){if(!s[l])continue;const a=r[l],h=n[l],f=i.create(),u=i.create();if(-1===a){if(-1===h)continue;{$(f,e,o,l,h);const s=tt(t,e[l]);s.length>0?i.copy(u,s[c(s.length)]):Q(u,e,o,l,h)}}else if(-1===h){const s=tt(t,e[l]);s.length>0?i.copy(f,s[c(s.length)]):Q(f,e,o,l,a),$(u,e,o,l,a)}else $(f,e,o,l,h),Q(u,e,o,l,a);const p=ot(t,f,u);for(const e of p)t.patrolRoutesNew.push(e)}}(a,f,u),function(t,e,o){if(t<=0)return;if(0===o.patrolRegions.length)return;let s=0;for(const t of e)t.roomType!=F.Exterior&&(s+=1);let r=0;for(;r>0;){const t=ft(o);if(void 0===t)break;const e=new p(t,o);r<2&&(e.hasTorch=!0),o.guards.push(e),r-=1}}(t,f,a),function(t){let e=t.cells.sizeX,o=t.cells.sizeY;for(let s=0;s<e;++s)for(let r=0;r<o;++r)(t.cells.at(s,r).type==R.GroundNormal||s>0&&t.cells.at(s-1,r).type==R.GroundNormal||s>0&&r>0&&t.cells.at(s-1,r-1).type==R.GroundNormal||s>0&&r+1<o&&t.cells.at(s-1,r+1).type==R.GroundNormal||r>0&&t.cells.at(s,r-1).type==R.GroundNormal||r+1<o&&t.cells.at(s,r+1).type==R.GroundNormal||s+1<e&&t.cells.at(s+1,r).type==R.GroundNormal||s+1<e&&r>0&&t.cells.at(s+1,r-1).type==R.GroundNormal||s+1<e&&r+1<o&&t.cells.at(s+1,r+1).type==R.GroundNormal)&&(t.cells.at(s,r).seen=!0)}(a),a.totalLoot=a.items.reduce(((t,e)=>t+(e.type==A.Coin?1:0)),0),a}function K(t,e,o,s){for(let r=o;r<=s;++r)t.at(e,r).type=R.Wall0000}function q(t,e,o,s){for(let r=e;r<=s;++r)t.at(r,o).type=R.Wall0000}function j(t,e,o){if(e!=o)for(const s of t)s.group==e&&(s.group=o)}function Z(t,e,o){let s=t.patrolRegions.length;t.patrolRegions.push({posMin:e,posMax:o});for(let r=e[0];r<o[0];++r)for(let i=e[1];i<o[1];++i)t.cells.at(r,i).region=s;return s}function J(t,e,o){console.assert(e<t.patrolRegions.length),console.assert(o<t.patrolRegions.length),t.patrolRoutes.push([e,o])}function $(t,e,o,s,r){for(const n of e[s].edges){const e=o[n];if(e.room_left===s&&e.room_right===r||e.room_left===r&&e.room_right===s)return void i.scaleAndAdd(t,e.origin,e.dir,e.doorOffset)}i.zero(t)}function Q(t,e,o,s,r){for(const n of e[s].edges){const e=o[n];if(e.room_left===s&&e.room_right===r){i.scaleAndAdd(t,e.origin,e.dir,e.doorOffset);const o=i.fromValues(-e.dir[1],e.dir[0]);return void i.add(t,t,o)}if(e.room_left===r&&e.room_right===s){i.scaleAndAdd(t,e.origin,e.dir,e.doorOffset);const o=i.fromValues(e.dir[1],-e.dir[0]);return void i.add(t,t,o)}}i.zero(t)}function tt(t,e){const o=[];for(let s=e.posMin[0];s<e.posMax[0];++s){if(e.posMin[1]>0){const r=t.cells.at(s,e.posMin[1]-1).type;r>=R.OneWayWindowE&&r<=R.OneWayWindowS&&o.push(i.fromValues(s,e.posMin[1]))}if(e.posMax[1]<t.cells.sizeY){const r=t.cells.at(s,e.posMax[1]).type;r>=R.OneWayWindowE&&r<=R.OneWayWindowS&&o.push(i.fromValues(s,e.posMax[1]-1))}}for(let s=e.posMin[1];s<e.posMax[1];++s){if(e.posMin[0]>0){const r=t.cells.at(e.posMin[0]-1,s).type;r>=R.OneWayWindowE&&r<=R.OneWayWindowS&&o.push(i.fromValues(e.posMin[0],s))}if(e.posMax[0]<t.cells.sizeX){const r=t.cells.at(e.posMax[0],s).type;r>=R.OneWayWindowE&&r<=R.OneWayWindowS&&o.push(i.fromValues(e.posMax[0]-1,s))}}if(o.length>0)return o;for(const s of t.items)s.type==A.Chair&&s.pos[0]>=e.posMin[0]&&s.pos[1]>=e.posMin[1]&&s.pos[0]<e.posMax[0]&&s.pos[1]<e.posMax[1]&&o.push(i.clone(s.pos));return o}function et(t,e){const o=[];for(let s=e.posMin[0];s<e.posMax[0];++s)for(let r=e.posMin[1];r<e.posMax[1];++r)0===t.cells.at(s,r).moveCost&&o.push(i.fromValues(s,r));if(o.length<=0)return e.posMin;const s=(e.posMin[0]+e.posMax[0]-1)/2,r=(e.posMin[1]+e.posMax[1]-1)/2;return o.sort(((t,e)=>(t[0]-s)**2+(t[1]-r)**2-((e[0]-s)**2+(e[1]-r)**2))),o[0]}function ot(t,e,o){const s=t.computeDistancesToPosition(o),r=i.clone(e),n=[];for(n.push(i.clone(r));r[0]!==o[0]||r[1]!==o[1];){const e=st(t,s,r);if(e[0]===r[0]&&e[1]===r[1])break;i.copy(r,e),n.push(i.clone(r))}return n}function st(t,e,o){let s=1/0,r=i.clone(o);const n=i.fromValues(Math.max(0,o[0]-1),Math.max(0,o[1]-1)),l=i.fromValues(Math.min(t.cells.sizeX,o[0]+2),Math.min(t.cells.sizeY,o[1]+2));for(let a=n[0];a<l[0];++a)for(let c=n[1];c<l[1];++c){const n=e.get(a,c);if(n==1/0)continue;let l=i.fromValues(a,c);t.guardMoveCost(o,l)!=1/0&&(t.cells.at(l[0],l[1]).type!=R.GroundWater&&n<s&&(s=n,r=l))}if(r[0]===o[0]&&r[1]===o[1]){console.log("failed to proceed");for(let t=n[0];t<l[0];++t)for(let o=n[1];o<l[1];++o){const s=e.get(t,o);console.log(t,o,s)}}return r}(I=F||(F={}))[I.Exterior=0]="Exterior",I[I.PublicCourtyard=1]="PublicCourtyard",I[I.PublicRoom=2]="PublicRoom",I[I.PrivateCourtyard=3]="PrivateCourtyard",I[I.PrivateRoom=4]="PrivateRoom";const rt=[R.OneWayWindowS,R.OneWayWindowE,R.OneWayWindowN,R.OneWayWindowW];function it(t){return rt[t[0]+2*Math.max(0,t[1])+1]}function nt(t,e,o,s){(function(t,e,o){return t.at(e-1,o).type>=R.PortcullisNS||(t.at(e+1,o).type>=R.PortcullisNS||(t.at(e,o-1).type>=R.PortcullisNS||t.at(e,o+1).type>=R.PortcullisNS))})(t.cells,e,o)||lt(t,e,o,s)}function lt(t,e,o,s){t.items.push({pos:i.fromValues(e,o),type:s})}function at(t,e,o){let s=e[0]-t[0],r=e[1]-t[1];for(let e=1e3;e>0;--e){let e=i.fromValues(t[0]+c(s),t[1]+c(r)),n=o.cells.at(e[0],e[1]).type;if((n==R.GroundWood||n==R.GroundMarble)&&!ct(o,e[0],e[1])){lt(o,e[0],e[1],A.Coin);break}}}function ct(t,e,o){for(const s of t.items)if(s.pos[0]==e&&s.pos[1]==o)return!0;for(const s of t.guards)if(s.pos[0]==e&&s.pos[1]==o)return!0;return!1}function ht(t){switch(t){case F.Exterior:return!1;case F.PublicCourtyard:return!0;case F.PublicRoom:return!1;case F.PrivateCourtyard:return!0;case F.PrivateRoom:return!1}}function ft(t){let e=t.cells.sizeX,o=t.cells.sizeY;for(let s=0;s<1e3;++s){let s=i.fromValues(c(e),c(o));if(i.squaredDistance(t.playerStartPos,s)<64)continue;let r=t.cells.at(s[0],s[1]).type;if((r==R.GroundWood||r==R.GroundMarble)&&!ct(t,s[0],s[1]))return s}}function ut(t){return R.Wall0000+t}function pt(t){return t>=R.Wall0000}function dt(t,e,o){const s=t.sizeX;let r=0;return o<t.sizeY-1&&pt(t.at(e,o+1).type)&&(r|=8),o>0&&pt(t.at(e,o-1).type)&&(r|=4),e<s-1&&pt(t.at(e+1,o).type)&&(r|=2),e>0&&pt(t.at(e-1,o).type)&&(r|=1),r}function gt(t="webgl",e,o){if("webgl"===t){const t=e.getContext("webgl2",{alpha:!1,depth:!1});return new Mt(t,o)}if("canvas"===t){const t=e.getContext("2d");return new bt(t,o)}if("null"===t)return new yt;throw new Error(`Invalid renderer ${t}`)}class mt{start(t,e){}addGlyph(t,e,o,s,r,i){}flush(){}}class yt{name="null";constructor(){this.renderGlyphs=new mt}getScreenSize(t){}beginFrame(t,e){}endFrame(){}}class Mt extends yt{constructor(t,e){super(),this.gl=t;const o=e.map((e=>function(t,e){const o=16,s=16,r=o*s,i=e.naturalWidth/o,n=e.naturalHeight/s,l=1,a=i*l,c=n*l,h=document.createElement("canvas");h.width=a,h.height=c*r;const f=h.getContext("2d");f.imageSmoothingEnabled=!1;for(let t=0;t<s;++t)for(let s=0;s<o;++s){const r=s*i,l=t*n,h=0,u=(o*t+s)*c;f.drawImage(e,r,l,i,n,h,u,a,c)}const u=f.getImageData(0,0,h.width,h.height),p=new Uint8Array(u.data.buffer),d=t.createTexture();return t.bindTexture(t.TEXTURE_2D_ARRAY,d),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D_ARRAY,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage3D(t.TEXTURE_2D_ARRAY,0,t.RGBA,a,c,r,0,t.RGBA,t.UNSIGNED_BYTE,p),d}(t,e)));this.name="webgl",this.renderGlyphs=new Tt(t,o),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND),t.clearColor(0,0,0,1)}getScreenSize(t){const e=this.gl.canvas;vt(e);const o=e.clientWidth,s=e.clientHeight;i.set(t,o,s)}beginFrame(t,e){const o=this.gl,s=o.canvas;vt(s);const r=s.clientWidth,n=s.clientHeight;o.viewport(0,0,r,n),o.clear(o.COLOR_BUFFER_BIT),i.set(t,r,n)}endFrame(){}}class Tt extends mt{constructor(t,e){super();const o={vPosition:0,vTexcoord:1,vColor:2},s=function(t,e,o,s){const r=xt(t,t.VERTEX_SHADER,e),i=xt(t,t.FRAGMENT_SHADER,o),n=t.createProgram();t.attachShader(n,r),t.attachShader(n,i);for(const e in s)t.bindAttribLocation(n,s[e],e);t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)||alert("Unable to initialize the shader program: "+t.getProgramInfoLog(n));return n}(t,"#version 300 es\n            in vec2 vPosition;\n            in vec3 vTexcoord;\n            in vec4 vColor;\n\n            uniform mat4 uMatScreenFromWorld;\n\n            out highp vec3 fTexcoord;\n            out highp vec4 fColor;\n\n            void main() {\n                fTexcoord = vTexcoord;\n                fColor = vColor;\n                gl_Position = uMatScreenFromWorld * vec4(vPosition, 0, 1);\n            }\n        ","#version 300 es\n            in highp vec3 fTexcoord;\n            in highp vec4 fColor;\n\n            uniform highp sampler2DArray uOpacity;\n\n            out lowp vec4 fragColor;\n\n            void main() {\n                fragColor = fColor * texture(uOpacity, fTexcoord);\n            }\n        ",o),r=t.getUniformLocation(s,"uMatScreenFromWorld"),i=t.getUniformLocation(s,"uOpacity"),n=2*Float32Array.BYTES_PER_ELEMENT+2*Uint32Array.BYTES_PER_ELEMENT,a=n,c=new ArrayBuffer(256*n),h=new Float32Array(c),f=new Uint32Array(c),u=t.createBuffer();let p=0;const d=l.create(),g=t.createVertexArray();t.bindVertexArray(g),t.enableVertexAttribArray(o.vPosition),t.enableVertexAttribArray(o.vTexcoord),t.enableVertexAttribArray(o.vColor),t.bindBuffer(t.ARRAY_BUFFER,u),t.vertexAttribPointer(o.vPosition,2,t.FLOAT,!1,n,0),t.vertexAttribPointer(o.vTexcoord,3,t.UNSIGNED_BYTE,!1,n,8),t.vertexAttribPointer(o.vColor,4,t.UNSIGNED_BYTE,!0,n,12),t.bufferData(t.ARRAY_BUFFER,c,t.DYNAMIC_DRAW);!function(t,e){const o=new Uint16Array(6*e);for(let t=0;t<e;++t){let e=6*t,s=4*t;o[e+0]=s+0,o[e+1]=s+1,o[e+2]=s+2,o[e+3]=s+2,o[e+4]=s+1,o[e+5]=s+3}const s=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s),t.bufferData(t.ELEMENT_ARRAY_BUFFER,o,t.STATIC_DRAW)}(t,64);t.bindVertexArray(null),this.start=(o,s)=>{l.copy(d,o),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D_ARRAY,e[s])},this.addGlyph=(t,e,o,s,r,i)=>{p>=64&&this.flush();const n=p*a,l=r<<16;h[n+0]=t,h[n+1]=e,f[n+2]=l+256,f[n+3]=i,h[n+4]=o,h[n+5]=e,f[n+6]=l+257,f[n+7]=i,h[n+8]=t,h[n+9]=s,f[n+10]=l,f[n+11]=i,h[n+12]=o,h[n+13]=s,f[n+14]=l+1,f[n+15]=i,++p},this.flush=()=>{p<=0||(t.useProgram(s),t.bindVertexArray(g),t.uniform1i(i,0),t.uniformMatrix4fv(r,!1,d),t.bindBuffer(t.ARRAY_BUFFER,u),t.bufferSubData(t.ARRAY_BUFFER,0,h,0),t.drawElements(t.TRIANGLES,6*p,t.UNSIGNED_SHORT,0),t.bindVertexArray(null),p=0)}}}function xt(t,e,o){const s=t.createShader(e);return t.shaderSource(s,o),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)||(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(s)),t.deleteShader(s)),s}function vt(t){const e=t.parentNode.getBoundingClientRect();t.width===e.width&&t.height===e.height||(t.width=e.width,t.height=e.height)}class bt extends yt{constructor(t,e){super();const o=e.map((e=>new _t(t,function(t){const e=16,o=16,s=e*o,r=t.naturalWidth/e,i=t.naturalHeight/o,n=1,l=r*n,a=i*n,c=document.createElement("canvas");c.width=l,c.height=a*s;const h=c.getContext("2d");h.imageSmoothingEnabled=!1;for(let s=0;s<o;++s)for(let o=0;o<e;++o){const n=o*r,c=s*i,f=0,u=(e*s+o)*a;h.drawImage(t,n,c,r,i,f,u,l,a)}return c.toDataURL()}(e),[16,16])));this.name="canvas",this.ctx=t,this.renderGlyphs=new St(o),this.gridCellSize=[16,16],this.offset=[0,0],this.shake=[0,0]}getScreenSize(t){vt(this.ctx.canvas);const e=this.ctx.canvas.clientWidth,o=this.ctx.canvas.clientHeight;i.set(t,e,o)}beginFrame(t,e){vt(this.ctx.canvas),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.save(),this.ctx.translate(this.offset[0]+this.shake[0],this.offset[1]+this.shake[1]),this.ctx.scale(...this.gridCellSize),this.renderGlyphs.mapSize=e,i.set(t,this.ctx.canvas.width,this.ctx.canvas.height)}endFrame(){this.ctx.restore()}}class St extends mt{constructor(t){super(),this.textures=t,this.activeTexture=null,this.tileSize=[16,16],this.mapSize=[0,0]}start(t,e){this.activeTexture=this.textures[e],this.activeTexture.ctx.imageSmoothingEnabled=!1}addGlyph(t,e,o,s,r,i){null!==this.activeTexture&&this.activeTexture.draw(r,t,this.mapSize[1]-e)}flush(){}}class _t{constructor(t,e,o=[16,16]){this.spriteSize=o,this.sheet=new Image,this.sheet.src=e,this.ctx=t}draw(t,e,o,s=!1){"number"==typeof t&&(t=[0,t]);let r=1-2*Number(s);s&&this.ctx.scale(-1,1),this.ctx.drawImage(this.sheet,t[0]*this.spriteSize[0],t[1]*this.spriteSize[1],this.spriteSize[0],this.spriteSize[1],r*e,o,r,1),s&&this.ctx.scale(-1,1)}drawScaled(t,e,o,s,r=!1){let i=1-2*Number(r);r&&this.ctx.scale(-1,1),this.ctx.drawImage(this.sheet,t[0]*this.spriteSize[0],t[1]*this.spriteSize[1],this.spriteSize[0],this.spriteSize[1],i*e,o,i*s,s),r&&this.ctx.scale(-1,1)}drawRotated(t,e,o,s,r=!1,i="center"){this.ctx.save(),"center"==i&&(i=[.5,.5]),this.ctx.translate(e,o),this.ctx.rotate(s*Math.PI/180),r&&this.ctx.scale(-1,1),this.ctx.translate(-i[0],-i[1]),this.ctx.drawImage(this.sheet,t[0]*this.spriteSize[0],t[1]*this.spriteSize[1],this.spriteSize[0],this.spriteSize[1],0,0,1,1),this.ctx.restore()}drawRotatedMultitile(t,e,o,s,r=!1,i="center"){this.ctx.save();let n=t[2],l=t[3];"center"==i&&(i=[n/2,l/2]),this.ctx.translate(e+i[0],o+i[1]),this.ctx.rotate(s*Math.PI/180),r&&this.ctx.scale(-1,1),this.ctx.translate(-i[0],-i[1]),this.ctx.drawImage(this.sheet,t[0]*this.spriteSize[0],t[1]*this.spriteSize[1],this.spriteSize[0]*n,this.spriteSize[1]*l,0,0,n,l),this.ctx.restore()}}const Rt=4278190080,Wt=4278233088,Pt=4278190248,At=4278211752,Gt=4289243304,Et=4283716692,wt=4294857812,zt=4294901332,Lt=4294857982,Ct=4283760382,Vt=4294901502;var Nt={};Nt=new URL(r("27Lyk").resolve("8FZzo"),import.meta.url).toString();var Dt={};Dt=new URL(r("27Lyk").resolve("lW8yX"),import.meta.url).toString(),window.onload=function(){Promise.all([Jt(Nt),Jt(Dt)]).then(Bt)};const Ut=65,kt=8,Xt=16,Ot=16,Yt=16,Ft=32,It=32;function Bt(t){const e=gt("webgl",document.querySelector("#canvas"),t),o=function(){const t=4,e=B(t);return{tLast:void 0,shiftModifierActive:!1,shiftUpLastTimeStamp:-1/0,player:new z(e.playerStartPos),finishedLevel:!1,seeAll:!0,seeGuardSight:!1,camera:re(e.playerStartPos),level:t,gameMap:e}}();function s(){requestAnimationFrame((t=>ie(t,e,o)))}document.body.addEventListener("keydown",(function(t){if("KeyF"==t.code||"NumpadAdd"==t.code)return void(o.shiftModifierActive=!0);if(t.ctrlKey)"KeyA"===t.code?(t.preventDefault(),o.seeAll=!o.seeAll):"KeyV"===t.code&&(t.preventDefault(),o.seeGuardSight=!o.seeGuardSight);else if("KeyR"==t.code)t.preventDefault(),function(t){const e=B(t.level);t.finishedLevel=!1,t.player=new z(e.playerStartPos),t.camera=re(e.playerStartPos),t.gameMap=e}(o);else{const e=o.shiftModifierActive||t.shiftKey||t.timeStamp-o.shiftUpLastTimeStamp<1?2:1;"ArrowLeft"==t.code||"Numpad4"==t.code||"KeyA"==t.code||"KeyH"==t.code?(t.preventDefault(),Kt(o,-1,0,e)):"ArrowRight"==t.code||"Numpad6"==t.code||"KeyD"==t.code||"KeyL"==t.code?(t.preventDefault(),Kt(o,1,0,e)):"ArrowDown"==t.code||"Numpad2"==t.code||"KeyS"==t.code||"KeyJ"==t.code?(t.preventDefault(),Kt(o,0,-1,e)):"ArrowUp"==t.code||"Numpad8"==t.code||"KeyW"==t.code||"KeyK"==t.code?(t.preventDefault(),Kt(o,0,1,e)):"Period"!=t.code&&"Numpad5"!=t.code&&"KeyZ"!=t.code||(t.preventDefault(),Kt(o,0,0,1))}o.shiftModifierActive=!1})),document.body.addEventListener("keyup",(function(t){"ShiftLeft"!=t.code&&"ShiftRight"!=t.code||(o.shiftUpLastTimeStamp=t.timeStamp)})),window.addEventListener("resize",(function(){s()})),s()}function Ht(t){t.level+=1,t.gameMap=B(t.level),t.finishedLevel=!1,t.player.pos=t.gameMap.playerStartPos,t.player.dir=i.fromValues(0,-1),t.player.gold=0,t.player.noisy=!1,t.player.damagedLastTurn=!1,t.player.turnsRemainingUnderwater=0,t.camera=re(t.gameMap.playerStartPos),t.gameMap.recomputeVisibility(t.player.pos)}function Kt(t,e,o,s){const r=t.player;if(r.health<=0)return;if(0===e&&0===o||s<=0)return qt(t),void jt(t);let n=function(t,e,o,s){const r=t.player;let n=i.clone(r.pos),l=0;for(let a=1;a<=s;++a){const s=i.fromValues(r.pos[0]+e*a,r.pos[1]+o*a);if(s[0]<0||s[1]<0||s[0]>=t.gameMap.cells.sizeX||s[1]>=t.gameMap.cells.sizeY){t.gameMap.allSeen()&&t.gameMap.allLootCollected()&&(l=a);break}if(Zt(t.gameMap,n,s))break;l=a,n=s}if(l>0){const s=i.fromValues(r.pos[0]+e*l,r.pos[1]+o*l);void 0!==t.gameMap.guards.find((t=>t.pos[0]==s[0]&&t.pos[1]==s[1]))&&(l=0)}if(l>0){const s=i.fromValues(r.pos[0]+e*l,r.pos[1]+o*l);void 0!==t.gameMap.items.find((t=>t.pos[0]===s[0]&&t.pos[1]===s[1]&&(t.type===A.TorchUnlit||t.type===A.TorchLit)))&&--l}return l}(t,e,o,s);if(n<=0){const s=i.fromValues(r.pos[0]+e*(n+1),r.pos[1]+o*(n+1)),l=t.gameMap.items.find((t=>t.pos[0]===s[0]&&t.pos[1]===s[1]));void 0===l||l.type!==A.TorchUnlit&&l.type!==A.TorchLit||(qt(t),l.type=l.type===A.TorchUnlit?A.TorchLit:A.TorchUnlit,jt(t))}else{for(qt(t);n>0;--n){if(r.pos[0]+=e,r.pos[1]+=o,r.pos[0]<0||r.pos[1]<0||r.pos[0]>=t.gameMap.cells.sizeX||r.pos[1]>=t.gameMap.cells.sizeY)return void Ht(t);r.gold+=t.gameMap.collectLootAt(r.pos[0],r.pos[1])}t.gameMap.cells.at(r.pos[0],r.pos[1]).type==R.GroundWoodCreaky&&function(t,e,o){e.noisy=!0;for(const s of t.guardsInEarshot(e.pos,o))s.heardThief=!0}(t.gameMap,r,17),jt(t)}}function qt(t){t.player.noisy=!1,t.player.damagedLastTurn=!1}function jt(t){t.gameMap.cells.at(t.player.pos[0],t.player.pos[1]).type==R.GroundWater?t.player.turnsRemainingUnderwater>0&&--t.player.turnsRemainingUnderwater:t.player.turnsRemainingUnderwater=7,g(t.gameMap,t.player),t.gameMap.computeLighting(),t.gameMap.recomputeVisibility(t.player.pos),t.gameMap.allSeen()&&t.gameMap.allLootCollected()&&(t.finishedLevel=!0)}function Zt(t,e,o){if(o[0]<0||o[1]<0||o[0]>=t.cells.sizeX||o[1]>=t.cells.sizeY)return!0;if(e[0]==o[0]&&e[1]==o[1])return!1;const s=t.cells.at(o[0],o[1]),r=s.type;return!!s.blocksPlayerMove||(r==R.OneWayWindowE&&o[0]<=e[0]||(r==R.OneWayWindowW&&o[0]>=e[0]||(r==R.OneWayWindowN&&o[1]<=e[1]||r==R.OneWayWindowS&&o[1]>=e[1])))}function Jt(t){return new Promise(((e,o)=>{const s=new Image;s.onload=()=>e(s),s.onerror=o,s.src=t}))}const $t=[112,116,118,120,122,122,64,65,65,65,66,67,70,73,66,68,69,72,66,74,71,75,52,53,54,55,50,50,77,76],Qt=[Gt,Wt,wt,4289243136,At,4278206576,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt,Gt],te=[100,98,96,110,89,87,50,50,80,80],ee=[At,At,Wt,Ct,At,At,Gt,Gt,Et,Ct],oe=wt;function se(t){return t[1]>0?1:t[1]<0?3:t[0]>0?0:t[0]<0?2:3}function re(t){const e={position:i.create(),velocity:i.create(),snapped:!1};return i.copy(e.position,t),i.zero(e.velocity),e}function ie(t,e,o){const s=t/1e3,r=void 0===o.tLast?0:Math.min(1/30,s-o.tLast);o.tLast=s;const n=i.create();e.getScreenSize(n),o.camera.snapped||(o.camera.snapped=!0,function(t,e){ne(t.camera.position,i.fromValues(t.gameMap.cells.sizeX,t.gameMap.cells.sizeY),e,t.player.pos),i.zero(t.camera.velocity)}(o,n)),r>0&&function(t,e,o){!function(t,e,o){const s=i.create();ne(s,i.fromValues(t.gameMap.cells.sizeX,t.gameMap.cells.sizeY),e,t.player.pos);const r=i.create();i.subtract(r,s,t.camera.position);const n=i.create();i.negate(n,t.camera.velocity);const l=8,a=i.create();i.scale(a,r,l**2),i.scaleAndAdd(a,a,n,2*l);const c=i.create();i.scaleAndAdd(c,t.camera.velocity,a,o),i.scaleAndAdd(t.camera.position,t.camera.position,t.camera.velocity,.5*o),i.scaleAndAdd(t.camera.position,t.camera.position,c,.5*o),i.copy(t.camera.velocity,c)}(t,e,o)}(o,n,r),function(t,e,o){t.beginFrame(e,[o.gameMap.cells.sizeX,o.gameMap.cells.sizeY]);const s=l.create();(function(t,e,o){const s=Xt*ce(e[0]),r=i.fromValues(e[0],e[1]-s),[n,a]=le(r),c=t.camera.position[0],h=t.camera.position[1],f=ae(r),u=s/(Yt*f),p=c-n/2,d=h-a/2;l.ortho(o,p,p+n,d-u,d+a,1,-1)})(o,e,s),t.renderGlyphs.start(s,1),function(t,e){for(let o=0;o<t.gameMap.cells.sizeX;++o)for(let s=0;s<t.gameMap.cells.sizeY;++s){const r=t.gameMap.cells.at(o,s);if(!r.seen&&!t.seeAll)continue;const i=r.type,n=$t[i],l=i>=R.Wall0000||r.lit?Qt[i]:oe;e.addGlyph(o,s,o+1,s+1,n,l)}for(const o of t.gameMap.items){const s=t.gameMap.cells.at(o.pos[0],o.pos[1]);if(!s.seen&&!t.seeAll)continue;const r=te[o.type],i=o.type>=A.DoorNS&&o.type<=A.PortcullisEW||s.lit?ee[o.type]:oe;e.addGlyph(o.pos[0],o.pos[1],o.pos[0]+1,o.pos[1]+1,r,i)}}(o,t.renderGlyphs),function(t,e){const o=t.player,s=o.pos[0],r=o.pos[1],i=t.gameMap.cells.at(s,r).lit,n=o.hidden(t.gameMap),l=o.damagedLastTurn?4278190335:o.noisy?zt:n?3490713616:i?Gt:wt;e.addGlyph(s,r,s+1,r+1,32,l)}(o,t.renderGlyphs),function(t,e){for(const o of t.gameMap.guards){const s=t.gameMap.cells.at(o.pos[0],o.pos[1]),r=t.seeAll||s.seen||o.speaking;if(!r&&i.squaredDistance(t.player.pos,o.pos)>36)continue;const n=33+se(o.dir),l=r?o.mode!=f.Patrol||o.speaking||s.lit?Lt:oe:Et,a=o.pos[0],c=o.pos[1];e.addGlyph(a,c,a+1,c+1,n,l)}}(o,t.renderGlyphs),function(t,e){for(const o of t.gameMap.guards){const s=t.gameMap.cells.at(o.pos[0],o.pos[1]);if(!(t.seeAll||s.seen||o.speaking)&&i.squaredDistance(t.player.pos,o.pos)>36)continue;const r=o.overheadIcon();if(void 0===r)continue;const n=o.pos[0],l=o.pos[1]+.625;e.addGlyph(n,l,n+1,l+1,r,Ct)}}(o,t.renderGlyphs),function(t,e){if(!t.seeGuardSight)return;const o=t.gameMap.cells.sizeX,s=t.gameMap.cells.sizeY,r=new b(o,s,!1),n=i.create(),l=i.create();for(const e of t.gameMap.guards){const a=3,c=Math.max(0,Math.floor(e.pos[0]-a)),h=Math.min(o,Math.floor(e.pos[0]+a)+1),f=Math.max(0,Math.floor(e.pos[1]-a)),u=Math.min(s,Math.floor(e.pos[1]+a)+1);for(let o=f;o<u;++o)for(let s=c;s<h;++s){i.set(n,s,o),i.subtract(l,n,e.pos);const a=t.gameMap.cells.at(s,o);r.get(s,o)||a.blocksPlayerMove||(t.seeAll||a.seen)&&(i.dot(e.dir,l)<0||i.squaredLength(l)>=e.sightCutoff(a.lit)||T(t.gameMap,e.pos,n)&&r.set(s,o,!0))}}for(let o=0;o<t.gameMap.cells.sizeY;++o)for(let s=0;s<t.gameMap.cells.sizeX;++s)r.get(s,o)&&e.addGlyph(s,o,s+1,o+1,15,2684371072)}(o,t.renderGlyphs),function(t,e){for(const o of t.gameMap.patrolRoutesNew)e.addGlyph(o[0],o[1],o[0]+1,o[1]+1,64,Rt);for(const o of t.gameMap.patrolRoutesNew)e.addGlyph(o[0],o[1],o[0]+1,o[1]+1,249,Vt)}(o,t.renderGlyphs),t.renderGlyphs.flush(),function(t,e,o){const s=ce(e[0]),r=e[0]/(s*kt),i=e[1]/(s*Xt),n=l.create();l.ortho(n,0,r,0,i,1,-1),t.renderGlyphs.start(n,0);const a=Math.ceil(r),c=4279242768;function h(e,o,s){for(let r=0;r<o.length;++r){const i=o.charCodeAt(r);t.renderGlyphs.addGlyph(e+r,0,e+r+1,1,i,s)}}t.renderGlyphs.addGlyph(0,0,a,1,219,c);const f=1;h(f,"Health",Pt);for(let e=0;e<w;++e){const s=e<o.player.health?Pt:Rt,r=3;t.renderGlyphs.addGlyph(e+f+7,0,e+f+8,1,r,s)}const u=o.gameMap.cells.at(o.player.pos[0],o.player.pos[1]).type==R.GroundWater&&o.player.turnsRemainingUnderwater>0;if(u){const e=f+w+88;h(e,"Air",zt);for(let s=0;s<o.player.turnsRemainingUnderwater;++s){const o=9;t.renderGlyphs.addGlyph(e+4+s,0,e+5+s,1,o,zt)}}const p=o.gameMap.percentSeen(),d="Level "+(o.level+1)+": "+p+"% Seen";h(Math.floor((a-d.length)/2+.5),d,Gt);let g="Loot "+o.player.gold+"/";g+=p<100?"?":o.gameMap.totalLoot;h(a-(g.length+1),g,Ct),t.renderGlyphs.flush()}(t,e,o)}(e,n,o),requestAnimationFrame((t=>ie(t,e,o)))}function ne(t,e,o,s){const r=i.create(),n=i.create();!function(t,e,o,s){const r=Xt*ce(e[0]),n=i.fromValues(e[0],e[1]-r),[l,a]=le(n);let c=l/2,h=t[0]-l/2;c>h&&(c=h=t[0]/2);let f=a/2,u=t[1]-a/2;f>u&&(f=u=t[1]/2);o[0]=c,o[1]=f,s[0]=h,s[1]=u}(e,o,r,n),t[0]=Math.max(r[0],Math.min(n[0],s[0]+.5)),t[1]=Math.max(r[1],Math.min(n[1],s[1]+.5))}function le(t){const e=ae(t),o=Ot*e,s=Yt*e;return[t[0]/o,t[1]/s]}function ae(t){const e=Ft*Ot,o=It*Yt;let s;return s=t[0]*o<t[1]*e?Math.max(1,Math.floor(t[0]/e+.5)):Math.max(1,Math.floor(t[1]/o+.5)),s}function ce(t){return Math.min(2,Math.max(1,Math.floor(t/(Ut*kt))))}
//# sourceMappingURL=index.587b180a.js.map
