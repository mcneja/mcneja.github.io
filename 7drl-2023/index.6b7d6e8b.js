function e(e){return e&&e.__esModule?e.default:e}var t,o,r,a,n,i,s,l,f,u,c,d,p,h,m,g,x,y,_,S,v,M,b,A,w,T,R,H,I,L,C,E=globalThis,F={},k={},P=E.parcelRequire94c2;null==P&&((P=function(e){if(e in F)return F[e].exports;if(e in k){var t=k[e];delete k[e];var o={id:e,exports:{}};return F[e]=o,t.call(o.exports,o,o.exports),o.exports}var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){k[e]=t},E.parcelRequire94c2=P);var D=P.register;D("27Lyk",function(e,t){Object.defineProperty(e.exports,"register",{get:()=>o,set:e=>o=e,enumerable:!0,configurable:!0});var o,r=new Map;o=function(e,t){for(var o=0;o<t.length-1;o+=2)r.set(t[o],{baseUrl:e,path:t[o+1]})}}),D("cmoHh",function(e,t){!function(e,t,o){function r(e){var t,o=this,r=(t=0xefc8249d,function(e){e=String(e);for(var o=0;o<e.length;o++){var r=.02519603282416938*(t+=e.charCodeAt(o));t=r>>>0,r-=t,r*=t,t=r>>>0,r-=t,t+=0x100000000*r}return(t>>>0)*23283064365386963e-26});o.next=function(){var e=2091639*o.s0+23283064365386963e-26*o.c;return o.s0=o.s1,o.s1=o.s2,o.s2=e-(o.c=0|e)},o.c=1,o.s0=r(" "),o.s1=r(" "),o.s2=r(" "),o.s0-=r(e),o.s0<0&&(o.s0+=1),o.s1-=r(e),o.s1<0&&(o.s1+=1),o.s2-=r(e),o.s2<0&&(o.s2+=1)}function a(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function n(e,t){var o=new r(e),n=t&&t.state,i=o.next;return i.int32=function(){return 0x100000000*o.next()|0},i.double=function(){return i()+(2097152*i()|0)*11102230246251565e-32},i.quick=i,n&&("object"==typeof n&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.alea=n}(0,e,"function"==typeof define&&define)}),D("euRi5",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:o+=e;for(var r=0;r<o.length+64;r++)t.x^=0|o.charCodeAt(r),t.next()}function a(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function n(e,t){var o=new r(e),n=t&&t.state,i=function(){return(o.next()>>>0)/0x100000000};return i.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},i.int32=o.next,i.quick=i,n&&("object"==typeof n&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xor128=n}(0,e,"function"==typeof define&&define)}),D("hDsEw",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(e^e<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:o+=e;for(var r=0;r<o.length+64;r++)t.x^=0|o.charCodeAt(r),r==o.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function a(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function n(e,t){var o=new r(e),n=t&&t.state,i=function(){return(o.next()>>>0)/0x100000000};return i.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},i.int32=o.next,i.quick=i,n&&("object"==typeof n&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xorwow=n}(0,e,"function"==typeof define&&define)}),D("3J2Zm",function(e,t){!function(e,t,o){function r(e){var t=this;t.next=function(){var e,o,r=t.x,a=t.i;return e=r[a],e^=e>>>7,o=e^e<<24^((e=r[a+1&7])^e>>>10)^((e=r[a+3&7])^e>>>3)^((e=r[a+4&7])^e<<7),e=r[a+7&7],e^=e<<13,o^=e^e<<9,r[a]=o,t.i=a+1&7,o},function(e,t){var o,r=[];if(t===(0|t))r[0]=t;else for(o=0,t=""+t;o<t.length;++o)r[7&o]=r[7&o]<<15^t.charCodeAt(o)+r[o+1&7]<<13;for(;r.length<8;)r.push(0);for(o=0;o<8&&0===r[o];++o);for(8==o?r[7]=-1:r[o],e.x=r,e.i=0,o=256;o>0;--o)e.next()}(t,e)}function a(e,t){return t.x=e.x.slice(),t.i=e.i,t}function n(e,t){null==e&&(e=+new Date);var o=new r(e),n=t&&t.state,i=function(){return(o.next()>>>0)/0x100000000};return i.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},i.int32=o.next,i.quick=i,n&&(n.x&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xorshift7=n}(0,e,"function"==typeof define&&define)}),D("6Px8M",function(e,t){!function(e,t,o){function r(e){var t=this;t.next=function(){var e,o,r=t.w,a=t.X,n=t.i;return t.w=r=r+0x61c88647|0,o=a[n+34&127],e=a[n=n+1&127],o^=o<<13,e^=e<<17,o^=o>>>15,e^=e>>>12,o=a[n]=o^e,t.i=n,o+(r^r>>>16)|0},function(e,t){var o,r,a,n,i,s=[],l=128;for(t===(0|t)?(r=t,t=null):(t+="\0",r=0,l=Math.max(l,t.length)),a=0,n=-32;n<l;++n)t&&(r^=t.charCodeAt((n+32)%t.length)),0===n&&(i=r),r^=r<<10,r^=r>>>15,r^=r<<4,r^=r>>>13,n>=0&&(i=i+0x61c88647|0,a=0==(o=s[127&n]^=r+i)?a+1:0);for(a>=128&&(s[127&(t&&t.length||0)]=-1),a=127,n=512;n>0;--n)r=s[a+34&127],o=s[a=a+1&127],r^=r<<13,o^=o<<17,r^=r>>>15,o^=o>>>12,s[a]=r^o;e.w=i,e.X=s,e.i=a}(t,e)}function a(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function n(e,t){null==e&&(e=+new Date);var o=new r(e),n=t&&t.state,i=function(){return(o.next()>>>0)/0x100000000};return i.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},i.int32=o.next,i.quick=i,n&&(n.X&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.xor4096=n}(0,e,"function"==typeof define&&define)}),D("lDm0S",function(e,t){!function(e,t,o){function r(e){var t=this,o="";t.next=function(){var e=t.b,o=t.c,r=t.d,a=t.a;return e=e<<25^e>>>7^o,o=o-r|0,r=r<<24^r>>>8^a,a=a-e|0,t.b=e=e<<20^e>>>12^o,t.c=o=o-r|0,t.d=r<<16^o>>>16^a,t.a=a-e|0},t.a=0,t.b=0,t.c=-0x61c88647,t.d=0x517cc1b7,e===Math.floor(e)?(t.a=e/0x100000000|0,t.b=0|e):o+=e;for(var r=0;r<o.length+20;r++)t.b^=0|o.charCodeAt(r),t.next()}function a(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function n(e,t){var o=new r(e),n=t&&t.state,i=function(){return(o.next()>>>0)/0x100000000};return i.double=function(){do var e=o.next()>>>11,t=(o.next()>>>0)/0x100000000,r=(e+t)/2097152;while(0===r)return r},i.int32=o.next,i.quick=i,n&&("object"==typeof n&&a(n,o),i.state=function(){return a(o,{})}),i}t&&t.exports?t.exports=n:o&&o.amd?o(function(){return n}):this.tychei=n}(0,e,"function"==typeof define&&define)}),D("kjyEk",function(e,t){}),D("iTVA6",function(e,t){e.exports=new URL("creak-7.63b3004c.mp3",import.meta.url).toString()}),D("28Aoq",function(e,t){e.exports=new URL("creak-8.73042d94.mp3",import.meta.url).toString()}),D("loJk2",function(e,t){e.exports=new URL("creak-9.d06defda.mp3",import.meta.url).toString()}),D("aPbaQ",function(e,t){e.exports=new URL("creak-10.57762380.mp3",import.meta.url).toString()}),D("3Lt6b",function(e,t){e.exports=new URL("creak-11.b8ba6527.mp3",import.meta.url).toString()}),D("ce6hk",function(e,t){e.exports=new URL("creak-12.27451032.mp3",import.meta.url).toString()}),D("5Cc9i",function(e,t){e.exports=new URL("hit16.mp3.12db2307.flac",import.meta.url).toString()}),D("FaWvz",function(e,t){e.exports=new URL("hit17.mp3.f1f9a130.flac",import.meta.url).toString()}),D("in96N",function(e,t){e.exports=new URL("hit18.mp3.9e7af88b.flac",import.meta.url).toString()}),D("lAYya",function(e,t){e.exports=new URL("hit19.mp3.d775e463.flac",import.meta.url).toString()}),D("lrFFe",function(e,t){e.exports=new URL("hit20.mp3.3b3594b6.flac",import.meta.url).toString()}),D("8IktG",function(e,t){e.exports=new URL("hit26.mp3.ad2a87c8.flac",import.meta.url).toString()}),D("jDOLn",function(e,t){e.exports=new URL("hit27.mp3.68a7736d.flac",import.meta.url).toString()}),D("eNjZd",function(e,t){e.exports=new URL("coin-rattle.01ea1b9b.mp3",import.meta.url).toString()}),D("gFQDW",function(e,t){e.exports=new URL("coin.27887bdc.mp3",import.meta.url).toString()}),D("g6s0o",function(e,t){e.exports=new URL("coin-2.e8e82d5c.mp3",import.meta.url).toString()}),D("38EWM",function(e,t){e.exports=new URL("coin-3.004f8541.mp3",import.meta.url).toString()}),D("4GkcK",function(e,t){e.exports=new URL("coin-4.6a51959e.mp3",import.meta.url).toString()}),D("cgtym",function(e,t){e.exports=new URL("coin-5.035907c7.mp3",import.meta.url).toString()}),D("eBj7I",function(e,t){e.exports=new URL("grunt.a8cde342.mp3",import.meta.url).toString()}),D("jK7UW",function(e,t){e.exports=new URL("grunt-2.30849a22.mp3",import.meta.url).toString()}),D("5FFXM",function(e,t){e.exports=new URL("grunt-3.687bdfee.mp3",import.meta.url).toString()}),D("kDliU",function(e,t){e.exports=new URL("grunt-4.4776cbdb.mp3",import.meta.url).toString()}),D("hCXAK",function(e,t){e.exports=new URL("grunt-5.7ebbc883.mp3",import.meta.url).toString()}),D("cfhG3",function(e,t){e.exports=new URL("grunt-6.b692d76a.mp3",import.meta.url).toString()}),D("b7oJW",function(e,t){e.exports=new URL("grunt-7.9923b5b3.mp3",import.meta.url).toString()}),D("kw8GX",function(e,t){e.exports=new URL("grunt-8.1912db98.mp3",import.meta.url).toString()}),D("9LbpL",function(e,t){e.exports=new URL("douse.5dfe688a.mp3",import.meta.url).toString()}),D("aWsJG",function(e,t){e.exports=new URL("douse-2.01d5e3d6.mp3",import.meta.url).toString()}),D("bng1w",function(e,t){e.exports=new URL("douse-3.5dfe688a.mp3",import.meta.url).toString()}),D("lKUPS",function(e,t){e.exports=new URL("douse-4.b84da553.mp3",import.meta.url).toString()}),D("dZ6Ot",function(e,t){e.exports=new URL("chiming-clock-short.556e70d4.mp3",import.meta.url).toString()}),D("2vlD3",function(e,t){e.exports=new URL("ticking-clock.35c9d3e3.mp3",import.meta.url).toString()}),D("aru1y",function(e,t){e.exports=new URL("eating.4854d1c5.mp3",import.meta.url).toString()}),D("lMhUh",function(e,t){e.exports=new URL("grab-key.fd446a6a.mp3",import.meta.url).toString()}),D("4d44Y",function(e,t){e.exports=new URL("grab-key-2.1f70d529.mp3",import.meta.url).toString()}),D("bEm3g",function(e,t){e.exports=new URL("ignite.d3dd60a8.mp3",import.meta.url).toString()}),D("GdyQD",function(e,t){e.exports=new URL("ignite-2.9dbae47a.mp3",import.meta.url).toString()}),D("1fsB5",function(e,t){e.exports=new URL("hide.b8c99711.mp3",import.meta.url).toString()}),D("6Pwxj",function(e,t){e.exports=new URL("hide-2.0fe6cda6.mp3",import.meta.url).toString()}),D("htDuP",function(e,t){e.exports=new URL("hide-3.302dff53.mp3",import.meta.url).toString()}),D("6HXgz",function(e,t){e.exports=new URL("hide-4.a97e1fc7.mp3",import.meta.url).toString()}),D("eCYq7",function(e,t){e.exports=new URL("hide-5.9bfbd476.mp3",import.meta.url).toString()}),D("5pbaw",function(e,t){e.exports=new URL("hide-6.1cd4f3d7.mp3",import.meta.url).toString()}),D("bwvl8",function(e,t){e.exports=new URL("gate.d5f8126d.mp3",import.meta.url).toString()}),D("ed1ua",function(e,t){e.exports=new URL("gate-2.0044fff9.mp3",import.meta.url).toString()}),D("782zK",function(e,t){e.exports=new URL("gate-3.5b7711d0.mp3",import.meta.url).toString()}),D("dPeI8",function(e,t){e.exports=new URL("gate-4.1e6a5d1b.mp3",import.meta.url).toString()}),D("judkj",function(e,t){e.exports=new URL("gate-5.72c10f72.mp3",import.meta.url).toString()}),D("lxyga",function(e,t){e.exports=new URL("thump.9f0f330d.mp3",import.meta.url).toString()}),D("lr8zJ",function(e,t){e.exports=new URL("splash1.decbf9bf.mp3",import.meta.url).toString()}),D("lDVN4",function(e,t){e.exports=new URL("splash2.3233364a.mp3",import.meta.url).toString()}),D("dy94L",function(e,t){e.exports=new URL("water-ambient.873a6917.mp3",import.meta.url).toString()}),D("lAhpG",function(e,t){e.exports=new URL("water-ambient-2.efcabd82.mp3",import.meta.url).toString()}),D("cCBZ8",function(e,t){e.exports=new URL("fire.13ea005c.mp3",import.meta.url).toString()}),D("dHyRJ",function(e,t){e.exports=new URL("fire-and-boil.e36f20a5.mp3",import.meta.url).toString()}),D("dW6q5",function(e,t){e.exports=new URL("outdoor-ambient.3d21830e.mp3",import.meta.url).toString()}),D("2oFKH",function(e,t){e.exports=new URL("outdoor-ambient-2.5fcdc149.mp3",import.meta.url).toString()}),D("l7n2L",function(e,t){e.exports=new URL("outdoor-ambient-3.53f64ba0.mp3",import.meta.url).toString()}),D("2sjSb",function(e,t){e.exports=new URL("outdoor-ambient-4.3c078af4.mp3",import.meta.url).toString()}),D("2NUSH",function(e,t){e.exports=new URL("guard-door.c3bdfc6d.mp3",import.meta.url).toString()}),D("6xjwR",function(e,t){e.exports=new URL("door-close.96f76874.mp3",import.meta.url).toString()}),D("11TN1",function(e,t){e.exports=new URL("door-unlock-and-open.28ff596b.mp3",import.meta.url).toString()}),D("8wLll",function(e,t){e.exports=new URL("door-close-and-lock.19ec2936.mp3",import.meta.url).toString()}),D("2tayG",function(e,t){e.exports=new URL("player-door-open.31e3a014.mp3",import.meta.url).toString()}),D("avEhW",function(e,t){e.exports=new URL("player-door-close.0a90723e.mp3",import.meta.url).toString()}),D("lLWGT",function(e,t){e.exports=new URL("player-door-unlock-and-open.e081c951.mp3",import.meta.url).toString()}),D("8T2ls",function(e,t){e.exports=new URL("player-door-close-and-lock.dd49aac6.mp3",import.meta.url).toString()}),D("fByUm",function(e,t){e.exports=new URL("water-submerge.b6b726d0.mp3",import.meta.url).toString()}),D("alZL1",function(e,t){e.exports=new URL("water-exit.d3e2453d.mp3",import.meta.url).toString()}),D("9vLti",function(e,t){e.exports=new URL("jump.e55ef093.mp3",import.meta.url).toString()}),D("1zLmV",function(e,t){e.exports=new URL("jump-2.6fe19da4.mp3",import.meta.url).toString()}),D("jLUJz",function(e,t){e.exports=new URL("alarm.befdf3d9.mp3",import.meta.url).toString()}),D("hWSD6",function(e,t){e.exports=new URL("switch-progress.c17dfd1e.mp3",import.meta.url).toString()}),D("4uL1H",function(e,t){e.exports=new URL("switch-reset.55cbc8a6.mp3",import.meta.url).toString()}),D("bUVGA",function(e,t){e.exports=new URL("switch-success.c04b26a8.mp3",import.meta.url).toString()}),D("kWLlo",function(e,t){e.exports=new URL("too high.9cb62710.mp3",import.meta.url).toString()}),D("4QQlw",function(e,t){e.exports=new URL("too high-2.e4f836e5.mp3",import.meta.url).toString()}),D("kBCif",function(e,t){e.exports=new URL("Hmm.ab4666bb.mp3",import.meta.url).toString()}),D("zYpBE",function(e,t){e.exports=new URL("What.15d09f65.mp3",import.meta.url).toString()}),D("frDLN",function(e,t){e.exports=new URL("hey.53e8bfa8.mp3",import.meta.url).toString()}),D("lbW3C",function(e,t){e.exports=new URL("hey-2.e5982d2d.mp3",import.meta.url).toString()}),D("bqr2F",function(e,t){e.exports=new URL("hey-3.d3e5ca0c.mp3",import.meta.url).toString()}),D("fBfvt",function(e,t){e.exports=new URL("what was that.fdee1630.mp3",import.meta.url).toString()}),D("fSmLO",function(e,t){e.exports=new URL("what was that-2.6dab2b51.mp3",import.meta.url).toString()}),D("4O0Sm",function(e,t){e.exports=new URL("what was that-3.170e08cc.mp3",import.meta.url).toString()}),D("dnpBB",function(e,t){e.exports=new URL("what was that-4.bf6a066e.mp3",import.meta.url).toString()}),D("lTzgV",function(e,t){e.exports=new URL("what was that-5.f5f4c00a.mp3",import.meta.url).toString()}),D("jNZ2c",function(e,t){e.exports=new URL("who goes there.e12006f8.mp3",import.meta.url).toString()}),D("fnPwl",function(e,t){e.exports=new URL("huh.0b84b50b.mp3",import.meta.url).toString()}),D("aUQCu",function(e,t){e.exports=new URL("wha.fed9d6c8.mp3",import.meta.url).toString()}),D("k92wf",function(e,t){e.exports=new URL("wait.2f6fca9e.mp3",import.meta.url).toString()}),D("77Kx3",function(e,t){e.exports=new URL("who there.f09c504d.mp3",import.meta.url).toString()}),D("8xfed",function(e,t){e.exports=new URL("what moved.5eb219b5.mp3",import.meta.url).toString()}),D("hBUAM",function(e,t){e.exports=new URL("what in the shadows.1990efa8.mp3",import.meta.url).toString()}),D("h1CTK",function(e,t){e.exports=new URL("shadow move.f9411514.mp3",import.meta.url).toString()}),D("8Op5H",function(e,t){e.exports=new URL("see something.5b8124e2.mp3",import.meta.url).toString()}),D("lRT2G",function(e,t){e.exports=new URL("hello.941e7f47.mp3",import.meta.url).toString()}),D("4QYOe",function(e,t){e.exports=new URL("ugh.d8bf005c.mp3",import.meta.url).toString()}),D("gN074",function(e,t){e.exports=new URL("ahh.d5b34b8b.mp3",import.meta.url).toString()}),D("dNeGR",function(e,t){e.exports=new URL("aww.afe83640.mp3",import.meta.url).toString()}),D("guTRc",function(e,t){e.exports=new URL("quiet out.dea512a6.mp3",import.meta.url).toString()}),D("dPFoZ",function(e,t){e.exports=new URL("rest me bones.ecd73632.mp3",import.meta.url).toString()}),D("cijMG",function(e,t){e.exports=new URL("jumpy.25423c6b.mp3",import.meta.url).toString()}),D("cisCa",function(e,t){e.exports=new URL("jumpin shadows.2d742d11.mp3",import.meta.url).toString()}),D("b5dIQ",function(e,t){e.exports=new URL("oh well.4c7e171f.mp3",import.meta.url).toString()}),D("d0IQ3",function(e,t){e.exports=new URL("case of the jitters.b71cacca.mp3",import.meta.url).toString()}),D("f9CFT",function(e,t){e.exports=new URL("must be seeing.44dbea47.mp3",import.meta.url).toString()}),D("4FvTv",function(e,t){e.exports=new URL("what in my coffee.dcffdfb6.mp3",import.meta.url).toString()}),D("iCyXz",function(e,t){e.exports=new URL("coffee too strong.620661e7.mp3",import.meta.url).toString()}),D("kGrG2",function(e,t){e.exports=new URL("hmm nothing.5e78dbae.mp3",import.meta.url).toString()}),D("3k4EW",function(e,t){e.exports=new URL("well I though I saw.b1184dc1.mp3",import.meta.url).toString()}),D("gnqdY",function(e,t){e.exports=new URL("nothing.73f51b50.mp3",import.meta.url).toString()}),D("5Ka6N",function(e,t){e.exports=new URL("hopefully nothing.d227b79c.mp3",import.meta.url).toString()}),D("eQtxH",function(e,t){e.exports=new URL("seeing things.bd917144.mp3",import.meta.url).toString()}),D("hk9GW",function(e,t){e.exports=new URL("what-2.66b0ac41.mp3",import.meta.url).toString()}),D("kmwuT",function(e,t){e.exports=new URL("hark.c23476ea.mp3",import.meta.url).toString()}),D("bCMWR",function(e,t){e.exports=new URL("noise.b4e76638.mp3",import.meta.url).toString()}),D("g8Qq3",function(e,t){e.exports=new URL("heard something.e9e5f3ce.mp3",import.meta.url).toString()}),D("g21UK",function(e,t){e.exports=new URL("cant hear now.275b01e7.mp3",import.meta.url).toString()}),D("9Zuei",function(e,t){e.exports=new URL("hearing things.369b6c03.mp3",import.meta.url).toString()}),D("i65tH",function(e,t){e.exports=new URL("noise again.a105d652.mp3",import.meta.url).toString()}),D("5mnQ6",function(e,t){e.exports=new URL("someone there.2eae49ec.mp3",import.meta.url).toString()}),D("83lsd",function(e,t){e.exports=new URL("who could that be.676f39e4.mp3",import.meta.url).toString()}),D("65hOz",function(e,t){e.exports=new URL("better check it out.e6a8e68d.mp3",import.meta.url).toString()}),D("j2wFI",function(e,t){e.exports=new URL("better be rats.ebf6a701.mp3",import.meta.url).toString()}),D("bZZ0a",function(e,t){e.exports=new URL("who that.e84cef75.mp3",import.meta.url).toString()}),D("jB7t1",function(e,t){e.exports=new URL("come out come out.beb4d769.mp3",import.meta.url).toString()}),D("e7nUw",function(e,t){e.exports=new URL("guess nothing.d8004f20.mp3",import.meta.url).toString()}),D("h1yeq",function(e,t){e.exports=new URL("wonder it was.d88b20b1.mp3",import.meta.url).toString()}),D("2mIEi",function(e,t){e.exports=new URL("back to post.16e4300d.mp3",import.meta.url).toString()}),D("lo3Ne",function(e,t){e.exports=new URL("quiet now.51f30083.mp3",import.meta.url).toString()}),D("c2S80",function(e,t){e.exports=new URL("sure I heard something.23701679.mp3",import.meta.url).toString()}),D("gU1Fl",function(e,t){e.exports=new URL("not there anymore.d9adab1a.mp3",import.meta.url).toString()}),D("6LYKz",function(e,t){e.exports=new URL("probably nothing.61c0f4ca.mp3",import.meta.url).toString()}),D("io6aB",function(e,t){e.exports=new URL("i dont know why i work here.e2b01997.mp3",import.meta.url).toString()}),D("b2L3v",function(e,t){e.exports=new URL("waste of my time.231ce329.mp3",import.meta.url).toString()}),D("8ViSP",function(e,t){e.exports=new URL("why do I even try.cf05f7cc.mp3",import.meta.url).toString()}),D("ber20",function(e,t){e.exports=new URL("at least Im not on cleaning duty.16f8237f.mp3",import.meta.url).toString()}),D("9rIu9",function(e,t){e.exports=new URL("at least my shift ends soon.47558b3a.mp3",import.meta.url).toString()}),D("f3tTD",function(e,t){e.exports=new URL("what do you want me to do about it.ed61d1be.mp3",import.meta.url).toString()}),D("hH4nA",function(e,t){e.exports=new URL("coming.2427458c.mp3",import.meta.url).toString()}),D("hl7NG",function(e,t){e.exports=new URL("to arms.6c7d0469.mp3",import.meta.url).toString()}),D("2h0t1",function(e,t){e.exports=new URL("torch-out.83e741ed.mp3",import.meta.url).toString()}),D("lVCJ1",function(e,t){e.exports=new URL("torch-out-2.e9f0c935.mp3",import.meta.url).toString()}),D("28vqu",function(e,t){e.exports=new URL("too-dark.b7a38623.mp3",import.meta.url).toString()}),D("lNOJi",function(e,t){e.exports=new URL("more-light.2dad110c.mp3",import.meta.url).toString()}),D("jmmzf",function(e,t){e.exports=new URL("that-better.c35ca651.mp3",import.meta.url).toString()}),D("lgIKO",function(e,t){e.exports=new URL("there-we-go.de095054.mp3",import.meta.url).toString()}),D("gSOQj",function(e,t){e.exports=new URL("where-was-i.de2c6909.mp3",import.meta.url).toString()}),D("fNEiS",function(e,t){e.exports=new URL("whistle.3a7291de.mp3",import.meta.url).toString()}),D("9rHLm",function(e,t){e.exports=new URL("whistle-2.476ef42b.mp3",import.meta.url).toString()}),D("6P3MQ",function(e,t){e.exports=new URL("whistle-3.6bcc64ea.mp3",import.meta.url).toString()}),D("3YUSH",function(e,t){e.exports=new URL("get em.e4bd8211.mp3",import.meta.url).toString()}),D("cHThu",function(e,t){e.exports=new URL("intruder.b4d4cb7f.mp3",import.meta.url).toString()}),D("iw2jP",function(e,t){e.exports=new URL("oh no its a thief.3ad4ac46.mp3",import.meta.url).toString()}),D("lFnLM",function(e,t){e.exports=new URL("we coming for you.92bed781.mp3",import.meta.url).toString()}),D("dMQmr",function(e,t){e.exports=new URL("coming for you.7bb9dc69.mp3",import.meta.url).toString()}),D("ajR5D",function(e,t){e.exports=new URL("halt.12eee447.mp3",import.meta.url).toString()}),D("coEKG",function(e,t){e.exports=new URL("see you.b9992b60.mp3",import.meta.url).toString()}),D("52627",function(e,t){e.exports=new URL("ill get you.dce0b107.mp3",import.meta.url).toString()}),D("19YnT",function(e,t){e.exports=new URL("a goner.50561a6a.mp3",import.meta.url).toString()}),D("9KeLo",function(e,t){e.exports=new URL("just you wait.d2b91fc0.mp3",import.meta.url).toString()}),D("8wIPR",function(e,t){e.exports=new URL("you wont get away.edf89db5.mp3",import.meta.url).toString()}),D("j75hu",function(e,t){e.exports=new URL("no you dont.4ac92675.mp3",import.meta.url).toString()}),D("9LPPm",function(e,t){e.exports=new URL("thief.2115f040.mp3",import.meta.url).toString()}),D("a1jqg",function(e,t){e.exports=new URL("thief-2.9040a582.mp3",import.meta.url).toString()}),D("diLrr",function(e,t){e.exports=new URL("thief-3.b8074467.mp3",import.meta.url).toString()}),D("9NLiR",function(e,t){e.exports=new URL("after them.b8ebaf41.mp3",import.meta.url).toString()}),D("i5XJD",function(e,t){e.exports=new URL("what is thy business.b27c32fc.mp3",import.meta.url).toString()}),D("fNDiT",function(e,t){e.exports=new URL("no mercy for the wicked.5762a3e4.mp3",import.meta.url).toString()}),D("7Ukh7",function(e,t){e.exports=new URL("must have run.7a11d2a0.mp3",import.meta.url).toString()}),D("etWS2",function(e,t){e.exports=new URL("where they go.39233cb1.mp3",import.meta.url).toString()}),D("gyCwG",function(e,t){e.exports=new URL("his holiness.4d336ce3.mp3",import.meta.url).toString()}),D("aBFy6",function(e,t){e.exports=new URL("the boss.7ca2e821.mp3",import.meta.url).toString()}),D("6haaK",function(e,t){e.exports=new URL("huff puff give up.0fb7d847.mp3",import.meta.url).toString()}),D("c35VN",function(e,t){e.exports=new URL("gone.c866fdd9.mp3",import.meta.url).toString()}),D("54XEQ",function(e,t){e.exports=new URL("come back here.4a9873e3.mp3",import.meta.url).toString()}),D("dElRl",function(e,t){e.exports=new URL("rotten scoundrel.aa0b2e4c.mp3",import.meta.url).toString()}),D("4bS6L",function(e,t){e.exports=new URL("aargh.09fd695b.mp3",import.meta.url).toString()}),D("6I24P",function(e,t){e.exports=new URL("blast.14fafb40.mp3",import.meta.url).toString()}),D("hhVn4",function(e,t){e.exports=new URL("dont come back.5b7087c8.mp3",import.meta.url).toString()}),D("bEJdc",function(e,t){e.exports=new URL("wont get away next time.9f24d709.mp3",import.meta.url).toString()}),D("c79ul",function(e,t){e.exports=new URL("for his holiness.674bd7fc.mp3",import.meta.url).toString()}),D("7qFpu",function(e,t){e.exports=new URL("lousy day at work.853bdb92.mp3",import.meta.url).toString()}),D("jfKOd",function(e,t){e.exports=new URL("i give up.d3f756cb.mp3",import.meta.url).toString()}),D("caLno",function(e,t){e.exports=new URL("what do i do help me.1938fc64.mp3",import.meta.url).toString()}),D("ibQRD",function(e,t){e.exports=new URL("guard rant.a80c9b54.mp3",import.meta.url).toString()}),D("cGDcu",function(e,t){e.exports=new URL("someone-smacked-me.6ebcb14f.mp3",import.meta.url).toString()}),D("8JRX4",function(e,t){e.exports=new URL("someone-hit-me.dd08ad43.mp3",import.meta.url).toString()}),D("bkAuQ",function(e,t){e.exports=new URL("who-hit-me.0d3d57dd.mp3",import.meta.url).toString()}),D("gw3Q6",function(e,t){e.exports=new URL("devils-hit-me.51748981.mp3",import.meta.url).toString()}),D("jlBOP",function(e,t){e.exports=new URL("have-guard-down.f17e438e.mp3",import.meta.url).toString()}),D("cuvD6",function(e,t){e.exports=new URL("man-down.fe834b41.mp3",import.meta.url).toString()}),D("dYqH4",function(e,t){e.exports=new URL("guard-down.6d38e368.mp3",import.meta.url).toString()}),D("8DNLc",function(e,t){e.exports=new URL("must-have-intruder.c875d4eb.mp3",import.meta.url).toString()}),D("2zlmp",function(e,t){e.exports=new URL("eye-out.a5b49afc.mp3",import.meta.url).toString()}),D("jvK1H",function(e,t){e.exports=new URL("take that.89a1c776.mp3",import.meta.url).toString()}),D("e3UnG",function(e,t){e.exports=new URL("oof.0fbc8e69.mp3",import.meta.url).toString()}),D("9fsxd",function(e,t){e.exports=new URL("uh.0f80062b.mp3",import.meta.url).toString()}),D("dGUHy",function(e,t){e.exports=new URL("ah.f85c33dd.mp3",import.meta.url).toString()}),D("jwMGi",function(e,t){e.exports=new URL("ah-2.5f33dd73.mp3",import.meta.url).toString()}),D("2juR4",function(e,t){e.exports=new URL("ha ya.86d45e64.mp3",import.meta.url).toString()}),D("cEISO",function(e,t){e.exports=new URL("ha ya-2.fc4fbee2.mp3",import.meta.url).toString()}),D("jVA57",function(e,t){e.exports=new URL("ha ya-3.78dc4818.mp3",import.meta.url).toString()}),D("1UHnF",function(e,t){e.exports=new URL("dont-stay-lit.b4df064e.mp3",import.meta.url).toString()}),D("4IOJX",function(e,t){e.exports=new URL("paranoid.56c57d56.mp3",import.meta.url).toString()}),D("7iuuC",function(e,t){e.exports=new URL("should-relight.b19d8b19.mp3",import.meta.url).toString()}),D("bBsnb",function(e,t){e.exports=new URL("torch-burned.6ebb1172.mp3",import.meta.url).toString()}),D("7Ju8p",function(e,t){e.exports=new URL("light-burned.284c7997.mp3",import.meta.url).toString()}),D("k5DRH",function(e,t){e.exports=new URL("got-dark.ea449bb4.mp3",import.meta.url).toString()}),D("hmSTR",function(e,t){e.exports=new URL("wish-torch.1425d15f.mp3",import.meta.url).toString()}),D("7uvGK",function(e,t){e.exports=new URL("why-happen.349b666c.mp3",import.meta.url).toString()}),D("eYfdW",function(e,t){e.exports=new URL("someone-stole.9bf9d0a5.mp3",import.meta.url).toString()}),D("bgbnX",function(e,t){e.exports=new URL("its-missing.5d267a16.mp3",import.meta.url).toString()}),D("edLXf",function(e,t){e.exports=new URL("who-took-it.43292bbe.mp3",import.meta.url).toString()}),D("fib9l",function(e,t){e.exports=new URL("boss-wont-like.363ba2ea.mp3",import.meta.url).toString()}),P("27Lyk").register(new URL("",import.meta.url).toString(),JSON.parse('["17fSe","index.6b7d6e8b.js","ilsm8","entitytiles31color.a190660a.png","1e9sp","terraintiles31color.b97f19b8.png","kDrfW","font.f78e2f21.png","8Qic0","Minstrel_Dance.84f0fe17.mp3","aSqJ5","level-requirement-1.1c09d439.mp3","hMICc","level-requirement-2.d04a051d.mp3","cFOzA","lose-game-over.be572349.mp3","iP5rH","Minstrel Dance Easter Egg.9bfc149a.mp3","4cgQm","footstep-wood.61af6a80.mp3","5uP20","footstep-tile.2079c58b.mp3","koWqL","footstep-water.9134aef9.mp3","drQCs","footstep-gravel.9bd43b2f.mp3","aKQuT","footstep-grass.5ff03075.mp3","bv6MN","creak-7.63b3004c.mp3","i01ZK","creak-8.73042d94.mp3","kMLeN","creak-9.d06defda.mp3","7QAkA","creak-10.57762380.mp3","extGj","creak-11.b8ba6527.mp3","fmPyc","creak-12.27451032.mp3","9stv3","hit16.mp3.12db2307.flac","iFwHo","hit17.mp3.f1f9a130.flac","cUkcS","hit18.mp3.9e7af88b.flac","3WoZq","hit19.mp3.d775e463.flac","4CRTl","hit20.mp3.3b3594b6.flac","byhsW","hit26.mp3.ad2a87c8.flac","9W38z","hit27.mp3.68a7736d.flac","57ec6","coin-rattle.01ea1b9b.mp3","4Xt2t","coin.27887bdc.mp3","7CMGD","coin-2.e8e82d5c.mp3","5OaqH","coin-3.004f8541.mp3","eMbVa","coin-4.6a51959e.mp3","3axOF","coin-5.035907c7.mp3","e7FGC","grunt.a8cde342.mp3","ePtUz","grunt-2.30849a22.mp3","54JTP","grunt-3.687bdfee.mp3","f4kGs","grunt-4.4776cbdb.mp3","gIhaU","grunt-5.7ebbc883.mp3","lqqo8","grunt-6.b692d76a.mp3","cLwSE","grunt-7.9923b5b3.mp3","2KH0C","grunt-8.1912db98.mp3","cpKKf","douse.5dfe688a.mp3","5MeQP","douse-2.01d5e3d6.mp3","2JDpK","douse-3.5dfe688a.mp3","2zYEJ","douse-4.b84da553.mp3","2t9RE","chiming-clock-short.556e70d4.mp3","iY5Cd","ticking-clock.35c9d3e3.mp3","3aopE","eating.4854d1c5.mp3","3tTcy","grab-key.fd446a6a.mp3","8L9C2","grab-key-2.1f70d529.mp3","cGSNL","ignite.d3dd60a8.mp3","iv3Fr","ignite-2.9dbae47a.mp3","iTJrg","hide.b8c99711.mp3","6QPv3","hide-2.0fe6cda6.mp3","l0nd4","hide-3.302dff53.mp3","2n0fD","hide-4.a97e1fc7.mp3","fOp9V","hide-5.9bfbd476.mp3","i4uwn","hide-6.1cd4f3d7.mp3","bFVB0","gate.d5f8126d.mp3","auuxb","gate-2.0044fff9.mp3","ejcPD","gate-3.5b7711d0.mp3","dGQlG","gate-4.1e6a5d1b.mp3","c1reW","gate-5.72c10f72.mp3","jbZGh","thump.9f0f330d.mp3","4p6yy","splash1.decbf9bf.mp3","7PaKC","splash2.3233364a.mp3","1HfrD","water-ambient.873a6917.mp3","h9RJn","water-ambient-2.efcabd82.mp3","2s5z3","fire.13ea005c.mp3","je4sD","fire-and-boil.e36f20a5.mp3","91ASO","outdoor-ambient.3d21830e.mp3","4LHFu","outdoor-ambient-2.5fcdc149.mp3","3FIlr","outdoor-ambient-3.53f64ba0.mp3","bM3ty","outdoor-ambient-4.3c078af4.mp3","fa9Lk","guard-door.c3bdfc6d.mp3","7iXif","door-close.96f76874.mp3","iHnDX","door-unlock-and-open.28ff596b.mp3","b2dYG","door-close-and-lock.19ec2936.mp3","59BJY","player-door-open.31e3a014.mp3","gxLBn","player-door-close.0a90723e.mp3","5dgAQ","player-door-unlock-and-open.e081c951.mp3","3OCXI","player-door-close-and-lock.dd49aac6.mp3","k5TMc","water-submerge.b6b726d0.mp3","9w33w","water-exit.d3e2453d.mp3","4kHlF","jump.e55ef093.mp3","UrS1Y","jump-2.6fe19da4.mp3","9uOV6","alarm.befdf3d9.mp3","6HjCO","switch-progress.c17dfd1e.mp3","d5XXc","switch-reset.55cbc8a6.mp3","2lEVY","switch-success.c04b26a8.mp3","la8N0","too high.9cb62710.mp3","7cL8R","too high-2.e4f836e5.mp3","2wBmK","Hmm.ab4666bb.mp3","jALpK","What.15d09f65.mp3","b9dEt","hey.53e8bfa8.mp3","fFe5r","hey-2.e5982d2d.mp3","lbRhG","hey-3.d3e5ca0c.mp3","fpGvS","what was that.fdee1630.mp3","1sKsl","what was that-2.6dab2b51.mp3","gm0uu","what was that-3.170e08cc.mp3","gYm3j","what was that-4.bf6a066e.mp3","binTT","what was that-5.f5f4c00a.mp3","kOvrs","who goes there.e12006f8.mp3","f7gll","huh.0b84b50b.mp3","kxaoK","wha.fed9d6c8.mp3","1IHGt","wait.2f6fca9e.mp3","d1AT3","who there.f09c504d.mp3","iTS30","what moved.5eb219b5.mp3","dgv1C","what in the shadows.1990efa8.mp3","3lODt","shadow move.f9411514.mp3","nwoyO","see something.5b8124e2.mp3","hLJrX","hello.941e7f47.mp3","7NNoN","ugh.d8bf005c.mp3","aGpum","ahh.d5b34b8b.mp3","iOuyX","aww.afe83640.mp3","iYi3V","quiet out.dea512a6.mp3","jjy9s","rest me bones.ecd73632.mp3","7xPeO","jumpy.25423c6b.mp3","1cPlO","jumpin shadows.2d742d11.mp3","8p5cP","oh well.4c7e171f.mp3","8Jj6R","case of the jitters.b71cacca.mp3","5u3ZN","must be seeing.44dbea47.mp3","clDJP","what in my coffee.dcffdfb6.mp3","fnIha","coffee too strong.620661e7.mp3","dxxv5","hmm nothing.5e78dbae.mp3","bGEJc","well I though I saw.b1184dc1.mp3","goGEv","nothing.73f51b50.mp3","5phrJ","hopefully nothing.d227b79c.mp3","hZpxD","seeing things.bd917144.mp3","kSjuO","what-2.66b0ac41.mp3","814wp","hark.c23476ea.mp3","6XNTC","noise.b4e76638.mp3","eSN3y","heard something.e9e5f3ce.mp3","9fotz","cant hear now.275b01e7.mp3","eseEk","hearing things.369b6c03.mp3","fHEVh","noise again.a105d652.mp3","aR76A","someone there.2eae49ec.mp3","6SX6V","who could that be.676f39e4.mp3","6vqpv","better check it out.e6a8e68d.mp3","4GKs5","better be rats.ebf6a701.mp3","kOipz","who that.e84cef75.mp3","f3MqY","come out come out.beb4d769.mp3","8Eo8p","guess nothing.d8004f20.mp3","6Z9FR","wonder it was.d88b20b1.mp3","2BOzR","back to post.16e4300d.mp3","iFNVa","quiet now.51f30083.mp3","bb2lS","sure I heard something.23701679.mp3","bJNpV","not there anymore.d9adab1a.mp3","bTEcp","probably nothing.61c0f4ca.mp3","4m6Oj","i dont know why i work here.e2b01997.mp3","2keaG","waste of my time.231ce329.mp3","coxSt","why do I even try.cf05f7cc.mp3","9mWWx","at least Im not on cleaning duty.16f8237f.mp3","iS60i","at least my shift ends soon.47558b3a.mp3","bFY2K","what do you want me to do about it.ed61d1be.mp3","4VzTB","coming.2427458c.mp3","fH358","to arms.6c7d0469.mp3","becxf","torch-out.83e741ed.mp3","6loVt","torch-out-2.e9f0c935.mp3","15Nl2","too-dark.b7a38623.mp3","4tFQo","more-light.2dad110c.mp3","eX20J","that-better.c35ca651.mp3","hVslI","there-we-go.de095054.mp3","gwtMM","where-was-i.de2c6909.mp3","eVH90","whistle.3a7291de.mp3","j31GE","whistle-2.476ef42b.mp3","g59Cn","whistle-3.6bcc64ea.mp3","3M7dG","get em.e4bd8211.mp3","bodxv","intruder.b4d4cb7f.mp3","aD9LH","oh no its a thief.3ad4ac46.mp3","hiMs1","we coming for you.92bed781.mp3","5N2Ks","coming for you.7bb9dc69.mp3","dxQIJ","halt.12eee447.mp3","35PQn","see you.b9992b60.mp3","boWMm","ill get you.dce0b107.mp3","iI5Sk","a goner.50561a6a.mp3","icWuP","just you wait.d2b91fc0.mp3","8kRcq","you wont get away.edf89db5.mp3","k6kBH","no you dont.4ac92675.mp3","64BGF","thief.2115f040.mp3","gdcwz","thief-2.9040a582.mp3","4q8Ah","thief-3.b8074467.mp3","9onoo","after them.b8ebaf41.mp3","93Pnl","what is thy business.b27c32fc.mp3","jpS1l","no mercy for the wicked.5762a3e4.mp3","lqfpT","must have run.7a11d2a0.mp3","94dJT","where they go.39233cb1.mp3","igW24","his holiness.4d336ce3.mp3","lqEqF","the boss.7ca2e821.mp3","8RJZ0","huff puff give up.0fb7d847.mp3","9wrD0","gone.c866fdd9.mp3","lSD3i","come back here.4a9873e3.mp3","2z5r6","rotten scoundrel.aa0b2e4c.mp3","6WfXi","aargh.09fd695b.mp3","9T16N","blast.14fafb40.mp3","k7LDh","dont come back.5b7087c8.mp3","gLbJJ","wont get away next time.9f24d709.mp3","4qtqX","for his holiness.674bd7fc.mp3","z6pdh","lousy day at work.853bdb92.mp3","boWBX","i give up.d3f756cb.mp3","jChss","what do i do help me.1938fc64.mp3","idVW7","guard rant.a80c9b54.mp3","10oTp","someone-smacked-me.6ebcb14f.mp3","9N3Jq","someone-hit-me.dd08ad43.mp3","j8EMJ","who-hit-me.0d3d57dd.mp3","fQh6R","devils-hit-me.51748981.mp3","25foy","have-guard-down.f17e438e.mp3","7gDyW","man-down.fe834b41.mp3","6OquI","guard-down.6d38e368.mp3","itpEm","must-have-intruder.c875d4eb.mp3","agqIY","eye-out.a5b49afc.mp3","jhJBF","take that.89a1c776.mp3","1RMnM","oof.0fbc8e69.mp3","aawqd","uh.0f80062b.mp3","7Azq2","ah.f85c33dd.mp3","bO5O6","ah-2.5f33dd73.mp3","cMgfB","ha ya.86d45e64.mp3","i0tVX","ha ya-2.fc4fbee2.mp3","haQJd","ha ya-3.78dc4818.mp3","dykwD","dont-stay-lit.b4df064e.mp3","5ub3k","paranoid.56c57d56.mp3","73yPj","should-relight.b19d8b19.mp3","dZmc2","torch-burned.6ebb1172.mp3","cnQQj","light-burned.284c7997.mp3","1osIE","got-dark.ea449bb4.mp3","fSADa","wish-torch.1425d15f.mp3","3CnbG","why-happen.349b666c.mp3","6XV2Z","someone-stole.9bf9d0a5.mp3","3a0i6","its-missing.5d267a16.mp3","k0M7k","who-took-it.43292bbe.mp3","euI2B","boss-wont-like.363ba2ea.mp3"]'));class W extends Array{constructor(...e){super(...e)}static fromValues(e,t){return new W(e,t)}static create(){return new W(0,0)}static clone(e){return new W(e[0],e[1])}equals(e){return this[0]===e[0]&&this[1]===e[1]}equalsValues(e,t){return this[0]===e&&this[1]===t}copy(e){this[0]=e[0],this[1]=e[1]}set(e,t){this[0]=e,this[1]=t}add(e){return W.fromValues(this[0]+e[0],this[1]+e[1])}subtract(e){return W.fromValues(this[0]-e[0],this[1]-e[1])}multiply(e){return W.fromValues(this[0]*e[0],this[1]*e[1])}scale(e){return W.fromValues(this[0]*e,this[1]*e)}scaleAndAdd(e,t){return W.fromValues(this[0]+e[0]*t,this[1]+e[1]*t)}distance(e){return Math.hypot(this[0]-e[0],this[1]-e[1])}squaredDistance(e){let t=this[0]-e[0],o=this[1]-e[1];return t*t+o*o}len(){return Math.hypot(this[0],this[1])}squaredLen(e){let t=this[0],o=this[1];return t*t+o*o}negate(){return W.fromValues(-this[0],-this[1])}dot(e){return this[0]*e[0]+this[1]*e[1]}lerp(e,t){return W.fromValues(this[0]+t*(e[0]-this[0]),this[1]+t*(e[1]-this[1]))}zero(){this[0]=0,this[1]=0}static copy(e,t){e[0]=t[0],e[1]=t[1]}static set(e,t,o){e[0]=t,e[1]=o}static add(e,t,o){e[0]=t[0]+o[0],e[1]=t[1]+o[1]}static subtract(e,t,o){e[0]=t[0]-o[0],e[1]=t[1]-o[1]}static multiply(e,t,o){e[0]=t[0]*o[0],e[1]=t[1]*o[1]}static scale(e,t,o){e[0]=t[0]*o,e[1]=t[1]*o}static scaleAndAdd(e,t,o,r){e[0]=t[0]+o[0]*r,e[1]=t[1]+o[1]*r}static distance(e,t){return Math.hypot(e[0]-t[0],e[1]-t[1])}static squaredDistance(e,t){let o=e[0]-t[0],r=e[1]-t[1];return o*o+r*r}static len(e){return Math.hypot(e[0],e[1])}static squaredLen(e){let t=e[0],o=e[1];return t*t+o*o}static negate(e,t){e[0]=-t[0],e[1]=-t[1]}static dot(e,t){return e[0]*t[0]+e[1]*t[1]}static lerp(e,t,o,r){e[0]=t[0]+r*(o[0]-t[0]),e[1]=t[1]+r*(o[1]-t[1])}static zero(e){e[0]=0,e[1]=0}}(t=L||(L={})).create=function(){return[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},t.copy=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]},t.ortho=function(e,t,o,r,a,n,i){let s=1/(t-o),l=1/(r-a),f=1/(n-i);e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+o)*s,e[13]=(a+r)*l,e[14]=(i+n)*f,e[15]=1};var G=((o=G||{})[o.Damage=0]="Damage",o[o.GuardChase=1]="GuardChase",o[o.GuardInvestigate=2]="GuardInvestigate",o[o.GuardSeeThief=3]="GuardSeeThief",o[o.GuardHearThief=4]="GuardHearThief",o[o.GuardDownWarning=5]="GuardDownWarning",o[o.GuardAwakesWarning=6]="GuardAwakesWarning",o[o.GuardExamineStolenTreasure=7]="GuardExamineStolenTreasure",o[o.GuardWarningResponse=8]="GuardWarningResponse",o[o.GuardHearGuard=9]="GuardHearGuard",o[o.GuardSpotDownedGuard=10]="GuardSpotDownedGuard",o[o.GuardSeeTorchLit=11]="GuardSeeTorchLit",o[o.GuardSeeUnlitTorch=12]="GuardSeeUnlitTorch",o[o.GuardEndChase=13]="GuardEndChase",o[o.GuardFinishInvestigating=14]="GuardFinishInvestigating",o[o.GuardFinishLooking=15]="GuardFinishLooking",o[o.GuardFinishListening=16]="GuardFinishListening",o[o.GuardFinishLightingTorch=17]="GuardFinishLightingTorch",o[o.GuardFinishLookingAtLitTorch=18]="GuardFinishLookingAtLitTorch",o[o.GuardStirring=19]="GuardStirring",o[o.GuardSpotStolenTreasure=20]="GuardSpotStolenTreasure",o[o.GuardSeeTorchDoused=21]="GuardSeeTorchDoused",o);class V{constructor(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationMaxTurns=0,this.notificationWorldPos=W.create(),this.notificationTimeRemaining=0}setSpeech(e,t,o){this.currentSpeech=e,this.currentSpeaker=t,this.currentSpeechAbove=o,this.currentSpeechTimeRemaining=2}setNotification(e,t,o=1,r=2){this.notification=e,this.notificationWorldPos=t instanceof ep?t:W.clone(t),this.notificationTimeRemaining=r,this.notificationMaxTurns=o}setNotificationHold(e,t){this.notification=e,this.notificationWorldPos=t instanceof ep?t:W.clone(t),this.notificationTimeRemaining=1/0,this.notificationMaxTurns=1}updateNotification(){--this.notificationMaxTurns,this.notificationMaxTurns<=0&&(this.notificationTimeRemaining=0,this.notificationMaxTurns=0)}isSpeechBubbleVisible(){return this.currentSpeechTimeRemaining>0}isNotificationVisible(){return this.notificationTimeRemaining>0}animate(e){this.currentSpeechTimeRemaining=Math.max(0,this.currentSpeechTimeRemaining-e),this.notificationTimeRemaining=Math.max(0,this.notificationTimeRemaining-e)}toggleShow(e){this.notificationTimeRemaining=2*!(this.notificationTimeRemaining>0),this.currentSpeechTimeRemaining>0?this.currentSpeechTimeRemaining=0:void 0!==this.currentSpeaker&&""!==this.currentSpeech&&(this.currentSpeechTimeRemaining=2,this.currentSpeechAbove=this.currentSpeaker.pos[1]>=e[1])}reset(){this.currentSpeech="",this.currentSpeaker=void 0,this.currentSpeechAbove=!1,this.currentSpeechTimeRemaining=0,this.notification="",this.notificationWorldPos=new W(0,0),this.notificationTimeRemaining=0,this.notificationMaxTurns=0}}var U={},B={linear:function(e,t,o,r){return(o-t)*e/r+t},easeInQuad:function(e,t,o,r){return(o-t)*(e/=r)*e+t},easeOutQuad:function(e,t,o,r){return-(o-t)*(e/=r)*(e-2)+t},easeInOutQuad:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e+t:-a/2*(--e*(e-2)-1)+t},easeInCubic:function(e,t,o,r){return(o-t)*(e/=r)*e*e+t},easeOutCubic:function(e,t,o,r){return(o-t)*((e=e/r-1)*e*e+1)+t},easeInOutCubic:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e+t:a/2*((e-=2)*e*e+2)+t},easeInQuart:function(e,t,o,r){return(o-t)*(e/=r)*e*e*e+t},easeOutQuart:function(e,t,o,r){return-(o-t)*((e=e/r-1)*e*e*e-1)+t},easeInOutQuart:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e*e+t:-a/2*((e-=2)*e*e*e-2)+t},easeInQuint:function(e,t,o,r){return(o-t)*(e/=r)*e*e*e*e+t},easeOutQuint:function(e,t,o,r){return(o-t)*((e=e/r-1)*e*e*e*e+1)+t},easeInOutQuint:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?a/2*e*e*e*e*e+t:a/2*((e-=2)*e*e*e*e+2)+t},easeInSine:function(e,t,o,r){var a=o-t;return-a*Math.cos(e/r*(Math.PI/2))+a+t},easeOutSine:function(e,t,o,r){return(o-t)*Math.sin(e/r*(Math.PI/2))+t},easeInOutSine:function(e,t,o,r){return-(o-t)/2*(Math.cos(Math.PI*e/r)-1)+t},easeInExpo:function(e,t,o,r){return 0==e?t:(o-t)*Math.pow(2,10*(e/r-1))+t},easeOutExpo:function(e,t,o,r){var a=o-t;return e==r?t+a:a*(-Math.pow(2,-10*e/r)+1)+t},easeInOutExpo:function(e,t,o,r){var a=o-t;return 0===e?t:e===r?t+a:(e/=r/2)<1?a/2*Math.pow(2,10*(e-1))+t:a/2*(-Math.pow(2,-10*--e)+2)+t},easeInCirc:function(e,t,o,r){return-(o-t)*(Math.sqrt(1-(e/=r)*e)-1)+t},easeOutCirc:function(e,t,o,r){return(o-t)*Math.sqrt(1-(e=e/r-1)*e)+t},easeInOutCirc:function(e,t,o,r){var a=o-t;return(e/=r/2)<1?-a/2*(Math.sqrt(1-e*e)-1)+t:a/2*(Math.sqrt(1-(e-=2)*e)+1)+t},easeInElastic:function(e,t,o,r){var a,n,i,s=o-t;return(i=1.70158,n=0,a=s,0===e)?t:1==(e/=r)?t+s:(n||(n=.3*r),a<Math.abs(s)?(a=s,i=n/4):i=n/(2*Math.PI)*Math.asin(s/a),-(a*Math.pow(2,10*(e-=1))*Math.sin(2*Math.PI*(e*r-i)/n))+t)},easeOutElastic:function(e,t,o,r){var a,n,i,s=o-t;return(i=1.70158,n=0,a=s,0===e)?t:1==(e/=r)?t+s:(n||(n=.3*r),a<Math.abs(s)?(a=s,i=n/4):i=n/(2*Math.PI)*Math.asin(s/a),a*Math.pow(2,-10*e)*Math.sin(2*Math.PI*(e*r-i)/n)+s+t)},easeInOutElastic:function(e,t,o,r){var a,n,i,s=o-t;return(i=1.70158,n=0,a=s,0===e)?t:2==(e/=r/2)?t+s:(n||(n=.3*1.5*r),a<Math.abs(s)?(a=s,i=n/4):i=n/(2*Math.PI)*Math.asin(s/a),e<1)?-.5*(a*Math.pow(2,10*(e-=1))*Math.sin(2*Math.PI*(e*r-i)/n))+t:a*Math.pow(2,-10*(e-=1))*Math.sin(2*Math.PI*(e*r-i)/n)*.5+s+t},easeInBack:function(e,t,o,r,a){return void 0===a&&(a=1.70158),(o-t)*(e/=r)*e*((a+1)*e-a)+t},easeOutBack:function(e,t,o,r,a){return void 0===a&&(a=1.70158),(o-t)*((e=e/r-1)*e*((a+1)*e+a)+1)+t},easeInOutBack:function(e,t,o,r,a){var n=o-t;return(void 0===a&&(a=1.70158),(e/=r/2)<1)?n/2*(e*e*(((a*=1.525)+1)*e-a))+t:n/2*((e-=2)*e*(((a*=1.525)+1)*e+a)+2)+t},easeInBounce:function(e,t,o,r){var a,n=o-t;return a=B.easeOutBounce(r-e,0,n,r),n-a+t},easeOutBounce:function(e,t,o,r){var a=o-t;return(e/=r)<1/2.75?7.5625*e*e*a+t:e<2/2.75?a*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?a*(7.5625*(e-=2.25/2.75)*e+.9375)+t:a*(7.5625*(e-=2.625/2.75)*e+.984375)+t},easeInOutBounce:function(e,t,o,r){var a=o-t;return e<r/2?.5*B.easeInBounce(2*e,0,a,r)+t:.5*B.easeOutBounce(2*e-r,0,a,r)+.5*a+t}};U=B;class N{update(e){return!1}currentTile(){return{}}}class O extends N{constructor(e,t,o=0,r=-1){super(),this.time=0,this.tileInfo=e,this.activeFrame=o,this.frameDuration=t,this.removeOnFinish=!1,this.loops=r}update(e){this.time+=e;let t=this.frameDuration instanceof Array?this.frameDuration[this.activeFrame]:this.frameDuration;return this.time>t&&(this.activeFrame++,this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0,this.loops>0&&this.loops--),this.time=0),0===this.loops}currentTile(){return this.tileInfo[this.activeFrame]}}class z extends N{constructor(e,t){super(),this.time=0,this.offset=W.clone(e[0].pt0),this.tileInfo=t,this.activeFrame=0,this.frameStep=1,this.activePt=0,this.tweenSeq=e,this.removeOnFinish=!1}update(e){let t=this.tweenSeq[this.activePt].pt0,o=this.tweenSeq[this.activePt].pt1,r=this.tweenSeq[this.activePt].duration,a=this.tweenSeq[this.activePt].fn;return void 0===t||void 0==o||(this.time=Math.min(this.time+e,r),this.time>=0&&(this.offset[0]=a(this.time,t[0],o[0],r),this.offset[1]=a(this.time,t[1],o[1],r)),this.time==r&&(this.activePt++,this.time=0,this.activeFrame++),this.activeFrame>=this.tileInfo.length&&(this.activeFrame=0),this.activePt===this.tweenSeq.length)}currentTile(){return this.tileInfo[this.activeFrame]}}class q extends N{constructor(e,t,o){super(),this.offset=new W,this.duration=0,this.period=1,this.time=0,this.tile=e,this.duration=t,this.period=o}update(e){return this.duration>0?this.time=Math.min(this.time+e,this.duration):this.time+=e,this.duration>0&&this.time===this.duration}get intensity(){return Math.sin(this.time/this.period)}agbr_color_to_tuple(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]}abgr_tuple_to_color(e,t,o,r){return(Math.floor(e%256)<<24|Math.floor(t%256)<<16|Math.floor(o%256)<<8|Math.floor(r%256))>>>0}blend(e,t,o){let r=this.agbr_color_to_tuple(e),a=this.agbr_color_to_tuple(t),n=r.map((e,t)=>e*o+a[t]*(1-o));return this.abgr_tuple_to_color(n[0],n[1],n[2],n[3])}currentTile(){let e=this.intensity;return{textureIndex:this.tile.textureIndex,color:void 0!==this.tile.color&&void 0!==this.tile.unlitColor?this.blend(this.tile.color,this.tile.unlitColor,(1+e)/2):0xffffffff}}}class Y extends N{constructor(e,t,o,r,a,n=new W(0,0),i=0,s=0){super(),this.time=0,this.tileInfo=e,this.offset=new W,this.centerPos=n,this.radius=t,this.speed=o,this.startingPos=r,this.duration=a,this.posRadians=r,this.removeOnFinish=!1}update(e){return this.duration>0?this.time=Math.min(this.time+e,this.duration):this.time+=e,this.posRadians+=this.speed*e,this.offset[0]=this.centerPos[0]+Math.cos(this.posRadians)*this.radius,this.offset[1]=this.centerPos[1]+Math.sin(this.posRadians)*this.radius,this.time===this.duration}currentTile(){return this.tileInfo}}var X=((r=X||{})[r.idle=0]="idle",r[r.dimmed=1]="dimmed",r[r.off=2]="off",r);class j extends N{constructor(e,t,o,r,a,n,i){super(),this.activeFrame=0,this.time=0,this.dimDuration=300,this.idleTiles=a,this.dimTile=n,this.offTile=i,this.lightId=t,this.lightVector=o,this.state=e,this.item=r}update(e){if(null!==this.item&&(this.item.type===ec.TorchUnlit&&(this.state=2),this.item.type!==ec.TorchUnlit&&2===this.state&&(this.state=0,this.lightVector[this.lightId]=0)),this.time+=e,2==this.state)return!1;let t=this.lightVector[this.lightId];if(0==t&&Math.random()>.995**(60*e)?(this.state=1,t=1.5):t>0&&(t=Math.max(t-3*e,0)),0==t){this.state=0;let e=this.idleTiles[this.activeFrame][1];this.time>=e&&(this.time=0,this.activeFrame++,this.activeFrame>=this.idleTiles.length&&(this.activeFrame=0))}return this.lightVector[this.lightId]=t,!1}currentTile(){return 0==this.state?this.idleTiles[this.activeFrame][0]:1==this.state?this.dimTile:this.offTile}}var K=((a=K||{})[a.Patrol=0]="Patrol",a[a.Look=1]="Look",a[a.LookAtTorch=2]="LookAtTorch",a[a.Listen=3]="Listen",a[a.ChaseVisibleTarget=4]="ChaseVisibleTarget",a[a.MoveToLastSighting=5]="MoveToLastSighting",a[a.InvestigateLastSighting=6]="InvestigateLastSighting",a[a.MoveToLastSound=7]="MoveToLastSound",a[a.MoveToGuardShout=8]="MoveToGuardShout",a[a.MoveToDownedGuard=9]="MoveToDownedGuard",a[a.MoveToMissingTreasure=10]="MoveToMissingTreasure",a[a.LookAtMissingTreasure=11]="LookAtMissingTreasure",a[a.WakeGuard=12]="WakeGuard",a[a.MoveToTorch=13]="MoveToTorch",a[a.LightTorch=14]="LightTorch",a[a.Unconscious=15]="Unconscious",a);class ${constructor(e,t){this.dir=W.fromValues(1,0),this.mode=0,this.modePrev=0,this.angry=!1,this.hasTorch=!1,this.hasPurse=!1,this.hasVaultKey=!1,this.torchAnimation=null,this.speaking=!1,this.hasMoved=!1,this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1,this.hearingGuard=!1,this.heardGuard=!1,this.animation=null,this.goals=[],this.modeTimeout=0;let o=e[t];this.pos=W.clone(o),this.heardGuardPos=W.create(),this.goal=W.clone(o),this.patrolPath=e,this.patrolPathIndex=t,this.updateDirInitial()}overheadIcon(){return 15===this.mode?eu.Unconscious:4===this.mode?eu.Chasing:Q(this.mode)?this.angry?eu.Angry:eu.Relaxed:eu.Alerted}posAnimated(){let e=this.animation?.offset??W.create(),t=W.create();return W.add(t,this.pos,e),t}allowsMoveOntoFrom(e){if(this.goals.length<=0)return!0;let t=this.goals[0];if(t.equals(this.pos)||t.equals(e))return!1;let o=Math.floor((this.pos[0]+e[0])/2),r=Math.floor((this.pos[1]+e[1])/2);return t[0]!==o||t[1]!==r}moving(){if(this.goals.length<=0)return!1;let e=this.goals[0];return!this.pos.equals(e)}chooseMoves(e){switch(this.mode){case 0:this.goals=this.choosePatrolStep(e);break;case 1:case 2:case 3:case 15:this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap);break;case 4:case 5:case 6:case 8:case 7:this.goals=this.chooseMoveTowardPosition(this.goal,e.gameMap);break;case 9:case 10:case 11:case 12:case 13:case 14:this.goals=this.chooseMoveTowardAdjacentToPosition(this.goal,e.gameMap)}}bestAvailableMove(e,t,o){let r=!1;for(let a of e)if(t.guardMoveCost(this.pos,a)!=1/0){if(o.pos.equals(a)){r=!0;continue}if(!t.isGuardAtVec(a))return[a,r]}return[this.pos,r]}act(e,t){let o=W.clone(this.pos),r=e.gameMap,a=e.player,n=e.levelStats;if(15!==this.mode&&!Q(this.mode)){let e=+!!this.moving();this.seesActor(r,a,e)&&(this.mode=4)}switch(this.heardThief&&15!==this.mode&&4!==this.mode&&(Q(this.mode)&&!this.heardThiefClosest?(this.mode=3,this.modeTimeout=2+e.rng.randomInRange(4),this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap)):9!==this.mode&&(W.copy(this.goal,a.pos),Q(this.mode)?this.goals=this.chooseMoveTowardPosition(this.pos,e.gameMap):this.goals=this.chooseMoveTowardPosition(this.goal,e.gameMap),this.mode=this.heardAlarm?10:7,this.modeTimeout=4+e.rng.randomInRange(2))),this.mode){case 0:if(this.makeBestAvailableMove(r,a),this.pos.equals(this.patrolPath[this.patrolPathIndex])){if(this.pos.equals(o)){let e=this.patrolPath[Math.max(0,this.patrolPathIndex+this.patrolPath.length-2)%this.patrolPath.length];if(o.equals(e)){let e=1===this.patrolPath.length,t=r.tryGetPosLookAt(this.pos,e);void 0!==t&&Z(this.dir,this.pos,t)}}}else this.enterPatrolMode(r);break;case 1:case 3:this.makeBestAvailableMove(r,a),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 2:this.makeBestAvailableMove(r,a),Z(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 4:if(W.copy(this.goal,a.pos),this.adjacentTo(a.pos)&&!this.pos.equals(a.pos)){if(Z(this.dir,this.pos,this.goal),4===this.modePrev){a.damagedLastTurn||t.push({speaker:this,speechType:G.Damage});let o=W.create(),r=W.create();W.subtract(r,a.pos,this.pos),W.scale(r,r,.5),this.animation=new z([{pt0:o,pt1:r,duration:.1,fn:U.easeInQuad},{pt0:r,pt1:o,duration:.1,fn:U.easeOutQuad}],[]),a.applyDamage(1),aW(e,a.health),aD(e),av(e,a.pos[0]-this.pos[0],a.pos[1]-this.pos[1]),++n.damageTaken}}else this.goals=this.chooseMoveTowardPosition(this.goal,r),this.makeBestAvailableMove(r,a);break;case 5:this.makeBestAvailableMove(r,a),this.pos.equals(this.goal)?(this.mode=6,this.modeTimeout=5):this.pos.equals(o)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 6:this.makeBestAvailableMove(r,a),this.modeTimeout>=3&&this.pos.equals(this.goal)&&this.tryStepGoalForward(e),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 7:case 8:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&(this.modeTimeout-=1),this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 9:this.makeBestAvailableMove(r,a),this.cardinallyAdjacentTo(this.goal)?r.guards.find(e=>e.pos.equals(this.goal)&&15===e.mode)?(this.mode=12,this.modeTimeout=3):(this.modeTimeout=0,this.enterPatrolMode(r)):this.pos.equals(o)&&(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r));break;case 10:this.makeBestAvailableMove(r,a),this.cardinallyAdjacentTo(this.goal)?(this.mode=11,this.modeTimeout=4):this.pos.equals(o)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 11:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&this.cardinallyAdjacentTo(this.goal)&&Z(this.dir,this.pos,this.goal),this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r);break;case 12:this.makeBestAvailableMove(r,a),this.pos.equals(o)&&Z(this.dir,this.pos,this.goal),--this.modeTimeout;let i=r.guards.find(e=>e.pos.equals(this.goal)&&15===e.mode);void 0!==i?this.modeTimeout<=0&&(i.modeTimeout=0,this.enterPatrolMode(r)):(this.modeTimeout=0,this.enterPatrolMode(r));break;case 13:this.makeBestAvailableMove(r,a),r.items.some(e=>e.pos.equals(this.goal)&&e.type===ec.TorchLit)?this.enterPatrolMode(r):this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):this.pos.equals(o)?(this.modeTimeout-=1,this.modeTimeout<=0&&this.enterPatrolMode(r)):this.modeTimeout=3;break;case 14:if(this.makeBestAvailableMove(r,a),--this.modeTimeout,Z(this.dir,this.pos,this.goal),this.modeTimeout<=0){!function(e,t){for(let o of e.items)o.type===ec.TorchUnlit&&o.pos.equals(t)&&(o.type=ec.TorchLit)}(r,this.goal);let e=ee(r,this.pos);void 0===e?this.enterPatrolMode(r):(W.copy(this.goal,e.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}break;case 15:this.modeTimeout<=0&&(this.modeTimeout=0,this.angry=!0,this.enterPatrolMode(r))}}postActSense(e,t,o,r,a,n){if(15!==this.mode){if(this.seesActor(e,t)?Q(this.mode)&&!this.adjacentTo(t.pos)?(this.mode=1,this.modeTimeout=2+n.randomInRange(4)):this.mode=4:4===this.mode&&4===this.modePrev&&(this.mode=5,this.modeTimeout=3),this.heardGuard&&1!==this.mode&&4!==this.mode&&5!==this.mode&&6!==this.mode&&7!==this.mode&&9!==this.mode&&12!==this.mode&&(this.mode=8,this.modeTimeout=2+n.randomInRange(4),W.copy(this.goal,this.heardGuardPos)),4!==this.mode&&9!==this.mode&&12!==this.mode){for(let t of e.guards)if(t!==this&&15===t.mode&&this.seesActor(e,t)){W.copy(this.goal,t.pos),this.mode=9,this.angry=!0,this.modeTimeout=3;break}}if(!this.angry&&Q(this.mode)){let t=e.treasures.find(t=>t.stolen&&this.seesPosition(e,t.posTreasure));void 0!==t&&(this.mode=10,W.copy(this.goal,t.posTreasure),this.angry=!0,this.modeTimeout=3)}if(this.hasTorch&&0===this.mode){let t=ee(e,this.pos);void 0!==t&&(W.copy(this.goal,t.pos),this.cardinallyAdjacentTo(this.goal)?(this.mode=14,this.modeTimeout=5):(this.mode=13,this.modeTimeout=3))}!this.hasTorch&&Q(this.mode)&&null!==t.itemUsed&&64>=W.squaredDistance(this.pos,t.itemUsed.pos)&&eo(e,this.pos,t.itemUsed.pos)&&(t.itemUsed.type===ec.TorchLit?(W.copy(this.goal,t.itemUsed.pos),this.mode=2,this.modeTimeout=2+n.randomInRange(4)):t.itemUsed.type===ec.TorchUnlit&&r.push({speaker:this,speechType:G.GuardSeeTorchDoused})),8===this.mode&&et(e,this.pos,this.goal)&&e.guards.some(e=>e.pos.equals(this.goal))&&W.copy(this.goal,this.pos)}this.heardThief=!1,this.heardThiefClosest=!1,this.heardAlarm=!1;let i=function(e,t,o){if(t==e)return;let r=o<=64;switch(t){case 0:switch(e){case 1:return G.GuardFinishLooking;case 2:return G.GuardFinishLookingAtLitTorch;case 3:return G.GuardFinishListening;case 7:return G.GuardFinishInvestigating;case 8:case 5:case 6:return G.GuardEndChase;case 14:return r?G.GuardFinishLightingTorch:void 0;case 15:return G.GuardAwakesWarning;default:return}case 1:return G.GuardSeeThief;case 2:return G.GuardSeeTorchLit;case 3:return G.GuardHearThief;case 4:if(5!=e&&6!==e)return G.GuardChase;break;case 14:if(0===e&&r)return G.GuardSeeUnlitTorch;break;case 5:case 6:break;case 7:return G.GuardInvestigate;case 8:return G.GuardHearGuard;case 13:if(14!==e&&r)return G.GuardSeeUnlitTorch;break;case 9:return G.GuardSpotDownedGuard;case 12:return G.GuardDownWarning;case 10:return G.GuardSpotStolenTreasure;case 11:return G.GuardExamineStolenTreasure}}(this.modePrev,this.mode,W.squaredDistance(this.pos,t.pos));if(void 0!==i&&r.push({speaker:this,speechType:i}),this.mode!==this.modePrev)switch(this.mode){case 4:a.push({posShouter:W.clone(this.pos),posGoal:W.clone(t.pos),angry:!1}),++o.numSpottings;break;case 12:case 11:a.push({posShouter:W.clone(this.pos),posGoal:W.clone(this.goal),angry:!0})}}tryStepGoalForward(e){let t=W.create();if(W.add(t,this.pos,this.dir),0===e.gameMap.guardMoveCost(this.pos,t)){W.copy(this.goal,t);return}let o=[W.fromValues(this.pos[0]-this.dir[1],this.pos[1]+this.dir[0]),W.fromValues(this.pos[0]+this.dir[1],this.pos[1]-this.dir[0])];if((o=o.filter(t=>0===e.gameMap.guardMoveCost(this.pos,t))).length>0){let t=e.rng.randomInRange(o.length);W.copy(this.goal,o[t])}}cardinallyAdjacentTo(e){let t=Math.abs(e[0]-this.pos[0]),o=Math.abs(e[1]-this.pos[1]);return 1==t&&0==o||0==t&&1==o}adjacentTo(e){let t=e[0]-this.pos[0],o=e[1]-this.pos[1];return 2>Math.abs(t)&&2>Math.abs(o)}seesActor(e,t,o=0){return this.seesPositionInternal(e,t.pos,t.hidden(e),et,o)}seesPosition(e,t){return this.seesPositionInternal(e,t,!1,eo,0)}seesPositionInternal(e,t,o,r,a){let n=W.create();if(W.subtract(n,t,this.pos),4!==this.mode&&W.dot(this.dir,n)<a)return!1;let i=e.cells.atVec(t).lit>0;if(W.squaredLen(n)>=this.sightCutoff(i)&&!(n[0]===2*this.dir[0]&&n[1]===2*this.dir[1]))return!1;if(Q(this.mode)&&!this.angry||Math.abs(n[0])>=2||Math.abs(n[1])>=2){if(o||!r(e,this.pos,t))return!1}else if(this.pos[0]!==t[0]&&this.pos[1]!==t[1]&&(e.cells.at(this.pos[0],t[1]).blocksSight||e.cells.at(t[0],this.pos[1]).blocksSight))return!1;return!0}hidden(e){return!!e.cells.atVec(this.pos).hidesPlayer}sightCutoff(e){return 4===this.mode?e?75:33:!Q(this.mode)||this.angry?e?75:15:e?40:3}enterPatrolMode(e){this.patrolPathIndex=e.patrolPathIndexForResume(this.patrolPath,this.patrolPathIndex,this.pos),this.mode=0}choosePatrolStep(e){return this.pos.equals(this.patrolPath[this.patrolPathIndex])&&(this.patrolPathIndex=(this.patrolPathIndex+1)%this.patrolPath.length),this.chooseMoveTowardPosition(this.patrolPath[this.patrolPathIndex],e.gameMap)}makeBestAvailableMove(e,t){let[o,r]=this.bestAvailableMove(this.goals,e,t);if(!o.equals(this.pos)){Z(this.dir,this.pos,o);let e=W.create();W.subtract(e,this.pos,o);let t=W.create();this.animation=new z([{pt0:e,pt1:t,duration:.2,fn:U.linear}],[]),W.copy(this.pos,o)}r&&(this.mode=4,Z(this.dir,this.pos,t.pos))}updateDirInitial(){let e=(this.patrolPathIndex+1)%this.patrolPath.length;Z(this.dir,this.pos,this.patrolPath[e])}chooseMoveTowardPosition(e,t){let o={posMin:W.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:W.fromValues(Math.min(t.cells.sizeX,this.pos[0]+2),Math.min(t.cells.sizeY,this.pos[1]+2))},r=t.computeDistancesToPosition(e,o);return t.nextPositions(r,this.pos)}chooseMoveTowardAdjacentToPosition(e,t){let o={posMin:W.fromValues(Math.max(0,this.pos[0]-1),Math.max(0,this.pos[1]-1)),posMax:W.fromValues(Math.min(t.cells.sizeX,this.pos[0]+2),Math.min(t.cells.sizeY,this.pos[1]+2))},r=t.computeDistancesToAdjacentToPosition(e,o);return t.nextPositions(r,this.pos)}}function Q(e){return 0===e||13===e||14===e}function J(e){for(let t of e.gameMap.guards)t.chooseMoves(e)}function Z(e,t,o){let r=W.create();W.subtract(r,o,t);let a=W.fromValues(-e[1],e[0]),n=W.dot(e,r),i=W.dot(a,r);n>=Math.abs(i)||(-n>Math.abs(i)?W.negate(e,e):i>=0?W.copy(e,a):W.negate(e,a))}function ee(e,t){let o;let r=65;for(let a of e.items)if(a.type===ec.TorchUnlit){let n=W.squaredDistance(a.pos,t);if(n>=r||!eo(e,t,a.pos))continue;r=n,o=a}return o}function et(e,t,o){let r=t[0],a=t[1],n=o[0]-r,i=o[1]-a,s=Math.abs(n),l=Math.abs(i),f=n>0?1:-1,u=i>0?1:-1,c=l-s,d=s+l-1,p=d;for(s*=2,l*=2;p>0;){if(c>0)a+=u,c-=s;else{if(0===c){let t=e.cells.at(r,a+u);if(t.blocksSight||t.isWindow&&p>1&&p<d-1)return!1}r+=f,c+=l}let t=e.cells.at(r,a);if(t.blocksSight||t.isWindow&&p>1&&p<d-1)return!1;--p}return!0}function eo(e,t,o){let r=t[0],a=t[1],n=o[0]-r,i=o[1]-a,s=Math.abs(n),l=Math.abs(i),f=n>0?1:-1,u=i>0?1:-1,c=l-s,d=s+l-1;for(s*=2,l*=2;d>0;){if(c>0)a+=u,c-=s;else{var p;if(0===c&&((p=e.cells.at(r,a+u)).blocksSight||ey(p.type)))return!1;r+=f,c+=l}let t=e.cells.at(r,a);if(t.blocksSight||ey(t.type))return!1;--d}return!0}const er=[W.fromValues(-1,0),W.fromValues(1,0),W.fromValues(0,-1),W.fromValues(0,1)];class ea{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Uint8Array(e*t),this.fill(o)}fill(e){this.values.fill(+!!e)}get(e,t){return 0!==this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=+!!o}}class en{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Int32Array(e*t),this.fill(o)}fill(e){this.values.fill(e)}get(e,t){return this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=o}}class ei{constructor(e,t,o){this.sizeX=e,this.sizeY=t,this.values=new Float64Array(e*t),this.fill(o)}fill(e){this.values.fill(e)}get(e,t){return this.values[this.sizeX*t+e]}set(e,t,o){this.values[this.sizeX*t+e]=o}}var es=((n=es||{})[n.Manor=0]="Manor",n[n.ManorRed=1]="ManorRed",n[n.Mansion=2]="Mansion",n[n.Fortress=3]="Fortress",n[n.Warrens=4]="Warrens",n),el=((i=el||{})[i.GroundNormal=0]="GroundNormal",i[i.GroundGrass=1]="GroundGrass",i[i.GroundWater=2]="GroundWater",i[i.GroundMarble=3]="GroundMarble",i[i.GroundWood=4]="GroundWood",i[i.GroundWoodCreaky=5]="GroundWoodCreaky",i[i.GroundVault=6]="GroundVault",i[i.GroundTreasure=7]="GroundTreasure",i[i.Wall0000=8]="Wall0000",i[i.Wall0001=9]="Wall0001",i[i.Wall0010=10]="Wall0010",i[i.Wall0011=11]="Wall0011",i[i.Wall0100=12]="Wall0100",i[i.Wall0101=13]="Wall0101",i[i.Wall0110=14]="Wall0110",i[i.Wall0111=15]="Wall0111",i[i.Wall1000=16]="Wall1000",i[i.Wall1001=17]="Wall1001",i[i.Wall1010=18]="Wall1010",i[i.Wall1011=19]="Wall1011",i[i.Wall1100=20]="Wall1100",i[i.Wall1101=21]="Wall1101",i[i.Wall1110=22]="Wall1110",i[i.Wall1111=23]="Wall1111",i[i.OneWayWindowE=24]="OneWayWindowE",i[i.OneWayWindowW=25]="OneWayWindowW",i[i.OneWayWindowN=26]="OneWayWindowN",i[i.OneWayWindowS=27]="OneWayWindowS",i[i.PortcullisNS=28]="PortcullisNS",i[i.PortcullisEW=29]="PortcullisEW",i[i.DoorNS=30]="DoorNS",i[i.DoorEW=31]="DoorEW",i[i.GardenDoorNS=32]="GardenDoorNS",i[i.GardenDoorEW=33]="GardenDoorEW",i);class ef{constructor(e,t){this.sizeX=e,this.sizeY=t;let o=e*t;this.values=Array(o);for(let e=0;e<o;++e)this.values[e]=this.emptyCell()}at(e,t){if(e<0||e>=this.sizeX||t<0||t>=this.sizeY)return this.emptyCell();let o=this.sizeX*t+e;return this.values[o]}atVec(e){return this.at(e[0],e[1])}index(e,t){return this.sizeX*t+e}indexVec(e){return this.index(e[0],e[1])}emptyCell(){return{type:1,moveCost:1/0,blocksPlayerMove:!1,blocksPlayerSight:!1,blocksSight:!1,blocksSound:!1,hidesPlayer:!1,isWindow:!1,lit:0,litAnim:0,litSrc:new Set,seen:!1,identified:!1}}}var eu=((s=eu||{})[s.Relaxed=0]="Relaxed",s[s.Angry=1]="Angry",s[s.Alerted=2]="Alerted",s[s.Chasing=3]="Chasing",s[s.Unconscious=4]="Unconscious",s),ec=((l=ec||{})[l.Chair=0]="Chair",l[l.Table=1]="Table",l[l.BedL=2]="BedL",l[l.BedR=3]="BedR",l[l.DrawersShort=4]="DrawersShort",l[l.DrawersTall=5]="DrawersTall",l[l.Bookshelf=6]="Bookshelf",l[l.Shelf=7]="Shelf",l[l.Stove=8]="Stove",l[l.Bush=9]="Bush",l[l.Coin=10]="Coin",l[l.Health=11]="Health",l[l.DoorNS=12]="DoorNS",l[l.DoorEW=13]="DoorEW",l[l.LockedDoorNS=14]="LockedDoorNS",l[l.LockedDoorEW=15]="LockedDoorEW",l[l.PortcullisNS=16]="PortcullisNS",l[l.PortcullisEW=17]="PortcullisEW",l[l.TorchUnlit=18]="TorchUnlit",l[l.TorchLit=19]="TorchLit",l[l.TorchCarry=20]="TorchCarry",l[l.PurseCarry=21]="PurseCarry",l[l.Key=22]="Key",l[l.KeyCarry=23]="KeyCarry",l[l.VaultTreasureBox=24]="VaultTreasureBox",l[l.EmptyVaultTreasureBox=25]="EmptyVaultTreasureBox",l[l.LootedVaultTreasureBox=26]="LootedVaultTreasureBox",l[l.Note=27]="Note",l[l.TreasureLock=28]="TreasureLock",l[l.TreasurePlinth=29]="TreasurePlinth",l[l.TreasureA=30]="TreasureA",l[l.TreasureB=31]="TreasureB",l[l.TreasureC=32]="TreasureC",l[l.TreasureD=33]="TreasureD",l[l.TreasureE=34]="TreasureE",l);const ed={0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,10:!1,11:!1,12:!1,13:!1,14:!1,15:!1,16:!1,17:!1,18:!1,19:!1,20:!1,21:!1,22:!1,23:!1,24:!1,25:!1,26:!1,27:!1,28:!0,29:!1,30:!0,31:!0,32:!0,33:!0,34:!0};class ep{constructor(e,t){this.itemUsed=null,this.animation=null,this.torchAnimation=null,this.pickTarget=null,this.lightActive=!1,this.idle=!1,this.idleCursorAnimation=null,this.idleCursorType="orbs",this.pos=W.clone(e),this.dir=W.fromValues(0,-1),this.healthMax=t?3:5,this.health=this.healthMax,this.loot=0,this.noisy=!1,this.preNoisy=!1,this.noiseOffset=W.fromValues(0,0),this.noisyAnim=0,this.hasVaultKey=!1,this.damagedLastTurn=!1,this.turnsRemainingUnderwater=7}applyDamage(e){this.health-=Math.min(e,this.health),this.damagedLastTurn=!0}hidden(e){return!this.lightActive&&void 0===e.guards.find(e=>e.mode==K.ChaseVisibleTarget)&&(!!e.cells.atVec(this.pos).hidesPlayer||2==e.cells.atVec(this.pos).type&&this.turnsRemainingUnderwater>0)}}const eh=[{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}],em=[{lx:-1,ly:-1,rx:-1,ry:-1,nx:-1,ny:-1},{lx:-1,ly:-1,rx:-1,ry:1,nx:-1,ny:0},{lx:-1,ly:1,rx:-1,ry:1,nx:-1,ny:1},{lx:-1,ly:1,rx:1,ry:1,nx:0,ny:1},{lx:1,ly:1,rx:1,ry:1,nx:1,ny:1},{lx:1,ly:1,rx:1,ry:-1,nx:1,ny:0},{lx:1,ly:-1,rx:1,ry:-1,nx:1,ny:-1},{lx:1,ly:-1,rx:-1,ry:-1,nx:0,ny:-1}],eg=[{dx:1,dy:0,cost:2},{dx:-1,dy:0,cost:2},{dx:0,dy:1,cost:2},{dx:0,dy:-1,cost:2},{dx:-1,dy:-1,cost:3},{dx:1,dy:-1,cost:3},{dx:-1,dy:1,cost:3},{dx:1,dy:1,cost:3}];class ex{constructor(e){this.cells=e,this.patrolRegions=[],this.patrolRoutes=[],this.items=[],this.guards=[],this.playerStartPos=W.create(),this.lightCount=0,this.numPreRevealedCells=0,this.backtrackingCoefficient=1,this.bookTitle=new Map,this.treasures=[],this.rooms=[],this.adjacencies=[]}hasLootAt(e){return this.items.some(t=>t.pos.equals(e)&&(10===t.type||t.type>=30||11===t.type||24===t.type))}collectLootAt(e){let t=[],o=this.items.some(t=>28===t.type&&t.pos.equals(e));return this.items=this.items.filter(r=>!r.pos.equals(e)||(10===r.type||11===r.type?(t.push(r),!1):r.type>=30&&!o?(t.push(r),!1):24!==r.type||(t.push(r),!1))),t}collectAllLoot(){let e=0;for(let t of(this.items=this.items.filter(t=>10!=t.type||(++e,!1)),this.guards))t.hasPurse&&(++e,t.hasPurse=!1);return e}identifyAdjacentCells(e){let t=Math.max(e[0]-1,0),o=Math.max(e[1]-1,0),r=Math.min(e[0]+2,this.cells.sizeX),a=Math.min(e[1]+2,this.cells.sizeY);for(let e=t;e<r;++e)for(let t=o;t<a;++t)this.cells.at(e,t).identified=!0}allSeen(){return!this.cells.values.some(e=>!e.seen)}numCells(){return this.cells.values.length}numCellsSeen(){let e=0;for(let t of this.cells.values)t.seen&&++e;return e}fractionRevealed(){return(this.numCellsSeen()-this.numPreRevealedCells)/(this.numCells()-this.numPreRevealedCells)}markAllSeen(){for(let e of this.cells.values)e.seen=!0,e.identified=!0}markAllUnseen(){for(let e of this.cells.values)e.seen=!1,e.identified=!1}recomputeVisibility(e){this.recomputeVisibilityFromPos(e);let t=W.create();for(let o of er)this.playerCanSeeInDirection(e,o)&&(W.add(t,e,o),this.recomputeVisibilityFromPos(t))}recomputeVisibilityFromPos(e){for(let t of eh)this.computeVisibility(e[0],e[1],e[0],e[1],t.lx,t.ly,t.rx,t.ry)}playerCanSeeInDirection(e,t){let o=W.create();return W.add(o,e,t),!(o[0]<0)&&!(o[1]<0)&&!(o[0]>=this.cells.sizeX)&&!(o[1]>=this.cells.sizeY)&&!this.cells.at(o[0],o[1]).blocksPlayerSight}computeVisibility(e,t,o,r,a,n,i,s){if(o<0||r<0||o>=this.cells.sizeX||r>=this.cells.sizeY)return;let l=o-e,f=r-t;if(l**2+f**2>400)return;l*=2,f*=2;let u=this.cells.at(o,r);if(u.seen=!0,!u.blocksPlayerSight){for(let e=0;e<2;++e)for(let t=0;t<2;++t){let u=o+2*e-1,c=r+2*t-1,d=l+2*e-1,p=f+2*t-1;u>=0&&c>=0&&u<this.cells.sizeX&&c<this.cells.sizeY&&!(a*p>n*d)&&!(d*s>p*i)&&(this.cells.at(u,c).seen=!0)}for(let u of eh){let c=l+u.lx,d=f+u.ly,p=l+u.rx,h=f+u.ry,[m,g]=a*d>n*c?[a,n]:[c,d],[x,y]=i*h>s*p?[p,h]:[i,s];x*g>y*m&&this.computeVisibility(e,t,o+u.nx,r+u.ny,m,g,x,y)}}}computeLighting(e){let t=new Set;for(let o of(null!==e&&this.cells.atVec(e.pos).type>=8&&t.add(this.cells.atVec(e.pos)),this.guards)){let e=this.cells.at(o.pos[0],o.pos[1]);e.type>=8&&t.add(e)}for(let e of this.cells.values)e.lit=0,e.litSrc.clear();let o=0;for(let e of this.items)19===e.type&&(this.castLight(e.pos,45,o,t),o++),8===e.type&&(this.castLight(e.pos,25,o,t),o++),18==e.type&&o++;for(let e of this.guards)e.hasTorch&&(e.mode!==K.Unconscious&&this.castLight(e.pos,15,o,t),o++);null!==e&&e.lightActive&&this.castLight(e.pos,0,o,t),o++,this.lightCount=o}castLight(e,t,o,r){for(let a of(this.cells.at(e[0],e[1]).lit=1,em))this.castLightRecursive(e[0],e[1],e[0]+a.nx,e[1]+a.ny,a.lx,a.ly,a.rx,a.ry,t,o,r)}castLightRecursive(e,t,o,r,a,n,i,s,l,f,u){if(o<0||r<0||o>=this.cells.sizeX||r>=this.cells.sizeY)return;let c=o-e,d=r-t;if(c**2+d**2>l)return;let p=this.cells.at(o,r);if(!p.litSrc.has(f)){let e=c**2+d**2;p.lit+=1/(.5*e+1),p.lit=Math.min(p.lit,1),p.litSrc.add(f)}if((!p.blocksSight||u.has(p))&&i*n>s*a)for(let p of(c*=2,d*=2,em)){let h=c+p.lx,m=d+p.ly,g=c+p.rx,x=d+p.ry,[y,_]=a*m>n*h?[a,n]:[h,m],[S,v]=i*x>s*g?[g,x]:[i,s];y*v>_*S||this.castLightRecursive(e,t,o+p.nx,r+p.ny,y,_,S,v,l,f,u)}}allLootCollected(){return void 0===this.items.find(e=>10==e.type)}isGuardAt(e,t){return void 0!=this.guards.find(o=>o.hasMoved&&o.pos.equalsValues(e,t))}isGuardAtVec(e){return void 0!=this.guards.find(t=>t.hasMoved&&t.pos.equals(e))}guardMoveCost(e,t){let o=this.cells.atVec(t).moveCost;return o===1/0?o:e[0]!=t[0]&&e[1]!=t[1]&&(this.cells.at(e[0],t[1]).moveCost>=64||this.cells.at(t[0],e[1]).moveCost>=64)?1/0:o}posNextBest(e,t){let o=1/0,r=W.clone(t),a=W.fromValues(Math.max(0,t[0]-1),Math.max(0,t[1]-1)),n=W.fromValues(Math.min(this.cells.sizeX,t[0]+2),Math.min(this.cells.sizeY,t[1]+2));for(let i=a[0];i<n[0];++i)for(let s=a[1];s<n[1];++s){let a=e.get(i,s);if(a==1/0)continue;let n=W.fromValues(i,s);this.guardMoveCost(t,n)!=1/0&&!this.isGuardAtVec(n)&&a<o&&(o=a,r=n)}return r}nextPositions(e,t){let o=W.fromValues(Math.max(0,t[0]-1),Math.max(0,t[1]-1)),r=W.fromValues(Math.min(this.cells.sizeX,t[0]+2),Math.min(this.cells.sizeY,t[1]+2)),a=[];for(let n=o[0];n<r[0];++n)for(let i=o[1];i<r[1];++i){let o=e.get(n,i);if(o===1/0)continue;let r=W.fromValues(n,i);if(this.guardMoveCost(t,r)===1/0)continue;let s=Math.abs(t[0]-r[0])+Math.abs(t[1]-r[1]);a.push([o,s,r])}return a.sort((e,t)=>e[0]!==t[0]?e[0]-t[0]:e[1]-t[1]),a.map(e=>e[2])}patrolPathIndexForResume(e,t,o){let r=this.computeDistancesToPosition(o,void 0),a=t;for(let t=0;t<e.length;++t){let t=e[a],o=this.posNextBest(r,t),n=e[(a+e.length-1)%e.length],i=W.create();W.subtract(i,t,o);let s=W.create();if(W.subtract(s,t,n),W.dot(i,s)>0)break;a=(a+1)%e.length}return a}computeDistancesToPosition(e,t){return console.assert(e[0]>=0),console.assert(e[1]>=0),console.assert(e[0]<this.cells.sizeX),console.assert(e[1]<this.cells.sizeY),this.computeDistanceField([{priority:0,pos:W.clone(e)}],t)}computeDistancesToPositionSubrect(e,t,o,r,a){return console.assert(e[0]>=t),console.assert(e[1]>=o),console.assert(e[0]<r),console.assert(e[1]<a),this.computeDistanceFieldSubrect([{priority:0,pos:W.clone(e)}],t,o,r,a)}computeDistancesToAdjacentToPosition(e,t){let o=[];for(let t of er){let r=W.clone(e).add(t);if(r[0]<0||r[1]<0||r[0]>=this.cells.sizeX||r[1]>=this.cells.sizeY)continue;let a=this.cells.atVec(r);a.moveCost!==1/0&&o.push({priority:a.moveCost,pos:r})}return this.computeDistanceField(o,t)}computeDistanceField(e,t){let o=this.cells.sizeX,r=this.cells.sizeY,a=[],n=new ei(o,r,1/0);for(let t of e)ev(a,t);let i=void 0===t?1:this.numNavigableSquaresInRect(t);for(;a.length>0&&i>0;){let e=eS(a);if(!(e.priority>=n.get(e.pos[0],e.pos[1])))for(let s of(n.set(e.pos[0],e.pos[1],e.priority),void 0!==t&&e.pos[0]>=t.posMin[0]&&e.pos[1]>=t.posMin[1]&&e.pos[0]<t.posMax[0]&&e.pos[1]<t.posMax[1]&&--i,eg)){let t=W.fromValues(e.pos[0]+s.dx,e.pos[1]+s.dy);if(t[0]<0||t[1]<0||t[0]>=o||t[1]>=r)continue;let i=this.guardMoveCost(e.pos,t);if(i==1/0)continue;let l=e.priority+i+s.cost;l<n.get(t[0],t[1])&&ev(a,{priority:l,pos:t})}}return n}numNavigableSquaresInRect(e){let t=0;for(let o=e.posMin[0];o<e.posMax[0];++o)for(let r=e.posMin[1];r<e.posMax[1];++r)this.cells.at(o,r).moveCost!==1/0&&++t;return t}computeDistanceFieldSubrect(e,t,o,r,a){console.assert(t>=0),console.assert(o>=0),console.assert(r<=this.cells.sizeX),console.assert(a<=this.cells.sizeY);let n=r-t,i=a-o,s=[],l=new ei(n,i,1/0);for(let r of e)ev(s,{priority:r.priority,pos:[r.pos[0]-t,r.pos[1]-o]});for(;s.length>0;){let e=eS(s);if(e.priority>=l.get(e.pos[0],e.pos[1]))continue;l.set(e.pos[0],e.pos[1],e.priority);let r=W.fromValues(e.pos[0]+t,e.pos[1]+o);for(let a of eg){let f=W.fromValues(e.pos[0]+a.dx,e.pos[1]+a.dy);if(f[0]<0||f[1]<0||f[0]>=n||f[1]>=i)continue;let u=W.fromValues(f[0]+t,f[1]+o),c=this.guardMoveCost(r,u);if(c==1/0)continue;let d=e.priority+c+a.cost;d<l.get(f[0],f[1])&&ev(s,{priority:d,pos:f})}}return l}guardsInEarshot(e,t){let o=this.cells.sizeX,r=this.cells.sizeY,a=new Map;for(let e of this.guards)e.mode!==K.Unconscious&&a.set(o*e.pos[1]+e.pos[0],e);let n=[],i=new ei(o,r,1/0),s=[];for(ev(n,{priority:0,pos:e});n.length>0;){let e=eS(n);if(e.priority>=i.get(e.pos[0],e.pos[1]))continue;i.set(e.pos[0],e.pos[1],e.priority);let l=a.get(o*e.pos[1]+e.pos[0]);for(let a of(void 0!==l&&s.push(l),eg)){let s=W.fromValues(e.pos[0]+a.dx,e.pos[1]+a.dy);if(s[0]<0||s[1]<0||s[0]>=o||s[1]>=r)continue;let l=e.priority+a.cost;l>t||this.cells.at(s[0],s[1]).blocksSound||l>=i.get(s[0],s[1])||ev(n,{priority:l,pos:s})}}return s}tryGetPosLookAt(e,t){let o=e[0],r=e[1];if(t){let e=this.items.filter(e=>2>Math.abs(e.pos[0]-o)&&2>Math.abs(e.pos[1]-r)&&(15===e.type||14===e.type));if(e.find(e=>e.pos[0]===o-1&&e.pos[1]===r))return W.fromValues(o+1,r);if(e.find(e=>e.pos[0]===o+1&&e.pos[1]===r))return W.fromValues(o-1,r);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r-1))return W.fromValues(o,r+1);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r+1))return W.fromValues(o,r-1);if(o>0&&30===this.cells.at(o-1,r).type)return W.fromValues(o+1,r);if(o<this.cells.sizeX-1&&30===this.cells.at(o+1,r).type)return W.fromValues(o-1,r);if(r>0&&31===this.cells.at(o,r-1).type)return W.fromValues(o,r+1);if(r<this.cells.sizeY-1&&31==this.cells.at(o,r+1).type)return W.fromValues(o,r-1)}if(o>0&&25==this.cells.at(o-1,r).type)return W.fromValues(o-1,r);if(o<this.cells.sizeX-1&&24==this.cells.at(o+1,r).type)return W.fromValues(o+1,r);if(r>0&&27==this.cells.at(o,r-1).type)return W.fromValues(o,r-1);if(r<this.cells.sizeY-1&&26==this.cells.at(o,r+1).type)return W.fromValues(o,r+1);if(this.items.find(t=>t.pos.equals(e)&&0===t.type)){let e=this.items.filter(e=>2>Math.abs(e.pos[0]-o)&&2>Math.abs(e.pos[1]-r)&&(1===e.type||19===e.type||18===e.type));if(e.find(e=>e.pos[0]===o-1&&e.pos[1]===r))return W.fromValues(o-1,r);if(e.find(e=>e.pos[0]===o+1&&e.pos[1]===r))return W.fromValues(o+1,r);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r-1))return W.fromValues(o,r-1);if(e.find(e=>e.pos[0]===o&&e.pos[1]===r+1))return W.fromValues(o,r+1)}}}function ey(e){return e>=24&&e<=27}function e_(e){return e>=12&&e<=17}function eS(e){let t=e[0];e[0]=e[e.length-1],e.pop();let o=0,r=e.length;for(;;){let t=o,a=2*o+1;a<r&&e[a].priority<e[t].priority&&(t=a);let n=a+1;if(n<r&&e[n].priority<e[t].priority&&(t=n),t==o)break;[e[o],e[t]]=[e[t],e[o]],o=t}return t}function ev(e,t){e.push(t);let o=e.length-1;for(;o>0;){let t=Math.floor((o-1)/2);if(e[o].priority>=e[t].priority)break;[e[o],e[t]]=[e[t],e[o]],o=t}}var eM={},eb=P("cmoHh"),eA=P("euRi5"),ew=P("hDsEw"),eT=P("3J2Zm"),eR=P("6Px8M"),eH=P("lDm0S"),eI={};!function(e,t,o){var r,a="random",n=o.pow(256,6),i=o.pow(2,52),s=2*i;function l(l,p,h){var m=[],g=c(function e(t,o){var r,a=[],n=typeof t;if(o&&"object"==n)for(r in t)try{a.push(e(t[r],o-1))}catch(e){}return a.length?a:"string"==n?t:t+"\0"}((p=!0==p?{entropy:!0}:p||{}).entropy?[l,d(t)]:null==l?function(){try{var o;return r&&(o=r.randomBytes)?o=o(256):(o=new Uint8Array(256),(e.crypto||e.msCrypto).getRandomValues(o)),d(o)}catch(o){var a=e.navigator,n=a&&a.plugins;return[+new Date,e,n,e.screen,d(t)]}}():l,3),m),x=new f(m),y=function(){for(var e=x.g(6),t=n,o=0;e<i;)e=(e+o)*256,t*=256,o=x.g(1);for(;e>=s;)e/=2,t/=2,o>>>=1;return(e+o)/t};return y.int32=function(){return 0|x.g(4)},y.quick=function(){return x.g(4)/0x100000000},y.double=y,c(d(x.S),t),(p.pass||h||function(e,t,r,n){return(n&&(n.S&&u(n,x),e.state=function(){return u(x,{})}),r)?(o[a]=e,t):e})(y,g,"global"in p?p.global:this==o,p.state)}function f(e){var t,o=e.length,r=this,a=0,n=r.i=r.j=0,i=r.S=[];for(o||(e=[o++]);a<256;)i[a]=a++;for(a=0;a<256;a++)i[a]=i[n=255&n+e[a%o]+(t=i[a])],i[n]=t;(r.g=function(e){for(var t,o=0,a=r.i,n=r.j,i=r.S;e--;)t=i[a=255&a+1],o=256*o+i[255&(i[a]=i[n=255&n+t])+(i[n]=t)];return r.i=a,r.j=n,o})(256)}function u(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function c(e,t){for(var o,r=e+"",a=0;a<r.length;)t[255&a]=255&(o^=19*t[255&a])+r.charCodeAt(a++);return d(t)}function d(e){return String.fromCharCode.apply(0,e)}if(c(o.random(),t),eI){eI=l;try{r=P("kjyEk")}catch(e){}}else"function"==typeof define&&define.amd?define(function(){return l}):o["seed"+a]=l}("undefined"!=typeof self?self:eI,[],Math),eI.alea=eb,eI.xor128=eA,eI.xorwow=ew,eI.xorshift7=eT,eI.xor4096=eR,eI.tychei=eH,eM=eI;class eL{constructor(t=""){""!==t?(this.seed=t,this.rng=e(eM)(t)):(this.seed="",this.rng=e(eM)())}reset(){this.rng=e(eM)(this.seed)}random(){return this.rng()}randomInRange(e){return Math.floor(this.rng()*e)}shuffleArray(e){for(let t=e.length-1;t>0;--t){let o=this.randomInRange(t+1),r=e[t];e[t]=e[o],e[o]=r}}}function eC(e){for(let t=e.length-1;t>0;--t){let o=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[o],e[o]=r}}const eE=[[3,3,2,2,6,6],[3,5,2,5,6,12],[3,5,2,6,9,15],[3,5,2,6,12,18],[3,7,3,6,15,21],[3,7,3,6,18,24],[3,7,3,6,21,30],[5,7,4,6,24,36],[5,9,4,6,30,42],[7,9,5,9,35,63]];var eF=((f=eF||{})[f.Exterior=0]="Exterior",f[f.PublicCourtyard=1]="PublicCourtyard",f[f.PublicRoom=2]="PublicRoom",f[f.PrivateCourtyard=3]="PrivateCourtyard",f[f.PrivateRoom=4]="PrivateRoom",f[f.Vault=5]="Vault",f[f.Bedroom=6]="Bedroom",f[f.Dining=7]="Dining",f[f.PublicLibrary=8]="PublicLibrary",f[f.PrivateLibrary=9]="PrivateLibrary",f[f.Kitchen=10]="Kitchen",f[f.Treasure=11]="Treasure",f[f.TreasureCourtyard=12]="TreasureCourtyard",f[f.LockedTreasure=13]="LockedTreasure",f[f.LockedTreasureCourtyard=14]="LockedTreasureCourtyard",f[f.ThroneRoom=15]="ThroneRoom",f),ek=((u=ek||{})[u.Standard=0]="Standard",u[u.GateFront=1]="GateFront",u[u.GateBack=2]="GateBack",u[u.Locked=3]="Locked",u);function eP(e,t,o,r){let a=[],n=4+o.randomInRange(3),i=n+2+o.randomInRange(7-n),s=.2>o.random()?5:e;s>=n&&++s,s>=i&&++s;let l=e;l>=n&&++l,l>=i&&++l,l>=s&&++l;let f=.5>o.random()?es.Manor:es.ManorRed;for(let t=0;t<e;++t){let e;let u=new eL("lvl"+t+o.random());f=(e=void 0!==r?r:9===t||t===s?es.Fortress:t===n||t===i?es.Mansion:t===l?es.Warrens:f)===es.Manor||e===es.ManorRed?f===es.Manor?es.ManorRed:es.Manor:.5>o.random()?es.Manor:es.ManorRed;let[c,d]=function(e,t,o){let r,a,n,i,s,l;[r,a,n,i,s,l]=eE[e];let f=r;for(let e=r;e<a;++e).5>o.random()&&++f;let u=n;for(let e=n;e<i;++e).5>o.random()&&++u;return(1&f)==0&&(f>r&&.5>o.random()?--f:++f),u=Math.max(u=Math.min(Math.floor(l/f),u),Math.ceil(s/f)),t===es.Mansion&&(f=Math.floor((f+1)/3+.5),u=Math.floor((u+1)/3+.5),f=Math.max(2,f),u=Math.max(2,u),f=3*Math.min(4,f)-1,u=3*Math.min(4,u)-1),[f,u]}(t,e,u);a.push({levelType:e,level:t,numRoomsX:c,numRoomsY:d,totalLoot:0,rng:u,played:!1})}let u=0;for(let e of a)u+=e.numRoomsX*e.numRoomsY;let c=0;for(let e of a){let o=Math.floor(t*(e.numRoomsX*e.numRoomsY)/u);c+=o,e.totalLoot=o}return a[a.length-1].totalLoot+=t-c,a}function eD(e){let t;let o=e.rng;o.reset();let r=e.level,a=e.levelType;if(a===es.Warrens)return function(e,t,o,r,a){let n;let i=new ea(t-1,o,!1),s=new ea(t,o-1,!1),l=new ea(t,o,!1),f=new ea(t,o,!0);for(let e=0;e<t;++e)for(let t=0;t<o-1;++t).125>a.random()&&l.set(e,t,!0);for(let e=Math.floor(t*o/8);e>0;--e){let e=a.randomInRange(t),r=a.randomInRange(o-1);e>0&&e<t-1&&.5>a.random()&&(l.set(e,r,!0),f.set(e,r,!1))}for(let e=0;e<t-1;++e)i.set(e,o-1,!0);let u=[];for(let e=0;e<t;++e)for(let t=0;t<o-1;++t)l.get(e,t)||u.push([e,t]);for(let e of(a.shuffleArray(u),u)){if(l.get(e[0],e[1]))continue;let r=[];for(let[a,n]of[[1,0],[0,1],[0,-1]]){let i=e[0]+a,s=e[1]+n;!(!(i<0)&&!(s<0)&&!(i>=t)&&!(s>=o)&&f.get(i,s))||r.push([a,n])}if(0===r.length)continue;let[n,u]=r[a.randomInRange(r.length)];l.set(e[0],e[1],!0),n<0?(i.set(e[0]-1,e[1],!0),l.set(e[0]-1,e[1],!0)):n>0?(i.set(e[0],e[1],!0),l.set(e[0]+1,e[1],!0)):u<0?(s.set(e[0],e[1]-1,!0),l.set(e[0],e[1]-1,!0)):u>0&&(s.set(e[0],e[1],!0),l.set(e[0],e[1]+1,!0))}let[c,d,p]=function(e,t,o,r){let a=e.sizeX,n=e.sizeY,i=2+r.randomInRange(2),s=3+r.randomInRange(2),l=Array(a+1).fill(6);for(let e=Math.floor(l.length/2);e>0;--e){let e=r.randomInRange(l.length);l[e]+=1}{let e=-1;for(let t=0;t<l.length;++t){let o=e+l[t];l[t]=e,e=o}}let f=Array(n+1).fill(6);for(let e=Math.floor(f.length/2);e>0;--e){let e=r.randomInRange(f.length);f[e]+=1}f[0]+=1,f[f.length-1]+=1;{let e=-1;for(let t=0;t<f.length;++t){let o=e+f[t];f[t]=e,e=o}}let u=new en(a+1,n,0),c=new en(a,n+1,0),d=r.randomInRange(2);for(let e=0;e<=a;++e)for(let p=0;p<=n;++p){let h=p>0&&p<n&&(e>0&&o.get(e-1,p-1)||e<a&&o.get(e,p-1)),m=e>0&&e<a&&(p>0&&t.get(e-1,p-1)||p<n&&t.get(e-1,p)),g=e>=a?i:l[e+1]-l[e]-4,x=p>=n?s:f[p+1]-f[p]-4;if(h&&m){u.set(e,p,u.get(e,p-1)),c.set(e,p,c.get(e-1,p));continue}if(h||!m&&(0>r.random()?0===r.randomInRange(2):(e+p+d&1)==0)){if(p<n&&u.set(e,p,p>0?u.get(e,p-1):r.randomInRange(g)+l[e]),e<a){let t=f[p];e<=0?t+=r.randomInRange(x):p!==n?r.random()>=.8?t+=r.randomInRange(x):(t+=r.randomInRange(x-1))>=c.get(e-1,p)&&++t:t=c.get(e-1,p),c.set(e,p,t)}}else{if(p<n){let t=l[e];p<=0?t+=r.randomInRange(g):0!==e&&e!==a?r.random()>=.8?t+=r.randomInRange(g):(t+=r.randomInRange(g-1))>=u.get(e,p-1)&&++t:t=u.get(e,p-1),u.set(e,p,t)}e<a&&c.set(e,p,e>0?c.get(e-1,p):r.randomInRange(x)+f[p])}}let p=2*a-1,h=2*n-1,m=new ea(p,h,!1),g=new en(p+1,h,0),x=new en(p,h+1,0);for(let e=0;e<a;++e)for(let t=0;t<n;++t){let o=u.get(e,t),r=u.get(e+1,t)-2;g.set(2*e,2*t,o),g.set(2*e+1,2*t,r),t+1<n&&(g.set(2*e,2*t+1,o),g.set(2*e+1,2*t+1,r));let i=c.get(e,t),s=c.get(e,t+1)-2;x.set(2*e,2*t,i),x.set(2*e,2*t+1,s),e+1<a&&(x.set(2*e+1,2*t,i),x.set(2*e+1,2*t+1,s))}for(let t=0;t<a;++t)for(let o=0;o<n;++o)m.set(2*t,2*o,e.get(t,o));for(let e=1;e<p;e+=2)for(let o=0;o<h;++o)m.set(e,o,!(1&o)&&t.get(Math.floor(e/2),Math.floor(o/2)));for(let e=0;e<p;++e)for(let t=1;t<h;t+=2)m.set(e,t,!(1&e)&&o.get(Math.floor(e/2),Math.floor(t/2)));return[m,g,x]}(f,i,s,a);eV(d,p,1,3);let h=es.Warrens,[m,g]=eB(c,d,p,h),x=eN(!1,!1,d,p,m,g);eX(x),a.shuffleArray(x),function(e,t,o){o.shuffleArray(t);for(let r=t.length;r>0;--r){let r=function(e,t,o){let r=[];for(let o of e){let e=o.roomLeft,a=o.roomRight;if(e.roomType!==a.roomType||e===t||a===t)continue;if(0===o.dir[1]){if(o.length!==1+(e.posMax[0]-e.posMin[0])||o.length!==1+(a.posMax[0]-a.posMin[0]))continue}else if(o.length!==1+(e.posMax[1]-e.posMin[1])||o.length!==1+(a.posMax[1]-a.posMin[1]))continue;let n=Math.min(e.posMin[0],a.posMin[0]),i=Math.min(e.posMin[1],a.posMin[1]),s=Math.max(e.posMax[0],a.posMax[0]),l=Math.max(e.posMax[1],a.posMax[1]),f=s-n,u=l-i;if(f*u>750)continue;let c=Math.max(f,u)/Math.min(f,u);0!==e.roomType&&1!==e.roomType&&c>(Math.min(f,u)>2?2:3)||r.push([o,c])}if(!(r.length<=0))return o.shuffleArray(r),r.sort((e,t)=>e[1]-t[1]),r[0][0]}(t,e[0],o);if(void 0===r)break;tt(e,t,r)}}(m,x,a),ej(m,x,e=>0===e.roomLeft.roomType&&0===e.roomRight.roomType),ej(m,x,e=>1===e.roomLeft.roomType&&1===e.roomRight.roomType),ej(m,x,e=>2===e.roomLeft.roomType&&2===e.roomRight.roomType&&.8>a.random()),ej(m,x,e=>2===e.roomLeft.roomType!=(2===e.roomRight.roomType)&&(e$(e.roomLeft)||e$(e.roomRight))&&.5>a.random()),ej(m,x,e=>e.roomLeft.group!==e.roomRight.group),eQ(m),eJ(m),e1(m,e,h,a);let y=eU(h,m);for(let e of y.cells.values)e.type=el.GroundNormal;tv(h,x,y),tM(e,h,m,y,a),y.backtrackingCoefficient=eZ(m),y.playerStartPos=tx(e,h,x,y),t3(y.cells),t2(y),n=e<1?[]:e<2?ta(y,m,a):ti(h,e,y,m,x,a);let _=void 0!==y.items.find(e=>e.type===ec.LockedDoorNS||e.type===ec.LockedDoorEW);eW(e,y,m,_,n,a);let S=Math.min(Math.floor(e/3),Math.min(n.length-+!!_,r));return tU(r-S,m,y,n,h,a),t0(y.bookTitle,m,y.items.filter(e=>e.type===ec.Bookshelf),a),tO(y,m,a),tz(e,y,m,a),t$(e,y,n,S,_,a),y.computeLighting(null),y.recomputeVisibility(y.playerStartPos),y.rooms=m.map(e=>({posMin:e.posMin,posMax:e.posMax})),y.adjacencies=x,y}(r,e.numRoomsX,e.numRoomsY,e.totalLoot,o);let n=new ea(e.numRoomsX,e.numRoomsY,!0);switch(a){case es.Manor:case es.ManorRed:!function(e,t){let o=e.sizeX,r=e.sizeY,a=Math.floor(o*r/4);for(let n=0;n<a;++n){let a=t.randomInRange(o),n=t.randomInRange(r);e.set(a,n,!1)}(1&o)==1&&function(e){let t=e.sizeX,o=e.sizeY;console.assert((1&t)==1);for(let r=(t-1)/2+1;r<t;++r)for(let a=0;a<o;++a)e.set(r,a,e.get(t-1-r,a))}(e),(1&r)==1&&.125>t.random()&&function(e){let t=e.sizeX,o=e.sizeY;console.assert((1&o)==1);let r=(o-1)/2;for(let a=0;a<t;++a)for(let t=r+1;t<o;++t)e.set(a,t,e.get(a,o-1-t))}(e)}(n,o);break;case es.Mansion:!function(e,t){let o=Math.floor((e.sizeX+1)/3),r=Math.floor((e.sizeY+1)/3);e.fill(!1);for(let t=0;t<o;++t)for(let o=0;o<r;++o)for(let r=0;r<2;++r)for(let a=0;a<2;++a)e.set(3*t+r,3*o+a,!0);let a=[];for(let e=0;e<o;++e)for(let t=0;t<r;++t)a.push(e*r+t);let n=[];for(let e=1;e<o;++e)for(let t=0;t<r;++t){let o=(e-1)*r+t,a=e*r+t;n.push([o,a])}for(let e=0;e<o;++e)for(let t=1;t<r;++t){let o=e*r+(t-1),a=e*r+t;n.push([o,a])}for(let o of(t.shuffleArray(n),n)){let t=o[0],n=o[1],i=a[t],s=a[n],l=t%r,f=Math.floor(t/r),u=n%r,c=Math.floor(n/r);if(i===s)continue;for(let e=0;e<a.length;++e)a[e]===s&&(a[e]=i);let d=3*Math.min(f,c),p=3*Math.max(f,c)+2,h=3*Math.min(l,u),m=3*Math.max(l,u)+2;for(let t=d;t<p;++t)for(let o=h;o<m;++o)e.set(t,o,!0)}}(n,o);break;case es.Fortress:!function(e,t){let o=.25>t.random();for(let t=0;t<e.sizeX;++t)for(let r=0;r<e.sizeY;++r){let a=Math.min(t,e.sizeX-1-t),n=Math.min(a,Math.min(r,e.sizeY-1-r));e.set(t,r,1!==n||!o&&r>1&&1!==a)}}(n,o)}let i=.25>o.random(),[s,l]=function(e,t,o,r,a,n,i,s,l,f,u,c,d){let p=new en(e+1,t,0),h=new en(e,t+1,0),m=d.randomInRange(2);for(let o=0;o<=e;++o)for(let r=0;r<=t;++r)if(.5>d.random()?0===d.randomInRange(2):(o+r+m&1)==0){if(r<t&&p.set(o,r,r>0?p.get(o,r-1):d.randomInRange(3)+5*o-1),o<e){let e=5*r-1;o<=0?e+=d.randomInRange(3):f&&0===r||c&&r===t?e=h.get(o-1,r):d.random()>=.75?e+=d.randomInRange(3):(e+=d.randomInRange(n-1))>=h.get(o-1,r)&&++e,h.set(o,r,e)}}else{if(r<t){let t=5*o-1;r<=0?t+=d.randomInRange(3):l&&0===o||u&&o===e?t=p.get(o,r-1):d.random()>=.75?t+=d.randomInRange(a):(t+=d.randomInRange(a-1))>=p.get(o,r-1)&&++t,p.set(o,r,t)}o<e&&h.set(o,r,o>0?h.get(o-1,r):d.randomInRange(n)+5*r-1)}return[p,h]}(e.numRoomsX,e.numRoomsY,5,5,3,3,.75,0,i,i,i,i,o),f=(1&e.numRoomsX)==1&&function(e){let t=Math.floor(e.sizeX/2);for(let o=0;o<e.sizeY;++o)for(let r=0;r<t;++r)if(e.get(r,o)!==e.get(e.sizeX-1-r,o))return!1;return!0}(n);f&&function(e,t){let o=t.sizeX,r=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=r+1),console.assert((1&o)==1);let a=(o-1)/2,n=Math.floor((a+.5)*5+1);for(let t=a+1;t<o+1;++t)for(let a=0;a<r;++a)e.set(t,a,2*n-e.get(o-t,a));for(let e=a+1;e<o;++e)for(let a=0;a<r+1;++a)t.set(e,a,t.get(o-1-e,a))}(s,l);let u=(1&e.numRoomsY)==1&&function(e){let t=Math.floor(e.sizeY/2);for(let o=0;o<e.sizeX;++o)for(let r=0;r<t;++r)if(e.get(o,r)!==e.get(o,e.sizeY-1-r))return!1;return!0}(n)&&(!f||.5>o.random());u&&function(e,t){let o=t.sizeX,r=e.sizeY;console.assert(e.sizeX=o+1),console.assert(t.sizeY=r+1),console.assert((1&r)==1);let a=(r-1)/2,n=Math.floor((a+.5)*5+1);for(let t=0;t<o+1;++t)for(let o=a+1;o<r;++o)e.set(t,o,e.get(t,r-1-o));for(let e=0;e<o;++e)for(let o=a+1;o<r+1;++o)t.set(e,o,2*n-t.get(e,r-o))}(s,l),eV(s,l,2,3);let[c,d]=eB(n,s,l,a),p=o.randomInRange(24)>=r,h=eN(f&&p,u&&p,s,l,c,d);eX(h),o.shuffleArray(h),function(e,t,o,r,a){ej(e,t,e=>0===e.roomLeft.roomType&&0===e.roomRight.roomType),ej(e,t,e=>1===e.roomLeft.roomType&&1===e.roomRight.roomType),r===es.Fortress?ej(e,t,e=>0!==e.roomLeft.roomType&&0!==e.roomRight.roomType&&e.roomLeft.group!==e.roomRight.group):(ej(e,t,e=>2===e.roomLeft.roomType&&2===e.roomRight.roomType&&(e.roomLeft.group!==e.roomRight.group||.4>a.random())),ej(e,t,e=>0!==e.roomLeft.roomType&&0!==e.roomRight.roomType&&e.roomLeft.roomType!==e.roomRight.roomType&&(e.roomLeft.group!==e.roomRight.group||.4>a.random())));let n=function(e,t){let o=[];for(let r of e)0!=r.dir[0]&&(r.roomLeft===t&&0!==r.roomRight.roomType&&r.dir[0]<0?o.push(r):0!==r.roomLeft.roomType&&r.roomRight===t&&r.dir[0]>0&&o.push(r));if(o.sort((e,t)=>e.origin[0]+e.dir[0]*e.length/2-(t.origin[0]+t.dir[0]*t.length/2)),!(o.length<=0))return o[Math.floor(o.length/2)]}(t,e[0]);if(void 0!==n&&(n.door=!0,n.doorType=1,eq(n)),a.randomInRange(r===es.Mansion?20:30)<e.length){let n=function(e,t){let o=[];for(let r of e)0!=r.dir[0]&&(r.roomLeft===t&&0!==r.roomRight.roomType&&r.dir[0]>0?o.push(r):0!==r.roomLeft.roomType&&r.roomRight===t&&r.dir[0]<0&&o.push(r));if(o.sort((e,t)=>e.origin[0]+e.dir[0]*e.length/2-(t.origin[0]+t.dir[0]*t.length/2)),!(o.length<=0))return o[Math.floor(o.length/2)]}(t,e[0]);void 0!==n&&(n.door=!0,n.doorType=r!==es.Fortress&&(o<3||.75>a.random())?2:3,eq(n))}if(a.randomInRange(r===es.Mansion?20:30)<e.length){let a=function(e,t){let o=[];for(let r of e)0==r.dir[1]||r.length<3||(1&r.length)!=0||r.roomLeft===t==(r.roomRight===t)||o.push(r);if(o.sort((e,t)=>e.origin[1]+e.dir[1]*e.length/2-(t.origin[1]+t.dir[1]*t.length/2)),!(o.length<=0))return o[Math.floor(o.length/2)]}(t,e[0]);if(void 0!==a){let e=r!==es.Fortress&&o<3?2:3;for(let t of eY(a))t.door=!0,t.doorType=e}}}(c,h,r,a,o),function(e,t,o){o.shuffleArray(t);for(let r=2*Math.floor(e.length/12);r>0;--r){let r=function(e,t,o){let r=[];for(let o of e){let e=o.roomLeft,a=o.roomRight;if(!o.door||e.roomType!==a.roomType||e===t||a===t)continue;if(0===o.dir[1]){if(o.length!==1+(e.posMax[0]-e.posMin[0])||o.length!==1+(a.posMax[0]-a.posMin[0]))continue}else if(o.length!==1+(e.posMax[1]-e.posMin[1])||o.length!==1+(a.posMax[1]-a.posMin[1]))continue;let n=Math.min(e.posMin[0],a.posMin[0]),i=Math.min(e.posMin[1],a.posMin[1]),s=Math.max(e.posMax[0],a.posMax[0]),l=Math.max(e.posMax[1],a.posMax[1]),f=s-n,u=l-i;if(f*u>750)continue;let c=Math.max(f,u)/Math.min(f,u);0!==e.roomType&&c>2||r.push([o,c])}if(!(r.length<=0))return o.shuffleArray(r),r.sort((e,t)=>e[1]-t[1]),r[0][0]}(t,e[0],o);if(void 0===r)break;tt(e,t,r)}}(c,h,o),a===es.Fortress&&(eQ(c),e0(c,r,a,o),function(e,t){for(let o of e){if(o.door||o.length<2)continue;let e=o.roomLeft,r=o.roomRight;if(0===e.roomType||5===e.roomType||0===r.roomType||5===r.roomType||eK(e)>1&&eK(r)>1||t.random()>=.4)continue;let a=Math.abs(e.depth-r.depth);o.door=!0,tK(e.roomType)&&tK(r.roomType)?o.doorType=0:a<2?o.doorType=0:o.doorType=3}}(h,o)),eQ(c),eJ(c),e1(c,r,a,o);let m=eU(a,c);tv(a,h,m),tM(r,a,c,m,o),m.backtrackingCoefficient=eZ(c),m.playerStartPos=tx(r,a,h,m);let g={rooms:[c[0]],path:function(e,t){let o=[],r=ty(e,t),a=W.clone(r),n=W.fromValues(1,0);for(let e=t.cells.sizeX*t.cells.sizeY;e>0;--e){o.push(W.clone(a));let e=W.fromValues(-n[1],n[0]),i=W.fromValues(n[1],-n[0]);if(t.cells.at(a[0]+n[0],a[1]+n[1]).type>=el.Wall0000){if(t.cells.at(a[0]+e[0],a[1]+e[1]).type<el.Wall0000)W.copy(n,e);else if(t.cells.at(a[0]+i[0],a[1]+i[1]).type<el.Wall0000)W.copy(n,i);else break}else if(!tX(t,a)){if(tX(t,W.fromValues(a[0]+e[0],a[1]+e[1])))W.copy(n,e);else if(tX(t,W.fromValues(a[0]+i[0],a[1]+i[1])))W.copy(n,i);else break}if(a.set(a[0]+n[0],a[1]+n[1]),a.equals(r)||a[0]<0||a[1]<0||a[0]>=t.cells.sizeX||a[1]>=t.cells.sizeY)break}return o}(h,m),minRoomDepth:c[0].depth,maxRoomDepth:c[0].depth};(function(e,t,o){let r=e.cells.sizeX,a=e.cells.sizeY;for(let o of t)e.cells.atVec(o).type=el.GroundNormal;tY(e,0,0,r,3,el.GroundNormal);let n=new ea(e.cells.sizeX,e.cells.sizeY,!1),i=[],s=[W.clone(e.playerStartPos)];for(let t=0;t<s.length;++t){let o=s[t];if(!n.get(o[0],o[1])&&(n.set(o[0],o[1],!0),!(e.cells.atVec(o).type>=el.Wall0000))){e.cells.atVec(o).type===el.GroundGrass&&i.push(o);for(let t=-1;t<=1;++t)for(let r=-1;r<=1;++r){let a=W.fromValues(o[0]+t,o[1]+r);a[0]>=0&&a[1]>=0&&a[0]<e.cells.sizeX&&a[1]<e.cells.sizeY&&!n.get(a[0],a[1])&&s.push(a)}}}for(let t of(o.shuffleArray(i),i.length=Math.floor(i.length/3),n.fill(!1),i))if(!n.get(t[0],t[1])){tV(e,t,ec.Bush);for(let e=Math.max(0,t[0]-1);e<Math.min(r,t[0]+2);++e)for(let o=Math.max(0,t[1]-1);o<Math.min(a,t[1]+2);++o)n.set(e,o,!0)}})(m,g.path,o),function(e){let t=e.cells.sizeX-1,o=Math.floor(t/2);for(let r=2;r<o;r+=5)e.cells.at(r,1).type=el.Wall0000,e.cells.at(t-r,1).type=el.Wall0000}(m),t3(m.cells),t2(m),r<1?t=[]:r<2?t=ta(m,c,o):(t=ti(a,r,m,c,h,o),r>5&&function(e,t){let o=e.path.length;t.push({rooms:e.rooms,path:tc(e.path,Math.floor(.25*o)),minRoomDepth:e.minRoomDepth,maxRoomDepth:e.maxRoomDepth}),t.push({rooms:e.rooms,path:tc(e.path,Math.floor(.75*o)),minRoomDepth:e.minRoomDepth,maxRoomDepth:e.maxRoomDepth})}(g,t));let x=void 0!==m.items.find(e=>e.type===ec.LockedDoorNS||e.type===ec.LockedDoorEW);eW(r,m,c,x,t,o);let y=Math.min(Math.floor(r/3),Math.min(t.length-+!!x,e.totalLoot));return tU(e.totalLoot-y,c,m,t,a,o),t0(m.bookTitle,c,m.items.filter(e=>e.type===ec.Bookshelf),o),tO(m,c,o),tz(r,m,c,o),t$(r,m,t,y,x,o),function(e){let t=new ea(e.cells.sizeX,e.cells.sizeY,!1),o=[e.playerStartPos];for(let r=0;r<o.length;++r){let a=o[r];if(!t.get(a[0],a[1])&&(t.set(a[0],a[1],!0),e.cells.atVec(a).seen=!0,++e.numPreRevealedCells,!(e.cells.atVec(a).type>=el.Wall0000)))for(let r=-1;r<=1;++r)for(let n=-1;n<=1;++n){let i=W.fromValues(a[0]+r,a[1]+n);i[0]>=0&&i[1]>=0&&i[0]<e.cells.sizeX&&i[1]<e.cells.sizeY&&!t.get(i[0],i[1])&&o.push(i)}}}(m),m.computeLighting(null),m.recomputeVisibility(m.playerStartPos),m.rooms=c.map(e=>({posMin:e.posMin,posMax:e.posMax})),m.adjacencies=h,m}function eW(e,t,o,r,a,n){if(e<2)return;if(e<8){eG(e,t,o,r,a,n);return}let i=o.find(e=>5===e.roomType);if(void 0===i){eG(e,t,o,r,a,n);return}let s=[el.GroundGrass,el.GroundMarble,el.GroundWood];for(let e of i.edges)if(3===e.doorType){let o=e.origin,r=5===e.roomLeft.roomType?e.roomRight:e.roomLeft;for(let n=0;n<e.length;n++){if(t.cells.atVec(o).type===el.DoorEW||t.cells.atVec(o).type===el.DoorNS){if(0===e.dir[0])for(let e of[-1,1]){let n=o.add(new W(e,0));if(s.includes(t.cells.atVec(n).type)){a.push({rooms:[r],path:[n],minRoomDepth:r.depth,maxRoomDepth:r.depth});return}}if(0===e.dir[1])for(let e of[-1,1]){let n=o.add(new W(0,e));if(s.includes(t.cells.atVec(n).type)){a.push({rooms:[r],path:[n],minRoomDepth:r.depth,maxRoomDepth:r.depth});return}}}o=o.add(e.dir)}}}function eG(e,t,o,r,a,n){let i=new ea(t.cells.sizeX,t.cells.sizeY,!1);for(let e of a)for(let t of e.path)i.set(t[0],t[1],!0);for(let e of t.items)(e.type===ec.Coin||e.type===ec.Health||e.type>=ec.TreasureA||e.type===ec.Note)&&i.set(e.pos[0],e.pos[1],!0);let s=[];if(e>=4)for(let e of t.items){if(e.type!==ec.Chair||i.get(e.pos[0],e.pos[1]))continue;let o=!1;for(let r of t.items)if(r.type===ec.Table&&Math.abs(r.pos[0]-e.pos[0])+Math.abs(r.pos[1]-e.pos[1])===1){o=!0;break}o&&s.push(e.pos)}for(let e of o){for(let o=e.posMin[0];o<e.posMax[0];++o)e.posMin[1]>0&&t.cells.at(o,e.posMin[1]-1).type==el.OneWayWindowS&&0===t.cells.at(o,e.posMin[1]).moveCost&&t.cells.at(o,e.posMin[1]+1).moveCost!==1/0&&!i.get(o,e.posMin[1])&&s.push(W.fromValues(o,e.posMin[1])),e.posMax[1]<t.cells.sizeY&&t.cells.at(o,e.posMax[1]).type==el.OneWayWindowN&&0===t.cells.at(o,e.posMax[1]-1).moveCost&&t.cells.at(o,e.posMax[1]-2).moveCost!==1/0&&!i.get(o,e.posMax[1]-1)&&s.push(W.fromValues(o,e.posMax[1]-1));for(let o=e.posMin[1];o<e.posMax[1];++o)e.posMin[0]>0&&t.cells.at(e.posMin[0]-1,o).type==el.OneWayWindowW&&0===t.cells.at(e.posMin[0],o).moveCost&&t.cells.at(e.posMin[0]+1,o).moveCost!==1/0&&!i.get(e.posMin[0],o)&&s.push(W.fromValues(e.posMin[0],o)),e.posMax[0]<t.cells.sizeX&&t.cells.at(e.posMax[0],o).type==el.OneWayWindowE&&0===t.cells.at(e.posMax[0]-1,o).moveCost&&t.cells.at(e.posMax[0]-2,o).moveCost!==1/0&&!i.get(e.posMax[0]-1,o)&&s.push(W.fromValues(e.posMax[0]-1,o))}if(s.length>0){let e=s[n.randomInRange(s.length)];for(let t of o)if(e[0]>=t.posMin[0]&&e[1]>=t.posMin[1]&&e[0]<t.posMax[0]&&e[1]<t.posMax[1]){let o=n.randomInRange(a.length+1);a.splice(o,0,{rooms:[t],path:[W.clone(e)],minRoomDepth:t.depth,maxRoomDepth:t.depth});return}}}function eV(e,t,o,r){let a=t.sizeX,n=e.sizeY,i=Number.MIN_SAFE_INTEGER;for(let t=0;t<n;++t)i=Math.max(i,-e.get(0,t));i+=o;for(let t=0;t<a+1;++t)for(let o=0;o<n;++o)e.set(t,o,e.get(t,o)+i);let s=Number.MIN_SAFE_INTEGER;for(let e=0;e<a;++e)s=Math.max(s,-t.get(e,0));s+=r;for(let e=0;e<a;++e)for(let o=0;o<n+1;++o)t.set(e,o,t.get(e,o)+s)}function eU(e,t){let o=0,r=0;for(let e of t)o=Math.max(o,e.posMax[0]),r=Math.max(r,e.posMax[1]);return o+=1,r+=1,e!==es.Warrens?(o+=2,r+=2):(o+=1,r+=1),new ex(new ef(o,r))}function eB(e,t,o,r){let a=e.sizeX,n=e.sizeY,i=new en(a,n,0),s=[];s.push({roomType:0,group:0,depth:0,betweenness:0,privateRoom:!1,posMin:W.fromValues(0,0),posMax:W.fromValues(0,0),edges:[],gridX:-1,gridY:-1});let l=+(r!==es.Mansion&&r!==es.Warrens);for(let r=0;r<a;++r)for(let a=0;a<n;++a){let n=s.length;i.set(r,a,n),s.push({roomType:e.get(r,a)?2:l,group:n,depth:0,betweenness:0,privateRoom:!1,posMin:W.fromValues(t.get(r,a)+1,o.get(r,a)+1),posMax:W.fromValues(t.get(r+1,a),o.get(r,a+1)),edges:[],gridX:r,gridY:a})}return[s,i]}function eN(e,t,o,r,a,n){let i=n.sizeX,s=n.sizeY,l=[];{let u=[];{let e=[];for(let t=0;t<i;++t){let i=o.get(t,0),s=o.get(t+1,0),f=r.get(t,0),u={origin:W.fromValues(i,f),dir:W.fromValues(1,0),length:s-i,roomLeft:a[n.get(t,0)],roomRight:a[0],nextMatching:null,door:!1,doorType:0};u.nextMatching=u,e.push(u),l.push(u)}u.push(e)}for(let e=1;e<s;++e){let t=[];function f(e,o,r,n,i){if(r-o<=0)return;let s={origin:W.fromValues(o,e),dir:W.fromValues(1,0),length:r-o,roomLeft:a[n],roomRight:a[i],nextMatching:null,door:!1,doorType:0};s.nextMatching=s,t.push(s),l.push(s)}let i=0,s=0;for(;i<o.sizeX&&s<o.sizeX;){let t=i<o.sizeX?o.get(i,e):1/0,a=s<o.sizeX?o.get(s,e-1):1/0,l=r.get(Math.max(0,Math.max(i,s)-1),e);t<a?(f(l,t,Math.min(a,i+1<o.sizeX?o.get(i+1,e):1/0),i>=n.sizeX?0:n.get(i,e),s<=0?0:n.get(s-1,e-1)),++i):(f(l,a,Math.min(t,s+1<o.sizeX?o.get(s+1,e-1):1/0),i<=0?0:n.get(i-1,e),s>=n.sizeX?0:n.get(s,e-1)),++s)}u.push(t)}{let e=[];for(let t=0;t<i;++t){let i=o.get(t,s-1),f=o.get(t+1,s-1),u=r.get(t,s),c={origin:W.fromValues(i,u),dir:W.fromValues(1,0),length:f-i,roomLeft:a[0],roomRight:a[n.get(t,s-1)],nextMatching:null,door:!1,doorType:0};c.nextMatching=c,e.push(c),l.push(c)}u.push(e)}if(e)for(let e=0;e<u.length;++e){let t=u[e],o=0,r=t.length-1;for(;o<=r;){let e=t[o],a=t[r];eO(e,a),o!==r&&(W.scaleAndAdd(a.origin,a.origin,a.dir,a.length),W.negate(a.dir,a.dir),[a.roomLeft,a.roomRight]=[a.roomRight,a.roomLeft]),o+=1,r-=1}}if(t){let e=0,t=u.length-1;for(;e<t;){let o=u[e],r=u[t];console.assert(o.length==r.length);for(let e=0;e<o.length;++e)eO(o[e],r[e]);e+=1,t-=1}}}{let f=[];{let e=[];for(let t=0;t<s;++t){let i=r.get(0,t),s=r.get(0,t+1),f=o.get(0,t),u={origin:W.fromValues(f,i),dir:W.fromValues(0,1),length:s-i,roomLeft:a[0],roomRight:a[n.get(0,t)],nextMatching:null,door:!1,doorType:0};u.nextMatching=u,e.push(u),l.push(u)}f.push(e)}for(let e=1;e<i;++e){let t=[];function u(e,o,r,n,i){if(r-o<=0)return;let s={origin:W.fromValues(e,o),dir:W.fromValues(0,1),length:r-o,roomLeft:a[n],roomRight:a[i],nextMatching:null,door:!1,doorType:0};s.nextMatching=s,t.push(s),l.push(s)}let i=0,s=0;for(;i<r.sizeY&&s<r.sizeY;){let t=i<r.sizeY?r.get(e-1,i):1/0,a=s<r.sizeY?r.get(e,s):1/0,l=o.get(e,Math.max(0,Math.max(i,s)-1));t<a?(u(l,t,Math.min(a,i+1<r.sizeY?r.get(e-1,i+1):1/0),i>=n.sizeY?0:n.get(e-1,i),s<=0?0:n.get(e,s-1)),++i):(u(l,a,Math.min(t,s+1<r.sizeY?r.get(e,s+1):1/0),i<=0?0:n.get(e-1,i-1),s>=n.sizeY?0:n.get(e,s)),++s)}f.push(t)}{let e=[];for(let t=0;t<s;++t){let s=r.get(i-1,t),f=r.get(i-1,t+1),u=o.get(i,t),c={origin:W.fromValues(u,s),dir:W.fromValues(0,1),length:f-s,roomLeft:a[n.get(i-1,t)],roomRight:a[0],nextMatching:null,door:!1,doorType:0};c.nextMatching=c,e.push(c),l.push(c)}f.push(e)}if(t)for(let e=0;e<f.length;++e){let t=f[e],o=Math.floor(t.length/2);for(let e=0;e<o;++e){let o=t[e],r=t[t.length-1-e];eO(o,r),W.scaleAndAdd(r.origin,r.origin,r.dir,r.length),W.negate(r.dir,r.dir),[r.roomLeft,r.roomRight]=[r.roomRight,r.roomLeft]}}if(e){let e=0,t=f.length-1;for(;e<t;){let o=f[e],r=f[t];for(let e=0;e<o.length;++e)eO(o[e],r[e]);e+=1,t-=1}}}return l}function eO(e,t){ez(e).nextMatching=t,ez(t).nextMatching=e}function ez(e){let t=e;for(;null!==t.nextMatching&&t.nextMatching!==e;)t=t.nextMatching;return t}function eq(e){ez(e).nextMatching=e.nextMatching,e.nextMatching=e}function eY(e){let t=[],o=e;for(;;){let r=o.nextMatching;if(t.push(o),null===r||r===e)break;o=r}return t}function eX(e){for(let t of e)t.roomLeft.edges.push(t),t.roomRight.edges.push(t)}function ej(e,t,o){let r=new Set;for(let a of t){if(r.has(a))continue;let t=eY(a);for(let e of t)r.add(e);if(console.assert(t.every(e=>e.length===a.length)),!(a.length<2)&&o(a))for(let o of t)o.door||(o.door=!0,o.doorType=0,function(e,t,o){if(t!==o)for(let r of e)r.group===t&&(r.group=o)}(e,o.roomLeft.group,o.roomRight.group))}}function eK(e){return e.edges.reduce((e,t)=>e+ +!!t.door,0)}function e$(e){return!(2!==e.roomType||e.edges.some(t=>t.door&&(t.roomLeft===e?t.roomRight.roomType:t.roomLeft.roomType)===0))}function eQ(e){let t=e.length,o=[];for(let r of e)0===r.roomType?r.depth=0:function(e){for(let t of e.edges)if(t.door&&3!==t.doorType){if(t.roomLeft===e){if(0===t.roomRight.roomType)return!0}else if(0===t.roomLeft.roomType)return!0}return!1}(r)?(r.depth=1,o.push(r)):r.depth=t;for(let e=0;e<o.length;++e){let t=o[e],r=t.depth+1;for(let e of t.edges){if(!e.door)continue;let a=e.roomLeft==t?e.roomRight:e.roomLeft;a.depth>r&&(a.depth=r,o.push(a))}}}function eJ(e){for(let t of e)t.betweenness=0;for(let t of e){let o=new Map,r=new Map,a=new Map;for(let t of e)a.set(t,1/0),r.set(t,0),o.set(t,0);a.set(t,0),o.set(t,1);let n=[];n.push(t);let i=[];for(;;){let e=n.shift();if(void 0===e)break;i.push(e);let t=(a.get(e)??0)+1;for(let r of e.edges){if(!r.door)continue;let a=r.roomLeft===e?r.roomRight:r.roomLeft;0!==a.roomType&&(a.depth===1/0&&(a.depth=t,n.push(a)),a.depth===t&&o.set(a,(o.get(a)??0)+(o.get(e)??0)))}}let s=0===t.roomType?10:1;for(;;){let e=i.pop();if(void 0===e)break;let n=(a.get(e)??0)-1,l=o.get(e)??1,f=r.get(e)??0;for(let i of e.edges){if(!i.door)continue;let u=i.roomLeft===e?i.roomRight:i.roomLeft;if(a.get(u)!==n)continue;let c=(o.get(u)??0)/l*(1+f);r.set(u,c),e!==t&&(e.betweenness+=f*s)}}}}function eZ(e){let t=new Map;for(let o of e)for(let r of(t.set(o,new Map),e))t.get(o).set(r,1/0);for(let o of e)for(let e of(t.get(o).set(o,0),o.edges)){if(!e.door)continue;let r=e.roomLeft===o?e.roomRight:e.roomLeft;t.get(o).set(r,1)}for(let o of e)for(let r of e)for(let a of e){let e=t.get(r).get(a),n=t.get(r).get(o),i=t.get(o).get(a);e>n+i&&t.get(r).set(a,n+i)}let o=new Set,r=e[0],a=0;for(;o.size<e.length;){o.add(r);let n=r,i=1/0;for(let a of e)if(a!==r&&!o.has(a)){let e=t.get(r).get(a);e<i&&(n=a,i=e)}if(i===1/0)break;r=n,a+=i}return a/(e.length-1)}function e0(e,t,o,r){let a=[];for(let r of e){if(0===r.roomType||t>=8&&r.depth<3||o===es.Fortress&&tK(r.roomType))continue;let e=0;for(let t of r.edges)t.door&&++e;e<=1&&a.push(r)}if(a.length>0){r.shuffleArray(a),a.sort((e,t)=>e2(e)-e2(t));let e=a[0];for(let t of(e.roomType=5,e.edges))t.door&&(t.doorType=3)}}function e1(e,t,o,r){let a=0;for(let t of e)a=Math.max(a,t.depth);let n=e.length-1,i=Math.floor(n/4),s=0,l=a;for(;l>0;){for(let t of e)(2==t.roomType||1==t.roomType)&&t.depth==l&&(t.roomType=2==t.roomType?4:3,t.privateRoom=!0,4==t.roomType&&(s+=1));if(s>=i)break;l-=1}for(;;){let t=!1;for(let o of e)if(3==o.roomType){for(let e of o.edges)if(1==(e.roomLeft!=o?e.roomLeft:e.roomRight).roomType){o.roomType=1,o.privateRoom=!0,t=!0;break}}if(!t)break}for(let a of(t>4&&o!==es.Fortress&&e0(e,t,o,r),e)){if(4!==a.roomType)continue;let e=a.posMax[0]-a.posMin[0],t=a.posMax[1]-a.posMin[1];if(e<3&&t<3||e*t>25)continue;let o=0;for(let e of a.edges)e.door&&++o;o>2||(a.roomType=6)}if(o===es.Fortress)for(let t of e3(e,e9,1,r))t.roomType=15;if(n>=8)for(let t of e3(e,e5,1,r))t.roomType=10;for(let t of e3(e,e6,Math.ceil(e.length/21),r))t.roomType=7;for(let t of e3(e,e7,Math.ceil(e.length/42),r))t.roomType=8;for(let t of e3(e,te,Math.ceil(e.length/42),r))t.roomType=9;let f=0;for(let t of e)(8===t.roomType||9===t.roomType)&&(f+=(t.posMax[0]-t.posMin[0])*(t.posMax[1]-t.posMin[1]));if(f>=30||9===t){let o=f>=60;for(let a of e3(e,e8,9===t?2:1,r))tK(a.roomType)?a.roomType=o?14:12:a.roomType=o?13:11}}function e2(e){return(e.posMax[0]-e.posMin[0])*(e.posMax[1]-e.posMin[1])}function e3(e,t,o,r){let a=e.filter(t);return r.shuffleArray(a),a.slice(0,o)}function e5(e){if(2!==e.roomType&&4!==e.roomType)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(3>Math.min(t,o)||Math.max(t,o)>7||e4(e))}function e4(e){for(let t of e.edges)if(t.door&&(t.roomLeft===e&&0===t.roomRight.roomType||t.roomRight===e&&0===t.roomLeft.roomType))return!0;return!1}function e8(e){if(e.depth<2||2!==e.roomType&&4!==e.roomType&&1!==e.roomType&&3!==e.roomType&&6!==e.roomType)return!1;let t=e.posMax[0]-e.posMin[0];if((1&t)==0||t<3||t>7)return!1;let o=e.posMax[1]-e.posMin[1];return(1&o)!=0&&!(o<3)&&!(o>7)}function e9(e){if(2!==e.roomType&&4!==e.roomType||e.depth<2||e4(e))return!1;let t=e.posMax[0]-e.posMin[0];if(t<3)return!1;let o=e.posMax[1]-e.posMin[1];if(o<3||t<4&&o<5||t<5&&o<4)return!1;if(t<o){if(tI(e,0,-1)>0&&tI(e,0,1)>0)return!1}else if(o<t){if(tI(e,-1,0)>0&&tI(e,1,0)>0)return!1}else if(tI(e,0,-1)>0&&tI(e,0,1)>0&&tI(e,-1,0)>0&&tI(e,1,0)>0)return!1;return!0}function e6(e){return(2===e.roomType||4===e.roomType)&&!(e.posMax[0]-e.posMin[0]<5)&&!(e.posMax[1]-e.posMin[1]<5)}function e7(e){if(2!==e.roomType)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(4>Math.min(t,o)||5>Math.max(t,o))}function te(e){if(4!==e.roomType)return!1;let t=e.posMax[0]-e.posMin[0],o=e.posMax[1]-e.posMin[1];return!(4>Math.min(t,o)||5>Math.max(t,o))}function tt(e,t,o){let r=o.roomLeft,a=o.roomRight;for(let e of a.edges)e!==o&&(r.edges.push(e),e.roomLeft===a?e.roomLeft=r:(console.assert(e.roomRight===a),e.roomRight=r));let n=W.fromValues(Math.min(r.posMin[0],a.posMin[0]),Math.min(r.posMin[1],a.posMin[1])),i=W.fromValues(Math.max(r.posMax[0],a.posMax[0]),Math.max(r.posMax[1],a.posMax[1]));for(W.copy(r.posMin,n),W.copy(r.posMax,i),r.depth=Math.min(r.depth,a.depth),eq(o),to(t,o),to(r.edges,o),to(e,a);function(e,t){for(let o of t.edges)for(let r of t.edges){if(o===r||!function(e,t){if(1!==Math.abs(e.dir.dot(t.dir)))return!1;let o=W.create();W.scaleAndAdd(o,e.origin,e.dir,e.length);let r=W.create();if(W.scaleAndAdd(r,t.origin,t.dir,t.length),t.roomLeft===e.roomLeft&&t.roomRight===e.roomRight){if(o.equals(t.origin)||r.equals(e.origin))return!0}else if(t.roomLeft===e.roomRight&&t.roomRight===e.roomLeft&&(o.equals(r)||e.origin.equals(t.origin)))return!0;return!1}(o,r))continue;let a=o.dir[0]>=0?Math.min(o.origin[0],r.origin[0]):Math.max(o.origin[0],r.origin[0]),n=o.dir[1]>=0?Math.min(o.origin[1],r.origin[1]):Math.max(o.origin[1],r.origin[1]),i=o.length+r.length;o.origin[0]=a,o.origin[1]=n,o.length=i,eq(o),eq(r),o.door=o.door||r.door,o.doorType=Math.max(o.doorType,r.doorType);let s=o.roomLeft===t?o.roomRight:o.roomLeft;return to(t.edges,r),to(s.edges,r),to(e,r),!0}return!1}(t,r););}function to(e,t){let o=e.indexOf(t);e.splice(o,1)}function tr(e,t){let o=new Set;for(let t of e)0!==t.roomType&&5!==t.roomType&&o.add(t);let r=new Set,a=[],n=Array.from(o);return!function e(n){a.push(n),r.add(n);let i=[...n.edges];for(let s of(t.shuffleArray(i),i)){if(!s.door)continue;let t=s.roomLeft===n?s.roomRight:s.roomLeft;!r.has(t)&&o.has(t)&&(e(t),a.push(n))}}(n[t.randomInRange(n.length)]),--a.length,function(e){let t=[];for(let o of e)t.push({room:o,nodeNext:null,nodePrev:null,visited:!1});for(let o=0;o<e.length;++o)t[o].nodeNext=t[(o+1)%t.length],t[o].nodePrev=t[(o+t.length-1)%t.length];return t}(a)}function ta(e,t,o){let r=tu(tr(t,o),e,o);return console.assert(1===r.length),r}function tn(e){for(let t of e)if(null!==t.nodeNext&&null!==t.nodePrev&&t.nodeNext.room===t.nodePrev.room)return t}function ti(e,t,o,r,a,n){let i=a.filter(t=>t.door&&tl(e,t.roomLeft)&&tl(e,t.roomRight));n.shuffleArray(i);let s=[],l=new Map,f=26-2*t;for(let e of i){let t=e.roomLeft,o=e.roomRight,r=l.get(t);void 0===r&&(r=[],l.set(t,r));let a=l.get(o);void 0===a&&(a=[],l.set(o,a));let i=tn(r),u=tn(a);if(i){if(u){if(!function(e,t,o){if(td(e,t)){if(!function(e,t){let o=e.nodePrev,r=e.nodeNext;for(;;){if(o===r)return o===t;if(null===o||null===r||o===e||r===e||o.room!==r.room)return!1;o=o.nodePrev,r=r.nodeNext}}(e,t)||4>=tp(e))return!1}else if(tp(e)+tp(t)+2>o)return!1;return!0}(i,u,f))continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},c={room:o,nodeNext:null,nodePrev:null,visited:!1},d=i.nodeNext,p=u.nodeNext;i.nodeNext=c,c.nodePrev=i,c.nodeNext=p,null!==p&&(p.nodePrev=c),u.nodeNext=e,e.nodePrev=u,e.nodeNext=d,null!==d&&(d.nodePrev=e),r.push(e),a.push(c),s.push(e),s.push(c),td(i,u)||(.5>n.random()?tf(i,s,l):tf(u,s,l))}else{if(tp(i)+2>f)continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1},l=i.nodeNext;i.nodeNext=n,n.nodePrev=i,n.nodeNext=e,e.nodePrev=n,e.nodeNext=l,null!==l&&(l.nodePrev=e),r.push(e),a.push(n),s.push(e),s.push(n)}}else if(u){if(tp(u)+2>f)continue;let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1},i=u.nodeNext;u.nodeNext=e,e.nodePrev=u,e.nodeNext=n,n.nodePrev=e,n.nodeNext=i,null!==i&&(i.nodePrev=n),r.push(e),a.push(n),s.push(e),s.push(n)}else{let e={room:t,nodeNext:null,nodePrev:null,visited:!1},n={room:o,nodeNext:null,nodePrev:null,visited:!1};e.nodeNext=n,e.nodePrev=n,n.nodeNext=e,n.nodePrev=e,r.push(e),a.push(n),s.push(e),s.push(n)}}for(let t of r){if(!tl(e,t))continue;{let e=l.get(t);if(void 0!==e&&e.length>0)continue}let o=t.edges.filter(t=>t.door&&tl(e,t.roomLeft)&&tl(e,t.roomRight));if(0===o.length)continue;let r=o[n.randomInRange(o.length)],a=r.roomLeft,i=r.roomRight,f=l.get(a);void 0===f&&(f=[],l.set(a,f));let u=l.get(i);void 0===u&&(u=[],l.set(i,u));let c={room:a,nodeNext:null,nodePrev:null,visited:!1},d={room:i,nodeNext:null,nodePrev:null,visited:!1};c.nodeNext=d,c.nodePrev=d,d.nodeNext=c,d.nodePrev=c,f.push(c),u.push(d),s.push(c),s.push(d)}for(let e of s)e.visited=!1;for(let e of s){if(e.visited)continue;if(tp(e)>2){th(e);continue}let t=Number.MAX_SAFE_INTEGER,o=[],r=e.nodeNext,a=e.room,i=r.room,s=l.get(a),f=l.get(i);for(let r of s){if(r===e)continue;let a=tp(r);a>t||(a<t&&(t=a,o.length=0),o.push([e,r]))}for(let e of f){if(e===r)continue;let a=tp(e);a>t||(a<t&&(t=a,o.length=0),o.push([r,e]))}if(0===o.length){th(e);continue}let[u,c]=o[n.randomInRange(o.length)],d=u.nodePrev,p=c.nodePrev;d.nodeNext=c,c.nodePrev=d,p.nodeNext=u,u.nodePrev=p,th(e)}for(let e of i){let t=e.roomLeft,o=e.roomRight,r=l.get(t);void 0===r&&(r=[],l.set(t,r));let a=l.get(o);void 0===a&&(a=[],l.set(o,a));let n=ts(r),i=ts(a);if(void 0===n||void 0===i||td(n,i))continue;let f=tp(n),u=tp(i);if(f>2&&u>2)continue;let c={room:t,nodeNext:null,nodePrev:null,visited:!1},d={room:o,nodeNext:null,nodePrev:null,visited:!1},p=n.nodeNext,h=i.nodePrev;n.nodeNext=i,i.nodePrev=n,h.nodeNext=d,d.nodePrev=h,d.nodeNext=c,c.nodePrev=d,c.nodeNext=p,p.nodePrev=c,r.push(c),a.push(d),s.push(c),s.push(d)}return t>=8&&(s=s.concat(tr(r,n))),tu(s,o,n)}function ts(e){let t;if(void 0===e)return;let o=Number.MAX_SAFE_INTEGER;for(let r of e){let e=tp(r);e<o&&(o=e,t=r)}return t}function tl(e,t){return 5!==t.roomType&&(0!==t.roomType||e===es.Warrens&&!(t.gridX<0))}function tf(e,t,o){if(null!==e.nodePrev)for(e.nodePrev.nodeNext=null;;){let r=e.nodeNext;e.nodePrev=null,e.nodeNext=null,to(t,e);let a=o.get(e.room);if(void 0!==a&&to(a,e),null===r)break;e=r}}function tu(e,t,o){for(let t of e)t.visited=!1;let r=[];for(let a of e){if(a.visited)continue;if(null==a.nodeNext&&null==a.nodePrev){a.visited=!0;continue}let e=function(e){let t=e;for(;null!=t.nodePrev&&(t=t.nodePrev)!=e;);return t}(a),n=[],i=new Set;for(let r=e;null!=r&&!r.visited;r=r.nodeNext){r.visited=!0;let e=r.nodeNext,a=r.nodePrev;if(null==e||null==a)continue;let s=r.room,l=e.room,f=a.room;i.add(s);let u=W.create();if(tm(u,s,f,t),l===f){let e=function(e,t){let o=[];for(let r=t.posMin[0];r<t.posMax[0];++r)t.posMin[1]>0&&e.cells.at(r,t.posMin[1]-1).type==el.OneWayWindowS&&0===e.cells.at(r,t.posMin[1]).moveCost&&o.push(W.fromValues(r,t.posMin[1])),t.posMax[1]<e.cells.sizeY&&e.cells.at(r,t.posMax[1]).type==el.OneWayWindowN&&0===e.cells.at(r,t.posMax[1]-1).moveCost&&o.push(W.fromValues(r,t.posMax[1]-1));for(let r=t.posMin[1];r<t.posMax[1];++r)t.posMin[0]>0&&e.cells.at(t.posMin[0]-1,r).type==el.OneWayWindowW&&0===e.cells.at(t.posMin[0],r).moveCost&&o.push(W.fromValues(t.posMin[0],r)),t.posMax[0]<e.cells.sizeX&&e.cells.at(t.posMax[0],r).type==el.OneWayWindowE&&0===e.cells.at(t.posMax[0]-1,r).moveCost&&o.push(W.fromValues(t.posMax[0]-1,r));if(o.length>0)return o;for(let r of e.items)r.type==ec.Chair&&r.pos[0]>=t.posMin[0]&&r.pos[1]>=t.posMin[1]&&r.pos[0]<t.posMax[0]&&r.pos[1]<t.posMax[1]&&o.push(W.clone(r.pos));return o}(t,s),r=W.create();for(let a of(e.length>0?W.copy(r,e[o.randomInRange(e.length)]):tg(r,s,f,t),t_(t,s,u,r)))n.push(a);n.push(W.clone(r));let a=t.tryGetPosLookAt(r,!1);if(void 0!==a){let e=W.create();W.subtract(e,a,r),function(e,t){let o=W.create();for(let r=t.length-1;r>0&&(W.subtract(o,t[r],t[r-1]),!o.equals(e));--r)if(0>=W.dot(o,e))return!0;return!1}(e,n)&&n.push(W.clone(r))}n.push(W.clone(r)),n.push(W.clone(r)),W.copy(u,r)}let c=W.create();for(let e of(tm(c,s,l,t),t_(t,s,u,c)))n.push(e)}let s=tc(n,o.randomInRange(n.length)),l=Array.from(i),f=l.reduce((e,t)=>Math.min(e,t.depth),1/0),u=l.reduce((e,t)=>Math.max(e,t.depth),0);r.push({rooms:l,path:s,minRoomDepth:f,maxRoomDepth:u})}return o.shuffleArray(r),r}function tc(e,t){let o=[];for(let r=t;r<e.length;++r)o.push(e[r]);for(let r=0;r<t;++r)o.push(e[r]);return o}function td(e,t){let o=e;for(;;){if(o===t)return!0;if(null===o.nodeNext||(o=o.nodeNext)===e)break}return!1}function tp(e){let t=0,o=e;for(;++t,null!==o.nodeNext&&(o=o.nodeNext)!==e;);return t}function th(e){let t=e;for(;t.visited=!0,null!==t.nodeNext&&(t=t.nodeNext)!==e;);}function tm(e,t,o,r){for(let a of t.edges)if(a.roomLeft===t&&a.roomRight===o||a.roomLeft===o&&a.roomRight===t){let t=W.create();for(let o=1;o<a.length;++o){W.scaleAndAdd(t,a.origin,a.dir,o);let n=r.cells.atVec(t).type;if(n>=el.PortcullisNS&&n<=el.GardenDoorEW||n<=el.GroundTreasure){W.copy(e,t);return}}}W.zero(e)}function tg(e,t,o,r){for(let a of t.edges){if(a.roomLeft===t&&a.roomRight===o){let n=W.create();tm(n,t,o,r);let i=W.fromValues(-a.dir[1],a.dir[0]);W.scaleAndAdd(e,n,i,2),0!=r.cells.at(e[0],e[1]).moveCost&&W.scaleAndAdd(e,n,i,1);return}if(a.roomLeft===o&&a.roomRight===t){let n=W.create();tm(n,t,o,r);let i=W.fromValues(a.dir[1],-a.dir[0]);W.scaleAndAdd(e,n,i,2),0!=r.cells.at(e[0],e[1]).moveCost&&W.scaleAndAdd(e,n,i,1);return}}W.zero(e)}function tx(e,t,o,r){let a;return t===es.Warrens?a=W.fromValues(Math.floor(r.cells.sizeX/2),1):(a=ty(o,r),0===e&&(a[0]-=Math.max(0,4-a[1]),a[1]=Math.max(0,a[1]-4))),a}function ty(e,t){let o,r,a;let n=0;for(let t of e){if(!t.door||0===t.roomLeft.roomType==(0===t.roomRight.roomType))continue;let e=t.origin[1]+Math.max(0,t.dir[1])*t.length;(void 0===a||e<n)&&(a=t,n=e)}if(void 0===a)return W.fromValues(0,0);0===a.roomLeft.roomType?(o=a.roomRight,r=a.roomLeft):(o=a.roomLeft,r=a.roomRight);let i=W.create();return tg(i,r,o,t),i}function t_(e,t,o,r){let a=Math.max(0,t.posMin[0]-1),n=Math.max(0,t.posMin[1]-1),i=Math.min(e.cells.sizeX,t.posMax[0]+1),s=Math.min(e.cells.sizeY,t.posMax[1]+1),l=e.computeDistancesToPositionSubrect(r,a,n,i,s),f=W.clone(o),u=[];for(;!f.equals(r);){u.push(W.clone(f));let o=function(e,t,o,r){let a=1/0,n=W.clone(r),i=Math.max(0,t.posMin[0]-1),s=Math.max(0,t.posMin[1]-1),l=Math.min(e.cells.sizeX,t.posMax[0]+1),f=Math.min(e.cells.sizeY,t.posMax[1]+1),u=W.fromValues(Math.max(i,r[0]-1),Math.max(s,r[1]-1)),c=W.fromValues(Math.min(l,r[0]+2),Math.min(f,r[1]+2));for(let t=u[0];t<c[0];++t)for(let l=u[1];l<c[1];++l){let f=o.get(t-i,l-s);if(f==1/0)continue;let u=W.fromValues(t,l);e.guardMoveCost(r,u)!=1/0&&f<a&&(a=f,n=u)}if(n.equals(r)){console.log("failed to proceed");for(let e=u[0];e<c[0];++e)for(let t=u[1];t<c[1];++t){let r=o.get(e-i,t-s);console.log(e,t,r)}}return n}(e,t,l,f);if(o.equals(f))break;W.copy(f,o)}return u}const tS=[el.OneWayWindowS,el.OneWayWindowE,el.OneWayWindowN,el.OneWayWindowW];function tv(e,t,o){for(let e of t){let t=e.roomLeft.roomType,r=e.roomRight.roomType;if(!(tK(t)&&tK(r))&&(0!==t||0!==r))for(let t=0;t<e.length+1;++t){let r=W.create();W.scaleAndAdd(r,e.origin,e.dir,t),o.cells.atVec(r).type=el.Wall0000}}let r=new Set;for(let a of t){if(r.has(a))continue;let t=eY(a);for(let e of t)r.add(e);for(let r of t){if(r.door)continue;let t=r.roomLeft.roomType,a=r.roomRight.roomType;if(5===t||5===a||0===t&&0===a)continue;let n=W.clone(r.dir);if(0===t!=(0===a))0==a&&W.negate(n,n);else if(tK(t)===tK(a))continue;else if(tK(a)){if(e===es.Fortress&&r.roomLeft.depth+1<r.roomRight.depth)continue;W.negate(n,n)}else if(e===es.Fortress&&r.roomRight.depth+1<r.roomLeft.depth)continue;let i=tS[n[0]+2*Math.max(0,n[1])+1];if(e===es.Fortress&&(0===t||0===a)){if(r.length>2&&(1&r.length)==0){let e=W.clone(r.origin).scaleAndAdd(r.dir,r.length/2);o.cells.atVec(e).type=i}}else if(5===r.length){let e=W.clone(r.origin).scaleAndAdd(r.dir,2+(r.origin[0]+r.origin[1]&1));o.cells.atVec(e).type=i}else{let e=1+Math.floor(r.length/2)-(1&r.length);for(let t=2;t<e;t+=2){let e=W.clone(r.origin).scaleAndAdd(r.dir,t),a=W.clone(r.origin).scaleAndAdd(r.dir,r.length-t);o.cells.atVec(e).type=i,o.cells.atVec(a).type=i}}}for(let e of t){if(!e.door)continue;let t=Math.floor(e.length/2),r=W.clone(e.origin).scaleAndAdd(e.dir,t),a=0==e.dir[0],n=e.roomLeft.roomType,i=e.roomRight.roomType;(0!==n||0!==i)&&(1===e.doorType||2===e.doorType?(o.cells.atVec(r).type=a?el.PortcullisNS:el.PortcullisEW,tV(o,r,a?ec.PortcullisNS:ec.PortcullisEW)):3===e.doorType?(o.cells.atVec(r).type=a?el.DoorNS:el.DoorEW,tV(o,r,a?ec.LockedDoorNS:ec.LockedDoorEW)):tK(n)&&tK(i)?o.cells.atVec(r).type=a?el.GardenDoorNS:el.GardenDoorEW:tK(n)||tK(i)||!e.roomLeft.privateRoom||!e.roomRight.privateRoom||6===n!=(6===i)?(o.cells.atVec(r).type=a?el.DoorNS:el.DoorEW,tV(o,r,a?ec.DoorNS:ec.DoorEW)):o.cells.atVec(r).type=a?el.DoorNS:el.DoorEW)}}}function tM(e,t,o,r,a){for(let n=1;n<o.length;++n){let i;let s=o[n];switch(s.roomType){case 0:i=t===es.Warrens?el.GroundNormal:el.GroundGrass;break;case 1:case 3:case 12:case 14:i=el.GroundGrass;break;case 2:case 8:case 10:case 15:i=el.GroundWood;break;case 4:case 6:case 9:i=el.GroundMarble;break;case 5:i=el.GroundVault;break;case 7:case 11:case 13:i=s.privateRoom?el.GroundMarble:el.GroundWood}tY(r,s.posMin[0],s.posMin[1],s.posMax[0],s.posMax[1],i),1===s.roomType||3===s.roomType?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1];if(a>=5&&n>=5)tY(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,el.GroundWater);else if(a>=2&&n>=2){let i=[ec.Bush,ec.Bush,ec.Bush,ec.Bush];a>2&&n>2&&i.push(tE(o,r)),r.shuffleArray(i);let s=[W.fromValues(t.posMin[0],t.posMin[1]),W.fromValues(t.posMax[0]-1,t.posMin[1]),W.fromValues(t.posMin[0],t.posMax[1]-1),W.fromValues(t.posMax[0]-1,t.posMax[1]-1)];for(let t=0;t<s.length;++t){let o=s[t];e.cells.atVec(o).type===el.GroundGrass&&tF(e,o,i[t])}}}(r,s,e,a):2===s.roomType||4===s.roomType?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1];if(a>=5&&n>=5){if(4===t.roomType)a>n?a>7&&tY(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,el.GroundWater):n>a?n>7&&tY(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,el.GroundWater):a>=7?(tY(e,t.posMin[0]+3,t.posMin[1]+1,t.posMax[0]-3,t.posMax[1]-1,el.GroundWater),tY(e,t.posMin[0]+1,t.posMin[1]+3,t.posMax[0]-1,t.posMax[1]-3,el.GroundWater)):tY(e,t.posMin[0]+1,t.posMin[1]+1,t.posMax[0]-1,t.posMax[1]-1,el.GroundWater);else if(a>n)for(let o=t.posMin[0]+3;o<t.posMax[0]-3;++o)tV(e,W.fromValues(o,t.posMin[1]+1),ec.Chair),tV(e,W.fromValues(o,t.posMax[1]-2),ec.Chair);else if(n>a)for(let o=t.posMin[1]+3;o<t.posMax[1]-3;++o)tV(e,W.fromValues(t.posMin[0]+1,o),ec.Chair),tV(e,W.fromValues(t.posMax[0]-2,o),ec.Chair);else 5===a&&5===n&&(tV(e,W.fromValues(t.posMin[0]+1,t.posMin[1]+1),ec.Table),tV(e,W.fromValues(t.posMin[0]+2,t.posMin[1]+1),ec.Chair),tV(e,W.fromValues(t.posMin[0]+1,t.posMin[1]+2),ec.Chair),tV(e,W.fromValues(t.posMax[0]-2,t.posMax[1]-2),tE(o,r)));if(a>5||n>5){if(e.cells.at(t.posMin[0]+1,t.posMin[1]+1).type=el.Wall0000,e.cells.at(t.posMax[0]-2,t.posMin[1]+1).type=el.Wall0000,e.cells.at(t.posMin[0]+1,t.posMax[1]-2).type=el.Wall0000,e.cells.at(t.posMax[0]-2,t.posMax[1]-2).type=el.Wall0000,a>n){let a=Math.floor(n/2);tV(e,W.fromValues(t.posMin[0]+1,t.posMin[1]+a),tb(o,r)),tV(e,W.fromValues(t.posMax[0]-2,t.posMax[1]-(a+1)),tb(o,r))}else if(n>a){let n=Math.floor(a/2);tV(e,W.fromValues(t.posMin[0]+n,t.posMin[1]+1),tb(o,r)),tV(e,W.fromValues(t.posMax[0]-(n+1),t.posMax[1]-2),tb(o,r))}}}else if(5==a&&n>=3&&(2==t.roomType||.33333>r.random())){let a=Array(n-2).fill(ec.Table);a.push(tE(o,r)),r.shuffleArray(a);for(let o=1;o<n-1;++o)tV(e,W.fromValues(t.posMin[0]+1,t.posMin[1]+o),ec.Chair),tV(e,W.fromValues(t.posMin[0]+2,t.posMin[1]+o),a[o-1]),tV(e,W.fromValues(t.posMin[0]+3,t.posMin[1]+o),ec.Chair)}else if(5==n&&a>=3&&(2==t.roomType||.33333>r.random())){let n=Array(a-2).fill(ec.Table);n.push(tE(o,r)),r.shuffleArray(n);for(let o=1;o<a-1;++o)tV(e,W.fromValues(t.posMin[0]+o,t.posMin[1]+1),ec.Chair),tV(e,W.fromValues(t.posMin[0]+o,t.posMin[1]+2),n[o-1]),tV(e,W.fromValues(t.posMin[0]+o,t.posMin[1]+3),ec.Chair)}else if(a>n&&(1&n)==1&&.66667>r.random()){let a=Math.floor(t.posMin[1]+n/2),i=2==t.roomType?ec.Table:ec.Chair,s=[tE(o,r),i];r.shuffleArray(s),tF(e,W.fromValues(t.posMin[0]+1,a),s[0]),tF(e,W.fromValues(t.posMax[0]-2,a),s[1])}else if(n>a&&(1&a)==1&&.66667>r.random()){let n=Math.floor(t.posMin[0]+a/2),i=2==t.roomType?ec.Table:ec.Chair,s=[tE(o,r),i];r.shuffleArray(s),tF(e,W.fromValues(n,t.posMin[1]+1),s[0]),tF(e,W.fromValues(n,t.posMax[1]-2),s[1])}else if(a>=5&&3===n){let a=Math.floor(t.posMin[1]+n/2);tF(e,W.fromValues(t.posMin[0]+1,a),tE(o,r)),tF(e,W.fromValues(t.posMax[0]-2,a),tE(o,r))}else if(n>=5&&3===a){let n=Math.floor(t.posMin[0]+a/2);tF(e,W.fromValues(n,t.posMin[1]+1),tE(o,r)),tF(e,W.fromValues(n,t.posMax[1]-2),tE(o,r))}else if(a>=3&&n>=3){let a=2==t.roomType?ec.Table:ec.Chair,n=[tE(o,r),a,a,a];r.shuffleArray(n),tF(e,W.fromValues(t.posMin[0],t.posMin[1]),n[0]),tF(e,W.fromValues(t.posMax[0]-1,t.posMin[1]),n[1]),tF(e,W.fromValues(t.posMin[0],t.posMax[1]-1),n[2]),tF(e,W.fromValues(t.posMax[0]-1,t.posMax[1]-1),n[3])}}(r,s,e,a):5===s.roomType?function(e,t,o){let r=t.posMax[0]-t.posMin[0],a=t.posMax[1]-t.posMin[1],n=new ea(r,a,!0),i=new ea(r,a,!1),s=new ea(r,a,!1),l=W.create(),f=W.create();for(let o of t.edges)for(let r=0;r<o.length;++r)if(W.scaleAndAdd(l,o.origin,o.dir,r),!(e.cells.atVec(l).type<el.PortcullisNS)){W.set(f,-o.dir[1],o.dir[0]);for(let e=-2;e<3;++e)W.scaleAndAdd(l,o.origin,o.dir,r),W.scaleAndAdd(l,l,f,e),l[0]>=t.posMin[0]&&l[1]>=t.posMin[1]&&l[0]<t.posMax[0]&&l[1]<t.posMax[1]&&i.set(l[0]-t.posMin[0],l[1]-t.posMin[1],!0)}if(r>=5&&a>=5){let o=[W.fromValues(t.posMin[0]+1,t.posMin[1]+1),W.fromValues(t.posMax[0]-2,t.posMin[1]+1),W.fromValues(t.posMin[0]+1,t.posMax[1]-2),W.fromValues(t.posMax[0]-2,t.posMax[1]-2)];if(!o.some(e=>i.get(e[0]-t.posMin[0],e[1]-t.posMin[1])))for(let t of o)e.cells.atVec(t).type=el.Wall0000}let u=!1,c=0,d=0;for(let o=0;o<r;++o)for(let r=0;r<a;++r){if(!tW(e.cells.at(o+t.posMin[0],r+t.posMin[1]).type)){s.set(o,r,!0),i.set(o,r,!0);continue}tk(e.cells,W.fromValues(o+t.posMin[0],r+t.posMin[1]))&&(u=!0,c=o,d=r)}if(!u)return;let p=[ec.VaultTreasureBox,ec.VaultTreasureBox,ec.DrawersTall,ec.DrawersShort,ec.Chair,ec.Table,ec.Bookshelf,ec.Shelf,ec.TorchUnlit];o.shuffleArray(p);let h=[];for(let r=0;;r=(r+1)%p.length){for(let e=0;e<n.values.length;++e)n.values[e]=+!i.values[e];tw(n,s,c,d),tA(n,s,h,t);let a=tC(n);if(0===a.length)break;let l=a[o.randomInRange(a.length)];console.assert(n.get(l[0],l[1])),console.assert(!s.get(l[0],l[1]));let f=p[r],u={pos:W.fromValues(l[0]+t.posMin[0],l[1]+t.posMin[1]),type:f,topLayer:ed[f]};e.items.push(u),h.push(u),s.set(l[0],l[1],!0),i.set(l[0],l[1],!0),f===ec.VaultTreasureBox&&(p.splice(r,1),--r)}}(r,s,a):6===s.roomType?function(e,t,o,r){let a,n;let i=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1],l=new ea(i,s,!0),f=new ea(i,s,!1),u=new ea(i,s,!1),c=new ea(i,s,!1),d=W.create();for(let o=0;o<i;++o)for(let r=0;r<s;++r)d.set(o+t.posMin[0],r+t.posMin[1]),tW(e.cells.atVec(d).type)?tk(e.cells,d)&&(f.set(o,r,!0),u.set(o,r,!0),a=o,n=r):(c.set(o,r,!0),f.set(o,r,!0),u.set(o,r,!0)),(tP(e.cells,d)||!tX(e,d))&&u.set(o,r,!0);if(void 0===a||void 0===n)return;let p=[];for(let o=t.posMin[0];o<t.posMax[0]-1;++o)for(let r=t.posMin[1];r<t.posMax[1];++r){let a=W.fromValues(o,r),n=W.fromValues(o+1,r);!tD(e.cells,a)&&!tD(e.cells,n)||tj(e,a)||tj(e,n)||tk(e.cells,a)||tk(e.cells,n)||2===i&&r!==t.posMin[1]&&r!==t.posMax[1]-1||p.push(a)}let h=[];if(p.length>0){let o=p[r.randomInRange(p.length)],a=W.fromValues(o[0]+1,o[1]),n={pos:W.clone(o),type:ec.BedL,topLayer:ed[ec.BedL]},i={pos:W.clone(a),type:ec.BedR,topLayer:ed[ec.BedR]};e.items.push(n),e.items.push(i),h.push(n);let s=o[0]-t.posMin[0],l=o[1]-t.posMin[1];c.set(s,l,!0),c.set(s+1,l,!0),f.set(s,l,!0),f.set(s+1,l,!0),u.set(s,l,!0),u.set(s+1,l,!0)}let m=[ec.DrawersTall,ec.DrawersShort,ec.Chair,ec.Chair,ec.Table,ec.Bookshelf,tE(o,r)];for(let o of(r.shuffleArray(m),m)){let i=!function(e){switch(e){case ec.Bookshelf:case ec.DrawersShort:case ec.VaultTreasureBox:case ec.EmptyVaultTreasureBox:case ec.LootedVaultTreasureBox:case ec.DrawersTall:case ec.Shelf:case ec.TorchUnlit:case ec.TorchLit:case ec.Stove:return!0;default:return!1}}(o)?f:u;for(let e=0;e<l.values.length;++e)l.values[e]=+!i.values[e];tw(l,c,a,n),tA(l,c,h,t);let s=tC(l);if(0===s.length)break;let d=s[r.randomInRange(s.length)];console.assert(l.get(d[0],d[1])),console.assert(!c.get(d[0],d[1]));let p={pos:W.fromValues(d[0]+t.posMin[0],d[1]+t.posMin[1]),type:o,topLayer:ed[o]};e.items.push(p),h.push(p),c.set(d[0],d[1],!0),f.set(d[0],d[1],!0),u.set(d[0],d[1],!0)}}(r,s,e,a):7===s.roomType?function(e,t,o,r){let a=t.posMin[0],n=t.posMin[1],i=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1];if(i>=s){let t=n+Math.floor(s/2);if((1&i)==0){tF(e,W.fromValues(a+1,t),tE(o,r)),tF(e,W.fromValues(a+i-2,t),tE(o,r));for(let o=a+2;o<a+i-2;++o)tV(e,W.fromValues(o,t-1),ec.Chair),tV(e,W.fromValues(o,t),ec.Table),tV(e,W.fromValues(o,t+1),ec.Chair)}else{let n=a+(i-1)/2;tF(e,W.fromValues(n,t),tE(o,r));for(let o=a+1;o<n;++o)tV(e,W.fromValues(o,t-1),ec.Chair),tV(e,W.fromValues(o,t),ec.Table),tV(e,W.fromValues(o,t+1),ec.Chair);for(let o=n+1;o<a+i-1;++o)tV(e,W.fromValues(o,t-1),ec.Chair),tV(e,W.fromValues(o,t),ec.Table),tV(e,W.fromValues(o,t+1),ec.Chair)}}else{let t=a+Math.floor(i/2);if((1&s)==0){tF(e,W.fromValues(t,n+1),tE(o,r)),tF(e,W.fromValues(t,n+s-2),tE(o,r));for(let o=n+2;o<n+s-2;++o)tV(e,W.fromValues(t-1,o),ec.Chair),tV(e,W.fromValues(t,o),ec.Table),tV(e,W.fromValues(t+1,o),ec.Chair)}else{let a=n+(s-1)/2;tF(e,W.fromValues(t,a),tE(o,r));for(let o=n+1;o<a;++o)tV(e,W.fromValues(t-1,o),ec.Chair),tV(e,W.fromValues(t,o),ec.Table),tV(e,W.fromValues(t+1,o),ec.Chair);for(let o=a+1;o<n+s-1;++o)tV(e,W.fromValues(t-1,o),ec.Chair),tV(e,W.fromValues(t,o),ec.Table),tV(e,W.fromValues(t+1,o),ec.Chair)}}}(r,s,e,a):10===s.roomType?function(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],i=[],s=a>n||a===n&&function(e){let t=0;for(let o of e.edges)0===o.dir[1]&&o.door&&++t;return t}(t)<=function(e){let t=0;for(let o of e.edges)0===o.dir[0]&&o.door&&++t;return t}(t);if(s){for(let e=0;e<a;++e)i.push(W.fromValues(e+t.posMin[0],t.posMin[1])),i.push(W.fromValues(e+t.posMin[0],t.posMax[1]-1));let e=(t.posMin[0]+t.posMax[0])/2;i.sort((t,o)=>Math.abs(t[0]-e)-Math.abs(o[0]-e))}else{for(let e=0;e<n;++e)i.push(W.fromValues(t.posMin[0],e+t.posMin[1])),i.push(W.fromValues(t.posMax[0]-1,e+t.posMin[1]));let e=(t.posMin[1]+t.posMax[1])/2;i.sort((t,o)=>Math.abs(t[1]-e)-Math.abs(o[1]-e))}i=i.filter(t=>!tk(e.cells,t)&&tD(e.cells,t));let l=tH(a*n/10,r),f=tH(i.length/3,r),u=tH(i.length/2,r);for(let t of i)tP(e.cells,t)?u>0&&(tV(e,t,ec.Table),--u):l>0?(tV(e,t,ec.Stove),--l):u>0?(tV(e,t,ec.Table),--u):f>0&&(tV(e,t,ec.Shelf),--f);if(s){if(n>=5)for(let o=t.posMin[0]+1;o<t.posMax[0]-1;o+=2)for(let r=t.posMin[1]+2;r<t.posMax[1]-2;++r)tV(e,W.fromValues(o,r),ec.Table)}else if(a>=5)for(let o=t.posMin[1]+1;o<t.posMax[1]-1;o+=2)for(let r=t.posMin[0]+2;r<t.posMax[0]-2;++r)tV(e,W.fromValues(r,o),ec.Table)}(r,s,0,a):11===s.roomType?tT(r,s,e,a):12===s.roomType?tR(r,s,e,a):13===s.roomType?tT(r,s,e,a):14===s.roomType?tR(r,s,e,a):8===s.roomType||9===s.roomType?function(e,t,o,r){let a=t.posMin[0],n=t.posMin[1],i=t.posMax[0]-t.posMin[0],s=t.posMax[1]-t.posMin[1];if(i>=s){if((1&i)==1)for(let t=1;t<i;t+=2)for(let o=1;o<s-1;++o)tV(e,W.fromValues(a+t,n+o),ec.Bookshelf);else{let t=i/2-1;for(let o=1;o<t;o+=2)for(let t=1;t<s-1;++t)tV(e,W.fromValues(a+o,n+t),ec.Bookshelf),tV(e,W.fromValues(a+i-(o+1),n+t),ec.Bookshelf);if((1&t)==1)for(let i=n+1;i<n+s-1;++i){let l=[void 0,void 0];l=i>n+1&&(i<n+s-2||4===s)?[ec.Table,ec.Chair]:[tE(o,r),void 0],r.shuffleArray(l),void 0!==l[0]&&tV(e,W.fromValues(a+t,i),l[0]),void 0!==l[1]&&tV(e,W.fromValues(a+t+1,i),l[1])}}}else if((1&s)==1)for(let t=1;t<s;t+=2)for(let o=1;o<i-1;++o)tV(e,W.fromValues(a+o,n+t),ec.Bookshelf);else{let t=s/2-1;for(let o=1;o<t;o+=2)for(let t=1;t<i-1;++t)tV(e,W.fromValues(a+t,n+o),ec.Bookshelf),tV(e,W.fromValues(a+t,n+s-(o+1)),ec.Bookshelf);if((1&t)==1)for(let s=a+1;s<a+i-1;++s){let l=[void 0,void 0];l=s>a+1&&(s<a+i-2||4===i)?[ec.Table,ec.Chair]:[tE(o,r),void 0],r.shuffleArray(l),void 0!==l[0]&&tV(e,W.fromValues(s,n+t),l[0]),void 0!==l[1]&&tV(e,W.fromValues(s,n+t+1),l[1])}}}(r,s,e,a):15===s.roomType&&function(e,t,o,r){let a,n,i,s,l,f;t.posMax[1]-t.posMin[1]<t.posMax[0]-t.posMin[0]||0!==tI(t,0,-1)&&0!==tI(t,0,1)?(l=t.posMax[1]-t.posMin[1],f=t.posMax[0]-t.posMin[0],i=0,tL(t,-1,0)>tL(t,1,0)?(a=t.posMin[0],n=t.posMin[1],s=1):(a=t.posMax[0]-1,n=t.posMax[1]-1,s=-1)):(l=t.posMax[0]-t.posMin[0],f=t.posMax[1]-t.posMin[1],s=0,tL(t,0,-1)>tL(t,0,1)?(a=t.posMax[0]-1,n=t.posMin[1],i=-1):(a=t.posMin[0],n=t.posMax[1]-1,i=1));let u=W.fromValues(i,s),c=W.fromValues(s,-i),d=W.fromValues(a,n),p=W.create(),h=(1&l)!=0?1:2,m=Math.floor((l-h)/2);for(let t=0;t<f-1;++t)for(let o=0;o<h;++o)W.scaleAndAdd(p,d,u,m+o),W.scaleAndAdd(p,p,c,t),e.cells.atVec(p).type=el.GroundMarble;for(let t=0;t<h;++t)W.scaleAndAdd(p,d,u,m+t),tV(e,p,ec.Chair);if(W.scaleAndAdd(p,d,u,m-1),tF(e,p,ec.DrawersShort),W.scaleAndAdd(p,d,u,m+h),tF(e,p,ec.DrawersShort),l>4&&(W.scaleAndAdd(p,d,u,0),tF(e,p,ec.TorchLit),W.scaleAndAdd(p,d,u,l-1),tF(e,p,ec.TorchLit)),f>6){if(l>=5)for(let t=2;t<f-2;++t)W.scaleAndAdd(p,d,u,1),W.scaleAndAdd(p,p,c,t),tF(e,p,ec.Chair),W.scaleAndAdd(p,d,u,l-2),W.scaleAndAdd(p,p,c,t),tF(e,p,ec.Chair);else{if(0===tI(t,-u[0],-u[1]))for(let t=2;t<f-2;++t)W.scaleAndAdd(p,d,u,0),W.scaleAndAdd(p,p,c,t),tF(e,p,ec.Chair);if(0===tI(t,u[0],u[1]))for(let t=2;t<f-2;++t)W.scaleAndAdd(p,d,u,l-1),W.scaleAndAdd(p,p,c,t),tF(e,p,ec.Chair)}}W.scaleAndAdd(p,d,u,0),W.scaleAndAdd(p,p,c,f-1),tF(e,p,ec.TorchLit),W.scaleAndAdd(p,d,u,l-1),W.scaleAndAdd(p,p,c,f-1),tF(e,p,ec.TorchLit)}(r,s,0,0),i==el.GroundWood&&e>3&&function(e,t,o){for(let r=t.posMin[0];r<t.posMax[0];++r)for(let a=t.posMin[1];a<t.posMax[1];++a){if(e.cells.at(r,a).type!=el.GroundWood||e.items.some(e=>e.pos[0]===r&&e.pos[1]===a&&e.type!==ec.Coin)||tk(e.cells,W.fromValues(r,a))||o.random()>=.02)continue;let n=r>t.posMin[0]&&r<t.posMax[0]-1&&e.cells.at(r-1,a).type===el.GroundWood&&e.cells.at(r+1,a).type===el.GroundWood&&!e.items.some(e=>e.pos[0]===r-1&&e.pos[1]===a&&t1(e.type))&&!e.items.some(e=>e.pos[0]===r+1&&e.pos[1]===a&&t1(e.type)),i=a>t.posMin[1]&&a<t.posMax[1]-1&&e.cells.at(r,a-1).type===el.GroundWood&&e.cells.at(r,a+1).type===el.GroundWood&&!e.items.some(e=>e.pos[0]===r&&e.pos[1]===a-1&&t1(e.type))&&!e.items.some(e=>e.pos[0]===r&&e.pos[1]===a+1&&t1(e.type));(n||i)&&(e.cells.at(r,a).type=el.GroundWoodCreaky)}}(r,s,a)}}function tb(e,t){return .25>t.random()?ec.Table:tE(e,t)}function tA(e,t,o,r){let a=e.sizeX,n=e.sizeY;for(let i of o){let o=i.pos[0]-r.posMin[0],s=i.pos[1]-r.posMin[1],l=[];for(let[e,r]of[[1,0],[0,1],[-1,0],[0,-1]]){let i=o+e,f=s+r;i<0||f<0||i>=a||f>=n||t.get(i,f)||l.push([i,f])}if(i.type===ec.BedL)for(let[e,r]of[[1,0],[0,1],[0,-1]]){let i=o+e+1,f=s+r;i<0||f<0||i>=a||f>=n||t.get(i,f)||l.push([i,f])}if(1===l.length){let[t,o]=l[0];e.set(t,o,!1)}}}function tw(e,t,o,r){let a=t.sizeX,n=t.sizeY;console.assert(e.sizeX===a),console.assert(e.sizeY===n),console.assert(o>=0),console.assert(r>=0),console.assert(o<a),console.assert(r<n),console.assert(!t.get(o,r));let i=new ea(a,n,!1),s=new en(a,n,0),l=new en(a,n,0);!function o(r,f,u,c,d){i.set(r,f,!0),s.set(r,f,u),l.set(r,f,u);let p=0,h=!1;for(let[e,m]of[[1,0],[0,1],[-1,0],[0,-1]]){let g=r+e,x=f+m;g<0||g>=a||x<0||x>=n||t.get(g,x)||(i.get(g,x)?(g!==c||x!==d)&&l.set(r,f,Math.min(l.get(r,f),s.get(g,x))):(o(g,x,u+1,r,f),++p,l.get(g,x)>=u&&(h=!0),l.set(r,f,Math.min(l.get(r,f),l.get(g,x)))))}c>=0?h&&e.set(r,f,!1):p>1&&e.set(r,f,!1)}(o,r,0,-1,-1)}function tT(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],i=t.posMin[0]+Math.floor((a-1)/2),s=t.posMin[1]+Math.floor((n-1)/2);tY(e,i,s,i+1,s+1,el.GroundTreasure),tV(e,W.fromValues(i,s),ec.TreasurePlinth),13===t.roomType&&tV(e,W.fromValues(i,s),ec.TreasureLock),(a>=5||n>=5)&&(tF(e,W.fromValues(t.posMin[0],t.posMin[1]),tE(o,r)),tF(e,W.fromValues(t.posMax[0]-1,t.posMin[1]),tE(o,r)),tF(e,W.fromValues(t.posMin[0],t.posMax[1]-1),tE(o,r)),tF(e,W.fromValues(t.posMax[0]-1,t.posMax[1]-1),tE(o,r)))}function tR(e,t,o,r){let a=t.posMax[0]-t.posMin[0],n=t.posMax[1]-t.posMin[1],i=t.posMin[0]+Math.floor((a-1)/2),s=t.posMin[1]+Math.floor((n-1)/2);a>3&&n>3?tY(e,Math.max(t.posMin[0]+1,i-1),Math.max(t.posMin[1]+1,s-1),Math.min(t.posMax[0]-1,i+2),Math.min(t.posMax[1]-1,s+2),el.GroundVault):tY(e,i,s,i+1,s+1,el.GroundTreasure),tV(e,W.fromValues(i,s),ec.TreasurePlinth),14===t.roomType&&tV(e,W.fromValues(i,s),ec.TreasureLock),(a>=5||n>=5)&&(tF(e,W.fromValues(t.posMin[0],t.posMin[1]),tE(o,r)),tF(e,W.fromValues(t.posMax[0]-1,t.posMin[1]),tE(o,r)),tF(e,W.fromValues(t.posMin[0],t.posMax[1]-1),tE(o,r)),tF(e,W.fromValues(t.posMax[0]-1,t.posMax[1]-1),tE(o,r)))}function tH(e,t){let o=e-Math.floor(e);return e=Math.floor(e),t.random()<o&&++e,e}function tI(e,t,o){let r=0;for(let a of e.edges){if(!a.door)continue;let n=-a.dir[1],i=a.dir[0];a.roomLeft===e&&(n=-n,i=-i),n===t&&i===o&&++r}return r}function tL(e,t,o){t=-t,o=-o;let r=W.fromValues(t,o),a=W.create(),n=W.create();t>0?W.set(n,e.posMin[0]-1,0):t<0?W.set(n,e.posMax[0],0):o>0?W.set(n,0,e.posMin[1]-1):W.set(n,0,e.posMax[1]);let i=1/0;for(let t of e.edges)t.door&&(W.scaleAndAdd(a,t.origin,t.dir,Math.floor(t.length/2)),W.subtract(a,a,n),i=Math.min(i,W.dot(r,a)));return console.assert(i>=0),i}function tC(e){let t=[];for(let o=0;o<e.sizeX;++o)for(let r=0;r<e.sizeY;++r)e.get(o,r)&&t.push(W.fromValues(o,r));return t}function tE(e,t){return 0===e?ec.TorchUnlit:.05>t.random()?ec.TorchUnlit:ec.TorchLit}function tF(e,t,o){!tk(e.cells,t)&&((o==ec.TorchUnlit||o==ec.TorchLit)&&tP(e.cells,t)||tV(e,t,o))}function tk(e,t){let[o,r]=t;return e.at(o-1,r).type>=el.PortcullisNS||e.at(o+1,r).type>=el.PortcullisNS||e.at(o,r-1).type>=el.PortcullisNS||e.at(o,r+1).type>=el.PortcullisNS}function tP(e,t){let[o,r]=t;return!!(ey(e.at(o-1,r).type)||ey(e.at(o+1,r).type)||ey(e.at(o,r-1).type)||ey(e.at(o,r+1).type))}function tD(e,t){let[o,r]=t;return!!(tG(e.at(o-1,r).type)||tG(e.at(o+1,r).type)||tG(e.at(o,r-1).type)||tG(e.at(o,r+1).type))}function tW(e){return e<el.Wall0000&&e!==el.GroundWater}function tG(e){return e>=el.Wall0000&&e<=el.OneWayWindowS}function tV(e,t,o){e.items.push({pos:W.clone(t),type:o,topLayer:ed[o]})}function tU(e,t,o,r,a,n){let i=function(e){let t=new ea(e.cells.sizeX,e.cells.sizeY,!1);for(let o of e.items)tB(o.type)&&t.set(o.pos[0],o.pos[1],!0);return t}(o),s=function(e,t){let o=new ea(e.cells.sizeX,e.cells.sizeY,!1);for(let t=0;t<e.cells.sizeX;++t)for(let r=0;r<e.cells.sizeY;++r){let a=e.cells.at(t,r).type;(a===el.GroundWater||a>=el.Wall0000)&&o.set(t,r,!0)}for(let e of t)if(1===e.path.length)for(let t of e.path)o.set(t[0],t[1],!0);for(let t of e.items)tB(t.type)||o.set(t.pos[0],t.pos[1],!0);return o}(o,r),l=0;for(let r of t)if(15===r.roomType){if(l>=e)break;tN(s,i,r.posMin,r.posMax,o,n)&&++l}for(let r of t){if(5!==r.roomType)continue;let t=n.randomInRange(3)+n.randomInRange(3);for(a===es.Fortress&&(t+=2);t>0&&(--t,!(l>=e));)tN(s,i,r.posMin,r.posMax,o,n)&&++l}for(let r of t){if(l>=e)break;if(0===r.roomType||5===r.roomType||(1===r.roomType||3===r.roomType)&&.75>n.random())continue;let t=0;for(let e of r.edges)e.door&&(t+=1);t<2&&tN(s,i,r.posMin,r.posMax,o,n)&&++l}for(let r of t){var f;if(l>=e)break;!(4!==(f=r.roomType)&&6!==f)&&!(.5>n.random())&&tN(s,i,r.posMin,r.posMax,o,n)&&++l}let u=t.filter(e=>0!==e.roomType&&!tK(e.roomType));n.shuffleArray(u);for(let t=0;t<1e3&&l<e;++t){let e=u[t%u.length];tN(s,i,e.posMin,e.posMax,o,n)&&++l}console.assert(l===e)}function tB(e){switch(e){case ec.Chair:case ec.Table:case ec.DrawersShort:case ec.DrawersTall:case ec.Bookshelf:case ec.Shelf:case ec.Bush:return!0;default:return!1}}function tN(e,t,o,r,a,n){let i=[];for(let a=o[0];a<r[0];++a)for(let n=o[1];n<r[1];++n)!e.get(a,n)&&t.get(a,n)&&i.push(W.fromValues(a,n));if(0===i.length){for(let t=o[0];t<r[0];++t)for(let a=o[1];a<r[1];++a)e.get(t,a)||i.push(W.fromValues(t,a));if(0===i.length)return!1}let s=i[n.randomInRange(i.length)];return tV(a,s,ec.Coin),e.set(s[0],s[1],!0),!0}function tO(e,t,o){let r=e.items.filter(e=>e.type===ec.Bookshelf);o.shuffleArray(r);let a=new Map;for(let e of t){let t=[];for(let o of r)o.pos[0]>=e.posMin[0]&&o.pos[1]>=e.posMin[1]&&o.pos[0]<e.posMax[0]&&o.pos[1]<e.posMax[1]&&t.push(o);t.length>0&&a.set(e,t)}for(let r of e.items.filter(e=>e.type===ec.TreasurePlinth)){let n=o.randomInRange(5);tV(e,r.pos,ec.TreasureA+n);let i={switches:[],numSwitchesUsed:0,posTreasure:W.clone(r.pos),stolen:!1};if(e.treasures.push(i),!e.items.some(e=>e.type===ec.TreasureLock&&e.pos.equals(r.pos)))continue;let s=[];for(let e=3;e>0&&0===s.length;--e)for(let o of t){let t=a.get(o);void 0!==t&&t.length>=e&&s.push(t)}if(0===s.length){e.items=e.items.filter(e=>!(e.type===ec.TreasureLock&&e.pos.equals(r.pos))),e.cells.atVec(r.pos).blocksPlayerMove=!1;continue}let l=s[o.randomInRange(s.length)],f="";for(let t=Math.min(l.length,3);t>0;--t){let t=l.pop();f.length>0&&(f+="\n");let o=e.bookTitle.get(t).split(" ")[0];o.endsWith(",")&&(o=o.substring(0,o.length-1)),f+=o,i.switches.push(W.clone(t.pos))}let u=new Set;for(let t of e.items)(t.type===ec.Coin||t.type===ec.Health||t.type===ec.Note)&&u.add(t.pos[0]*e.cells.sizeY+t.pos[1]);let c=e.items.filter(t=>(t.type===ec.DrawersShort||t.type===ec.DrawersTall||t.type===ec.Shelf)&&!u.has(t.pos[0]*e.cells.sizeY+t.pos[1]));if(c.length>0){let t=c[o.randomInRange(c.length)].pos,r={pos:W.clone(t),type:ec.Note,topLayer:ed[ec.Note]};e.items.push(r),e.bookTitle.set(r,f)}}e.items.sort((e,t)=>e.type===ec.TreasureLock&&t.type!==ec.TreasureLock?1:e.type!==ec.TreasureLock&&t.type===ec.TreasureLock?-1:0)}function tz(e,t,o,r){if(e<1)return;let a=1+Math.floor((9-e)/4);tq([10],t,o,r)&&--a,a>0&&tq([10,7],t,o,r)&&--a;for(let e=10;e>0&&a>0;--e)tq([10,7,6],t,o,r)&&--a}function tq(e,t,o,r){let a=o.filter(t=>e.includes(t.roomType));if(0===a.length)return!1;for(let e=0;e<10;++e){let e=a[r.randomInRange(a.length)];if(function(e,t,o,r){let a=[];for(let r=e[0];r<t[0];++r)for(let n=e[1];n<t[1];++n){let e=W.fromValues(r,n);(function(e,t){let o=t.cells.atVec(e).type;if(o===el.GroundWater||o>=el.Wall0000)return!1;let r=!1;for(let o of t.items)if(o.pos.equals(e)){if(o.type!==ec.Table)return!1;r=!0}return r})(e,o)&&a.push(e)}return 0!==a.length&&(tV(o,a[r.randomInRange(a.length)],ec.Health),!0)}(e.posMin,e.posMax,t,r))return!0}return!1}function tY(e,t,o,r,a,n){for(let i=t;i<r;++i)for(let t=o;t<a;++t)e.cells.at(i,t).type=n}function tX(e,t){return!(e.cells.atVec(t).type>=el.Wall0000)&&(t[0]>=0&&e.cells.at(t[0]-1,t[1]).type>=el.Wall0000||t[1]>=0&&e.cells.at(t[0],t[1]-1).type>=el.Wall0000||t[0]+1<e.cells.sizeX&&e.cells.at(t[0]+1,t[1]).type>=el.Wall0000||t[1]+1<e.cells.sizeY&&e.cells.at(t[0],t[1]+1).type>=el.Wall0000)}function tj(e,t){for(let o of e.items)if(o.pos.equals(t))return!0;for(let o of e.guards)if(o.pos.equals(t))return!0;return!1}function tK(e){switch(e){case 1:case 3:case 12:case 14:return!0;case 0:case 2:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 13:case 15:return!1}}function t$(e,t,o,r,a,n){if(!(e<=0)){if(a&&o.length>0){let r=o.filter(e=>e.path.length>1&&e.minRoomDepth>0);0===r.length&&(r=[...o]),r.sort((e,t)=>e.minRoomDepth-t.minRoomDepth);let a=Math.floor(r.length/2),i=r[a];o=o.filter(e=>e!==i);let s=new $(i.path,0);e>1&&n.randomInRange(5+e)<e&&(s.hasTorch=!0),s.hasVaultKey=!0,t.guards.push(s)}if(r>0&&e<4){let a=o.findIndex(e=>e.path.length<=1);if(a>=0){let i=o[a];o.splice(a,1);let s=new $(i.path,0);e>1&&n.randomInRange(5+e)<e&&(s.hasTorch=!0),s.hasPurse=!0,r--,t.guards.push(s)}}for(let a of o){let o=new $(a.path,0);e>1&&n.randomInRange(5+e)<e&&(a.path.length>1||!t.items.some(e=>e.pos.equals(a.path[0])))&&(o.hasTorch=!0),r>0&&(o.hasPurse=!0,r--),t.guards.push(o)}if(1===e){let e=t.items.filter(e=>e.type===ec.PortcullisEW).sort((e,t)=>e.pos[1]-t.pos[1]);if(e.length>=1){let o=e[0].pos,r=t.guards[0];W.set(r.pos,o[0],o[1]+1),W.set(r.dir,0,-1),r.enterPatrolMode(t)}}console.assert(0===r)}}const tQ=["Alien","Aliens","Amulet","Amulets","Arm","Arms","Armor","Armor","Arrow","Arrows","Attack","Attacks","Aura","Aurae","Awakening","Awakenings","Axe","Axes","Bane","Banes","Battle-Axe","Battle-Axes","Blood","Bloods","Breath","Breaths","Captive","Captives","Castle","Castles","Catacomb","Catacombs","Cave","Caves","Chamber","Chambers","Champion","Champions","Child","Children","Citadel","Citadels","City","Cities","Claw","Claws","Cow","Cows","Crown","Crowns","Crusade","Crusades","Crystal","Crystals","Curse","Curses","Dagger","Daggers","Daughter","Daughters","Dawn","Dawn","Day","Days","Dungeon","Dungeons","Dragon","Dragons","Eye","Eyes","Field","Fields","Fire","Fires","Fist","Fists","Forest","Forests","Fortress","Fortresses","Fugitive","Fugitives","Game","Games","Gem","Gems","Guardian","Guardians","Hand","Hands","Helm","Helms","Horde","Hordes","Hour","Hours","Keep","Keeps","Key","Keys","Knight","Knights","Land","Lands","Legend","Legends","Lord","Lords","Master","Masters","Mercenary","Mercenaries","Mind","Minds","Mine","Mines","Minion","Minions","Mirror","Mirrors","Night","Nights","Moon","Moons","Omen","Omens","Orb","Orbs","Path","Paths","Pit","Pits","Plague","Plagues","Pool","Pools","Potion","Potions","Prince","Princes","Princess","Princesses","Prison","Prisons","Prisoner","Prisoners","Prophecy","Prophecies","Quest","Quests","Rampage","Rampages","Realm","Realms","Reaper","Reapers","Rebirth","Rebirths","Return","Returns","Revenge","Revenges","Ring","Rings","Rise","Rise","River","Rivers","Scroll","Scrolls","Serpent","Serpents","Servant","Servants","Shadow","Shadows","Shield","Shields","Sign","Signs","Siren","Sirens","Slave","Slaves","Son","Sons","Spawn","Spawn","Spear","Spears","Spell","Spells","Sphere","Spheres","Staff","Staves","Stronghold","Strongholds","Sword","Swords","Thief","Thieves","Threat","Threats","Throne","Thrones","Tower","Towers","Trail","Trails","Trial","Trials","Valley","Valleys","Wand","Wands","Warrior","Warriors","Weapon","Weapons","Wind","Winds","Witch","Witches","Wizard","Wizards"],tJ=["Adventure","Agony","the Ancients","Anger","Avenging","Battle","Beholding","Brilliance","Danger","Darkness","Death","Deception","Despair","Destiny","Destruction","Disease","Ecstacy","Enchantment","Enlightenment","Eternity","Evil","Falsehood","Famine","Fantasy","Fate","Fear","Flame","Foretelling","Forewarning","Fortune","Fury","Gallantry","Gingivitis","the Gods","Intrigue","Keeping","Legend","the Living Dead","Lore","Madness","Magic","Menace","Midnight","Might","Murder","Mystery","Power","Prophecy","Radiance","Rebellion","Reckoning","Remembrance","Shadow","Sickness","Strength","Suffering","Terror","Time","Truth","the Undead","the Universe","Unraveling","Valor","Vengeance","Venom","War"],tZ=["Administrative Law","Arbitrage","Attorney-Client Privilege","Attractive Nuisances","Bankruptcy","Civil Procedure","Community Property","Comparative Legal Traditions","Contract Law","Consideration","Corporate Finance","Corporate Taxation","Criminal Law","Cross-Examination","Damages","Discovery","Economics","Embezzlement","Estate Planning","Estoppel","Homicide","Income Taxation","Intangible Property","International Transactions","Intestate Succession","Probate","Promissory Estoppel","Property","Quid Pro Quo","Reckless Disregard","Regulatory Policy","Securities Regulation","Security Interests","Statutory Law","Torts","Trial Procedure","Wills, Trusts, and Estates"];function t0(e,t,o,r){let a=[...tZ];r.shuffleArray(a);let n=0,i=[...tQ];r.shuffleArray(i);let s=0,l=new Map;for(let e of t){let t=[];for(let r of o)r.pos[0]>=e.posMin[0]&&r.pos[1]>=e.posMin[1]&&r.pos[0]<e.posMax[0]&&r.pos[1]<e.posMax[1]&&t.push(r);t.length>0&&l.set(e,t)}for(let t of l){let o=t[0],l=t[1],f=W.create(),u=W.create();o.posMax[0]-o.posMin[0]>=o.posMax[1]-o.posMin[1]?(W.set(f,1,0),W.set(u,0,-1)):(W.set(f,0,-1),W.set(u,1,0)),l.sort((e,t)=>{let o=W.dot(f,e.pos),r=W.dot(f,t.pos);return o<r?-1:o>r?1:(o=W.dot(u,e.pos))<(r=W.dot(u,t.pos))?-1:+(o>r)});let c=[];for(let e=0;e<l.length;++e){let e;if(o.privateRoom){let t=i[s];s=(s+1)%i.length,e=t+" of "+tJ[r.randomInRange(tJ.length)]}else e=a[n],n=(n+1)%a.length;c.push(e)}c.sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}));for(let t=0;t<l.length;++t)e.set(l[t],c[t])}}function t1(e){return e===ec.DrawersTall||e===ec.Bookshelf||e===ec.Shelf||e===ec.Stove||e===ec.TreasureLock}function t2(e){let t=e.cells.sizeX,o=e.cells.sizeY;for(let r=0;r<t;++r)for(let t=0;t<o;++t){let o=e.cells.at(r,t),a=o.type,n=a>=el.Wall0000&&a<=el.Wall1111,i=ey(a),s=a==el.GroundWater;o.moveCost=n||i?1/0:64*!!s,o.blocksPlayerMove=n,o.blocksPlayerSight=n&&a!==el.Wall0000,o.blocksSight=n,o.blocksSound=n,o.hidesPlayer=!1,o.isWindow=i}for(let t of e.items){let o=e.cells.atVec(t.pos),r=t.type;o.moveCost=Math.max(o.moveCost,function(e){switch(e){case 0:return 32;case 1:case 2:case 3:return 64;case 4:case 5:case 6:case 7:case 8:case 18:case 19:case 28:case 29:case 24:case 25:case 26:case 30:case 31:case 32:case 33:case 34:return 1/0;case 9:return 10;case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 20:case 21:case 22:case 23:case 27:return 0}}(r)),(r===ec.DoorNS||r===ec.DoorEW||r===ec.LockedDoorNS||r===ec.LockedDoorEW)&&(o.blocksPlayerSight=!0),(r===ec.DoorNS||r===ec.DoorEW||r===ec.LockedDoorNS||r===ec.LockedDoorEW||r===ec.PortcullisNS||r===ec.PortcullisEW||r===ec.Bush||r===ec.DrawersTall||r===ec.Bookshelf||r===ec.Shelf||r===ec.Stove)&&(o.blocksSight=!0),(r===ec.Table||r===ec.Bush||r===ec.BedL||r===ec.BedR)&&(o.hidesPlayer=!0),t1(r)&&(o.blocksPlayerMove=!0)}}function t3(e){for(let o=0;o<e.sizeX;++o)for(let r=0;r<e.sizeY;++r){var t;e.at(o,r).type==el.Wall0000&&(e.at(o,r).type=(t=function(e,t,o){let r=e.sizeX,a=e.sizeY,n=0;return o<a-1&&t5(e.at(t,o+1).type)&&(n|=8),o>0&&t5(e.at(t,o-1).type)&&(n|=4),t<r-1&&t5(e.at(t+1,o).type)&&(n|=2),t>0&&t5(e.at(t-1,o).type)&&(n|=1),n}(e,o,r),el.Wall0000+t))}}function t5(e){return e>=el.Wall0000&&e<=el.DoorEW}class t4{start(e,t){}addGlyph(e,t,o,r,a){}addGlyphLit(e,t,o,r,a,n){}addGlyphLit4(e,t,o,r,a,n){}flush(){}constructor(e,t,o,r){this.beginFrame=e=>{};let a=e.getContext("webgl2",{alpha:!1,depth:!1}),n=[r.image,t.image,o.image].map(e=>(function(e,t){let o=t.naturalWidth/16,r=t.naturalHeight/16,a=4*o,n=4*r,i=document.createElement("canvas");i.width=a,i.height=256*n;let s=i.getContext("2d");s.imageSmoothingEnabled=!1;for(let e=0;e<16;++e)for(let i=0;i<16;++i){let l=i*o,f=e*r,u=(16*e+i)*n;s.drawImage(t,l,f,o,r,0,u,a,n)}let l=new Uint8Array(s.getImageData(0,0,i.width,i.height).data.buffer),f=e.createTexture();return e.bindTexture(e.TEXTURE_2D_ARRAY,f),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,a,n,256,0,e.RGBA,e.UNSIGNED_BYTE,l),e.generateMipmap(e.TEXTURE_2D_ARRAY),f})(a,e));this.renderVignette=function(e){let t={vPositionScreen:0},o=t9(e,`#version 300 es
        in vec2 vPositionScreen;

        uniform mat4 uMatDiscFromScreen;

        out highp vec2 fPositionDisc;

        void main() {
            highp vec4 posScreen = vec4(vPositionScreen.xy, 0, 1);
            fPositionDisc = (uMatDiscFromScreen * posScreen).xy;
            gl_Position = posScreen;
        }
    `,`#version 300 es
        in highp vec2 fPositionDisc;

        uniform highp vec4 uColorInner;
        uniform highp vec4 uColorOuter;
        uniform highp float uRadiusInner;

        out lowp vec4 fragColor;

        void main() {
            highp float r = length(fPositionDisc);
            highp float u = smoothstep(uRadiusInner, 1.0, r);
            fragColor = mix(uColorInner, uColorOuter, u);
        }
    `,t),r=e.getUniformLocation(o,"uMatDiscFromScreen"),a=e.getUniformLocation(o,"uColorInner"),n=e.getUniformLocation(o,"uColorOuter"),i=e.getUniformLocation(o,"uRadiusInner"),s=new Float32Array(12);{let e=0;function l(t,o){s[e++]=t,s[e++]=o}l(-1,-1),l(1,-1),l(1,1),l(1,1),l(-1,1),l(-1,-1)}let f=e.createBuffer(),u=e.createVertexArray();return e.bindVertexArray(u),e.enableVertexAttribArray(t.vPositionScreen),e.bindBuffer(e.ARRAY_BUFFER,f),e.vertexAttribPointer(t.vPositionScreen,2,e.FLOAT,!1,0,0),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindVertexArray(null),(t,s,l,f)=>{e.useProgram(o),e.uniformMatrix4fv(r,!1,t),e.uniform1f(i,s),e.uniform4fv(a,l),e.uniform4fv(n,f),e.bindVertexArray(u),e.drawArrays(e.TRIANGLES,0,6),e.bindVertexArray(null)}}(a),this.terrainTileSet=t,this.entityTileSet=o,this.fontTileSet=r;let i={vPosition:0,vTexcoord:1,vColor:2};function s(e,t,o){let r=255&e,a=e>>8&255,n=e>>16&255,i=e>>24&255;return Math.max(0,Math.min(255,Math.trunc(r+((255&t)-r)*o)))+(Math.max(0,Math.min(255,Math.trunc(a+((t>>8&255)-a)*o)))<<8)+(Math.max(0,Math.min(255,Math.trunc(n+((t>>16&255)-n)*o)))<<16)+(Math.max(0,Math.min(255,Math.trunc(i+((t>>24&255)-i)*o)))<<24)}let l=t9(a,`#version 300 es
            in vec2 vPosition;
            in vec3 vTexcoord;
            in vec4 vColor;

            uniform mat4 uMatScreenFromWorld;

            out highp vec3 fTexcoord;
            out highp vec4 fColor;

            void main() {
                fTexcoord = vTexcoord;
                fColor = vColor;
                gl_Position = uMatScreenFromWorld * vec4(vPosition, 0, 1);
            }
        `,`#version 300 es
            in highp vec3 fTexcoord;
            in highp vec4 fColor;

            uniform highp sampler2DArray uOpacity;

            out lowp vec4 fragColor;

            void main() {
                fragColor = fColor * texture(uOpacity, fTexcoord);
            }
        `,i),f=a.getUniformLocation(l,"uMatScreenFromWorld"),u=a.getUniformLocation(l,"uOpacity"),c=2*Float32Array.BYTES_PER_ELEMENT+2*Uint32Array.BYTES_PER_ELEMENT,d=new ArrayBuffer(256*c),p=new Float32Array(d),h=new Uint32Array(d),m=a.createBuffer(),g=0,x=L.create(),y=a.createVertexArray();a.bindVertexArray(y),a.enableVertexAttribArray(i.vPosition),a.enableVertexAttribArray(i.vTexcoord),a.enableVertexAttribArray(i.vColor),a.bindBuffer(a.ARRAY_BUFFER,m),a.vertexAttribPointer(i.vPosition,2,a.FLOAT,!1,c,0),a.vertexAttribPointer(i.vTexcoord,3,a.UNSIGNED_BYTE,!1,c,8),a.vertexAttribPointer(i.vColor,4,a.UNSIGNED_BYTE,!0,c,12),a.bufferData(a.ARRAY_BUFFER,d,a.DYNAMIC_DRAW),function(e,t){let o=new Uint16Array(384);for(let e=0;e<64;++e){let t=6*e,r=4*e;o[t+0]=r+0,o[t+1]=r+1,o[t+2]=r+2,o[t+3]=r+2,o[t+4]=r+1,o[t+5]=r+3}let r=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferData(e.ELEMENT_ARRAY_BUFFER,o,e.STATIC_DRAW)}(a,64),a.bindVertexArray(null),this.start=(e,t)=>{L.copy(x,e),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D_ARRAY,n[t])},this.addGlyph=(e,t,o,r,a)=>{if(void 0===a.textureIndex)return;g>=64&&this.flush(),o=e+(o-e)*1,r=t+(r-t)*1;let n=a.color?a.color:0xffffffff,i=g*c,s=a.textureIndex<<16;p[i+0]=e,p[i+1]=t,h[i+2]=s+256,h[i+3]=n,p[i+4]=o,p[i+5]=t,h[i+6]=s+257,h[i+7]=n,p[i+8]=e,p[i+9]=r,h[i+10]=s,h[i+11]=n,p[i+12]=o,p[i+13]=r,h[i+14]=s+1,h[i+15]=n,++g},this.addGlyphLit=(e,t,o,r,a,n)=>{if(void 0===a.textureIndex)return;g>=64&&this.flush(),o=e+(o-e)*1,r=t+(r-t)*1;let i=a.color?a.color:0xffffffff,l=s(a.unlitColor?a.unlitColor:0xff505050,i,n**.25),f=g*c,u=a.textureIndex<<16;p[f+0]=e,p[f+1]=t,h[f+2]=u+256,h[f+3]=l,p[f+4]=o,p[f+5]=t,h[f+6]=u+257,h[f+7]=l,p[f+8]=e,p[f+9]=r,h[f+10]=u,h[f+11]=l,p[f+12]=o,p[f+13]=r,h[f+14]=u+1,h[f+15]=l,++g},this.addGlyphLit4=(e,t,o,r,a,n)=>{if(void 0===a.textureIndex)return;g>=64&&this.flush();let i=a.color?a.color:0xffffffff,l=a.unlitColor?a.unlitColor:0xff505050;function f(e){return s(l,i,e**.25)}o=e+(o-e)*1,r=t+(r-t)*1;let u=g*c,d=a.textureIndex<<16;p[u+0]=e,p[u+1]=t,h[u+2]=d+256,h[u+3]=f(n[0]),p[u+4]=o,p[u+5]=t,h[u+6]=d+257,h[u+7]=f(n[1]),p[u+8]=e,p[u+9]=r,h[u+10]=d,h[u+11]=f(n[2]),p[u+12]=o,p[u+13]=r,h[u+14]=d+1,h[u+15]=f(n[3]),++g},this.flush=()=>{g<=0||(a.useProgram(l),a.bindVertexArray(y),a.uniform1i(u,0),a.uniformMatrix4fv(f,!1,x),a.bindBuffer(a.ARRAY_BUFFER,m),a.bufferSubData(a.ARRAY_BUFFER,0,p,0),a.drawElements(a.TRIANGLES,6*g,a.UNSIGNED_SHORT,0),a.bindVertexArray(null),g=0)},this.beginFrame=e=>{a.viewport(0,0,e[0],e[1]),a.clear(a.COLOR_BUFFER_BIT)},a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.enable(a.BLEND),a.clearColor(0,0,0,1)}}function t8(e,t,o){let r=e.createShader(t);return e.shaderSource(r,o),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(r)),e.deleteShader(r)),r}function t9(e,t,o,r){let a=t8(e,e.VERTEX_SHADER,t),n=t8(e,e.FRAGMENT_SHADER,o),i=e.createProgram();for(let t in e.attachShader(i,a),e.attachShader(i,n),r)e.bindAttribLocation(i,r[t],t);return e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)||alert("Unable to initialize the shader program: "+e.getProgramInfoLog(i)),i}var t6={};t6=new URL("entitytiles31color.a190660a.png",import.meta.url).toString();var t7={};t7=new URL("terraintiles31color.b97f19b8.png",import.meta.url).toString();var oe={};oe=new URL("font.f78e2f21.png",import.meta.url).toString();var ot=((c={})[c.Font=0]="Font",c[c.Terrain=1]="Terrain",c[c.Entity=2]="Entity",c);function oo(e){return 16*e[1]+e[0]}const or={name:"Basic Font",imageSrc:oe,image:new Image,tileSize:[16,16],offset:[0,0],letterMap:[],background:{textureIndex:219,color:0xff101010},heart:{textureIndex:3},air:{textureIndex:9}},oa={name:"31 Color Terrain Tileset",imageSrc:t7,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,terrainTiles:[{textureIndex:oo([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([2,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([11,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([11,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([9,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([12,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([10,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([7,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([14,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([15,0]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([2,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,1]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a}],redWallTerrainTiles:[{textureIndex:oo([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([2,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([10,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([10,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([9,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([12,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([10,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([7,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([14,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([15,2]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([2,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,3]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,14]),color:0xffd0f3ff,unlitColor:0xff754a4a}],manseTerrainTiles:[{textureIndex:oo([5,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([0,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([7,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([7,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([4,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([3,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([9,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([12,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([10,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([7,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([14,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([15,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([2,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([9,15]),color:0xffd0f3ff,unlitColor:0xff754a4a}],fortressTerrainTiles:[{textureIndex:oo([5,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([10,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([0,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([6,14]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([6,15]),color:0xffc2e3ee,unlitColor:0xff754a4a},{textureIndex:oo([5,14]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([3,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([9,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([12,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([10,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([7,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([14,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([15,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([2,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([13,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([11,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([5,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a},{textureIndex:oo([8,15]),color:0xffd0f3ff,unlitColor:0xff754a4a}],ledgeTiles:[{textureIndex:oo([0,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oo([1,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oo([2,11]),color:0xff736847,unlitColor:0xff483428},{textureIndex:oo([3,11]),color:0xff736847,unlitColor:0xff483428}],waterAnimation:[{textureIndex:128,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:129,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:130,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:131,color:0xffd0fefe,unlitColor:0xff908080}],manseWaterAnimation:[{textureIndex:144,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:145,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:146,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:147,color:0xffd0fefe,unlitColor:0xff908080}],fortressWaterAnimation:[{textureIndex:160,color:0xff908080,unlitColor:0xff604040},{textureIndex:161,color:0xff908080,unlitColor:0xff604040},{textureIndex:162,color:0xff908080,unlitColor:0xff604040},{textureIndex:163,color:0xff908080,unlitColor:0xff604040}]},on={name:"31 Color Entity Tileset",imageSrc:t6,image:new Image,tileSize:[16,16],cellSize:[16,16],tileRatios:[1,1],offset:[0,0],flattenTexture:!0,unlitTile:{textureIndex:oo([0,0])},namedTiles:{pickTarget:{textureIndex:188,color:0xffffffff},noise:{textureIndex:187,color:0x80ffffff},crossHatch:{textureIndex:3,color:0xffffffff},patrolRoute:{textureIndex:31,color:0xff80ff80},speechBubbleR:{textureIndex:183,color:0xffffffff},speechBubbleL:{textureIndex:184,color:0xffffffff},idleIndicator:{textureIndex:188,color:0xffffffff},playerHint:{textureIndex:185,color:0xffffffff},uiWindowTile:{textureIndex:32,color:0xffffffff},uiCreakyTile:{textureIndex:33,color:0xffffffff},treasureA:{textureIndex:160,color:0xffffffff},treasureB:{textureIndex:161,color:0xffffffff},treasureC:{textureIndex:162,color:0xffffffff},treasureD:{textureIndex:163,color:0xffffffff},treasureE:{textureIndex:164,color:0xffffffff},treasureV:{textureIndex:171,color:0xffffffff}},touchButtons:{menu:{textureIndex:oo([11,1]),color:0xa0ffffff,unlitColor:0x30ffffff},up:{textureIndex:oo([2,1]),color:0xa0ffffff,unlitColor:0x30ffffff},down:{textureIndex:oo([3,1]),color:0xa0ffffff,unlitColor:0x30ffffff},left:{textureIndex:oo([0,1]),color:0xa0ffffff,unlitColor:0x30ffffff},right:{textureIndex:oo([1,1]),color:0xa0ffffff,unlitColor:0x30ffffff},wait:{textureIndex:oo([4,1]),color:0xa0ffffff,unlitColor:0x30ffffff},jump:{textureIndex:oo([5,1]),color:0xa0ffffff,unlitColor:0x30ffffff},bang:{textureIndex:oo([13,1]),color:0xa0ffffff,unlitColor:0x30ffffff},menuAccept:{textureIndex:oo([4,1]),color:0xa0ffffff,unlitColor:0x30ffffff},zoomOut:{textureIndex:oo([6,1]),color:0xa0ffffff,unlitColor:0x30ffffff},zoomIn:{textureIndex:oo([7,1]),color:0xa0ffffff,unlitColor:0x30ffffff},heal:{textureIndex:oo([8,1]),color:0xa0ffffff,unlitColor:0x30ffffff},startLevel:{textureIndex:oo([9,1]),color:0xa0ffffff,unlitColor:0x30ffffff},nextLevel:{textureIndex:oo([9,1]),color:0xa0ffffff,unlitColor:0x30ffffff},forceRestart:{textureIndex:oo([10,1]),color:0xa0ffffff,unlitColor:0x30ffffff},fullscreen:{textureIndex:oo([14,1]),color:0xa0ffffff,unlitColor:0x30ffffff}},vaultGoldAnimationTiles:[{textureIndex:157,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:173,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:174,color:0xffffffff,unlitColor:0xffffffff},{textureIndex:175,color:0xffffffff,unlitColor:0xffffffff}],itemGlows:{[ec.Coin]:{textureIndex:oo([12,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.TreasureA]:{textureIndex:oo([5,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.TreasureB]:{textureIndex:oo([6,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.TreasureC]:{textureIndex:oo([7,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.TreasureD]:{textureIndex:oo([8,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.TreasureE]:{textureIndex:oo([9,9]),color:0xa0ffffff,unlitColor:0xffffff},[ec.VaultTreasureBox]:{textureIndex:oo([11,9]),color:0xa0ffffff,unlitColor:0xffffff}},itemTiles:[{textureIndex:oo([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([6,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([2,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,4]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oo([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([9,10]),color:0xffffffff,unlitColor:0xffffffff}],redWallItemTiles:[{textureIndex:oo([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([6,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([2,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,5]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oo([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([9,10]),color:0xffffffff,unlitColor:0xffffffff}],manseItemTiles:[{textureIndex:oo([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([2,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,6]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oo([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([9,10]),color:0xffffffff,unlitColor:0xffffffff}],fortressItemTiles:[{textureIndex:oo([3,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([4,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([10,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([9,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,12]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([14,14]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,15]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,11]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([2,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([3,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([1,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([6,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([4,7]),color:0xffd0ffff,unlitColor:0xffc0aaaa},{textureIndex:oo([0,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([12,13]),color:0xffd0fefe,unlitColor:0xffd0fefe},{textureIndex:oo([0,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,13]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([1,15]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([11,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([10,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([15,7]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([8,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([7,13]),color:0xffffffff,unlitColor:0xffb49090},{textureIndex:oo([5,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([6,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([7,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([8,10]),color:0xffffffff,unlitColor:0xffffffff},{textureIndex:oo([9,10]),color:0xffffffff,unlitColor:0xffffffff}],npcTiles:[{textureIndex:oo([9,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([8,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([10,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([7,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([9,8]),color:0xff705050},{textureIndex:oo([8,8]),color:0xff705050},{textureIndex:oo([10,8]),color:0xff705050},{textureIndex:oo([7,8]),color:0xff705050},{textureIndex:oo([9,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([8,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([10,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([7,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([6,8]),color:0xffffffff,unlitColor:0xff705050},{textureIndex:oo([6,8]),color:0xffffffff,unlitColor:0xff705050}],playerTiles:{normal:{textureIndex:oo([1,8]),color:0xffffffff,unlitColor:0xffa8a8a8},hidden:{textureIndex:oo([0,8]),color:0xffffffff,unlitColor:0xffa8a8a8},right:{textureIndex:oo([2,8]),color:0xffffffff,unlitColor:0xffa8a8a8},left:{textureIndex:oo([3,8]),color:0xffffffff,unlitColor:0xffa8a8a8},down:{textureIndex:oo([1,8]),color:0xffffffff,unlitColor:0xffa8a8a8},up:{textureIndex:oo([4,8]),color:0xffffffff,unlitColor:0xffa8a8a8},dead:{textureIndex:oo([5,8]),color:0xffffffff,unlitColor:0xffa8a8a8},litFace:{textureIndex:176,color:0xffffffff}},guardStateTiles:[{textureIndex:oo([0,11])},{textureIndex:oo([1,11])},{textureIndex:oo([2,11])},{textureIndex:oo([3,11])},{textureIndex:oo([4,11])}],stoveAnimation:[{textureIndex:238,color:0xffffffff,unlitColor:0xff908080},{textureIndex:239,color:0xffffffff,unlitColor:0xff908080}],candleAnimation:[{textureIndex:224,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:225,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:226,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:227,color:0xffd0fefe,unlitColor:0xff908080},{textureIndex:208,color:0xffd0fefe,unlitColor:0xff908080}],torchAnimation:[{textureIndex:220},{textureIndex:221},{textureIndex:222},{textureIndex:223},{textureIndex:223}],treasureGateAnimation:[{textureIndex:216},{textureIndex:200},{textureIndex:201},{textureIndex:202},{textureIndex:203}],playerTorchAnimation:[{textureIndex:217},{textureIndex:218},{textureIndex:219},{textureIndex:219}],achievementIcons:{achievementVictory:{textureIndex:75},achievementGhosty:{textureIndex:110},achievementZippy:{textureIndex:77},achievementHungry:{textureIndex:78},achievementThumpy:{textureIndex:79},achievementSofty:{textureIndex:91},achievementSteppy:{textureIndex:94},achievementHealthy:{textureIndex:107},achievementTreasure:{textureIndex:108},achievementMapping:{textureIndex:109},achievementFaceless:{textureIndex:76}},achievementIncompleteIcon:{textureIndex:63},achievementFailedIcon:{textureIndex:0}};(d=function(){this.init()}).prototype={init:function(){var e=this||p;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||p;if(e=parseFloat(e),t.ctx||v(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,p.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var r=t._howls[o]._getSoundIds(),a=0;a<r.length;a++){var n=t._howls[o]._soundById(r[a]);n&&n._node&&(n._node.volume=n._volume*e)}return t}return t._volume},mute:function(e){var t=this||p;t.ctx||v(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,p.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var r=t._howls[o]._getSoundIds(),a=0;a<r.length;a++){var n=t._howls[o]._soundById(r[a]);n&&n._node&&(n._node.muted=!!e||n._muted)}return t},stop:function(){for(var e=this||p,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||p,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,v()),e},codecs:function(e){return(this||p)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||p;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio){if("undefined"!=typeof Audio)try{var t=new Audio;void 0===t.oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0}try{var t=new Audio;t.muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||p,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(t){return e}if(!t||"function"!=typeof t.canPlayType)return e;var o=t.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator?e._navigator.userAgent:"",a=r.match(/OPR\/(\d+)/g),n=a&&33>parseInt(a[0].split("/")[1],10),i=-1!==r.indexOf("Safari")&&-1===r.indexOf("Chrome"),s=r.match(/Version\/(.*?) /),l=i&&s&&15>parseInt(s[1],10);return e._codecs={mp3:!!(!n&&(o||t.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!o,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(t.canPlayType('audio/wav; codecs="1"')||t.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(t.canPlayType("audio/x-m4b;")||t.canPlayType("audio/m4b;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!l&&t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!l&&t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||p;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var t=function(o){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var r=new Audio;r._unlocked=!0,e._releaseHtml5Audio(r)}catch(t){e.noAudio=!0;break}for(var a=0;a<e._howls.length;a++)if(!e._howls[a]._webAudio)for(var n=e._howls[a]._getSoundIds(),i=0;i<n.length;i++){var s=e._howls[a]._soundById(n[i]);s&&s._node&&!s._node._unlocked&&(s._node._unlocked=!0,s._node.load())}e._autoResume();var l=e.ctx.createBufferSource();l.buffer=e._scratchBuffer,l.connect(e.ctx.destination),void 0===l.start?l.noteOn(0):l.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),l.onended=function(){l.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0);for(var o=0;o<e._howls.length;o++)e._howls[o]._emit("unlock")}};return document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0),document.addEventListener("keydown",t,!0),e}},_obtainHtml5Audio:function(){var e=this||p;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=new Audio().play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var t=this||p;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&p.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio){for(var o=0;o<e._howls[t]._sounds.length;o++)if(!e._howls[t]._sounds[o]._paused)return e}return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var t=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(t,t)}},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&p.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then(function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}},p=new d,(h=function(e){if(!e.src||0===e.src.length){console.error("An array of source files must be passed with any new Howl.");return}this.init(e)}).prototype={init:function(e){var t=this;return p.ctx||v(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!!e.xhr&&!!e.xhr.withCredentials&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=p.usingWebAudio&&!t._html5,void 0!==p.ctx&&p.ctx&&p.autoUnlock&&p._unlockAudio(),p._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e,t,o=null;if(p.noAudio){this._emit("loaderror",null,"No audio support.");return}"string"==typeof this._src&&(this._src=[this._src]);for(var r=0;r<this._src.length;r++){if(this._format&&this._format[r])e=this._format[r];else{if("string"!=typeof(t=this._src[r])){this._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(e=/^data:audio\/([^;,]+);/i.exec(t))||(e=/\.([^.]+)$/.exec(t.split("?",1)[0])),e&&(e=e[1].toLowerCase())}if(e||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),e&&p.codecs(e)){o=this._src[r];break}}if(!o){this._emit("loaderror",null,"No codec support for selected audio sources.");return}return this._src=o,this._state="loading","https:"===window.location.protocol&&"http:"===o.slice(0,5)&&(this._html5=!0,this._webAudio=!1),new m(this),this._webAudio&&x(this),this},play:function(e,t){var o=this,r=null;if("number"==typeof e)r=e,e=null;else if("string"==typeof e&&"loaded"===o._state&&!o._sprite[e])return null;else if(void 0===e&&(e="__default",!o._playLock)){for(var a=0,n=0;n<o._sounds.length;n++)o._sounds[n]._paused&&!o._sounds[n]._ended&&(a++,r=o._sounds[n]._id);1===a?e=null:r=null}var i=r?o._soundById(r):o._inactiveSound();if(!i)return null;if(r&&!e&&(e=i._sprite||"__default"),"loaded"!==o._state){i._sprite=e,i._ended=!1;var s=i._id;return o._queue.push({event:"play",action:function(){o.play(s)}}),s}if(r&&!i._paused)return t||o._loadQueue("play"),i._id;o._webAudio&&p._autoResume();var l=Math.max(0,i._seek>0?i._seek:o._sprite[e][0]/1e3),f=Math.max(0,(o._sprite[e][0]+o._sprite[e][1])/1e3-l),u=1e3*f/Math.abs(i._rate),c=o._sprite[e][0]/1e3,d=(o._sprite[e][0]+o._sprite[e][1])/1e3;i._sprite=e,i._ended=!1;var h=function(){i._paused=!1,i._seek=l,i._start=c,i._stop=d,i._loop=!!(i._loop||o._sprite[e][2])};if(l>=d){o._ended(i);return}var m=i._node;if(o._webAudio){var g=function(){o._playLock=!1,h(),o._refreshBuffer(i);var e=i._muted||o._muted?0:i._volume;m.gain.setValueAtTime(e,p.ctx.currentTime),i._playStart=p.ctx.currentTime,void 0===m.bufferSource.start?i._loop?m.bufferSource.noteGrainOn(0,l,86400):m.bufferSource.noteGrainOn(0,l,f):i._loop?m.bufferSource.start(0,l,86400):m.bufferSource.start(0,l,f),u!==1/0&&(o._endTimers[i._id]=setTimeout(o._ended.bind(o,i),u)),t||setTimeout(function(){o._emit("play",i._id),o._loadQueue()},0)};"running"===p.state&&"interrupted"!==p.ctx.state?g():(o._playLock=!0,o.once("resume",g),o._clearTimer(i._id))}else{var x=function(){m.currentTime=l,m.muted=i._muted||o._muted||p._muted||m.muted,m.volume=i._volume*p.volume(),m.playbackRate=i._rate;try{var r=m.play();if(r&&"undefined"!=typeof Promise&&(r instanceof Promise||"function"==typeof r.then)?(o._playLock=!0,h(),r.then(function(){o._playLock=!1,m._unlocked=!0,t?o._loadQueue():o._emit("play",i._id)}).catch(function(){o._playLock=!1,o._emit("playerror",i._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),i._ended=!0,i._paused=!0})):t||(o._playLock=!1,h(),o._emit("play",i._id)),m.playbackRate=i._rate,m.paused){o._emit("playerror",i._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}"__default"!==e||i._loop?o._endTimers[i._id]=setTimeout(o._ended.bind(o,i),u):(o._endTimers[i._id]=function(){o._ended(i),m.removeEventListener("ended",o._endTimers[i._id],!1)},m.addEventListener("ended",o._endTimers[i._id],!1))}catch(e){o._emit("playerror",i._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===m.src&&(m.src=o._src,m.load());var y=window&&window.ejecta||!m.readyState&&p._navigator.isCocoonJS;if(m.readyState>=3||y)x();else{o._playLock=!0,o._state="loading";var _=function(){o._state="loaded",x(),m.removeEventListener(p._canPlayEvent,_,!1)};m.addEventListener(p._canPlayEvent,_,!1),o._clearTimer(i._id)}}return i._id},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var o=t._getSoundIds(e),r=0;r<o.length;r++){t._clearTimer(o[r]);var a=t._soundById(o[r]);if(a&&!a._paused&&(a._seek=t.seek(o[r]),a._rateSeek=0,a._paused=!0,t._stopFade(o[r]),a._node)){if(t._webAudio){if(!a._node.bufferSource)continue;void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),t._cleanBuffer(a._node)}else isNaN(a._node.duration)&&a._node.duration!==1/0||a._node.pause()}arguments[1]||t._emit("pause",a?a._id:null)}return t},stop:function(e,t){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"stop",action:function(){o.stop(e)}}),o;for(var r=o._getSoundIds(e),a=0;a<r.length;a++){o._clearTimer(r[a]);var n=o._soundById(r[a]);n&&(n._seek=n._start||0,n._rateSeek=0,n._paused=!0,n._ended=!0,o._stopFade(r[a]),n._node&&(o._webAudio?n._node.bufferSource&&(void 0===n._node.bufferSource.stop?n._node.bufferSource.noteOff(0):n._node.bufferSource.stop(0),o._cleanBuffer(n._node)):isNaN(n._node.duration)&&n._node.duration!==1/0||(n._node.currentTime=n._start||0,n._node.pause(),n._node.duration===1/0&&o._clearSound(n._node))),t||o._emit("stop",n._id))}return o},mute:function(e,t){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"mute",action:function(){o.mute(e,t)}}),o;if(void 0===t){if("boolean"!=typeof e)return o._muted;o._muted=e}for(var r=o._getSoundIds(t),a=0;a<r.length;a++){var n=o._soundById(r[a]);n&&(n._muted=e,n._interval&&o._stopFade(n._id),o._webAudio&&n._node?n._node.gain.setValueAtTime(e?0:n._volume,p.ctx.currentTime):n._node&&(n._node.muted=!!p._muted||e),o._emit("mute",n._id))}return o},volume:function(){var e,t,o,r=this,a=arguments;if(0===a.length)return r._volume;if(1===a.length||2===a.length&&void 0===a[1]?r._getSoundIds().indexOf(a[0])>=0?t=parseInt(a[0],10):e=parseFloat(a[0]):a.length>=2&&(e=parseFloat(a[0]),t=parseInt(a[1],10)),void 0===e||!(e>=0)||!(e<=1))return(o=t?r._soundById(t):r._sounds[0])?o._volume:0;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"volume",action:function(){r.volume.apply(r,a)}}),r;void 0===t&&(r._volume=e),t=r._getSoundIds(t);for(var n=0;n<t.length;n++)(o=r._soundById(t[n]))&&(o._volume=e,a[2]||r._stopFade(t[n]),r._webAudio&&o._node&&!o._muted?o._node.gain.setValueAtTime(e,p.ctx.currentTime):o._node&&!o._muted&&(o._node.volume=e*p.volume()),r._emit("volume",o._id));return r},fade:function(e,t,o,r){var a=this;if("loaded"!==a._state||a._playLock)return a._queue.push({event:"fade",action:function(){a.fade(e,t,o,r)}}),a;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),o=parseFloat(o),a.volume(e,r);for(var n=a._getSoundIds(r),i=0;i<n.length;i++){var s=a._soundById(n[i]);if(s){if(r||a._stopFade(n[i]),a._webAudio&&!s._muted){var l=p.ctx.currentTime,f=l+o/1e3;s._volume=e,s._node.gain.setValueAtTime(e,l),s._node.gain.linearRampToValueAtTime(t,f)}a._startFadeInterval(s,e,t,o,n[i],void 0===r)}}return a},_startFadeInterval:function(e,t,o,r,a,n){var i=this,s=t,l=o-t,f=Math.abs(l/.01),u=Math.max(4,f>0?r/f:r),c=Date.now();e._fadeTo=o,e._interval=setInterval(function(){var a=(Date.now()-c)/r;c=Date.now(),s+=l*a,s=Math.round(100*s)/100,s=l<0?Math.max(o,s):Math.min(o,s),i._webAudio?e._volume=s:i.volume(s,e._id,!0),n&&(i._volume=s),(o<t&&s<=o||o>t&&s>=o)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,i.volume(o,e._id),i._emit("fade",e._id))},u)},_stopFade:function(e){var t=this._soundById(e);return t&&t._interval&&(this._webAudio&&t._node.gain.cancelScheduledValues(p.ctx.currentTime),clearInterval(t._interval),t._interval=null,this.volume(t._fadeTo,e),t._fadeTo=null,this._emit("fade",e)),this},loop:function(){var e,t,o,r=arguments;if(0===r.length)return this._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(o=this._soundById(parseInt(r[0],10)))&&o._loop;e=r[0],this._loop=e}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var a=this._getSoundIds(t),n=0;n<a.length;n++)(o=this._soundById(a[n]))&&(o._loop=e,this._webAudio&&o._node&&o._node.bufferSource&&(o._node.bufferSource.loop=e,e&&(o._node.bufferSource.loopStart=o._start||0,o._node.bufferSource.loopEnd=o._stop,this.playing(a[n])&&(this.pause(a[n],!0),this.play(a[n],!0)))));return this},rate:function(){var e,t,o,r=this,a=arguments;if(0===a.length?t=r._sounds[0]._id:1===a.length?r._getSoundIds().indexOf(a[0])>=0?t=parseInt(a[0],10):e=parseFloat(a[0]):2===a.length&&(e=parseFloat(a[0]),t=parseInt(a[1],10)),"number"!=typeof e)return(o=r._soundById(t))?o._rate:r._rate;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"rate",action:function(){r.rate.apply(r,a)}}),r;void 0===t&&(r._rate=e),t=r._getSoundIds(t);for(var n=0;n<t.length;n++)if(o=r._soundById(t[n])){r.playing(t[n])&&(o._rateSeek=r.seek(t[n]),o._playStart=r._webAudio?p.ctx.currentTime:o._playStart),o._rate=e,r._webAudio&&o._node&&o._node.bufferSource?o._node.bufferSource.playbackRate.setValueAtTime(e,p.ctx.currentTime):o._node&&(o._node.playbackRate=e);var i=r.seek(t[n]),s=1e3*((r._sprite[o._sprite][0]+r._sprite[o._sprite][1])/1e3-i)/Math.abs(o._rate);(r._endTimers[t[n]]||!o._paused)&&(r._clearTimer(t[n]),r._endTimers[t[n]]=setTimeout(r._ended.bind(r,o),s)),r._emit("rate",o._id)}return r},seek:function(){var e,t,o=this,r=arguments;if(0===r.length?o._sounds.length&&(t=o._sounds[0]._id):1===r.length?o._getSoundIds().indexOf(r[0])>=0?t=parseInt(r[0],10):o._sounds.length&&(t=o._sounds[0]._id,e=parseFloat(r[0])):2===r.length&&(e=parseFloat(r[0]),t=parseInt(r[1],10)),void 0===t)return 0;if("number"==typeof e&&("loaded"!==o._state||o._playLock))return o._queue.push({event:"seek",action:function(){o.seek.apply(o,r)}}),o;var a=o._soundById(t);if(a){if("number"==typeof e&&e>=0){var n=o.playing(t);n&&o.pause(t,!0),a._seek=e,a._ended=!1,o._clearTimer(t),o._webAudio||!a._node||isNaN(a._node.duration)||(a._node.currentTime=e);var i=function(){n&&o.play(t,!0),o._emit("seek",t)};if(n&&!o._webAudio){var s=function(){o._playLock?setTimeout(s,0):i()};setTimeout(s,0)}else i()}else{if(!o._webAudio)return a._node.currentTime;var l=o.playing(t)?p.ctx.currentTime-a._playStart:0,f=a._rateSeek?a._rateSeek-a._seek:0;return a._seek+(f+l*Math.abs(a._rate))}}return o},playing:function(e){if("number"==typeof e){var t=this._soundById(e);return!!t&&!t._paused}for(var o=0;o<this._sounds.length;o++)if(!this._sounds[o]._paused)return!0;return!1},duration:function(e){var t=this._duration,o=this._soundById(e);return o&&(t=this._sprite[o._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,o=0;o<t.length;o++)t[o]._paused||e.stop(t[o]._id),e._webAudio||(e._clearSound(t[o]._node),t[o]._node.removeEventListener("error",t[o]._errorFn,!1),t[o]._node.removeEventListener(p._canPlayEvent,t[o]._loadFn,!1),t[o]._node.removeEventListener("ended",t[o]._endFn,!1),p._releaseHtml5Audio(t[o]._node)),delete t[o]._node,e._clearTimer(t[o]._id);var r=p._howls.indexOf(e);r>=0&&p._howls.splice(r,1);var a=!0;for(o=0;o<p._howls.length;o++)if(p._howls[o]._src===e._src||e._src.indexOf(p._howls[o]._src)>=0){a=!1;break}return g&&a&&delete g[e._src],p.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,o,r){var a=this["_on"+e];return"function"==typeof t&&a.push(r?{id:o,fn:t,once:r}:{id:o,fn:t}),this},off:function(e,t,o){var r=this["_on"+e],a=0;if("number"==typeof t&&(o=t,t=null),t||o)for(a=0;a<r.length;a++){var n=o===r[a].id;if(t===r[a].fn&&n||!t&&n){r.splice(a,1);break}}else if(e)this["_on"+e]=[];else{var i=Object.keys(this);for(a=0;a<i.length;a++)0===i[a].indexOf("_on")&&Array.isArray(this[i[a]])&&(this[i[a]]=[])}return this},once:function(e,t,o){return this.on(e,t,o,1),this},_emit:function(e,t,o){for(var r=this["_on"+e],a=r.length-1;a>=0;a--)(!r[a].id||r[a].id===t||"load"===e)&&(setTimeout((function(e){e.call(this,t,o)}).bind(this,r[a].fn),0),r[a].once&&this.off(e,r[a].fn,r[a].id));return this._loadQueue(e),this},_loadQueue:function(e){if(this._queue.length>0){var t=this._queue[0];t.event===e&&(this._queue.shift(),this._loadQueue()),e||t.action()}return this},_ended:function(e){var t=e._sprite;if(!this._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(this._ended.bind(this,e),100),this;var o=!!(e._loop||this._sprite[t][2]);if(this._emit("end",e._id),!this._webAudio&&o&&this.stop(e._id,!0).play(e._id),this._webAudio&&o){this._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=p.ctx.currentTime;var r=(e._stop-e._start)*1e3/Math.abs(e._rate);this._endTimers[e._id]=setTimeout(this._ended.bind(this,e),r)}return this._webAudio&&!o&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,this._clearTimer(e._id),this._cleanBuffer(e._node),p._autoSuspend()),this._webAudio||o||this.stop(e._id,!0),this},_clearTimer:function(e){if(this._endTimers[e]){if("function"!=typeof this._endTimers[e])clearTimeout(this._endTimers[e]);else{var t=this._soundById(e);t&&t._node&&t._node.removeEventListener("ended",this._endTimers[e],!1)}delete this._endTimers[e]}return this},_soundById:function(e){for(var t=0;t<this._sounds.length;t++)if(e===this._sounds[t]._id)return this._sounds[t];return null},_inactiveSound:function(){this._drain();for(var e=0;e<this._sounds.length;e++)if(this._sounds[e]._ended)return this._sounds[e].reset();return new m(this)},_drain:function(){var e=this._pool,t=0,o=0;if(!(this._sounds.length<e)){for(o=0;o<this._sounds.length;o++)this._sounds[o]._ended&&t++;for(o=this._sounds.length-1;o>=0;o--){if(t<=e)return;this._sounds[o]._ended&&(this._webAudio&&this._sounds[o]._node&&this._sounds[o]._node.disconnect(0),this._sounds.splice(o,1),t--)}}},_getSoundIds:function(e){if(void 0!==e)return[e];for(var t=[],o=0;o<this._sounds.length;o++)t.push(this._sounds[o]._id);return t},_refreshBuffer:function(e){return e._node.bufferSource=p.ctx.createBufferSource(),e._node.bufferSource.buffer=g[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,p.ctx.currentTime),this},_cleanBuffer:function(e){var t=p._navigator&&p._navigator.vendor.indexOf("Apple")>=0;if(!e.bufferSource)return this;if(p._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=p._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(p._navigator&&p._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}},(m=function(e){this._parent=e,this.init()}).prototype={init:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++p._counter,e._sounds.push(this),this.create(),this},create:function(){var e=this._parent,t=p._muted||this._muted||this._parent._muted?0:this._volume;return e._webAudio?(this._node=void 0===p.ctx.createGain?p.ctx.createGainNode():p.ctx.createGain(),this._node.gain.setValueAtTime(t,p.ctx.currentTime),this._node.paused=!0,this._node.connect(p.masterGain)):p.noAudio||(this._node=p._obtainHtml5Audio(),this._errorFn=this._errorListener.bind(this),this._node.addEventListener("error",this._errorFn,!1),this._loadFn=this._loadListener.bind(this),this._node.addEventListener(p._canPlayEvent,this._loadFn,!1),this._endFn=this._endListener.bind(this),this._node.addEventListener("ended",this._endFn,!1),this._node.src=e._src,this._node.preload=!0===e._preload?"auto":e._preload,this._node.volume=t*p.volume(),this._node.load()),this},reset:function(){var e=this._parent;return this._muted=e._muted,this._loop=e._loop,this._volume=e._volume,this._rate=e._rate,this._seek=0,this._rateSeek=0,this._paused=!0,this._ended=!0,this._sprite="__default",this._id=++p._counter,this},_errorListener:function(){this._parent._emit("loaderror",this._id,this._node.error?this._node.error.code:0),this._node.removeEventListener("error",this._errorFn,!1)},_loadListener:function(){var e=this._parent;e._duration=Math.ceil(10*this._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),this._node.removeEventListener(p._canPlayEvent,this._loadFn,!1)},_endListener:function(){var e=this._parent;e._duration===1/0&&(e._duration=Math.ceil(10*this._node.duration)/10,e._sprite.__default[1]===1/0&&(e._sprite.__default[1]=1e3*e._duration),e._ended(this)),this._node.removeEventListener("ended",this._endFn,!1)}},g={},x=function(e){var t=e._src;if(g[t]){e._duration=g[t].duration,S(e);return}if(/^data:[^;]+;base64,/.test(t)){for(var o=atob(t.split(",")[1]),r=new Uint8Array(o.length),a=0;a<o.length;++a)r[a]=o.charCodeAt(a);_(r.buffer,e)}else{var n=new XMLHttpRequest;n.open(e._xhr.method,t,!0),n.withCredentials=e._xhr.withCredentials,n.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach(function(t){n.setRequestHeader(t,e._xhr.headers[t])}),n.onload=function(){var t=(n.status+"")[0];if("0"!==t&&"2"!==t&&"3"!==t){e._emit("loaderror",null,"Failed loading audio file with status: "+n.status+".");return}_(n.response,e)},n.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete g[t],e.load())},y(n)}},y=function(e){try{e.send()}catch(t){e.onerror()}},_=function(e,t){var o=function(){t._emit("loaderror",null,"Decoding audio data failed.")},r=function(e){e&&t._sounds.length>0?(g[t._src]=e,S(t,e)):o()};"undefined"!=typeof Promise&&1===p.ctx.decodeAudioData.length?p.ctx.decodeAudioData(e).then(r).catch(o):p.ctx.decodeAudioData(e,r,o)},S=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},v=function(){if(p.usingWebAudio){try{"undefined"!=typeof AudioContext?p.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?p.ctx=new webkitAudioContext:p.usingWebAudio=!1}catch(e){p.usingWebAudio=!1}p.ctx||(p.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(p._navigator&&p._navigator.platform),t=p._navigator&&p._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),o=t?parseInt(t[1],10):null;if(e&&o&&o<9){var r=/safari/.test(p._navigator&&p._navigator.userAgent.toLowerCase());p._navigator&&!r&&(p.usingWebAudio=!1)}p.usingWebAudio&&(p.masterGain=void 0===p.ctx.createGain?p.ctx.createGainNode():p.ctx.createGain(),p.masterGain.gain.setValueAtTime(p._muted?0:p._volume,p.ctx.currentTime),p.masterGain.connect(p.ctx.destination)),p._setup()}},"function"==typeof define&&define.amd&&define([],function(){return{Howler:p,Howl:h}}),C=p,void 0!==E?(E.HowlerGlobal=d,E.Howler=p,E.Howl=h,E.Sound=m):"undefined"!=typeof window&&(window.HowlerGlobal=d,window.Howler=p,window.Howl=h,window.Sound=m),HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){if(!this.ctx||!this.ctx.listener)return this;for(var t=this._howls.length-1;t>=0;t--)this._howls[t].stereo(e);return this},HowlerGlobal.prototype.pos=function(e,t,o){return this.ctx&&this.ctx.listener?(t="number"!=typeof t?this._pos[1]:t,o="number"!=typeof o?this._pos[2]:o,"number"!=typeof e)?this._pos:(this._pos=[e,t,o],void 0!==this.ctx.listener.positionX?(this.ctx.listener.positionX.setTargetAtTime(this._pos[0],Howler.ctx.currentTime,.1),this.ctx.listener.positionY.setTargetAtTime(this._pos[1],Howler.ctx.currentTime,.1),this.ctx.listener.positionZ.setTargetAtTime(this._pos[2],Howler.ctx.currentTime,.1)):this.ctx.listener.setPosition(this._pos[0],this._pos[1],this._pos[2]),this):this},HowlerGlobal.prototype.orientation=function(e,t,o,r,a,n){if(!this.ctx||!this.ctx.listener)return this;var i=this._orientation;return(t="number"!=typeof t?i[1]:t,o="number"!=typeof o?i[2]:o,r="number"!=typeof r?i[3]:r,a="number"!=typeof a?i[4]:a,n="number"!=typeof n?i[5]:n,"number"!=typeof e)?i:(this._orientation=[e,t,o,r,a,n],void 0!==this.ctx.listener.forwardX?(this.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),this.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),this.ctx.listener.forwardZ.setTargetAtTime(o,Howler.ctx.currentTime,.1),this.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),this.ctx.listener.upY.setTargetAtTime(a,Howler.ctx.currentTime,.1),this.ctx.listener.upZ.setTargetAtTime(n,Howler.ctx.currentTime,.1)):this.ctx.listener.setOrientation(e,t,o,r,a,n),this)},Howl.prototype.init=(M=Howl.prototype.init,function(e){return this._orientation=e.orientation||[1,0,0],this._stereo=e.stereo||null,this._pos=e.pos||null,this._pannerAttr={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:360,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:360,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:0,distanceModel:void 0!==e.distanceModel?e.distanceModel:"inverse",maxDistance:void 0!==e.maxDistance?e.maxDistance:1e4,panningModel:void 0!==e.panningModel?e.panningModel:"HRTF",refDistance:void 0!==e.refDistance?e.refDistance:1,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:1},this._onstereo=e.onstereo?[{fn:e.onstereo}]:[],this._onpos=e.onpos?[{fn:e.onpos}]:[],this._onorientation=e.onorientation?[{fn:e.onorientation}]:[],M.call(this,e)}),Howl.prototype.stereo=function(e,t){var o=this;if(!o._webAudio)return o;if("loaded"!==o._state)return o._queue.push({event:"stereo",action:function(){o.stereo(e,t)}}),o;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===t){if("number"!=typeof e)return o._stereo;o._stereo=e,o._pos=[e,0,0]}for(var a=o._getSoundIds(t),n=0;n<a.length;n++){var i=o._soundById(a[n]);if(i){if("number"!=typeof e)return i._stereo;i._stereo=e,i._pos=[e,0,0],i._node&&(i._pannerAttr.panningModel="equalpower",i._panner&&i._panner.pan||w(i,r),"spatial"===r?void 0!==i._panner.positionX?(i._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),i._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),i._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):i._panner.setPosition(e,0,0):i._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),o._emit("stereo",i._id)}}return o},Howl.prototype.pos=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(e,t,o,r)}}),a;if(t="number"!=typeof t?0:t,o="number"!=typeof o?-.5:o,void 0===r){if("number"!=typeof e)return a._pos;a._pos=[e,t,o]}for(var n=a._getSoundIds(r),i=0;i<n.length;i++){var s=a._soundById(n[i]);if(s){if("number"!=typeof e)return s._pos;s._pos=[e,t,o],s._node&&((!s._panner||s._panner.pan)&&w(s,"spatial"),void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(t,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(o,Howler.ctx.currentTime)):s._panner.setPosition(e,t,o)),a._emit("pos",s._id)}}return a},Howl.prototype.orientation=function(e,t,o,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(e,t,o,r)}}),a;if(t="number"!=typeof t?a._orientation[1]:t,o="number"!=typeof o?a._orientation[2]:o,void 0===r){if("number"!=typeof e)return a._orientation;a._orientation=[e,t,o]}for(var n=a._getSoundIds(r),i=0;i<n.length;i++){var s=a._soundById(n[i]);if(s){if("number"!=typeof e)return s._orientation;s._orientation=[e,t,o],s._node&&(s._panner||(s._pos||(s._pos=a._pos||[0,0,-.5]),w(s,"spatial")),void 0!==s._panner.orientationX?(s._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.orientationY.setValueAtTime(t,Howler.ctx.currentTime),s._panner.orientationZ.setValueAtTime(o,Howler.ctx.currentTime)):s._panner.setOrientation(e,t,o)),a._emit("orientation",s._id)}}return a},Howl.prototype.pannerAttr=function(){var e,t,o,r=arguments;if(!this._webAudio)return this;if(0===r.length)return this._pannerAttr;if(1===r.length){if("object"!=typeof r[0])return(o=this._soundById(parseInt(r[0],10)))?o._pannerAttr:this._pannerAttr;e=r[0],void 0===t&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),this._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:this._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:this._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:this._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:this._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:this._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:this._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:this._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:this._panningModel})}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var a=this._getSoundIds(t),n=0;n<a.length;n++)if(o=this._soundById(a[n])){var i=o._pannerAttr;i={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:i.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:i.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:i.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:i.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:i.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:i.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:i.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:i.panningModel};var s=o._panner;s||(o._pos||(o._pos=this._pos||[0,0,-.5]),w(o,"spatial"),s=o._panner),s.coneInnerAngle=i.coneInnerAngle,s.coneOuterAngle=i.coneOuterAngle,s.coneOuterGain=i.coneOuterGain,s.distanceModel=i.distanceModel,s.maxDistance=i.maxDistance,s.refDistance=i.refDistance,s.rolloffFactor=i.rolloffFactor,s.panningModel=i.panningModel}return this},Sound.prototype.init=(b=Sound.prototype.init,function(){var e=this._parent;this._orientation=e._orientation,this._stereo=e._stereo,this._pos=e._pos,this._pannerAttr=e._pannerAttr,b.call(this),this._stereo?e.stereo(this._stereo):this._pos&&e.pos(this._pos[0],this._pos[1],this._pos[2],this._id)}),Sound.prototype.reset=(A=Sound.prototype.reset,function(){var e=this._parent;return this._orientation=e._orientation,this._stereo=e._stereo,this._pos=e._pos,this._pannerAttr=e._pannerAttr,this._stereo?e.stereo(this._stereo):this._pos?e.pos(this._pos[0],this._pos[1],this._pos[2],this._id):this._panner&&(this._panner.disconnect(0),this._panner=void 0,e._refreshBuffer(this)),A.call(this)}),w=function(e,t){"spatial"===(t=t||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)};var oi={};oi=new URL("Minstrel_Dance.84f0fe17.mp3",import.meta.url).toString();var os={};os=new URL("level-requirement-1.1c09d439.mp3",import.meta.url).toString();var ol={};ol=new URL("level-requirement-2.d04a051d.mp3",import.meta.url).toString();var of={};of=new URL("lose-game-over.be572349.mp3",import.meta.url).toString();var ou={};ou=new URL("Minstrel Dance Easter Egg.9bfc149a.mp3",import.meta.url).toString();var oc={};oc=new URL("footstep-wood.61af6a80.mp3",import.meta.url).toString();var od={};od=new URL("footstep-tile.2079c58b.mp3",import.meta.url).toString();var op={};op=new URL("footstep-water.9134aef9.mp3",import.meta.url).toString();var oh={};oh=new URL("footstep-gravel.9bd43b2f.mp3",import.meta.url).toString();var om={};om=new URL("footstep-grass.5ff03075.mp3",import.meta.url).toString();const og=[P("iTVA6"),P("28Aoq"),P("loJk2"),P("aPbaQ"),P("3Lt6b"),P("ce6hk")],ox=[P("5Cc9i"),P("FaWvz"),P("in96N"),P("lAYya"),P("lrFFe"),P("8IktG"),P("jDOLn")],oy=[P("8IktG")],o_=[P("eNjZd")],oS=[P("gFQDW"),P("g6s0o"),P("38EWM"),P("4GkcK"),P("cgtym")],ov=[P("eBj7I"),P("jK7UW"),P("5FFXM"),P("kDliU"),P("hCXAK"),P("cfhG3"),P("b7oJW"),P("kw8GX")],oM=[P("9LbpL"),P("aWsJG"),P("bng1w"),P("lKUPS")],ob=[P("dZ6Ot")],oA=[P("2vlD3")],ow=[P("aru1y")],oT=[P("lMhUh"),P("4d44Y")],oR=[P("bEm3g"),P("GdyQD")],oH=[P("1fsB5"),P("6Pwxj"),P("htDuP"),P("6HXgz"),P("eCYq7"),P("5pbaw")],oI=[P("bwvl8"),P("ed1ua"),P("782zK"),P("dPeI8"),P("judkj")],oL=[P("lxyga")],oC=[P("lr8zJ"),P("lDVN4")],oE=[P("dy94L"),P("lAhpG")],oF=[P("cCBZ8"),P("dHyRJ")],ok=[P("dW6q5"),P("2oFKH"),P("l7n2L"),P("2sjSb")],oP=[P("2NUSH")],oD=[P("6xjwR")],oW=[P("11TN1")],oG=[P("8wLll")],oV=[P("2tayG")],oU=[P("avEhW")],oB=[P("lLWGT")],oN=[P("8T2ls")],oO=[P("fByUm")],oz=[P("alZL1")],oq=[P("9vLti"),P("1zLmV")],oY=[P("jLUJz")],oX=[P("hWSD6")],oj=[P("4uL1H")],oK=[P("bUVGA")],o$=[P("kWLlo"),P("4QQlw")],oQ=[[P("kBCif"),"Hmm..."],[P("zYpBE"),"What?"],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"],[P("fBfvt"),"What was that?"],[P("fSmLO"),"What was that?"],[P("4O0Sm"),"What was that?"],[P("dnpBB"),"What was that?"],[P("lTzgV"),"What was that?"],[P("jNZ2c"),"Who goes there?"],[P("fnPwl"),"Huh?"],[P("zYpBE"),"What?"],[P("aUQCu"),"Wha..."],[P("k92wf"),"Wait!"],[P("77Kx3"),"Who's there?"],[P("8xfed"),"What moved?"],[P("hBUAM"),"What's that\nin the shadows?"],[P("h1CTK"),"Did that\nshadow move?"],[P("8Op5H"),"I see\nsomething!"],[P("lRT2G"),"Hello?"],[P("4QYOe"),"Uhh..."]],oJ=[[P("gN074"),"Ahh..."],[P("dNeGR"),"Aww..."],[P("guTRc"),"Quiet out..."],[P("dPFoZ"),"Rest me old\nbones..."]],oZ=[[P("kBCif"),"Hmm..."],[P("zYpBE"),"What?"],[P("fBfvt"),"What was that?"],[P("guTRc"),"Quiet out\nthere..."],[P("cijMG"),"Jumpy tonight..."],[P("cisCa"),"Jumpin' at\nshadows!"],[P("kBCif"),"Hmm..."],[P("b5dIQ"),"Oh well..."],[P("d0IQ3"),"I've got myself\na case of the\njitters..."],[P("f9CFT"),"I must be\nseein' things..."],[P("4FvTv"),"What'd they put\nin my coffee?"],[P("iCyXz"),"Coffee must be\ntoo strong!"],[P("kGrG2"),"Hmm!\nNothing..."],[P("3k4EW"),"Well, I thought\nI saw something."],[P("gnqdY"),"Nothing..."],[P("5Ka6N"),"Hopefully\nnothing."],[P("eQtxH"),"Seein' things,\nI guess."],[P("eQtxH"),"Seein' things,\nI guess."]],o0=[[P("kBCif"),"Hmm..."],[P("zYpBE"),"What?"],[P("fBfvt"),"What was that?"],[P("cijMG"),"Jumpy tonight..."],[P("kBCif"),"Hmm..."],[P("b5dIQ"),"Oh well..."],[P("d0IQ3"),"I've got myself\na case of the\njitters..."],[P("f9CFT"),"I must be\nseein' things..."],[P("4FvTv"),"What'd they put\nin my coffee?"],[P("iCyXz"),"Coffee must be\ntoo strong!"],[P("kGrG2"),"Hmm!\nNothing..."],[P("gnqdY"),"Nothing..."],[P("5Ka6N"),"Hopefully\nnothing."],[P("eQtxH"),"Seein' things,\nI guess."],[P("eQtxH"),"Seein' things,\nI guess."]],o1=[[P("kBCif"),"Hmm..."],[P("zYpBE"),"What?"],[P("hk9GW"),"What?"],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"],[P("fBfvt"),"What was that?"],[P("fSmLO"),"What was that?"],[P("4O0Sm"),"What was that?"],[P("dnpBB"),"What was that?"],[P("lTzgV"),"What was that?"],[P("fnPwl"),"Huh?"],[P("zYpBE"),"What?"],[P("aUQCu"),"Wha..."],[P("k92wf"),"Wait!"],[P("77Kx3"),"Who's there?"],[P("lRT2G"),"Hello?"],[P("4QYOe"),"Uhh..."],[P("kmwuT"),"Hark?"],[P("bCMWR"),"What was that noise?"],[P("bCMWR"),"What was that noise?"],[P("g8Qq3"),"I heard something..."],[P("g8Qq3"),"I heard something..."]],o2=[[P("kBCif"),"Hmm..."],[P("cijMG"),"Jumpy tonight..."],[P("b5dIQ"),"Oh well..."],[P("d0IQ3"),"I've got myself\na case of the\njitters..."],[P("4FvTv"),"What's in my\ncoffee today?"],[P("iCyXz"),"Coffee must be\ntoo strong!"],[P("kGrG2"),"Hmm!\nNothing..."],[P("g21UK"),"Well, I can't\nhear it now."],[P("gnqdY"),"Nothing..."],[P("5Ka6N"),"Hopefully\nnothing."],[P("9Zuei"),"I must be\nhearing things."]],o3=[[P("kBCif"),"Hmm..."],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"],[P("zYpBE"),"What?"],[P("i65tH"),"That noise\nagain?"],[P("5mnQ6"),"Someone's there!"],[P("83lsd"),"Who could\nthat be?"],[P("65hOz"),"Better check\nit out."],[P("j2wFI"),"That better\nbe rats!"],[P("bZZ0a"),"Who is that?"],[P("jB7t1"),"Come out, come out\nwherever you are!"]],o5=[[P("kBCif"),"Hmm..."],[P("cisCa"),"Jumpin' at\nshadows!"],[P("cijMG"),"Jumpy!"],[P("b5dIQ"),"Oh, well."],[P("e7nUw"),"Guess it was\nnothing."],[P("h1yeq"),"Wonder what it was."],[P("2mIEi"),"Back to my post."],[P("lo3Ne"),"All quiet now."],[P("c2S80"),"I'm sure I\nheard something."],[P("gU1Fl"),"Not there anymore."],[P("6LYKz"),"Probably nothing."],[P("kGrG2"),"Hmm!\nNothing."],[P("io6aB"),"I don't know why\nI work here."],[P("b2L3v"),"Waste of my time."],[P("8ViSP"),"Why do I\neven try?"],[P("ber20"),"At least I'm not\non cleaning duty."],[P("9rIu9"),"At least my\nshift ends soon."],[P("f3tTD"),"What do you\nwant me to\ndo about it?"]],o4=[[P("bqr2F"),"Hey!"],[P("zYpBE"),"What?"],[P("hH4nA"),"Coming!"],[P("hl7NG"),"To arms!"]],o8=[[P("2h0t1"),"That torch is out!"],[P("lVCJ1"),"That light\nburned out!"],[P("28vqu"),"It's too dark\nin here."],[P("lNOJi"),"Let's have\nmore light."]],o9=[[P("jmmzf"),"That's better."],[P("lgIKO"),"There we go."],[P("gSOQj"),"Now where was I?"]],o6=[[P("fNEiS"),"(Whistle)"],[P("9rHLm"),"(Whistle)"],[P("6P3MQ"),"(Whistle)"],[P("3YUSH"),"Get 'em!"],[P("cHThu"),"Intruder!"],[P("iw2jP"),"Oh no...\nIt's a thief!"],[P("lFnLM"),"We're coming\nfor you!"],[P("dMQmr"),"Coming for you!"],[P("ajR5D"),"Halt!"],[P("coEKG"),"We see you!"],[P("52627"),"I'll get you!"],[P("19YnT"),"You're a goner!"],[P("9KeLo"),"Just you wait!"],[P("8wIPR"),"You won't get away!"],[P("j75hu"),"No you don't!"],[P("9LPPm"),"Thief!"],[P("a1jqg"),"Thief!"],[P("diLrr"),"Thief!"],[P("9NLiR"),"After them!"],[P("i5XJD"),"What is thy business\nwith this gold?"],[P("fNDiT"),"No mercy for\nthe wicked!"]],o7=[[P("7Ukh7"),"Must have\nrun off..."],[P("b5dIQ"),"Oh, well..."],[P("etWS2"),"Where did they go?"],[P("gyCwG"),"His Holiness would\nnot be pleased!"],[P("aBFy6"),"The boss will\nnot be pleased!"],[P("6haaK"),"I give up!"],[P("c35VN"),"Gone!"],[P("54XEQ"),"Come back here!"],[P("dElRl"),"Rotten scoundrel!"],[P("4bS6L"),"Aargh!!"],[P("6I24P"),"Blast!"],[P("hhVn4"),"Don't come back!"],[P("bEJdc"),"You won't\nget away\nnext time!"],[P("c79ul"),"For His Holiness!"],[P("7qFpu"),"What a lousy day\nat work!"],[P("jfKOd"),"I give up..."],[P("caLno"),"What do I do?\nHelp me, help me..."],[P("ibQRD"),"(Guard rant)"]],re=[[P("cGDcu"),"Someone smacked me!"],[P("8JRX4"),"Someone hit me!"],[P("bkAuQ"),"Who hit me!?"],[P("gw3Q6"),"Which of you\ndevils hit me!?"]],rt=[[P("jlBOP"),"We have a guard down!"],[P("cuvD6"),"Man down!"],[P("dYqH4"),"Guard down!"]],ro=[[P("gN074"),"Ahh..."]],rr=[[P("8DNLc"),"We must have\nan intruder!"],[P("2zlmp"),"I will keep\nan eye out!"],[P("cHThu"),"Intruder!"]],ra=[[P("jvK1H"),"Take that!!"],[P("e3UnG"),"Oof!!"],[P("9fsxd"),"Ugg!!"],[P("dGUHy"),"Ahh!!"],[P("jwMGi"),"Ahh!!"],[P("2juR4"),"Hi-yah!"],[P("cEISO"),"Hi-yah!"],[P("jVA57"),"Hi-yah!"]],rn=[[P("kBCif"),"Hmm..."],[P("zYpBE"),"What?"],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"],[P("fBfvt"),"What was that?"],[P("fSmLO"),"What was that?"],[P("4O0Sm"),"What was that?"],[P("dnpBB"),"What was that?"],[P("lTzgV"),"What was that?"],[P("jNZ2c"),"Who goes there?"],[P("fnPwl"),"Huh?"],[P("zYpBE"),"What?"],[P("aUQCu"),"Wha..."],[P("k92wf"),"Wait!"],[P("77Kx3"),"Who's there?"],[P("lRT2G"),"Hello?"],[P("4QYOe"),"Uhh..."]],ri=[[P("1UHnF"),"They don't\nstay lit!"],[P("4IOJX"),"That's enough to make\na guy paranoid!"],[P("7iuuC"),"Somebody should\nrelight that."],[P("bBsnb"),"That torch\nburned out."],[P("7Ju8p"),"That light\nburned out."],[P("k5DRH"),"It got dark!"],[P("hmSTR"),"Wish I had\na torch..."],[P("7uvGK"),"Why did that\nhappen?"]],rs=[[P("fnPwl"),"Huh?"],[P("zYpBE"),"What?"],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"]],rl=[[P("eYfdW"),"Someone stole\nthe Treasure!"],[P("bgbnX"),"It's missing!"],[P("edLXf"),"Who took it?"],[P("fib9l"),"The boss won't\nlike this!"]],rf=[[P("fnPwl"),"Huh?"],[P("zYpBE"),"What?"],[P("frDLN"),"Hey!"],[P("lbW3C"),"Hey!"],[P("bqr2F"),"Hey!"]];class ru{constructor(){this.activeHowls=[],this.activeLimit=2,this.fadeTime=1e3}setFadetime(e=1e3){return this.fadeTime=e,this}fade(e,t){return this.fadeTime>0?(e.fade(1,0,this.fadeTime,t),setTimeout(()=>e.stop(t),this.fadeTime)):e.stop(t),this}empty(){for(let e of this.activeHowls)this.fade(...e);return this.activeHowls=[],this}queue(e,t){if(this.activeHowls.unshift([e,t]),this.activeHowls.length>this.activeLimit){let e=this.activeHowls.pop();this.fade(...e)}return this.activeHowls=this.activeHowls.slice(0,this.activeLimit),this}}class rc{constructor(e,t=null){this.howls=e.map(e=>new h({src:[e]})),this.howlNum=0,this.soundPool=t,eC(this.howls)}play(e,t=0,o=!1){let r=this.next();r.loop(o),r.volume(e),r.stereo(t);try{let e=r.play();return null!==this.soundPool&&this.soundPool.queue(r,e),e}catch(e){console.log(`Audio playback error ${r}`,e)}return -1}next(){return this.howlNum++,this.howlNum==this.howls.length&&(this.howlNum=0,eC(this.howls)),this.howls[this.howlNum]}}class rd{constructor(e,t=null){this.sounds=e.map(rp),this.soundNum=0,this.soundPool=t,this.mute=!1,eC(this.sounds)}play(e,t=0){let o=this.next();if(!this.mute){o.sound.volume(e),o.sound.stereo(t);let r=o.sound.play();null!==this.soundPool&&this.soundPool.queue(o.sound,r)}return o}next(){let e=this.sounds[this.soundNum];return++this.soundNum,this.soundNum===this.sounds.length&&(this.soundNum=0,eC(this.sounds)),e}}function rp(e){return{sound:new h({src:[e[0]]}),subtitle:e[1]}}const rh={left:!1,right:!1,up:!1,down:!1,wait:!1,jump:!1,zoomIn:!1,zoomOut:!1,snapToPlayer:!1,menuAccept:!1,panUp:!1,panDown:!1,panLeft:!1,panRight:!1,menu:!1,menuBack:!1,menuToggle:!1,homePlay:!1,homeDaily:!1,homeStats:!1,homeAchievements:!1,homeOptions:!1,jumpToggle:!1,startLevel:!1,guardMute:!1,volumeMute:!1,volumeDown:!1,volumeUp:!1,forceRestart:!1,resetState:!1,seeAll:!1,collectLoot:!1,getKey:!1,markSeen:!1,guardSight:!1,guardPatrols:!1,roomAdjacencies:!1,nextLevel:!1,prevLevel:!1,fullscreen:!1,showSpeech:!1,idleCursorToggle:!1,showFPS:!1,devMenu:!1};var rm=null;const rg={"Alt+Comma":["prevLevel"],"Alt+KeyA":["seeAll"],"Alt+KeyB":["roomAdjacencies"],"Alt+KeyC":["collectLoot"],"Alt+KeyK":["getKey"],"Alt+KeyP":["guardPatrols"],"Alt+KeyR":["resetState"],"Alt+KeyS":["markSeen"],"Alt+KeyV":["guardSight"],"Alt+Period":["nextLevel"],"Alt+KeyF":["showFPS"],ArrowDown:["down"],ArrowLeft:["left"],ArrowRight:["right"],ArrowUp:["up"],BracketLeft:["zoomOut"],BracketRight:["zoomIn"],Digit0:["volumeMute"],Digit9:["guardMute"],Enter:["wait","menuAccept"],Equal:["volumeUp"],Escape:["menu","menuBack"],KeyA:["left","homeAchievements"],KeyC:["credits"],KeyD:["right","homeDaily","keyRepeatDelay"],KeyF:["jumpToggle","fullscreen"],KeyG:["guardMute"],KeyI:["idleCursorToggle"],KeyJ:["down","screenShakeEnabled"],KeyK:["up","keyRepeatRate"],KeyH:["left","helpControls"],KeyL:["right"],KeyM:["helpKey"],KeyN:["homeRestart","startLevel"],KeyO:["homeOptions"],KeyP:["homePlay"],KeyR:["homePlay"],KeyS:["down","homeStats","scorePopup"],KeyW:["up"],KeyX:["devMenu"],KeyZ:["wait","menuAccept"],Period:["wait","menuAccept"],Shift:["jump"],Slash:["menu","menuBack"],Space:["wait","menuAccept"],Minus:["volumeDown"],Numpad2:["down"],Numpad4:["left","menu"],Numpad6:["right","menuAccept"],Numpad8:["up"],Numpad5:["wait"],NumpadAdd:["jumpToggle"],NumpadEnter:["menuAccept"],Tab:["showSpeech"],"Control+ArrowDown":["panDown"],"Control+ArrowLeft":["panLeft"],"Control+ArrowRight":["panRight"],"Control+ArrowUp":["panUp"],"Control+KeyA":["panLeft"],"Control+KeyD":["panRight"],"Control+KeyH":["panLeft"],"Control+KeyJ":["panUp"],"Control+KeyK":["panDown"],"Control+KeyL":["panRight"],"Control+KeyR":["forceRestart"],"Control+KeyS":["panDown"],"Control+KeyW":["panUp"],"Control+Numpad2":["panDown"],"Control+Numpad4":["panLeft"],"Control+Numpad6":["panRight"],"Control+Numpad8":["panUp"],"Control+Z":["snapToPlayer"],"Control+Numpad5":["snapToPlayer"],"Control+Period":["snapToPlayer"],"Control+Space":["snapToPlayer"]};class rx extends Array{constructor(e=0,t=0,o=0,r=0){super(e,t,o,r)}collide(e,t,o=0,r=0){return!(e+o<this[0])&&!(t+r<this[1])&&!(e>=this[0]+this[2])&&!(t>=this[1]+this[3])}}class ry{constructor(){for(let e in this.currentFramePresses=new Set,this.controlStates={...rh},this.controlTimes={},this.controlStates)this.controlTimes[e]=Date.now();window.addEventListener("blur",e=>{this.clearPressedAll()})}setPressed(e,t,o=!0){this.controlStates[e]=t,this.controlTimes[e]=Date.now(),o&&t&&this.currentFramePresses.add(e),rm=this}clearPressedAll(){for(let e in this.controlStates)this.controlStates[e]=!1}endFrame(){this.currentFramePresses.clear()}}class r_ extends ry{constructor(e=null){super(),null==e&&(e=rg),this.keyMap=e;let t=this;document.onkeydown=function(e){t.keyDownHandler(e)},document.onkeyup=function(e){t.keyUpHandler(e)}}getCode(e){let t=e.code;return e.altKey&&"AltLeft"!==e.code&&"AltRight"!==e.code&&(t="Alt+"+t),e.ctrlKey&&"ControlLeft"!==e.code&&"ControlRight"!==e.code&&(t="Control+"+t),("AltLeft"==e.code||"AltRight"==e.code)&&(t="Alt"),("ShiftLeft"==e.code||"ShiftRight"==e.code)&&(t="Shift"),("ControlLeft"==e.code||"ControlRight"==e.code)&&(t="Control"),t}updateModifierDown(e){for(let t in this.keyMap)for(let o of this.keyMap[t])!t.includes(e)&&this.controlStates[o]&&(this.controlStates[o]=!1)}updateModifierUp(e){for(let t in this.keyMap)for(let o of this.keyMap[t])t.includes(e)&&this.controlStates[o]&&(this.controlStates[o]=!1)}keyDownHandler(e){rm=this;let t=this.getCode(e);if(["Alt","Control"].includes(t)&&this.updateModifierDown(t),t in this.keyMap)for(let o of(e.preventDefault(),this.keyMap[t]))this.controlStates[o]||this.setPressed(o,!0)}keyUpHandler(e){let t=this.getCode(e);if(["Alt","Control"].includes(t)&&this.updateModifierUp(t),t in this.keyMap)for(let o of(e.preventDefault(),this.keyMap[t]))this.setPressed(o,!1)}}class rS extends ry{constructor(e){super(),this.gamepad=e,this.thresh=.4,this.internalStates={...this.controlStates}}setPressed(e,t){this.internalStates[e]!=t&&(this.internalStates[e]=t,super.setPressed(e,t))}}class rv{constructor(){window.addEventListener("gamepadconnected",e=>this.connected(e)),window.addEventListener("gamepaddisconnected",e=>this.disconnected(e)),this.gamepads={}}connected(e){this.gamepads[e.gamepad.index]=new rS(e.gamepad)}disconnected(e){this.gamepads[e.gamepad.index],delete this.gamepads[e.gamepad.index]}updateGamepadStates(){let e=navigator.getGamepads();if(null!=e)for(let t of e){if(null==t)continue;let e=this.gamepads[t.index];e.gamepad=t,e.setPressed("jump",rM(t,0)),e.setPressed("wait",rM(t,2)),e.setPressed("menuAccept",rM(t,0)||rM(t,2)),e.setPressed("zoomOut",rM(t,6)&&!rM(t,7)),e.setPressed("zoomIn",rM(t,7)&&!rM(t,6)),e.setPressed("menu",rM(t,9)),e.setPressed("left",rM(t,14)&&!rM(t,12)&&!rM(t,13)||t.axes[0]<-e.thresh&&Math.abs(t.axes[1])<.5*Math.abs(t.axes[0])),e.setPressed("right",rM(t,15)&&!rM(t,12)&&!rM(t,13)||t.axes[0]>e.thresh&&Math.abs(t.axes[1])<.5*Math.abs(t.axes[0])),e.setPressed("up",rM(t,12)&&!rM(t,14)&&!rM(t,15)||t.axes[1]<-e.thresh&&Math.abs(t.axes[0])<.5*Math.abs(t.axes[1])),e.setPressed("down",rM(t,13)&&!rM(t,14)&&!rM(t,15)||t.axes[1]>e.thresh&&Math.abs(t.axes[0])<.5*Math.abs(t.axes[1])),e.setPressed("panLeft",t.axes[2]<-e.thresh),e.setPressed("panRight",t.axes[2]>e.thresh),e.setPressed("panUp",t.axes[3]<-e.thresh),e.setPressed("panDown",t.axes[3]>e.thresh),e.setPressed("snapToPlayer",rM(t,5)),e.setPressed("showSpeech",rM(t,4))}}}function rM(e,t){return t<e.buttons.length&&e.buttons[t].pressed}class rb extends ry{constructor(e){super(),this.mouseActive=!1,this.targetOnTouchDown=null,this.canvas=e,e.addEventListener("touchstart",e=>this.process_touchstart(e),!0),e.addEventListener("touchmove",e=>this.process_touchmove(e),!0),e.addEventListener("touchcancel",e=>this.process_touchend(e),!0),e.addEventListener("touchend",e=>this.process_touchend(e),!0),e.addEventListener("mousedown",e=>this.process_mousedown(e),!0),e.addEventListener("mouseup",e=>this.process_mouseup(e),!0),e.addEventListener("mousemove",e=>this.process_mousemove(e),!0),this.lastMotion={id:-1,active:!1,x0:0,y0:0,x:0,y:0},this.coreTouchTargets={up:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},down:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},left:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},right:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},wait:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},jump:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},menuAccept:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!1},pan:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomIn:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0},zoomOut:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0},forceRestart:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0},menuToggle:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0},fullscreen:{id:-1,rect:new rx,touchXY:[0,0],tileInfo:null,mouseable:!0}},this.touchTargets=this.coreTouchTargets}clearMotion(){this.lastMotion.active=!1,this.lastMotion.id=-1,this.lastMotion.x0=0,this.lastMotion.y0=0,this.lastMotion.x=0,this.lastMotion.y=0,this.targetOnTouchDown=null}updateCoreTouchTarget(e,t,o){let r=this.coreTouchTargets[e];r.rect=t,r.tileInfo=o;let a=r.touchXY[0],n=this.canvas.clientHeight-(r.touchXY[1]+1);!r.rect.collide(a,n)&&this.controlStates[e]&&-1!=r.id&&(this.setPressed(e,!1,!1),r.id=-1)}activateTouchTargets(e){let t;for(let[o,r]of(t=void 0===e?this.coreTouchTargets:{...this.coreTouchTargets,...e},Object.entries(this.touchTargets)))o in t||(this.controlStates[o]=!1);this.touchTargets=t}process_mousedown(e){rm=this;let t=e.clientX,o=this.canvas.clientHeight-(e.clientY+1);for(let[r,a]of(this.mouseActive=!0,this.lastMotion.id=-2,this.lastMotion.active=!1,this.lastMotion.x0=t,this.lastMotion.y0=o,this.lastMotion.x=t,this.lastMotion.y=o,this.targetOnTouchDown=null,Object.entries(this.touchTargets)))a.mouseable&&a.rect.collide(t,o)&&(a.touchXY=[e.clientX,e.clientY],a.id=-2,this.setPressed(r,!0),this.targetOnTouchDown=r);e.preventDefault()}process_mousemove(e){rm=this,this.mouseActive=!0;let t=e.clientX,o=this.canvas.clientHeight-(e.clientY+1);for(let[r,a]of(-2==this.lastMotion.id&&(this.lastMotion.active=!0,this.lastMotion.x=t,this.lastMotion.y=o),Object.entries(this.touchTargets)))a.mouseable&&-2===a.id&&(a.rect.collide(t,o)?a.touchXY=[e.clientX,e.clientY]:(this.setPressed(r,!1,!1),a.id=-1));e.preventDefault()}process_mouseup(e){for(let[e,t]of Object.entries(this.touchTargets))t.mouseable&&this.controlStates[e]&&(t.id=-1,this.setPressed(e,!1,!0),this.controlTimes[e]=0);this.clearMotion(),e.preventDefault()}process_touchstart(e){for(let t of(rm=this,this.mouseActive=!1,this.targetOnTouchDown=null,e.changedTouches)){let e=t.clientX,o=this.canvas.clientHeight-(t.clientY+1);for(let[r,a]of(this.lastMotion.id=t.identifier,this.lastMotion.active=!1,this.lastMotion.x0=e,this.lastMotion.y0=o,this.lastMotion.x=e,this.lastMotion.y=o,Object.entries(this.touchTargets)))a.rect.collide(e,o)&&(a.touchXY=[t.clientX,t.clientY],a.id=t.identifier,this.targetOnTouchDown=r,this.setPressed(r,!0))}e.preventDefault()}process_touchmove(e){for(let t of(this.mouseActive=!1,e.changedTouches)){let e=t.clientX,o=this.canvas.clientHeight-(t.clientY+1);for(let[r,a]of(this.lastMotion.id==t.identifier&&(this.lastMotion.active=!0,this.lastMotion.x=e,this.lastMotion.y=o),Object.entries(this.touchTargets)))a.id==t.identifier&&(a.rect.collide(e,o)?a.touchXY=[t.clientX,t.clientY]:(a.id=-1,this.setPressed(r,!1,!1)))}e.preventDefault()}process_touchend(e){for(let t of(this.mouseActive=!1,e.changedTouches)){for(let[e,o]of Object.entries(this.touchTargets))o.id==t.identifier&&(o.id=-1,this.setPressed(e,!1,!0),this.controlTimes[e]=0);this.lastMotion.id==t.identifier&&this.clearMotion()}e.preventDefault()}}var rA=((T=rA||{})[T.HomeScreen=0]="HomeScreen",T[T.StatsScreen=1]="StatsScreen",T[T.AchievementsScreen=2]="AchievementsScreen",T[T.OptionsScreen=3]="OptionsScreen",T[T.HelpControls=4]="HelpControls",T[T.HelpKey=5]="HelpKey",T[T.Mansion=6]="Mansion",T[T.MansionComplete=7]="MansionComplete",T[T.Dead=8]="Dead",T[T.Win=9]="Win",T[T.DailyHub=10]="DailyHub",T[T.CreditsScreen=11]="CreditsScreen",T[T.DevScreen=12]="DevScreen",T),rw=((R=rw||{})[R.Indoor=0]="Indoor",R[R.Outdoor=1]="Outdoor",R[R.OutdoorWater=2]="OutdoorWater",R[R.Water=3]="Water",R[R.Kitchen=4]="Kitchen",R);let rT=!1;function rR(){document.getElementById("modalDialog").style.display="none",rT=!1}function rH(e,t){var o;o=function(e,t){if(null===e)return"No game played yet!";let o=e.numGhostedLevels,r=e.numSpottings,a=e.numInjuries,n=e.numKnockouts,i=e.totalScore,s=e.turns,l=e.numCompletedLevels,f=e.numLevels,u=l>=f,c=e.daily,d=0===e.numLevels?"":u?"Completed mission in "+s+" turns.":"\uD83D\uDC80 Died on level "+(l+1)+" after "+s+" turns.",p="";if(u&&null===c){let e;for(e in t)t[e].failed||(p+=t[e].unicodeBadge);p.length>0&&(p="Achievements: "+p+"<br>")}return`\uD83C\uDFDB\uFE0F LLLOOOT! \uD83C\uDFDB\uFE0F<br>${null!==c?"\uD83D\uDCC5 Daily run for "+c:"\uD83C\uDFB2 Random game"}<br>${d}<br>Completed:   ${l} of ${f}<br>Ghosted:     ${o}<br>Spottings:   ${r}<br>Knockouts:   ${n}<br>Injuries:    ${a}<br>Total score: ${i}<br>${p}`}(e,t),document.getElementById("modalText").innerHTML=o,document.getElementById("modalDialog").style.display="block",rT=!0,document.getElementById("modalCloseButton").onclick=()=>{rR()}}class rI{constructor(){this.pages=[],this.activePage=0,this.activePageData=[],this.highlightedAction=0,this.actionSequence=[],this.cachedPageText="",this.screenSize=W.create(),this.state=new Map,this.glyphs=[],this.maxLineLength=0,this.pixelsPerCharX=0,this.pixelsPerCharY=0,this.offsetX=0,this.offsetY=0,this.textW=8,this.textH=16,this.mat=L.create(),this.touchTargets={}}initAction(e){this.touchTargets[e]={id:-1,rect:new rx(0,0,0,0),tileInfo:{},touchXY:[-1,-1],mouseable:!0}}parseImage(e,t,o,r){let a=e.slice(t+2).indexOf("#");if(a<0)return[e,t];let n=Number(e.slice(t+1,t+2+a));return Number.isNaN(n)?[e,t]:(this.glyphs.push([n,new rx(t,r-o-.875,2,1)]),[e=e.slice(0,t)+"  "+e.slice(t+3+a),t+1])}parseButton(e,t,o,r){let a,n;let i=t;for(;;){if((a=e.slice(t).indexOf("|"))<0||(a+=t,(n=e.slice(a+1).indexOf("]"))<0))return[e,t];if(n+=a+1,t===a)break;"#"===e[t]&&([e,t]=this.parseImage(e,t,o,r)),t+=1}let s=e.slice(a+1,n);if(void 0!==s&&""!==s){s in this.touchTargets||this.initAction(s);let e=[i,t+1,o],[a,n]=[e[0],e[2]-1/8],[l,f]=[e[1],e[2]+1];this.touchTargets[s].rect=new rx(a,r-f,l-a,f-n),this.actionSequence.push(s)}return[e=e.slice(0,a)+e.slice(n),t=a]}parseUI(e){let t=this.pages[this.activePage];for(let[e,o]of this.state)t=t.replace("$"+e+"$",o);if(t===this.cachedPageText&&this.screenSize.equals(e))return;this.cachedPageText=t,W.copy(this.screenSize,e),this.activePageData=t.split("\n");let o=this.activePageData;this.glyphs.length=0,this.actionSequence=[],this.touchTargets={};for(let e=0;e<o.length;++e){let t=o[e],r=0;for(;r<t.length;){switch(t[r]){case"#":[t,r]=this.parseImage(t,r,e,o.length);break;case"[":[t,r]=this.parseButton(t,r,e,o.length)}r+=1}o[e]=t}for(let e of(this.highlightedAction=Math.max(0,Math.min(this.actionSequence.length-1,this.highlightedAction)),this.maxLineLength=0,this.activePageData))this.maxLineLength=Math.max(this.maxLineLength,e.length);for(let t in this.updateScreenSize(e),this.touchTargets){let e=this.touchTargets[t];e.rect[0]-=this.offsetX,e.rect[1]-=this.offsetY,e.rect[0]*=this.pixelsPerCharX,e.rect[1]*=this.pixelsPerCharY,e.rect[2]*=this.pixelsPerCharX,e.rect[3]*=this.pixelsPerCharY}}updateScreenSize(e){let t=a9(e);this.pixelsPerCharX=this.textW*t,this.pixelsPerCharY=this.textH*t;let o=this.maxLineLength*this.pixelsPerCharX,r=this.activePageData.length*this.pixelsPerCharY,a=e[0]/this.pixelsPerCharX,n=e[1]/this.pixelsPerCharY;this.offsetX=Math.floor(-((e[0]-o)/2))/this.pixelsPerCharX,this.offsetY=Math.floor(-((e[1]-r)/2))/this.pixelsPerCharY,L.ortho(this.mat,this.offsetX,this.offsetX+a,this.offsetY,this.offsetY+n,1,-1)}render(e){let t=this.activePageData,o=this.mat,r=this.maxLineLength,a=or.background.textureIndex;e.start(o,ot.Font),e.addGlyph(-1.5,-.75,r+1.5,t.length+.75,{textureIndex:a,color:0xffd020b0}),e.addGlyph(-1,-.5,r+1,t.length+.5,{textureIndex:a,color:0xff1a0416}),e.flush();let n=L.create();for(let t in L.ortho(n,0,this.screenSize[0],0,this.screenSize[1],1,-1),e.start(n,ot.Font),this.touchTargets){rm?.controlStates[t]&&(this.highlightedAction=this.actionSequence.indexOf(t));let o=this.touchTargets[t].rect,r=this.highlightedAction<this.actionSequence.length&&this.actionSequence[this.highlightedAction]===t?0xffd020b0:0xff802060;e.addGlyph(o[0],o[1],o[0]+o[2],o[1]+o[3],{textureIndex:a,color:r})}for(let t of(e.flush(),e.start(o,ot.Entity),this.glyphs)){let o=t[1];e.addGlyph(o[0],o[1],o[2]+o[0],o[3]+o[1],{textureIndex:t[0],color:0xffffffff})}e.flush(),e.start(o,ot.Font);for(let o=0;o<t.length;++o){let r=t.length-(1+o);for(let a=0;a<t[o].length;++a){let n=a;if(" "===t[o])continue;let i=t[o].charCodeAt(a);e.addGlyph(n,r,n+1,r+1,{textureIndex:i,color:0xffeef0ff})}}e.flush()}updateData(e){}update(e){}navigateUI(e){let t="";return e("up")?(this.highlightedAction--,this.highlightedAction<0&&(this.highlightedAction=this.actionSequence.length-1)):e("down")?(this.highlightedAction++,this.highlightedAction>=this.actionSequence.length&&(this.highlightedAction=0)):this.highlightedAction<this.actionSequence.length&&e("menuAccept")&&(t=this.actionSequence[this.highlightedAction]),t}onControls(e,t){}}class rL extends rI{constructor(){super(),this.pages=[`LLLOOOT!

$playRestartOrResume$
[H|helpControls]: Controls help
[M|helpKey]: Map key
[D|homeDaily]: Daily challenge
[O|homeOptions]: Options
[S|homeStats]: Statistics
[A|homeAchievements]: Achievements
[C|credits]: Credits$devMode$`],this.devSequence="LRLRUD",this.devSequenceCursor=0}update(e){let t=e.hasStartedGame?null!==e.dailyRun?"[R|homePlay]: Resume daily game\n[N|homeRestart]: New game":"[R|homePlay]: Resume game\n[N|homeRestart]: New game":"[P|homePlay]: Play game\n";this.state.set("playRestartOrResume",t),this.state.set("devMode",e.devMode?"\n[X|devMenu]: Developer menu":"")}onControls(e,t){let o=this.navigateUI(t);t("homePlay")||"homePlay"==o||t("menu")||"menu"==o||t("menuToggle")?(a2(e),this.devSequenceCursor=0):t("devMenu")||"devMenu"==o?e.gameMode=rA.DevScreen:t("homeRestart")||"homeRestart"==o?(e.rng=new eL,e.dailyRun=null,a3(e)):t("homeDaily")||"homeDaily"==o?e.gameMode=rA.DailyHub:t("homeStats")||"homeStats"==o?e.gameMode=rA.StatsScreen:t("homeAchievements")||"homeAchievements"==o?e.gameMode=rA.AchievementsScreen:t("homeOptions")||"homeOptions"==o?e.gameMode=rA.OptionsScreen:t("helpControls")||"helpControls"==o?e.gameMode=rA.HelpControls:t("helpKey")||"helpKey"==o?e.gameMode=rA.HelpKey:(t("credits")||"credits"==o)&&(e.gameMode=rA.CreditsScreen),t("left")&&this.updateCheatCode("L",e),t("right")&&this.updateCheatCode("R",e),t("up")&&this.updateCheatCode("U",e),t("down")&&this.updateCheatCode("D",e)}updateCheatCode(e,t){this.devSequence[this.devSequenceCursor]!==e&&(this.devSequenceCursor=0),this.devSequence[this.devSequenceCursor]===e&&++this.devSequenceCursor,this.devSequenceCursor>=this.devSequence.length&&(t.devMode=!t.devMode,this.devSequenceCursor=0)}}class rC extends rI{constructor(){super(),this.pages=[`Developer Menu

[Alt+<|prevLevel]  Previous level
[Alt+>|nextLevel]  Next level
[Alt+C|collectLoot]  Collect loot 
[Alt+K|getKey]  Get key
[Alt+S|markSeen]  Mark mansion seen
[Alt+A|seeAll]  See entire map: $seeAll$
[Alt+P|guardPatrols]  See guard patrols: $guardPatrols$
[Alt+V|guardSight]  See guard sight: $guardSight$
[Alt+B|roomAdjacencies]  See rooms: $roomAdjacencies$
[Alt+F|showFPS]  Show FPS: $showFPS$

$message$

[Esc|menuBack]    Back to menu`],this.state.set("message","")}update(e){this.state.set("showFPS",e.fpsInfo.enabled?"Yes":"No"),this.state.set("seeAll",e.seeAll?"Yes":"No"),this.state.set("guardPatrols",e.seeGuardPatrols?"Yes":"No"),this.state.set("guardSight",e.seeGuardSight?"Yes":"No"),this.state.set("roomAdjacencies",e.seeRoomAdjacencies?"Yes":"No"),this.state.set("showFPS",e.fpsInfo.enabled?"Yes":"No")}onControls(e,t){let o=this.navigateUI(t);if(t("menuToggle"))a2(e);else if(t("menuBack")||"menuBack"==o)e.gameMode=rA.HomeScreen,this.state.set("message","");else if(t("prevLevel")||"prevLevel"==o)e.hasStartedGame?e.level>0&&(aa(e),as(e,e.level-1)):this.state.set("message","START GAME FIRST");else if(t("nextLevel")||"nextLevel"==o)e.hasStartedGame?e.level<e.gameMapRoughPlans.length-1&&(aa(e),as(e,e.level+1)):this.state.set("message","START GAME FIRST");else if(t("collectLoot")||"collectLoot"==o){if(e.hasStartedGame){let t=e.gameMap.collectAllLoot();e.player.loot+=t,e.lootStolen+=t,aF(e)}else this.state.set("message","START GAME FIRST")}else t("getKey")||"getKey"==o?e.player.hasVaultKey=!0:t("markSeen")||"markSeen"==o?e.hasStartedGame?(e.gameMap.markAllSeen(),aF(e)):this.state.set("message","START GAME FIRST"):t("seeAll")||"seeAll"==o?(e.seeAll=!e.seeAll,this.state.set("message","")):t("guardSight")||"guardSight"==o?(e.seeGuardSight=!e.seeGuardSight,this.state.set("message","")):t("guardPatrols")||"guardPatrols"==o?(e.seeGuardPatrols=!e.seeGuardPatrols,this.state.set("message","")):t("roomAdjacencies")||"roomAdjacencies"===o?(e.seeRoomAdjacencies=!e.seeRoomAdjacencies,this.state.set("message","")):(t("showFPS")||"showFPS"==o)&&(e.fpsInfo.enabled=!e.fpsInfo.enabled,this.state.set("message",""))}}class rE extends rI{update(e){this.state.set("volumeLevel",(100*e.soundVolume).toFixed(0)),this.state.set("volumeMute",e.volumeMute?"Yes":"No"),this.state.set("guardMute",e.guardMute?"Yes":"No"),this.state.set("screenShakeEnabled",e.screenShakeEnabled?"Yes":"No"),this.state.set("keyRepeatRate",e.keyRepeatRate.toString()),this.state.set("keyRepeatDelay",e.keyRepeatDelay.toString())}onControls(e,t){let o=this.navigateUI(t);if(t("menuToggle"))a2(e);else if(t("menuBack")||"menuBack"==o)e.gameMode=rA.HomeScreen;else if(t("volumeUp")||"volumeUp"==o){let t=Math.min(1,e.soundVolume+.1);aq(e,t)}else if(t("volumeDown")||"volumeDown"==o){let t=Math.max(.1,e.soundVolume-.1);aq(e,t)}else{var r;t("volumeMute")||"volumeMute"==o?aX(e,!e.volumeMute):t("guardMute")||"guardMute"==o?aj(e,!e.guardMute):t("screenShakeEnabled")||"screenShakeEnabled"===o?(r=!e.screenShakeEnabled,e.screenShakeEnabled=r,window.localStorage.setItem("LLL/screenShakeEnabled",r?"true":"false")):t("keyRepeatRate")||"keyRepeatRate"==o?(e.keyRepeatRate-=50,e.keyRepeatRate<100&&(e.keyRepeatRate=400),window.localStorage.setItem("LLL/keyRepeatRate",e.keyRepeatRate.toString())):t("keyRepeatDelay")||"keyRepeatDelay"==o?(e.keyRepeatDelay-=50,e.keyRepeatDelay<100&&(e.keyRepeatDelay=500),window.localStorage.setItem("LLL/keyRepeatDelay",e.keyRepeatDelay.toString())):(t("forceRestart")||"forceRestart"==o)&&(window.localStorage.clear(),e.persistedStats=aQ(),e.gameMode=rA.HomeScreen,aq(e,1),aX(e,!1),aj(e,!1))}}constructor(...e){super(...e),this.pages=[`Options

         Sound volume: $volumeLevel$%
[=|volumeUp]      Volume up
[-|volumeDown]      Volume down
[0|volumeMute]      Volume mute: $volumeMute$
[9|guardMute]      Guard mute: $guardMute$
[J|screenShakeEnabled]      Jolt screen: $screenShakeEnabled$
[K|keyRepeatRate]      Key repeat rate $keyRepeatRate$ms
[D|keyRepeatDelay]      Key repeat delay $keyRepeatDelay$ms
[Ctrl+R|forceRestart] Reset data

[Esc|menuBack]    Back to menu`]}}class rF extends rI{update(e){this.activePage=rm===e.keyboardController?0:rm===e.touchController?+!e.touchController.mouseActive:2}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a2(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rA.HomeScreen)}constructor(...e){super(...e),this.pages=[`Help: Keyboard Controls

  Move: Arrows / WASD / HJKL
  Wait: Space / Z / Period / Numpad5
  Leap/Run: Shift + move (unlimited!)
  Leap/Run (Toggle): F / Numpad+
  Zoom View: [ / ]
  Scroll View: Control + move
  Recenter View: Control + wait
  Volume: (Mute/Down/Up) 0 / - / =
  Guard Mute (Toggle): 9
  Show last speech: Tab

Disable NumLock if using numpad
Touch and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Touch Controls

  Move: #016# / #017# / #018# / #019#
  Wait: #020#
  Leap/Run: #21# + move (unlimited!)
  Zoom View: #22# / #23#
  Scroll View: Touch and drag
  Menu: #27#
  Navigate menu: #018# / #019# / #20#

Keyboard and gamepad also supported

[Esc|menuBack] Back to menu`,`Help: Gamepad Controls

  Move: Left Stick/Pad
  Wait: Button2
  Leap/Run: Button1 + move
  Zoom View: Left / Right trigger
  Scroll View: Right stick
  Recenter View: Right bumper
  Show last speech: Left bumper

Keyboard and touch also supported

[Esc|menuBack] Back to menu`]}}const rk=on.namedTiles.treasureA.textureIndex,rP=on.namedTiles.treasureB.textureIndex,rD=on.namedTiles.treasureC.textureIndex,rW=on.namedTiles.treasureD.textureIndex,rG=on.namedTiles.treasureE.textureIndex,rV=on.namedTiles.treasureV.textureIndex;class rU extends rI{update(e){}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a2(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rA.HomeScreen)}constructor(...e){super(...e),this.pages=[`Map Key

#${on.playerTiles.normal.textureIndex}# Thief: You!
#${on.npcTiles[3].textureIndex}# Guard: Avoid them!
#${on.itemTiles[ec.Coin].textureIndex}# Loot: Steal it!
#${on.itemTiles[ec.Bush].textureIndex}# Tree: Hiding place
#${on.itemTiles[ec.Table].textureIndex}# Table: Hiding place
#${on.itemTiles[ec.Chair].textureIndex}# Stool: Guards sit here
#${on.itemTiles[ec.TorchLit].textureIndex}# Torch: Douse it
#${on.namedTiles.uiWindowTile.textureIndex}# Window: One-way escape
#${on.namedTiles.uiCreakyTile.textureIndex}# Creaky floor: Alerts guards
Bonus loot: Steal it?
#${rk}##${rP}##${rD}##${rW}##${rG}##${rV}#

[Esc|menuBack] Back to menu`]}}class rB extends rI{update(e){}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a2(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rA.HomeScreen)}constructor(...e){super(...e),this.pages=[`Credits

Made for 2023 Seven-Day Roguelike Challenge
Expanded Post-Jam Edition

by James McNeill and Damien Moore

Additional voices by Evan Moore
Additional assistance by Mike Gaffney
Testing by Mendi Carroll and Tom Elmer
Special thanks to Mendi Carroll

[Esc|menuBack] Back to menu`]}}class rN extends rI{timeToMidnightUTC(){let e=new Date,t=new Date(e);t.setUTCHours(24,0,0,0);let o=t.getTime()-e.getTime(),r=Math.floor(o/1e3%60),a=Math.floor(o/6e4%60);return Math.floor(o/36e5%24).toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")}update(e){let t=e.persistedStats.lastPlayedDailyGame;if(e.persistedStats.currentDailyGameId!==ne()&&(e.persistedStats.currentDailyGameId=ne(),e.persistedStats.currentDailyPlays=0,e.persistedStats.currentDailyWins=0,e.persistedStats.currentDailyWinFirstTry=0,e.persistedStats.currentDailyBestScore=0,aJ(e.persistedStats)),null!==t&&e.persistedStats.currentDailyPlays>0){if(0===e.persistedStats.currentDailyWins)this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game played");else if(0===e.persistedStats.currentDailyWinFirstTry)this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game won");else{let t=on.itemTiles[ec.TorchLit].textureIndex;this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+` game won first try #${t}#`)}this.state.set("timeLeft","Time to next game: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play it again")}else this.state.set("dailyStatus",e.persistedStats.currentDailyGameId+" game ready"),this.state.set("timeLeft","Time left to play: "+this.timeToMidnightUTC()),this.state.set("playMode","[P|homePlay] Play now");let o=t?.daily??"None",r=t?.totalScore??0;this.state.set("plays",e.persistedStats.currentDailyPlays.toString()),this.state.set("wins",e.persistedStats.currentDailyWins.toString()),this.state.set("lastPlayed",o),this.state.set("lastScore",r.toString()),this.state.set("bestScore",e.persistedStats.currentDailyBestScore.toString())}onControls(e,t){if(rT)(t("menuAccept")||t("menuBack"))&&rR();else{let o=this.navigateUI(t);t("menuToggle")?a2(e):t("menuBack")||"menuBack"==o?e.gameMode=rA.HomeScreen:t("homePlay")||"homePlay"==o?(a5(e),e.hasStartedGame=!0):(t("scorePopup")||"scorePopup"==o)&&rH(e.persistedStats.lastPlayedDailyGame,e.achievements)}}constructor(...e){super(...e),this.pages=[`The Daily Challenge

Play a new seeded game each day and 
compare results with your rivals.

$dailyStatus$
Plays:             $plays$
Wins:              $wins$
Best score:        $bestScore$

$playMode$
$timeLeft$

Last game played:  $lastPlayed$
Last score:        $lastScore$
[S|scorePopup] Score popup (for copy/paste)

[Esc|menuBack] Back to menu`]}}class rO extends rI{update(e){this.state.set("totalPlays",e.persistedStats.totalPlays.toString()),this.state.set("totalWins",e.persistedStats.totalWins.toString()),this.state.set("totalGhosts",e.persistedStats.totalGhosts.toString()),this.state.set("bestScore",e.persistedStats.bestScore.toString()),this.state.set("allDailyPlays",e.persistedStats.allDailyPlays.toString()),this.state.set("allDailyWins",e.persistedStats.allDailyWins.toString()),this.state.set("allDailyWinsFirstTry",e.persistedStats.allDailyWinsFirstTry.toString())}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a2(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rA.HomeScreen)}constructor(...e){super(...e),this.pages=[`Play Statistics

All games
Total plays:             $totalPlays$
Total wins:              $totalWins$
Total mansions ghosted:  $totalGhosts$
Best score:              $bestScore$

Daily games
Total plays:             $allDailyPlays$
Total wins:              $allDailyWins$
Total wins first try:    $allDailyWinsFirstTry$

[Esc|menuBack] Back to menu`]}}class rz extends rI{update(e){let t=on.achievementIcons,o=`#${on.achievementIncompleteIcon.textureIndex}#`,r=`#${on.achievementFailedIcon.textureIndex}#`,a=null!==e.dailyRun;function n(e,t,n,i,s){let l=n>0?`#${s.textureIndex}#`:i.failed||a?r:o;e.state.set(t,l)}n(this,"victoryAchieved",e.persistedStats.achievementVictory,e.achievements.achievementVictory,t.achievementVictory),n(this,"ghostyAchieved",e.persistedStats.achievementGhosty,e.achievements.achievementGhosty,t.achievementGhosty),n(this,"zippyAchieved",e.persistedStats.achievementZippy,e.achievements.achievementZippy,t.achievementZippy),n(this,"hungryAchieved",e.persistedStats.achievementHungry,e.achievements.achievementHungry,t.achievementHungry),n(this,"thumpyAchieved",e.persistedStats.achievementThumpy,e.achievements.achievementThumpy,t.achievementThumpy),n(this,"softyAchieved",e.persistedStats.achievementSofty,e.achievements.achievementSofty,t.achievementSofty),n(this,"steppyAchieved",e.persistedStats.achievementSteppy,e.achievements.achievementSteppy,t.achievementSteppy),n(this,"healthyAchieved",e.persistedStats.achievementHealthy,e.achievements.achievementHealthy,t.achievementHealthy),n(this,"treasureAchieved",e.persistedStats.achievementTreasure,e.achievements.achievementTreasure,t.achievementTreasure),n(this,"mappingAchieved",e.persistedStats.achievementMapping,e.achievements.achievementMapping,t.achievementMapping),n(this,"facelessAchieved",e.persistedStats.achievementFaceless,e.achievements.achievementFaceless,t.achievementFaceless)}onControls(e,t){let o=this.navigateUI(t);t("menuToggle")?a2(e):(t("menuBack")||"menuBack"==o)&&(e.gameMode=rA.HomeScreen)}constructor(...e){super(...e),this.pages=[`Achievements

Earn achievements by meeting certain
requirements when you complete a game.

 $victoryAchieved$ Victory: winning is enough...
 $hungryAchieved$ Hungry: collect all food
 $treasureAchieved$ Looty: steal all bonus loot
 $healthyAchieved$ Healthy: take no damage
 $steppyAchieved$ Steppy: no leap where a step works
 $thumpyAchieved$ Thumpy: knock out all guards
 $softyAchieved$ Softy: no knockouts
 $mappingAchieved$ Looky: map 100% before looting anything
 $facelessAchieved$ Ghosty: ghost every level
 $zippyAchieved$ Zippy: under par time on every level
 $ghostyAchieved$ Mosty Ghosty: ghost with no knockouts

[Esc|menuBack] Back to menu`]}}class rq extends rI{update(e){let t=Math.max(0,al(e)-e.turns),o=10*e.lootStolen,r=au(e),a=5*e.levelStats.extraFoodCollected,n=0===e.levelStats.numSpottings?o:0,i=o+r+a+t+n;this.state.set("levelType",function(e){switch(e){case 0:case 1:return"Manor";case 2:return"Mansion";case 3:return"Fortress";case 4:return"Warrens"}}(e.gameMapRoughPlans[e.level].levelType)),this.state.set("level",(e.level+1).toString()),this.state.set("numLevels",e.gameMapRoughPlans.length.toString()),this.state.set("lootScore",(10*e.lootStolen).toString()),this.state.set("treasureScore",e.gameMap.treasures.length>0||e.gameMap.items.some(e=>e.type===ec.VaultTreasureBox||e.type===ec.EmptyVaultTreasureBox||e.type===ec.LootedVaultTreasureBox)?"\n Bonus Loot:  "+r:""),this.state.set("foodScore",a>0?"\n Food:        "+a:""),this.state.set("timeBonus",t.toString()),this.state.set("ghostBonus",n.toString()),this.state.set("levelScore",i.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString())}onControls(e,t){let o=this.navigateUI(t);(t("startLevel")||"startLevel"==o)&&(e.level>=e.gameMapRoughPlans.length-1?function(e){C.stop();let t=.1>Math.random()?"easterEgg":"victorySong";e.sounds[t].play(.5),e.persistedStats.totalWins++;let o=e.gameStats.totalScore;e.persistedStats.bestScore=Math.max(e.persistedStats.bestScore,o);let r={score:o,date:ne(),turns:e.totalTurns,level:e.level+1};ai(e,"gameEnd"),e.persistedStats.scores.push(r),e.dailyRun&&(e.persistedStats.currentDailyBestScore=Math.max(e.persistedStats.currentDailyBestScore,o),e.persistedStats.currentDailyWins++,e.persistedStats.currentDailyWinFirstTry=1===e.persistedStats.currentDailyPlays?1:e.persistedStats.currentDailyWinFirstTry,e.persistedStats.lastPlayedDailyGame=structuredClone(e.gameStats),e.persistedStats.allDailyWins++,e.persistedStats.allDailyWinsFirstTry+=+(1===e.persistedStats.currentDailyPlays)),aJ(e.persistedStats),e.dailyRun||function(e){let t;for(t in e.achievements)t in e.persistedStats&&!e.achievements[t].failed&&(e.persistedStats[t]++,a$(t,e.persistedStats[t]))}(e),e.gameMode=rA.Win}(e):as(e,e.level+1))}constructor(...e){super(...e),this.pages=[`$levelType$ Looted! ($level$/$numLevels$)

\x9a\x9b Loot:        $lootScore$$treasureScore$$foodScore$
\x86\x87 Ghost:       $ghostBonus$
\x8c\x8d Speed:       $timeBonus$
\x84\x85 Total:       $levelScore$

\x82\x83 Cumulative:  $totalScore$

[N|startLevel]: Next`]}}class rY extends rI{update(e){this.state.set("level",e.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",e.gameStats.numLevels.toString()),this.state.set("numGhostedLevels",e.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString()),this.state.set("totalTurns",`${e.gameStats.turns}`),this.state.set("numSpottings",`${e.gameStats.numSpottings}`),this.state.set("numInjuries",`${e.gameStats.numInjuries}`),this.state.set("numKnockouts",`${e.gameStats.numKnockouts}`)}onControls(e,t){if(rT)(t("menuAccept")||t("menuBack"))&&rR();else{let o=this.navigateUI(t);t("homeRestart")||"homeRestart"==o?(e.rng=new eL,e.dailyRun=null,a3(e)):t("menuBack")||"menuBack"==o?(e.rng=new eL,e.dailyRun=null,a3(e),e.gameMode=rA.HomeScreen,e.hasStartedGame=!1):(t("scorePopup")||"scorePopup"==o)&&rH(e.gameStats,e.achievements)}}constructor(...e){super(...e),this.pages=[`         You are dead!

\x84\x85 Total Score:   $totalScore$

Statistics
\x9e\x9f Completed:     $level$ of $numLevels$
\x8c\x8d Total turns:   $totalTurns$
\x94\x95 Spottings:     $numSpottings$
\x92\x93 Injuries:      $numInjuries$
\x96\x97 Knockouts:     $numKnockouts$
\x86\x87 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`]}}class rX extends rI{update(e){if(this.state.set("level",e.gameStats.numCompletedLevels.toString()),this.state.set("numLevels",e.gameStats.numLevels.toString()),this.state.set("totalTurns",`${e.gameStats.turns}`),this.state.set("numSpottings",`${e.gameStats.numSpottings}`),this.state.set("numInjuries",`${e.gameStats.numInjuries}`),this.state.set("numKnockouts",`${e.gameStats.numKnockouts}`),this.state.set("numGhostedLevels",e.gameStats.numGhostedLevels.toString()),this.state.set("totalScore",e.gameStats.totalScore.toString()),void 0===this.achievementsLine){if(this.achievementsLine="",!e.dailyRun){let t;for(t in e.achievements)e.achievements[t].failed||(this.achievementsLine+=`#${on.achievementIcons[t].textureIndex}#`);this.achievementsLine.length>0&&(this.achievementsLine="\nAchievements:  "+this.achievementsLine)}this.state.set("achievements",this.achievementsLine)}}onControls(e,t){if(rT)(t("menuAccept")||t("menuBack"))&&rR();else{let o=this.navigateUI(t);t("homeRestart")||"homeRestart"==o?(e.rng=new eL,e.dailyRun=null,this.achievementsLine=void 0,a3(e)):t("menuBack")||"menuBack"==o?(e.rng=new eL,e.dailyRun=null,a3(e),e.gameMode=rA.HomeScreen,this.achievementsLine=void 0,e.hasStartedGame=!1):(t("scorePopup")||"scorePopup"==o)&&rH(e.gameStats,e.achievements)}}constructor(...e){super(...e),this.pages=[`Mission Complete!

\x84\x85 Total Score:   $totalScore$$achievements$

Statistics
\x9e\x9f Completed:     $level$ of $numLevels$
\x8c\x8d Total turns:   $totalTurns$
\x94\x95 Spottings:     $numSpottings$
\x92\x93 Injuries:      $numInjuries$
\x96\x97 Knockouts:     $numKnockouts$
\x86\x87 Ghosted:       $numGhostedLevels$

[N|homeRestart]:   New game
[S|scorePopup]:   Score popup (for copy/paste)
[Esc|menuBack]: Exit to home screen`],this.achievementsLine=void 0}}class rj{update(e,t){"gameStart"===t&&(this.failed=!1)}constructor(){this.failed=!1,this.unicodeBadge=""}}class rK extends rj{update(e,t){super.update(e,t)}constructor(...e){super(...e),this.unicodeBadge=""}}class r$ extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&(e.levelStats.numSpottings>0||e.levelStats.numKnockouts>0)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rQ extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&e.turns>al(e)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rJ extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&e.levelStats.steppableLeaps>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class rZ extends rj{update(e,t){super.update(e,t),"levelEnd"===t&&e.gameMap.guards.some(e=>e.mode!==K.Unconscious)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r0 extends rj{update(e,t){super.update(e,t),"levelEnd"===t&&e.levelStats.numKnockouts>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r1 extends rj{update(e,t){super.update(e,t),"levelEnd"===t&&e.gameMap.items.some(e=>e.type===ec.Health)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r2 extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&e.player.health<e.player.healthMax&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r3 extends rj{update(e,t){super.update(e,t),"turnEnd"===t?e.gameMap.items.some(e=>e.type===ec.EmptyVaultTreasureBox)&&(this.failed=!0):"levelEnd"===t&&e.gameMap.items.some(e=>e.type>=ec.TreasureA||e.type===ec.VaultTreasureBox||e.type===ec.EmptyVaultTreasureBox)&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r5 extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&!this.failed&&(e.lootStolen>0||e.treasureStolen>0||e.levelStats.extraFoodCollected>0)&&!e.gameMap.allSeen()&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}class r4 extends rj{update(e,t){super.update(e,t),"turnEnd"===t&&e.levelStats.numSpottings>0&&(this.failed=!0)}constructor(...e){super(...e),this.unicodeBadge=""}}const r8={numGameMaps:10,totalGameLoot:100};var r9=((H=r9||{})[H.Creak=0]="Creak",H[H.Splash=1]="Splash",H[H.Thud=2]="Thud",H[H.Alarm=3]="Alarm",H[H.BangDoor=4]="BangDoor",H[H.BangChair=5]="BangChair",H),r6=((I=r6||{})[I.Normal=0]="Normal",I[I.AttemptedLeap=1]="AttemptedLeap",I[I.AttemptedLeapBounceBack=2]="AttemptedLeapBounceBack",I);const r7=void 0,ae=document.querySelector("canvas");let at=ae.clientWidth,ao=ae.clientHeight;function ar(e){document.body.addEventListener("keydown",e=>r()),ae.addEventListener("mousedown",e=>r()),ae.addEventListener("touchstart",e=>r()),window.addEventListener("gamepadconnected",e=>r());let t=new t4(ae,oa,on,or),o=function(e,t,o,r,a){let n=new eL,i=eP(r8.numGameMaps,r8.totalGameLoot,n,r7),s=eD(i[0]),l=aQ(),f=parseInt(window.localStorage.getItem("LLL/keyRepeatRate")??"175");isNaN(f)&&(f=175);let u=parseInt(window.localStorage.getItem("LLL/keyRepeatDelay")??"250");isNaN(u)&&(u=250);let c=parseFloat(window.localStorage.getItem("LLL/soundVolume")??"1.0");isNaN(c)&&(c=1);let d=window.localStorage.getItem("LLL/volumeMute"),p=window.localStorage.getItem("LLL/guardMute"),h=window.localStorage.getItem("LLL/screenShakeEnabled"),m=new ep(s.playerStartPos,!1),g={gameStats:{totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:null,timeStarted:0,timeEnded:0},persistedStats:l,levelStats:{numKnockouts:0,numSpottings:0,damageTaken:0,extraFoodCollected:0,steppableLeaps:0},achievements:{achievementVictory:new rK,achievementHungry:new r1,achievementTreasure:new r3,achievementHealthy:new r2,achievementSteppy:new rJ,achievementThumpy:new rZ,achievementSofty:new r0,achievementMapping:new r5,achievementFaceless:new r4,achievementZippy:new rQ,achievementGhosty:new r$},lightStates:Array(s.lightCount).fill(0),particles:[],tLast:void 0,dt:0,idleTimer:5,rng:n,fpsInfo:{enabled:!1,msgFPS:"FPS: --",frames:0,cumulativeTime:0,worstFrame:0,drops:0},devMode:!1,dailyRun:null,leapToggleActive:!1,healthBarState:{damageDisplayTimer:0,healing:!1,size:1,enlargeTimeRemaining:0,heartFlashRemaining:Array(m.healthMax).fill(0)},gameMode:rA.HomeScreen,textWindows:{[rA.HomeScreen]:new rL,[rA.OptionsScreen]:new rE,[rA.StatsScreen]:new rO,[rA.AchievementsScreen]:new rz,[rA.DailyHub]:new rN,[rA.HelpControls]:new rF,[rA.HelpKey]:new rU,[rA.MansionComplete]:new rq,[rA.Dead]:new rY,[rA.Win]:new rX,[rA.CreditsScreen]:new rB,[rA.DevScreen]:new rC},player:m,ambience:rw.Outdoor,ambientSoundPool:r,oldPlayerPos:W.clone(s.playerStartPos),hintMessage:"",numStepMoves:0,numLeapMoves:0,numWaitMoves:0,numZoomMoves:0,hasEnteredMansion:!1,experiencedPlayer:!1,finishedLevel:!1,hasStartedGame:!1,zoomLevel:4,seeAll:!1,seeGuardSight:!1,seeGuardPatrols:!1,seeRoomAdjacencies:!1,camera:az(s.playerStartPos,4),level:0,turns:0,totalTurns:0,lootStolen:0,lootAvailable:i[0].totalLoot,treasureStolen:0,gameMapRoughPlans:i,gameMap:s,sounds:e,subtitledSounds:t,activeSoundPool:o,soundVolume:c,guardMute:null!==p&&"true"===p,volumeMute:null!==d&&"true"===d,screenShakeEnabled:null===h||"true"===h,keyRepeatActive:void 0,keyRepeatRate:f,keyRepeatDelay:u,touchController:a,gamepadManager:new rv,keyboardController:new r_,popups:new V};return a1(s,g),aZ(s,g),a0(s,g),J(g),aF(g),aw(g,g.player.pos),g}({},{},new ru,new ru,new rb(ae));function r(){if(0==Object.keys(o.sounds).length){var e,t,r,a;for(let n in e=o.sounds,t=o.subtitledSounds,r=o.activeSoundPool,a=o.ambientSoundPool,e.footstepWood=new rc([oc]),e.footstepTile=new rc([od]),e.footstepWater=new rc([op]),e.footstepGravel=new rc([oh]),e.footstepGrass=new rc([om]),e.footstepCreaky=new rc(og),e.victorySong=new rc([oi]),e.levelRequirementJingle=new rc([os],r),e.levelCompleteJingle=new rc([ol],r),e.gameOverJingle=new rc([of],r),e.easterEgg=new rc([ou],r),e.hitPlayer=new rc(ox),e.hitGuard=new rc(oy),e.coin=new rc(oS),e.coinRattle=new rc(o_),e.food=new rc(ow),e.grabKey=new rc(oT),e.clockChime=new rc(ob),e.clockTick=new rc(oA),e.doorOpen=new rc(oP),e.doorClose=new rc(oD),e.doorOpenLocked=new rc(oW),e.doorCloseLocked=new rc(oG),e.playerDoorOpen=new rc(oV),e.playerDoorClose=new rc(oU),e.playerDoorOpenLocked=new rc(oB),e.playerDoorCloseLocked=new rc(oN),e.grunt=new rc(ov),e.douse=new rc(oM),e.ignite=new rc(oR),e.hide=new rc(oH),e.gate=new rc(oI),e.thump=new rc(oL),e.splash=new rc(oC),e.waterEnter=new rc(oO),e.waterExit=new rc(oz),e.jump=new rc(oq),e.tooHigh=new rc(o$),e.treasureAlarm=new rc(oY),e.switchProgress=new rc(oX),e.switchReset=new rc(oj),e.switchSuccess=new rc(oK),e.ambienceWater=new rc(oE,a),e.ambienceKitchen=new rc(oF,a),e.ambienceOutdoor=new rc(ok,a),t.guardInvestigate=new rd(o3,r),t.guardFinishInvestigating=new rd(o5,r),t.guardSeeThief=new rd(oQ),t.guardFinishLooking=new rd(oZ,r),t.guardFinishLookingAtLitTorch=new rd(o0,r),t.guardChase=new rd(o6,r),t.guardEndChase=new rd(o7,r),t.guardHearGuard=new rd(o4,r),t.guardSpotDownedGuard=new rd(rf,r),t.guardSeeUnlitTorch=new rd(o8,r),t.guardHearThief=new rd(o1,r),t.guardAwakesWarning=new rd(re,r),t.guardDownWarning=new rd(rt,r),t.guardWarningResponse=new rd(rr,r),t.guardFinishListening=new rd(o2,r),t.guardFinishLightingTorch=new rd(o9,r),t.guardDamage=new rd(ra,r),t.guardStirring=new rd(ro,r),t.guardRest=new rd(oJ,r),t.guardSeeTorchLit=new rd(rn,r),t.guardSeeTorchDoused=new rd(ri,r),t.guardSpotStolenTreasure=new rd(rs,r),t.guardExamineStolenTreasure=new rd(rl,r),C.volume(o.soundVolume),C.mute(aY(o)),o.subtitledSounds)o.subtitledSounds[n].mute=o.guardMute}}window.addEventListener("blur",e=>{C.mute(aY(o))}),window.addEventListener("focus",e=>{C.mute(aY(o))}),new ResizeObserver(e=>{at=ae.clientWidth,ao=ae.clientHeight,o.camera.snapped=!1,screen.orientation.unlock()}).observe(ae),requestAnimationFrame(e=>(function e(t,o,r){let a=t/1e3,n=void 0===r.tLast?0:Math.min(1/30,a-r.tLast);r.dt=n,r.tLast=a,r.fpsInfo.enabled&&(r.fpsInfo.frames++,r.fpsInfo.cumulativeTime+=n,r.fpsInfo.worstFrame<n&&(r.fpsInfo.worstFrame=n),n>.017&&r.fpsInfo.drops++,r.fpsInfo.cumulativeTime>1&&(r.fpsInfo.msgFPS=`FPS: ${Math.round(r.fpsInfo.frames/r.fpsInfo.cumulativeTime*10)/10} (worst: ${Math.round(1e3*r.fpsInfo.worstFrame)}ms, # drops: ${r.fpsInfo.drops})`,r.fpsInfo.cumulativeTime=0,r.fpsInfo.frames=0,r.fpsInfo.worstFrame=0,r.fpsInfo.drops=0)),ae.width=at,ae.height=ao;let i=W.fromValues(at,ao);r.oldPlayerPos=W.clone(r.player.pos),function(e){if(e.gamepadManager.updateGamepadStates(),null!==rm)for(let o in e.gameMode===rA.Mansion?function(o){var r,a;if(o.controlStates.panLeft&&(e.camera.panning=!0,e.camera.position[0]-=1/e.camera.zoom),o.controlStates.panRight&&(e.camera.panning=!0,e.camera.position[0]+=1/e.camera.zoom),o.controlStates.panUp&&(e.camera.panning=!0,e.camera.position[1]+=1/e.camera.zoom),o.controlStates.panDown&&(e.camera.panning=!0,e.camera.position[1]-=1/e.camera.zoom),o.controlStates.snapToPlayer&&(e.camera.panning=!1),t("left"))e.leapToggleActive!==o.controlStates.jump?aR(e,-1,0):ab(e,-1,0,0);else if(t("right"))e.leapToggleActive!==o.controlStates.jump?aR(e,1,0):ab(e,1,0,0);else if(t("down"))e.leapToggleActive!==o.controlStates.jump?aR(e,0,-1):ab(e,0,-1,0);else if(t("up"))e.leapToggleActive!==o.controlStates.jump?aR(e,0,1):ab(e,0,1,0);else if(t("wait"))(function(e){let t=e.player;if(t.health<=0){aT(e);return}t.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion(),aC(e),e.gameMap.identifyAdjacentCells(t.pos),t.pickTarget=null,t.preNoisy=!1,++e.numWaitMoves,aE(e),aw(e,e.player.pos)})(e);else if(t("menu")||t("menuToggle"))e.player.health>0?e.gameMode=rA.HomeScreen:e.gameMode=rA.Dead;else if(t("jumpToggle"))e.leapToggleActive=!e.leapToggleActive;else if(t("seeAll"))e.devMode&&(e.seeAll=!e.seeAll);else if(t("collectLoot")){if(e.devMode){let t=e.gameMap.collectAllLoot();e.player.loot+=t,e.lootStolen+=t,aF(e)}}else if(t("getKey")){if(e.devMode)for(let t of(e.player.hasVaultKey=!0,e.gameMap.guards))t.hasVaultKey=!1}else if(t("forceRestart"))e.dailyRun?a5(e):(e.rng=new eL,e.dailyRun=null,a3(e));else if(t("nextLevel"))e.devMode&&e.level<e.gameMapRoughPlans.length-1&&(aa(e),as(e,e.level+1),e.camera.zoomed=!1);else if(t("resetState"))e.devMode&&function(e){let t=eD(e.gameMapRoughPlans[e.level]);e.player=new ep(t.playerStartPos,null!==e.dailyRun),e.lightStates=Array(t.lightCount).fill(0),a1(t,e),aZ(t,e),a0(t,e),e.turns=0,e.totalTurns=0,e.lootStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,e.treasureStolen=0,an(e.levelStats),ai(e,"gameStart"),e.hintMessage="",aG(e),e.finishedLevel=!1,e.ambience=rw.Outdoor,e.camera=az(t.playerStartPos,e.zoomLevel),e.gameMap=t,e.popups.reset(),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),J(e),aF(e),aw(e,e.player.pos),C.stop(),ag(e),null===e.player.torchAnimation&&console.log("WARNING: No player torch added")}(e);else if(t("prevLevel"))e.devMode&&e.level>0&&(aa(e),as(e,e.level-1),e.camera.zoomed=!1);else if(t("showFPS"))e.devMode&&(e.fpsInfo.enabled=!e.fpsInfo.enabled);else if(t("guardSight"))e.devMode&&(e.seeGuardSight=!e.seeGuardSight);else if(t("guardPatrols"))e.devMode&&(e.seeGuardPatrols=!e.seeGuardPatrols);else if(t("roomAdjacencies"))e.devMode&&(e.seeRoomAdjacencies=!e.seeRoomAdjacencies);else if(t("markSeen"))e.devMode&&(e.gameMap.markAllSeen(),aF(e));else if(t("zoomIn"))(r=e).zoomLevel=Math.min(16,r.zoomLevel+1),r.camera.panning=!1,++r.numZoomMoves,aF(r);else if(t("zoomOut"))(a=e).zoomLevel=Math.max(-4,a.zoomLevel-1),a.camera.panning=!1,++a.numZoomMoves,aF(a);else if(t("guardMute"))aj(e,!e.guardMute),e.popups.setNotification("Guard speech: "+(e.guardMute?"disabled":"enabled"),e.player,3,2);else if(t("idleCursorToggle")){switch(e.player.idleCursorType){case"orbs":e.player.idleCursorType="off";break;case"off":e.player.idleCursorType="orbs"}e.player.idle=!1,e.idleTimer=2,e.popups.setNotification("Player idle cursor: "+e.player.idleCursorType,e.player,3,2)}else if(t("volumeMute"))aX(e,!e.volumeMute),e.popups.setNotification("Sound: "+(e.volumeMute?"disabled":"enabled"),e.player,3,2);else if(t("volumeDown")){let t=Math.max(.1,e.soundVolume-.1);aq(e,t),e.popups.setNotification("Sound volume: "+Math.floor(100*e.soundVolume+.5)+"%",e.player,3,2)}else if(t("volumeUp")){let t=Math.min(1,e.soundVolume+.1);aq(e,t),e.popups.setNotification("Sound volume: "+Math.floor(100*e.soundVolume+.5)+"%",e.player,3,2)}else t("showSpeech")&&e.popups.toggleShow(e.player.pos)}(rm):e.textWindows[e.gameMode]?.onControls(e,function(e){let t=!1;return null!==rm&&e in rm.controlStates&&((t=rm.currentFramePresses.has(e))&&(rm.controlTimes[e],Date.now()),t)}),e.touchController.endFrame(),e.keyboardController.endFrame(),e.gamepadManager.gamepads)e.gamepadManager.gamepads[o].endFrame();function t(t){let o=Date.now(),r=!1;if(null===rm)return!1;let a=rm.controlStates;if(!(t in a))return!1;let n=e.keyRepeatActive===t?e.keyRepeatRate:e.keyRepeatDelay;return(r=rm.currentFramePresses.has(t)||a[t]&&o-rm.controlTimes[t]>n)&&(a[t]&&o-rm.controlTimes[t]>n&&(e.keyRepeatActive=t),rm.controlTimes[t]=o),a[t]||e.keyRepeatActive!==t||(e.keyRepeatActive=void 0),r}}(r),r.camera.zoomed||(r.camera.zoomed=!0,function(e,t){let o=16*a9(t),r=t[0]/16,a=(t[1]-2*o)/16,n=e.gameMap.cells.sizeX,i=e.gameMap.cells.sizeY;r*i<a*n?e.zoomLevel=Math.log(r/n)/Math.log(1.1892):e.zoomLevel=Math.log(a/i)/Math.log(1.1892),e.zoomLevel=Math.max(0,Math.floor(e.zoomLevel))}(r,i)),r.camera.snapped||(r.camera.panning=!1,r.camera.snapped=!0,r.camera.zoom=r.zoomLevel,r.camera.zoomVelocity=0,r.camera.scale=Math.pow(1.1892,r.camera.zoom),a4(W.fromValues(r.gameMap.cells.sizeX,r.gameMap.cells.sizeY),i,r.camera.scale,rm===r.touchController&&!r.touchController.mouseActive,r.camera.position,r.player.pos),W.zero(r.camera.velocity),W.zero(r.camera.joltOffset),W.zero(r.camera.joltVelocity)),n>0&&function(e,t,o){for(let r of(function(e,t,o){let r=e.zoomLevel-e.camera.zoom,a=-e.camera.zoomVelocity,n=e.camera.zoomVelocity+(2*a+8*r)*8*o;e.camera.zoom+=(e.camera.zoomVelocity+n)*(.5*o),e.camera.zoomVelocity=n,e.camera.scale=Math.pow(1.1892,e.camera.zoom);let i=W.create();if(!e.camera.panning){let r=W.create(),a=Math.pow(1.1892,e.zoomLevel);a4(W.fromValues(e.gameMap.cells.sizeX,e.gameMap.cells.sizeY),t,a,rm===e.touchController&&!e.touchController.mouseActive,r,e.player.pos);let n=W.create();W.subtract(n,r,e.camera.position);let s=W.create();W.negate(s,e.camera.velocity);let l=W.create();W.scale(l,n,64),W.scaleAndAdd(l,l,s,16),W.scaleAndAdd(i,e.camera.velocity,l,o)}W.scaleAndAdd(e.camera.position,e.camera.position,e.camera.velocity,.5*o),W.scaleAndAdd(e.camera.position,e.camera.position,i,.5*o),W.copy(e.camera.velocity,i);let s=W.create();W.scale(s,e.camera.joltOffset,-576),W.scaleAndAdd(s,s,e.camera.joltVelocity,-48);let l=W.create();W.scaleAndAdd(l,e.camera.joltVelocity,s,o),W.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,e.camera.joltVelocity,.5*o),W.scaleAndAdd(e.camera.joltOffset,e.camera.joltOffset,l,.5*o),W.copy(e.camera.joltVelocity,l)}(e,t,o),function(e,t){let o,r;let a=e.player;if(e.player.health<=0||e.gameMode!==rA.Mansion||null!==e.player.animation||(e.idleTimer-=t,e.idleTimer>0))return;let n=W.create(),i=W.fromValues(-.125,0),s=W.fromValues(.125,0),l=W.fromValues(0,.125),f=a.hidden(e.gameMap),u=on.playerTiles;f||Math.random()>.5?(o=[{pt0:n,pt1:l,duration:.1,fn:U.easeInQuad},{pt0:l,pt1:n,duration:.05,fn:U.easeOutQuad},{pt0:n,pt1:n,duration:.1,fn:U.easeOutQuad},{pt0:n,pt1:l,duration:.1,fn:U.easeInQuad},{pt0:l,pt1:n,duration:.05,fn:U.easeOutQuad}],r=f?[u.hidden]:[u.normal]):(o=[{pt0:n,pt1:i,duration:.1,fn:U.easeOutQuad},{pt0:i,pt1:i,duration:.5,fn:U.easeOutQuad},{pt0:i,pt1:n,duration:.1,fn:U.easeInQuad},{pt0:n,pt1:s,duration:.1,fn:U.easeOutQuad},{pt0:s,pt1:s,duration:.5,fn:U.easeOutQuad},{pt0:s,pt1:n,duration:.1,fn:U.easeInQuad}],r=[u.left,u.left,u.normal,u.right,u.right,u.normal]),a.animation=new z(o,r),a.idle||("orbs"===a.idleCursorType?a.idleCursorAnimation=[new Y(on.namedTiles.idleIndicator,.6,Math.PI,0,0),new Y(on.namedTiles.idleIndicator,.6,Math.PI,2*Math.PI/3,0),new Y(on.namedTiles.idleIndicator,.6,Math.PI,4*Math.PI/3,0)]:a.idleCursorAnimation=[]),a.idle=!0,e.idleTimer=5}(e,o),function(e,t){e.healthBarState.damageDisplayTimer=Math.max(0,e.healthBarState.damageDisplayTimer-t),e.healthBarState.enlargeTimeRemaining=Math.max(0,e.healthBarState.enlargeTimeRemaining-1.5*t);let o=1;o=e.healthBarState.enlargeTimeRemaining>.85?1-((e.healthBarState.enlargeTimeRemaining-.85)/.15000000000000002)**2:(o=e.healthBarState.enlargeTimeRemaining/.85)*o*(3-2*o),e.healthBarState.size=1+o/2,o=t/1;for(let t=0;t<e.healthBarState.heartFlashRemaining.length;++t)e.healthBarState.heartFlashRemaining[t]=Math.max(0,e.healthBarState.heartFlashRemaining[t]-o)}(e,o),e.popups.animate(o),void 0!==e.popups.currentSpeaker&&(e.popups.currentSpeechAbove?e.player.pos[1]>e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!1):e.player.pos[1]<e.popups.currentSpeaker.pos[1]&&(e.popups.currentSpeechAbove=!0)),e.player.noisyAnim+=2*o,e.player.noisyAnim-=Math.floor(e.player.noisyAnim),e.player.animation&&e.player.animation.update(o)&&(e.player.animation=null),e.player.lightActive&&e.player.torchAnimation?.update(o)&&(e.player.torchAnimation=null),e.player.idle&&e.player.idleCursorAnimation&&(e.player.idleCursorAnimation=e.player.idleCursorAnimation.filter(e=>!e.update(o))),e.gameMap.cells.values))r.animation?.update(o);for(let t of e.gameMap.items)t.animation?.update(o);for(let t of e.gameMap.guards)t.animation?.update(o)&&(t.animation=null),t.torchAnimation?.update(o)&&(t.torchAnimation=null);if(e.gameMapRoughPlans[e.level].levelType===es.Fortress&&!e.oldPlayerPos.equals(e.player.pos)){let t=e.gameMap.items.find(t=>t.pos.equals(e.oldPlayerPos));if(t&&t.type===ec.Bush){let e=aN(es.Fortress,on)[t.type],o={...e},r={...e},a={...e};o.textureIndex=e.textureIndex?e.textureIndex+1:0,r.textureIndex=e.textureIndex?e.textureIndex+2:0,a.textureIndex=e.textureIndex?e.textureIndex+3:0,t.animation=new O([e,o,r,a,a,a,r,o,e],1,0,1)}}e.gameMap.items=e.gameMap.items.filter(e=>{let t=e.animation?.update(o);return!0===t&&(e.animation=void 0),!(e instanceof z)&&!(e instanceof O)||!e.removeOnFinish||!0!==t}),e.particles=e.particles.filter(e=>{let t=e.animation?.update(o);return!(e.animation instanceof z)&&!(e.animation instanceof O)||!e.animation.removeOnFinish||!0!==t})}(r,i,n);let s=r.textWindows[r.gameMode];void 0!==s&&(s.update(r),s.parseUI(i)),function(e,t,o,r){if(rm!==e)return;let a=r.textWindows[r.gameMode];if(-1!==e.lastMotion.id&&void 0===a&&null===e.targetOnTouchDown&&e.lastMotion.active){let t=e.lastMotion.x-e.lastMotion.x0,o=e.lastMotion.y-e.lastMotion.y0,a=t/(16*r.camera.scale),n=o/(16*r.camera.scale);r.camera.panning=!0,r.camera.position[0]-=a-r.camera.anchor[0],r.camera.position[1]-=n-r.camera.anchor[1],r.camera.anchor[0]=a,r.camera.anchor[1]=n}else r.camera.anchor[0]=0,r.camera.anchor[1]=0;(function(e,t,o,r){let a=void 0!==t.entityTileSet.touchButtons?t.entityTileSet.touchButtons:{},n=16*a9(o),i=o[0],s=o[1]-n,l=Math.min(80,Math.floor(Math.min(i,s)/5)),f=r.gameMode===rA.Mansion,u=[{action:"menuToggle",rect:new rx(0,n+s-l-0,l,l),tileInfo:a.menu,visible:!0},{action:"zoomIn",rect:new rx(0+i-l-0,n+s-l-0,l,l),tileInfo:a.zoomIn,visible:f},{action:"zoomOut",rect:new rx(0+i-l-0,n+s-2*l-0,l,l),tileInfo:a.zoomOut,visible:f},{action:"left",rect:new rx(0,n+l+0,l,l),tileInfo:a.left,visible:!0},{action:"right",rect:new rx(0+2*l+0,n+l+0,l,l),tileInfo:a.right,visible:!0},{action:"up",rect:new rx(0+l+0,n+2*l+0,l,l),tileInfo:a.up,visible:!0},{action:"down",rect:new rx(0+l+0,n+0,l,l),tileInfo:a.down,visible:!0},{action:"wait",rect:new rx(0+l+0,n+l+0,l,l),tileInfo:a.wait,visible:f},{action:"jump",rect:new rx(0+i-1.5*l-0,n+0,1.5*l,1.5*l),tileInfo:a.jump,visible:f},{action:"menuAccept",rect:new rx(0+i-1.5*l-0,n+0,1.5*l,1.5*l),tileInfo:a.menuAccept,visible:!f}],c=new rx;for(let t of u)e.updateCoreTouchTarget(t.action,t.visible?t.rect:c,t.tileInfo)})(e,t,o,r),e.activateTouchTargets(a?a.touchTargets:void 0)}(r.touchController,o,i,r),function(e,t,o){e.beginFrame(t);let r=L.create();(function(e,t,o){let r=16*a9(t),[a,n]=a8(W.fromValues(t[0],t[1]-r),e.camera.scale),i=e.camera.position[0]+e.camera.joltOffset[0],s=e.camera.position[1]+e.camera.joltOffset[1],l=r/(16*e.camera.scale),f=i-a/2,u=s-n/2;L.ortho(o,f,f+a,u-l,u+n,1,-1)})(o,t,r),function(e,t,o){for(let r=0;r<e.sizeX;r++)for(let a=0;a<e.sizeY;a++){let n=e.at(r,a);n.type<el.Wall0000||n.type>el.DoorEW?e.at(r,a).litAnim=aU(n.lit,t,n.litSrc,o||n.seen):e.at(r,a).litAnim=0}}(o.gameMap.cells,o.lightStates,o.seeAll),e.start(r,ot.Terrain),function(e,t){let o=function(e,t){switch(e){case es.Manor:return t.terrainTiles;case es.ManorRed:return t.redWallTerrainTiles;case es.Mansion:return t.manseTerrainTiles;case es.Fortress:return t.fortressTerrainTiles;case es.Warrens:return t.redWallTerrainTiles}}(e.gameMapRoughPlans[e.level].levelType,t.terrainTileSet);for(let r=0;r<e.gameMap.cells.sizeX;++r)for(let a=e.gameMap.cells.sizeY-1;a>=0;--a){let n=e.gameMap.cells.at(r,a);if(!n.seen&&!e.seeAll)continue;let i=n.type;i!=el.GroundWoodCreaky||n.lit||n.identified||e.seeAll||(i=el.GroundWood);let s=aB(r,a,e.gameMap.cells),l=n.animation?n.animation.currentTile():o[i];if(i!==el.DoorEW&&i!==el.DoorNS||n.blocksSight||void 0===l.textureIndex||(l={textureIndex:l.textureIndex+1,color:l.color,unlitColor:l.unlitColor}),t.addGlyphLit4(r,a,r+1,a+1,l,s),i===el.GroundWater){let o=t.terrainTileSet.ledgeTiles,n=0;for(let i of[[0,1],[0,-1],[-1,0],[1,0]])e.gameMap.cells.at(r+i[0],a+i[1]).type!==el.GroundWater&&t.addGlyphLit4(r,a,r+1,a+1,o[n],s),n++}}}(o,e),e.flush(),e.start(r,ot.Entity),aO(o,e,!1),function(e,t){if(!e.seeGuardSight)return;let o=e.gameMap.cells.sizeX,r=e.gameMap.cells.sizeY,a=new ea(o,r,!1),n=W.create(),i=W.create();for(let t of e.gameMap.guards){let s=Math.max(0,Math.floor(t.pos[0]-10)),l=Math.min(o,Math.floor(t.pos[0]+10)+1),f=Math.max(0,Math.floor(t.pos[1]-10)),u=Math.min(r,Math.floor(t.pos[1]+10)+1);for(let o=f;o<u;++o)for(let r=s;r<l;++r){if(a.get(r,o))continue;W.set(n,r,o),W.subtract(i,n,t.pos);let s=e.gameMap.cells.atVec(n);!(!e.seeAll&&!s.seen||s.blocksPlayerMove||t.mode!==K.ChaseVisibleTarget&&0>W.dot(t.dir,i)||W.squaredLen(i)>=t.sightCutoff(s.lit>0)&&!(i[0]===2*t.dir[0]&&i[1]===2*t.dir[1])||s.hidesPlayer&&(Math.abs(i[0])>1||Math.abs(i[1])>1||Q(t.mode)))&&et(e.gameMap,t.pos,n)&&a.set(r,o,!0)}}for(let o=0;o<e.gameMap.cells.sizeY;++o)for(let r=0;r<e.gameMap.cells.sizeX;++r)a.get(r,o)&&t.addGlyph(r,o,r+1,o+1,on.namedTiles.crossHatch)}(o,e),function(e,t){if(e.seeGuardPatrols)for(let o of e.gameMap.guards)for(let e of o.patrolPath)t.addGlyph(e[0],e[1],e[0]+1,e[1]+1,on.namedTiles.patrolRoute)}(o,e),function(e,t){for(let r of e.gameMap.guards){var o;let a=0+((o=r.dir)[1]>0?1:o[1]<0?3:o[0]>0?0:o[0]<0?2:3),n=e.gameMap.cells.atVec(r.pos),i=aU(n.lit,e.lightStates,n.litSrc,e.seeAll||n.seen),s=e.seeAll||n.seen||r.speaking;if(!s&&W.squaredDistance(e.player.pos,r.pos)>36)continue;s||r.mode===K.Unconscious?r.mode!==K.Patrol||r.speaking||0!=n.lit?r.mode===K.Unconscious?a+=12:a+=8:i=0:a+=4;let l=structuredClone(t.entityTileSet.npcTiles[a]);r.mode===K.Unconscious&&r.hidden(e.gameMap)&&(l.color=0xff705050,l.unlitColor=0xff604040);let f=e.gameMap.items.find(e=>[ec.PortcullisEW,ec.PortcullisNS].includes(e.type)),u=.25*!!(void 0!==f&&f.pos.equals(r.pos)),c=r.animation?.offset??W.create(),d=r.pos[0]+c[0]+u,p=r.pos[1]+c[1];if(r.hasTorch||r.hasPurse||r.hasVaultKey){let e=d+.375*r.dir[0]+.375*r.dir[1],o=p-.125,a=r.mode!==K.Unconscious&&r.torchAnimation?r.torchAnimation.currentTile():t.entityTileSet.itemTiles[ec.TorchCarry],n=d-.25*r.dir[0]+.375*(r.dir[1]<0),s=p-.125,f=r.hasVaultKey?on.itemTiles[ec.KeyCarry]:t.entityTileSet.itemTiles[ec.PurseCarry];r.dir[1]>0?(r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,i),t.addGlyphLit(d,p,d+1,p+1,l,i),(r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,s,n+1,s+1,f,i)):r.dir[1]<0?((r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,s,n+1,s+1,f,i),t.addGlyphLit(d,p,d+1,p+1,l,i),r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,i)):(t.addGlyphLit(d,p,d+1,p+1,l,i),r.hasTorch&&t.addGlyphLit(e,o,e+1,o+1,a,i),(r.hasPurse||r.hasVaultKey)&&t.addGlyphLit(n,s,n+1,s+1,f,i))}else t.addGlyphLit(d,p,d+1,p+1,l,i)}}(o,e),(o.gameMode!==rA.MansionComplete&&o.gameMode!==rA.Win||o.player.animation)&&function(e,t){let o;let r=e.player,a=r.animation,n=a&&a instanceof z?a.offset:W.create(),i=r.pos[0]+n[0],s=r.pos[1]+n[1],l=r.pos[0],f=r.pos[1],u=e.gameMap.cells.at(l,f),c=aU(u.lit,e.lightStates,u.litSrc,e.seeAll||u.seen),d=r.hidden(e.gameMap),p=r.health<=0;if(a)o=a.currentTile();else{let e=t.entityTileSet.playerTiles;o=p?e.dead:d||u.type===el.GroundWater?e.hidden:e.normal}let h=[],m=structuredClone(o);if(!p){if(r.idle){if(null!==r.idleCursorAnimation&&1===r.idleCursorAnimation.length&&r.idleCursorAnimation[0]instanceof q){let e=r.idleCursorAnimation[0].currentTile();t.addGlyphLit(l,f,l+1,f+1,e,1)}if(null!==r.idleCursorAnimation&&r.idleCursorAnimation.length>1){for(let e of r.idleCursorAnimation)if(e instanceof Y){let o=e.currentTile(),r=e.offset;r[1]>0?t.addGlyphLit(l+r[0],f+r[1]/4-.125,l+r[0]+1,f+r[1]/4+1-.125,o,1):h.push([l+r[0],f+r[1]/4-.125,l+r[0]+1,f+r[1]/4+1-.125,o,1])}}}r.damagedLastTurn?(m.color=0xff5454fe,m.unlitColor=0xff0000a8):d&&(m.color=0xff705050,m.unlitColor=0xff604040)}if(t.addGlyphLit(i,s,i+1,s+1,m,c),d&&r.idle&&t.addGlyphLit(i,s,i+1,s+1,t.entityTileSet.playerTiles.litFace,.15),r.lightActive){let e=null!==r.torchAnimation?r.torchAnimation.currentTile():t.entityTileSet.itemTiles[ec.TorchCarry];t.addGlyphLit(i,s,i+1,s+1,e,c)}for(let e of h)t.addGlyphLit(...e)}(o,e),aO(o,e,!0),o.seeRoomAdjacencies&&function(e,t,o){let r={textureIndex:4,color:0xffffffff,unlitColor:0xffffffff},a={textureIndex:4,color:0xff4040ff,unlitColor:0xffffffff},n={textureIndex:4,color:0xffffffff,unlitColor:0xffffffff},i=1/16;for(let t of e){let e=t.posMin[0],a=t.posMin[1],n=t.posMax[0],s=t.posMax[1];o.addGlyph(e,a,n,a+i,r),o.addGlyph(e,s-i,n,s,r),o.addGlyph(e,a+i,e+i,s-i,r),o.addGlyph(n-i,a+i,n,s-i,r)}for(let e of t){let t=.5+e.origin[0],r=.5+e.origin[1],s=t+e.dir[0]*e.length,l=r+e.dir[1]*e.length,f=Math.abs(e.dir[0])*(1-i),u=Math.abs(e.dir[1])*(1-i),c=Math.min(t,s)+f-(.5-i),d=Math.min(r,l)+u-(.5-i),p=Math.max(t,s)-f+(.5-i),h=Math.max(r,l)-u+(.5-i),m=e.door?n:a;o.addGlyph(c,d,p,d+i,m),o.addGlyph(c,h-i,p,h,m),o.addGlyph(c,d+i,c+i,h-i,m),o.addGlyph(p-i,d+i,p,h-i,m)}}(o.gameMap.rooms,o.gameMap.adjacencies,e),function(e,t){for(let o of e.particles)if(o.animation&&(e.seeAll||e.gameMap.cells.atVec(o.pos).seen)){let e=o.animation,r=e instanceof z||e instanceof Y?e.offset:W.create(),a=o.pos[0]+r[0],n=o.pos[1]+r[1],i=e.currentTile();o.animation instanceof z&&!(o.animation.time>=0)||t.addGlyph(a,n,a+1,n+1,i)}}(o,e),o.gameMode===rA.Mansion&&function(e,t){let o=e.player,r=t.entityTileSet.namedTiles.speechBubbleR,a=t.entityTileSet.namedTiles.speechBubbleL;for(let n of e.gameMap.guards){let i=e.gameMap.cells.atVec(n.pos);if(!(e.seeAll||i.seen||n.speaking)&&W.squaredDistance(e.player.pos,n.pos)>36)continue;let s=n.animation?.offset??W.create(),l=n.pos[0]+s[0],f=n.pos[1]+s[1];n.speaking&&!e.popups.isSpeechBubbleVisible()&&(n.dir[0]>=0?t.addGlyph(l+1,f,l+2,f+1,r):t.addGlyph(l-1,f,l,f+1,a));let u=n.overheadIcon();if(u!==eu.Relaxed){let e=t.entityTileSet.guardStateTiles[u];t.addGlyph(l,f+.625,l+1,f+1.625,e)}if(n===o.pickTarget){let e=on.namedTiles.pickTarget;t.addGlyph(l,f+.625,l+1,f+1.625,e)}}if(o.preNoisy||o.noisy){let e=o.animation,r=e&&e instanceof z?e.offset:W.create();if(.5>Math.abs(r[0])&&.5>Math.abs(r[1])){let e=o.pos[0]+o.noiseOffset[0]/2,r=o.pos[1]+o.noiseOffset[1]/2;if(o.preNoisy)t.addGlyph(e,r,e+1,r+1,on.namedTiles.pickTarget);else{let a=.0625*Math.sin(o.noisyAnim*Math.PI*2);t.addGlyph(e-a,r-a,e+1+a,r+1+a,on.namedTiles.noise)}}}}(o,e),function(e,t){let o=e.gameMap.cells.sizeX,r=e.gameMap.cells.sizeY,a={textureIndex:0,color:0xffffffff,unlitColor:0xffffffff};t.addGlyph(-1,0,0,r,a),t.addGlyph(o,0,o+1,r,a),t.addGlyph(-1,-1,o+1,0,a),t.addGlyph(-1,r,o+1,r+1,a)}(o,e),e.flush(),function(e,t,o,r,a,n){let i=Math.max(1,t-e)*Math.max(0,r)/.5;if(i<=0)return;let s=+!o,l=+!!o,f=+!!o,u=[s,l,f,Math.min(1,.05*i)],c=[s,l,f,Math.min(1,.5*i)],d=L.create();n[0]<n[1]?(d[0]=n[0]/n[1],d[5]=1):(d[0]=1,d[5]=n[1]/n[0]),d[0]/=1.5,d[5]/=1.5,d[10]=1,d[15]=1,a.renderVignette(d,.8/1.5,u,c)}(o.player.health,o.player.healthMax,o.healthBarState.healing,o.healthBarState.damageDisplayTimer,e,t),(o.gameMode===rA.Mansion||o.gameMode===rA.MansionComplete)&&(function(e,t,o){if(!o.popups.isSpeechBubbleVisible()||void 0===o.popups.currentSpeaker)return;let r=o.popups.currentSpeech;if(0===r.length)return;let a=a9(t),n=8*a,i=16*a,s=16*o.camera.scale,l=16*o.camera.scale,[f,u]=a8(W.fromValues(t[0],t[1]-i),o.camera.scale),c=o.camera.position[0]+o.camera.joltOffset[0],d=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.currentSpeaker.posAnimated(),h=Math.floor((p[0]+.5-c+f/2)*s),m=Math.floor((p[1]+.5-d+u/2)*l)+i,g=r.split("\n"),x=g.reduce((e,t)=>Math.max(e,t.length),0),y=g.length,_=L.create();L.ortho(_,0,t[0],0,t[1],1,-1);let S=4*a,v=2*a,M=2*a,b=x*n+2*(S+M),A=y*i+2*(v+M),w=h-b/2,T=(A/2+.625*l)*(o.popups.currentSpeechAbove?1:-1)+m-A/2;w=Math.min(w=Math.max(w,0),t[0]-b),T=Math.min(T=Math.max(T,i),t[1]-A),e.start(_,ot.Font),e.addGlyph(w,T,w+x*n+2*(S+M),T+y*i+2*(v+M),{textureIndex:219,color:0xff080808}),e.addGlyph(w+M,T+M,w+x*n+2*S+M,T+y*i+2*v+M,{textureIndex:219,color:0xffd0d0d0});let R=T+(y-1)*i+v+M;for(let t of g){let o=Math.floor(w+S+M+(x-t.length)*n/2);for(let r=0;r<t.length;++r){let a=t.charCodeAt(r);e.addGlyph(o,R,o+n,R+i,{textureIndex:a,color:0xff080808}),o+=n}R-=i}e.flush()}(e,t,o),function(e,t,o){if(!o.popups.isNotificationVisible())return;let r=o.popups.notification;if(0===r.length)return;let a=a9(t),n=8*a,i=16*a,s=16*o.camera.scale,l=16*o.camera.scale,[f,u]=a8(W.fromValues(t[0],t[1]-i),o.camera.scale),c=o.camera.position[0]+o.camera.joltOffset[0],d=o.camera.position[1]+o.camera.joltOffset[1],p=o.popups.notificationWorldPos,h=p instanceof ep?p.animation?p.pos.add(p.animation.offset):p.pos:p,m=(h[0]+.5-c+f/2)*s,g=(h[1]+.5-d+u/2)*l+i,x=r.split("\n"),y=x.reduce((e,t)=>Math.max(e,t.length),0),_=x.length,S=L.create();L.ortho(S,0,t[0],0,t[1],1,-1);let v=8*a,M=4*a,b=y*n+2*v,A=_*i+2*M,w=m-b/2,T=.5*(A+.875*l*2)+g-A/2,R=8*a;w=Math.min(w=Math.max(w,R),t[0]-(b+R)),T=Math.min(T=Math.max(T,i+R),t[1]-(A+R)),e.start(S,ot.Font),e.addGlyph(w,T,w+y*n+2*v,T+_*i+2*M,{textureIndex:219,color:0xb0080808});let H=T+(_-1)*i+M;for(let t of x){let o=w+v+(y-t.length)*n/2;for(let r=0;r<t.length;++r){let a=t.charCodeAt(r);e.addGlyph(o,H,o+n,H+i,{textureIndex:a,color:0xffffffff}),o+=n}H-=i}e.flush()}(e,t,o)),(o.gameMode===rA.Mansion||o.gameMode===rA.MansionComplete)&&function(e,t,o){let r=o.hintMessage;if(0===r.length)return;let a=a9(t),n=t[0]/(8*a),i=t[1]/(16*a),s=L.create(),l=-((n-r.length)/2);L.ortho(s,l,n+l,-1.75,i+-1.75,1,-1),e.start(s,ot.Font),e.addGlyph(-1,-.25,r.length+1,1.25,{textureIndex:or.background.textureIndex,color:0xb0080808,unlitColor:0xb0080808}),a7(e,0,r,0xffffffff),e.flush()}(e,t,o);let a=o.textWindows[o.gameMode];if(void 0!==a&&a.render(e),function(e,t,o){let r=a9(t),a=t[0]/(8*r),n=t[1]/(16*r),i=L.create();L.ortho(i,0,a,0,n,1,-1),e.start(i,ot.Font),e.addGlyph(0,0,a,1,or.background);let s=(o.dailyRun?"Daily Lvl ":"Lvl ")+(o.level+1),l=al(o),f=""+o.turns+"/"+l,u=o.turns>l?0xff5454fe:o.turns>.75*l?0xff54fefe:0xff54fe54;0!==o.levelStats.numSpottings&&(f+="!");let c=o.fpsInfo.enabled?o.fpsInfo.msgFPS:"",d=o.fpsInfo.enabled?2:1,p=s.length+f.length+c.length+d,h=1;if(o.gameMap.cells.atVec(o.player.pos).type==el.GroundWater&&o.player.turnsRemainingUnderwater>0){let t=or.air.textureIndex;for(let r=0;r<5;++r){let a=r<o.player.turnsRemainingUnderwater-1?0xfffefe54:0xff705050;e.addGlyph(h,0,h+1,1,{textureIndex:t,color:a}),++h}}else{let t=o.healthBarState.size,r=or.heart.textureIndex;for(let a=0;a<o.player.healthMax;++a){let n=o.healthBarState.heartFlashRemaining[a],i=a<o.player.health?a6(0xff0000a8,0xffffffff,n):a6(0xff705050,0xff5454fe,n);e.addGlyph(h,0,h+t,t,{textureIndex:r,color:i}),h+=t}}++h;let m="Leap";o.leapToggleActive&&a7(e,h,m,0xff54fe54),h=o.player.healthMax+m.length+2;let g=a,x=Math.floor(100*o.gameMap.fractionRevealed()),y=o.player.hasVaultKey?"Key ":"",_="Map "+x+"% ",S="Loot "+o.lootStolen+"/"+(x<100?"?":o.lootAvailable)+" ",v=x>=100&&o.lootStolen>=o.lootAvailable&&o.gameMode===rA.Mansion?"Escape! ":"",M=g-(h+p+y.length+1);_.length+S.length+v.length>M&&(x<100?S="":_=""),_.length+S.length+v.length>M&&(S="",_=""),_.length+S.length+v.length>M&&(v=""),a7(e,g-=S.length,S,0xfffe54fe),a7(e,g-=_.length,_,0xffffffff),a7(e,g-=y.length,y,0xfffefe54),a7(e,g-=v.length,v,0xffffffff);let b=(h+g-p)/2;a7(e,b,s,0xffa8a8a8),a7(e,b+s.length+1,f,u),""!==c&&a7(e,b+s.length+f.length+2,c,0xffa8a8a8),e.flush()}(e,t,o),rm===o.touchController){let r=L.create();L.ortho(r,0,t[0],0,t[1],1,-1),e.start(r,ot.Entity),function(e,t){for(let o in t.coreTouchTargets){if(!(o in t.controlStates))continue;let r=t.coreTouchTargets[o];if(!r.mouseable&&t.mouseActive||null===r.tileInfo||0===r.rect[2]||0===r.rect[3])continue;let a=+!!t.controlStates[o];e.addGlyphLit(r.rect[0],r.rect[1],r.rect[0]+r.rect[2],r.rect[1]+r.rect[3],r.tileInfo,a)}e.flush()}(e,o.touchController),e.flush()}}(o,i,r),requestAnimationFrame(t=>e(t,o,r))})(e,t,o))}function aa(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;let t=0===e.levelStats.numSpottings,o=Math.max(0,al(e)-e.turns),r=10*e.lootStolen,a=au(e),n=5*e.levelStats.extraFoodCollected;e.gameStats.totalScore+=r+a+n+o+(t?r:0),e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level+1,e.gameStats.numGhostedLevels+=+!!t,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}function an(e){e.numKnockouts=0,e.numSpottings=0,e.damageTaken=0,e.extraFoodCollected=0,e.steppableLeaps=0}function ai(e,t){let o;for(o in e.achievements)e.achievements[o].update(e,t)}function as(e,t){if(e.level=t,e.level>=e.gameMapRoughPlans.length){a3(e);return}e.popups.reset(),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.gameMap=eD(e.gameMapRoughPlans[e.level]),e.lightStates=Array(e.gameMap.lightCount).fill(0),a1(e.gameMap,e),aZ(e.gameMap,e),a0(e.gameMap,e),e.hintMessage="",aG(e),e.finishedLevel=!1,e.turns=0,e.lootStolen=0,e.treasureStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,an(e.levelStats),W.copy(e.player.pos,e.gameMap.playerStartPos),e.player.dir=W.fromValues(0,-1),e.player.noisy=!1,e.player.preNoisy=!1,e.player.hasVaultKey=!1,e.player.damagedLastTurn=!1,e.player.turnsRemainingUnderwater=7,e.player.animation=null,e.popups.reset(),e.camera=az(e.gameMap.playerStartPos,e.zoomLevel),e.camera.zoomed=0!==t,e.gameMode=rA.Mansion,e.hasEnteredMansion=!1,J(e),aF(e),aw(e,e.player.pos),ag(e)}function al(e){let t=(e.gameMap.numCells()-e.gameMap.numPreRevealedCells)*e.gameMap.backtrackingCoefficient,o=e.gameMap.guards.length;return 10*Math.ceil((t/3.5+(8*o+o/t*1e3))/10)}function af(e,t){return e.reduce((e,o)=>e+ +!!t(o),0)}function au(e){let t=10*e.lootStolen;return 0+t*af(e.gameMap.treasures,e=>e.stolen&&e.switches.length>0)+t/2*af(e.gameMap.treasures,e=>e.stolen&&e.switches.length<=0)+30*af(e.gameMap.items,e=>e.type===ec.LootedVaultTreasureBox)}window.onload=function(){window.focus(),Promise.all([aV(or.imageSrc,or.image),aV(oa.imageSrc,oa.image),aV(on.imageSrc,on.image)]).then(ar)},window.onclick=()=>{window.focus()};const ac=["Use darkness or hiding places to avoid guards","Escape out windows with Shift+Dir","Knock out adjacent, unaware guards with Shift+Dir","Pickpocket by following exactly for two turns","Zoom view with [ and ]","Bang walls to make noise with Dir, then Shift+Dir","'Ghost' by never being fully seen","Knock out spotting guard by leaping onto them"];function ad(e){aa(e),ai(e,"levelEnd"),e.activeSoundPool.empty(),e.ambientSoundPool.empty(),C.stop(),e.sounds.levelCompleteJingle.play(.35),0===e.levelStats.numSpottings&&(e.persistedStats.totalGhosts++,a$("totalGhosts",e.persistedStats.totalGhosts)),e.level<ac.length?e.hintMessage="Hint: "+ac[e.level]:e.hintMessage="",e.gameMode=rA.MansionComplete}function ap(e,t){return e.gameMap.hasLootAt(t)&&!e.gameMap.items.find(e=>e.type===ec.TreasureLock&&e.pos.equals(t))}function ah(e,t,o){let r=e.gameMap.collectLootAt(t);if(0===r.length)return!1;let a=!1,n=!1;for(let i of r){let r=i.type,s=0,l=1;if(i.type===ec.Coin)++e.player.loot,++e.lootStolen,a=!0;else if(i.type>=ec.TreasureA){for(let o of(a=!0,++e.treasureStolen,e.gameMap.treasures))o.posTreasure.equals(i.pos)&&(o.stolen=!0,e.gameMapRoughPlans[e.level].levelType===es.Fortress&&aL(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0));s=.5}else if(i.type===ec.VaultTreasureBox){a=!0,r=ec.Coin,l=3,e.gameMap.items.push({type:ec.LootedVaultTreasureBox,pos:W.clone(t),topLayer:!1});let o=new O(on.vaultGoldAnimationTiles,.15,0,1);o.removeOnFinish=!0,e.particles.push({pos:W.clone(i.pos),animation:o}),aL(e.gameMap,e.player,e.popups,3,t[0]-e.player.pos[0],t[1]-e.player.pos[1],e.sounds,46,!0)}else i.type===ec.Health&&(aD(e),e.player.health>=e.player.healthMax?++e.levelStats.extraFoodCollected:(++e.player.health,aW(e,e.player.health-1)),n=!0);let f=aN(e.gameMapRoughPlans[e.level].levelType,on);for(let t=0;t<l;t++){let a={type:r,pos:W.clone(i.pos),topLayer:!1},n=W.create(),l=W.fromValues(o[0]-i.pos[0],o[1]-i.pos[1]+s),u=l.scale(.3333).add(W.fromValues(0,.5+s/2)),c=new z([{pt0:n,pt1:u,duration:.1,fn:U.easeOutQuad},{pt0:u,pt1:l,duration:.1,fn:U.easeInQuad}],[f[r],f[r]]);c.time=-(.2*t),c.removeOnFinish=!0,a.animation=c,e.particles.push(a)}}return a&&e.sounds.coin.play(1),n&&e.sounds.food.play(.25),!0}function am(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;let o=e.gameMap.cells.atVec(t);return!(o.blocksPlayerMove||aI(o.type)||o.type===el.PortcullisNS||o.type===el.PortcullisEW||(o.type===el.DoorNS||o.type===el.DoorEW)&&e.gameMap.items.some(e=>e.pos.equals(t)&&e_(e.type))||e.gameMap.items.some(e=>e.pos.equals(t)&&!function(e){switch(e){case ec.DrawersShort:case ec.VaultTreasureBox:case ec.EmptyVaultTreasureBox:case ec.LootedVaultTreasureBox:case ec.TorchUnlit:case ec.TorchLit:case ec.TreasureLock:case ec.TreasurePlinth:case ec.TreasureA:case ec.TreasureB:case ec.TreasureC:case ec.TreasureD:case ec.TreasureE:return!1;default:return!0}}(e.type))||e.gameMap.guards.some(o=>o.pos.equals(t)&&!o.allowsMoveOntoFrom(e.player.pos)))}function ag(e){switch(e.ambientSoundPool.empty(),e.ambience){case rw.Indoor:break;case rw.Outdoor:e.sounds.ambienceOutdoor.play(1,0,!0);break;case rw.Kitchen:e.sounds.ambienceKitchen.play(1,0,!0);break;case rw.Water:e.sounds.ambienceWater.play(.5,0,!0);break;case rw.OutdoorWater:e.sounds.ambienceWater.play(.5,0,!0),e.sounds.ambienceOutdoor.play(1,0,!0)}}function ax(e,t,o){if(e.player.pos.distance(e.oldPlayerPos)>1){let t=e.oldPlayerPos.add(e.player.pos).scale(.5);e.gameMap.cells.atVec(t)}if(!function(e){let t=1/0,o=1/0,r=1/0,a=e.gameMap.items.filter(e=>e.type===ec.Stove);!function e(n,i,s,l){let f=[];for(let e of[[1,0],[0,1],[-1,0],[0,-1]]){let u=s.add(W.fromValues(e[0],e[1]));if(i.has(u[1]*n.sizeX+u[0]))continue;let c=n.atVec(u);c.type<=el.Wall0000&&(f.push(u),i.add(u[1]*n.sizeX+u[0]),c.type===el.GroundGrass&&t===1/0&&(t=10-l),c.type===el.GroundWater&&o===1/0&&(o=10-l),r===1/0&&a.find(e=>e.pos.equals(u))&&(r=10-l))}if(l>0&&r===1/0&&(t===1/0||o===1/0))for(let t of f)e(n,i,t,l-1)}(e.gameMap.cells,new Set,e.player.pos,10);let n=Math.min(t,r,o),i=n===1/0?rw.Indoor:o<1/0&&t<1/0?rw.OutdoorWater:o<1/0?rw.Water:r<1/0?rw.Kitchen:n===t?rw.Outdoor:rw.Indoor;i!==e.ambience&&(e.ambience=i,ag(e))}(e),o.hidesPlayer&&!t.hidesPlayer){e.sounds.hide.play(.2);return}let r=.5+Math.random()/2,a=t.type!==o.type;if(a){if(t.type===el.GroundWater){e.sounds.waterExit.play(.5*r);return}if(o.type===el.GroundWater){e.sounds.waterEnter.play(.5*r);return}}if(o.type===el.DoorEW||o.type===el.DoorNS){let t=e.gameMap.items.find(t=>t.pos.equals(e.player.pos));t&&(t.type===ec.DoorEW||t.type===ec.DoorNS?e.sounds.playerDoorOpen.play(r):(t.type===ec.LockedDoorEW||t.type===ec.LockedDoorNS)&&e.sounds.playerDoorOpenLocked.play(r))}if(t.type===el.DoorEW||t.type===el.DoorNS){let t=e.gameMap.items.find(t=>t.pos.equals(e.oldPlayerPos));t&&(t.type===ec.DoorEW||t.type===ec.DoorNS?e.sounds.playerDoorClose.play(r):(t.type===ec.LockedDoorEW||t.type===ec.LockedDoorNS)&&e.sounds.playerDoorCloseLocked.play(r))}switch(o.type){case el.GroundWoodCreaky:e.sounds.footstepCreaky.play(.15*r);break;case el.GroundWood:(a||Math.random()>.9)&&e.sounds.footstepWood.play(.15*r);break;case el.GroundNormal:(a||Math.random()>.5)&&e.sounds.footstepGravel.play(.03*r);break;case el.GroundGrass:(a||Math.random()>.75)&&e.sounds.footstepGrass.play(.05*r);break;case el.GroundWater:(a||Math.random()>.6)&&e.sounds.footstepWater.play(.02*r);break;case el.GroundMarble:case el.GroundVault:(a||Math.random()>.8)&&e.sounds.footstepTile.play(.05*r);break;default:(a||Math.random()>.8)&&e.sounds.footstepTile.play(.02*r)}}function ay(e,t,o){let r=W.create(),a=W.fromValues(t/4,o/4);e.player.animation=new z([{pt0:r,pt1:a,duration:.05,fn:U.linear},{pt0:a,pt1:r,duration:.05,fn:U.linear}],[on.playerTiles.normal])}function a_(e,t,o){e.sounds.footstepTile.play(.1),ay(e,t,o)}function aS(e,t,o,r,a=0){let n=null;t.pickTarget=null,o.hasPurse&&(o.hasPurse=!1,t.loot+=1,e.lootStolen+=1,n={pos:W.clone(o.pos),type:ec.Coin,topLayer:ed[ec.Coin]}),o.hasVaultKey&&(o.hasVaultKey=!1,t.hasVaultKey=!0,n={pos:W.clone(o.pos),type:ec.Key,topLayer:ed[ec.Key]});let i=aN(e.gameMapRoughPlans[e.level].levelType,on);if(n){let t=W.create(),o=r.subtract(n.pos),s=o.scale(.3333).add(W.fromValues(0,.5)),l=a>0?new z([{pt0:t,pt1:t,duration:.1,fn:U.easeOutQuad},{pt0:t,pt1:s,duration:.1,fn:U.easeOutQuad},{pt0:s,pt1:o,duration:.1,fn:U.easeInQuad}],[i[n.type],i[n.type],i[n.type]]):new z([{pt0:t,pt1:s,duration:.1,fn:U.easeOutQuad},{pt0:s,pt1:o,duration:.1,fn:U.easeInQuad}],[i[n.type],i[n.type]]);l.removeOnFinish=!0,n.animation=l,e.particles.push(n),n.type===ec.Key?e.sounds.grabKey.play(1):e.sounds.coin.play(1)}}function av(e,t,o){e.screenShakeEnabled&&W.scaleAndAdd(e.camera.joltVelocity,e.camera.joltVelocity,W.fromValues(t,o),-8)}function aM(e,t,o,r){if(1===r){e.player.preNoisy&&t===e.player.noiseOffset[0]&&o===e.player.noiseOffset[1]?(aC(e),e.player.pickTarget=null,ay(e,1.25*t,1.25*o),av(e,t,o),aL(e.gameMap,e.player,e.popups,4,t,o,e.sounds),aE(e),0===e.gameMapRoughPlans[e.level].level&&e.popups.setNotification("Noise\nattracts\npeople",e.player.pos)):(e.player.preNoisy=!1,a_(e,t,o));return}let a=e.player.pos[0]+t,n=e.player.pos[1]+o,i=e.gameMap.items.find(e=>e.pos[0]===a&&e.pos[1]===n&&(e.type===ec.Bookshelf||e.type===ec.Note));if(void 0===i){e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,e.player.pickTarget=null,0!==e.gameMapRoughPlans[e.level].level||e.experiencedPlayer||ey(e.gameMap.cells.at(a,n).type)||e.popups.setNotification("Make Noise:\nShift+"+aP(t,o),e.player.pos),a_(e,t,o);return}aC(e);let s=e.player.pickTarget!==i;if(e.player.pickTarget=s&&e.gameMap.treasures.some(e=>e.switches.some(e=>e.equals(i.pos)))?i:null,e.gameMap.cells.at(a,n).lit||(e.player.lightActive=!0),ay(e,t,o),aE(e),e.player.preNoisy=!0,e.player.noiseOffset[0]=t,e.player.noiseOffset[1]=o,s){let t=e.gameMap.bookTitle.get(i);void 0===t&&(t="Untitled"),i.type===ec.Bookshelf&&(t='"'+t+'"'),e.popups.setNotification(t,e.player.pos);return}let l=0;for(let t of e.gameMap.treasures){let o=t.switches.findIndex(e=>e.equals(i.pos));if(!(o<0)){if(t.numSwitchesUsed>=t.switches.length)l=Math.max(l,1);else if(o===t.numSwitchesUsed){if(++t.numSwitchesUsed,t.numSwitchesUsed>=t.switches.length){let o=e.gameMap.items.filter(e=>e.type===ec.TreasureLock&&e.pos.equals(t.posTreasure));for(let r of(e.gameMap.items=e.gameMap.items.filter(e=>!(e.type===ec.TreasureLock&&e.pos.equals(t.posTreasure))),e.gameMap.cells.atVec(t.posTreasure).blocksPlayerMove=!1,o)){let t=new O(on.treasureGateAnimation,.3,0,1);t.removeOnFinish=!0,r.animation=t,e.particles.push(r)}l=Math.max(l,4)}else l=Math.max(l,3)}else 0===o?(t.numSwitchesUsed=1,l=Math.max(l,3)):(t.numSwitchesUsed=0,l=Math.max(l,2))}}switch(l){case 0:break;case 1:case 2:e.sounds.switchReset.play(.5),e.popups.setNotification("(clunk)",e.player.pos);break;case 3:e.sounds.switchProgress.play(.5),e.popups.setNotification("(click)",e.player.pos);break;case 4:e.sounds.switchSuccess.play(.5),e.popups.setNotification("(rumble)",e.player.pos),av(e,t,o)}}function ab(e,t,o,r){let a;let n=e.player;if(n.health<=0){aT(e);return}1!==r&&(n.preNoisy=!1),n.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();let i=W.clone(n.pos),s=W.fromValues(n.pos[0]+t,n.pos[1]+o);if(s[0]<0||s[0]>=e.gameMap.cells.sizeX||s[1]<0||s[1]>=e.gameMap.cells.sizeY){if(e.finishedLevel){aC(e),ad(e);let r=W.create(),a=W.clone(s).subtract(i),l=r.add(a).scale(.5).add(W.fromValues(0,.0625)),f=[{pt0:r,pt1:l,duration:.1,fn:U.easeInQuad},{pt0:l,pt1:a,duration:.1,fn:U.easeOutQuad},{pt0:a,pt1:a,duration:o>0?.5:.1,fn:U.easeOutQuad}],u=t<0?on.playerTiles.left:t>0?on.playerTiles.right:o>0?on.playerTiles.up:on.playerTiles.down;n.animation=new z(f,[u,u,u,u])}else 1>e.gameMap.fractionRevealed()?e.popups.setNotification("Map and loot\nbefore leaving",e.player.pos):e.popups.setNotification("Collect all loot\nbefore leaving",e.player.pos),a_(e,t,o);return}let l=e.gameMap.cells.atVec(s);if(l.blocksPlayerMove){ap(e,s)?(aC(e),ah(e,s,n.pos),n.pickTarget=null,ay(e,t,o),aE(e)):(0===r&&e.gameMap.items.some(e=>e.type===ec.TreasureLock&&e.pos.equals(s))&&e.popups.setNotification("Locked!",e.player.pos),aM(e,t,o,r));return}if(l.type==el.OneWayWindowE&&s[0]<=i[0]||l.type==el.OneWayWindowW&&s[0]>=i[0]||l.type==el.OneWayWindowN&&s[1]<=i[1]||l.type==el.OneWayWindowS&&s[1]>=i[1]){e.popups.setNotification("Window is\nimpassable\nfrom here",e.player.pos),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.tooHigh.play(.3),250),aM(e,t,o,r);return}if(aI(l.type)){ak(e,t,o),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.jump.play(.3),250),a_(e,t,o);return}for(let a of e.gameMap.items.filter(e=>e.pos.equals(s)))switch(a.type){case ec.DrawersShort:case ec.VaultTreasureBox:case ec.EmptyVaultTreasureBox:case ec.LootedVaultTreasureBox:case ec.TreasurePlinth:ap(e,s)?(aC(e),ah(e,s,n.pos),n.pickTarget=null,ay(e,t,o),aE(e)):am(e,W.fromValues(i[0]+2*t,i[1]+2*o))?ak(e,t,o):aM(e,t,o,r);return;case ec.TorchUnlit:aC(e),e.sounds.ignite.play(.08),a.type=ec.TorchLit,n.pickTarget=null,n.itemUsed=a,ay(e,t,o),aE(e);return;case ec.TorchLit:aC(e),e.sounds.douse.play(.05),a.type=ec.TorchUnlit,n.pickTarget=null,n.itemUsed=a,ay(e,t,o),aE(e);return;case ec.PortcullisEW:case ec.PortcullisNS:1!==r&&ak(e,t,o),e.sounds.gate.play(.3),0===e.gameMapRoughPlans[e.level].level&&setTimeout(()=>e.sounds.jump.play(.3),1e3),ay(e,t,o);return;case ec.LockedDoorEW:case ec.LockedDoorNS:if(!n.hasVaultKey){0===r&&e.popups.setNotification("Locked!",e.player.pos),aM(e,t,o,r);return}}let f=e.gameMap.guards.find(e=>e.pos.equals(s));if(void 0===f)aC(e),n.pickTarget=null;else if(f.mode===K.Unconscious)aC(e),n.pickTarget=null,function(e,t){let o;let r=W.clone(t.pos),a=W.clone(e.player.pos),n=W.create();W.subtract(n,r,a),W.add(n,n,r);let i=!1;(function(e,t){if(t[0]<0||t[1]<0||t[0]>=e.gameMap.cells.sizeX||t[1]>=e.gameMap.cells.sizeY||e.gameMap.cells.atVec(t).moveCost===1/0||e.gameMap.guards.find(e=>e.pos.equals(t)))return!0;for(let o of e.gameMap.items.filter(e=>e.pos.equals(t)))switch(o.type){case ec.PortcullisEW:case ec.PortcullisNS:return!0;case ec.LockedDoorEW:case ec.LockedDoorNS:if(!e.player.hasVaultKey)return!0}return!1})(e,n)&&(W.copy(n,a),i=!0),W.copy(t.pos,n),e.gameMap.cells.atVec(t.pos).type===el.GroundWater&&(t.modeTimeout=0);let s=W.clone(r).subtract(t.pos),l=W.create();if(i)o=[{pt0:s,pt1:l,duration:.2,fn:U.easeOutQuad}];else{let e=W.fromValues(.5*(r[0]-t.pos[0]),.5*(r[1]-t.pos[1]));o=[{pt0:s,pt1:e,duration:.2,fn:U.easeInQuad},{pt0:e,pt1:l,duration:.1,fn:U.easeOutQuad}]}t.animation=new z(o,[])}(e,f);else if(f.mode===K.ChaseVisibleTarget){a_(e,t,o);return}else{aC(e);let t=!1;if((f.hasPurse||f.hasVaultKey)&&(n.pickTarget===f?t=!0:n.pickTarget=f),!f.allowsMoveOntoFrom(n.pos)){t&&aS(e,n,f,i),aE(e),aw(e,i);return}t&&aS(e,n,f,s)}let u=n.hidden(e.gameMap)||e.gameMap.cells.atVec(n.pos).type===el.GroundWater;W.copy(n.pos,s),++e.numStepMoves,e.gameMap.identifyAdjacentCells(n.pos);let c=W.clone(i).subtract(s),d=W.create(),p=c.add(d).scale(.5).add(W.fromValues(0,.0625)),h=n.hidden(e.gameMap)||l.type===el.GroundWater;if(void 0!==f&&f.mode===K.Unconscious){let e=W.fromValues(.5*(i[0]-s[0]),.5*(i[1]-s[1]));a=[{pt0:c,pt1:e,duration:.2,fn:U.easeInQuad},{pt0:e,pt1:d,duration:.1,fn:U.easeOutQuad}]}else{let e=2===r?.05:.1;a=[{pt0:c,pt1:p,duration:e,fn:U.easeInQuad},{pt0:p,pt1:d,duration:e,fn:U.easeOutQuad},{pt0:d,pt1:d,duration:o>0&&!h?.5:.1,fn:U.easeOutQuad}],o>0&&!h&&a.push({pt0:d,pt1:d,duration:.1,fn:U.easeOutQuad})}let m=t<0?on.playerTiles.left:t>0?on.playerTiles.right:o>0?on.playerTiles.up:on.playerTiles.down,g=u?on.playerTiles.hidden:m,x=h?on.playerTiles.hidden:m,y=h?on.playerTiles.hidden:on.playerTiles.left;n.animation=new z(a,[g,x,x,y]),ah(e,n.pos,s),l.type===el.GroundWoodCreaky&&aL(e.gameMap,n,e.popups,0,0,-1,e.sounds),aE(e),aw(e,i),ax(e,e.gameMap.cells.atVec(i),l)}function aA(e,t){return Math.abs(t[0]-e[0])+Math.abs(t[1]-e[1])===1}function aw(e,t){if(e.popups.isNotificationVisible())return;let o=e.gameMapRoughPlans[e.level].level;if(3===o){!function(e){if(e.lootStolen>=e.lootAvailable)return;let t=e.gameMap.allSeen(),o=function(e){let t=e.gameMap.items.reduce((e,t)=>e+ +(t.type===ec.Coin),0),o=e.gameMap.guards.reduce((e,t)=>e+ +!!t.hasPurse,0);return 0===t&&o>0}(e);if(e.experiencedPlayer&&(!t||!o)||e.gameMap.guards.some(e=>!Q(e.mode)&&e.mode!==K.Unconscious))return;let r=e.gameMap.guards.filter(e=>e.hasPurse);if(0===r.length)return;r.sort((t,o)=>W.squaredDistance(e.player.pos,t.pos)-W.squaredDistance(e.player.pos,o.pos));let a=r[0];if(Q(a.mode)&&aA(e.player.pos,a.pos)){let t=a.pos[0]-e.player.pos[0],o=a.pos[1]-e.player.pos[1],r=W.fromValues(a.pos[0],Math.max(a.pos[1],e.player.pos[1])),n=e.player.pickTarget===a?"Loot: ":"Loot (1/2): ";e.popups.setNotificationHold(n+aP(t,o)+"\nKnockout: Shift+"+aP(t,o),r);return}if(function(e,t){let o=t.pos[0]-e.player.pos[0],r=t.pos[1]-e.player.pos[1];if(!(2===Math.abs(o)&&0===r||0===o&&2===Math.abs(r))||e.gameMap.cells.atVec(e.player.pos).type===el.GroundWater)return!1;let a=W.fromValues(e.player.pos[0]+o/2,e.player.pos[1]+r/2),n=e.gameMap.cells.atVec(a);return!(n.blocksPlayerMove||(n.type===el.DoorNS||n.type===el.DoorEW)&&e.gameMap.items.some(e=>e.pos.equals(a)&&e_(e.type)))&&(n.type!=el.OneWayWindowE||!(o<=0))&&(n.type!=el.OneWayWindowW||!(o>=0))&&(n.type!=el.OneWayWindowN||!(r<=0))&&(n.type!=el.OneWayWindowS||!(r>=0))&&!!am(e,t.pos)}(e,a)){let t=a.pos[0]-e.player.pos[0],o=a.pos[1]-e.player.pos[1],r=W.fromValues(a.pos[0],Math.max(a.pos[1],e.player.pos[1]));e.popups.setNotificationHold("Leap: Shift+"+aP(t,o),r);return}t&&o&&e.popups.setNotificationHold("Loot",a.pos)}(e);return}if(e.experiencedPlayer)return;if(2===o&&!e.hasEnteredMansion&&e.player.pos.equals(e.gameMap.playerStartPos)){let t=W.create();W.copy(t,e.player.pos),t[1]+=1,e.popups.setNotificationHold("Zoom view: [ or ]",t);return}if(1===o&&!e.hasEnteredMansion){let t,o=1/0;for(let r of e.gameMap.guards){let a=W.squaredDistance(r.pos,e.player.pos);a<o&&(o=a,t=r)}void 0!==t&&o<16&&e.popups.setNotificationHold("Wait: Z\nor Period/Space",t.pos);return}if(0!==o)return;let r=e.gameMap.items.find(t=>t.type===ec.Coin&&aA(t.pos,e.player.pos));if(void 0!==r){e.popups.setNotificationHold("Loot: "+aP(r.pos[0]-e.player.pos[0],r.pos[1]-e.player.pos[1]),r.pos);return}let a=e.gameMap.allSeen(),n=e.lootStolen>=e.lootAvailable;if(a&&n){if(0===e.player.pos[0]&&0!==t[0]){e.popups.setNotificationHold("Exit: "+aP(-1,0),e.player.pos);return}if(e.player.pos[0]===e.gameMap.cells.sizeX-1&&t[0]!==e.gameMap.cells.sizeX-1){e.popups.setNotificationHold("Exit: "+aP(1,0),e.player.pos);return}if(0===e.player.pos[1]&&0!==t[1]){e.popups.setNotificationHold("Exit: "+aP(0,-1),e.player.pos);return}if(e.player.pos[1]===e.gameMap.cells.sizeY-1&&t[1]!==e.gameMap.cells.sizeY-1){e.popups.setNotificationHold("Exit: "+aP(0,1),e.player.pos);return}for(let[t,o,r]of[[1,0,el.OneWayWindowE],[-1,0,el.OneWayWindowW],[0,1,el.OneWayWindowN],[0,-1,el.OneWayWindowS]])if(e.gameMap.cells.at(e.player.pos[0]+t,e.player.pos[1]+o).type===r){ak(e,t,o);return}}if(e.gameMap.cells.atVec(e.player.pos).type==el.GroundWater){if(e.gameMap.cells.atVec(t).type!==el.GroundWater){e.popups.setNotification("Hide underwater",e.player.pos);return}if(1===e.player.turnsRemainingUnderwater){e.popups.setNotification("Out of breath;\nsurfacing",e.player.pos);return}}if(!e.player.pos.equals(t)){let t=e.gameMap.items.filter(t=>t.pos.equals(e.player.pos));if(t.some(e=>e.type===ec.Bush)){e.popups.setNotification("Hide in bushes",e.player.pos);return}if(t.some(e=>e.type===ec.Table)){e.popups.setNotification("Hide under tables",e.player.pos);return}if(t.some(e=>e.type===ec.BedL||e.type===ec.BedR)){e.popups.setNotification("Hide under beds",e.player.pos);return}}if(0===e.numLeapMoves&&!e.hasEnteredMansion){let t;let o=e.gameMap.items.find(t=>(t.type===ec.PortcullisEW||t.type===ec.PortcullisNS)&&2>W.squaredDistance(e.player.pos,t.pos));if(void 0!==o){let t=o.pos[0]-e.player.pos[0],r=o.pos[1]-e.player.pos[1];!function(e,t,o){e.popups.setNotificationHold("Leap: Shift+"+aP(t,o),e.player.pos)}(e,t,r);return}for(let o of e.gameMap.items)(o.type===ec.PortcullisEW||o.type===ec.PortcullisNS)&&(void 0===t||t.pos[1]>o.pos[1])&&(t=o);if(void 0!==t){e.popups.setNotificationHold("Move: \x18\x19\x1b\x1a",t.pos);return}}if(!(a&&n)&&e.numLeapMoves<=1){let o=W.fromValues(Math.floor((e.player.pos[0]+t[0])/2),Math.floor((e.player.pos[1]+t[1])/2));if(e.gameMap.items.some(e=>e.pos.equals(o)&&e.type===ec.PortcullisEW)){e.popups.setNotificationHold("Leap over open\nground or low\nfurniture too",e.player.pos);return}}}function aT(e){e.popups.setNotification(e.dailyRun?"Retry: Ctrl+R\nMenu: Esc/Slash":"New Game: Ctrl+R\nMenu: Esc/Slash",e.player.pos)}function aR(e,t,o){let r=e.player;if(r.health<=0){aT(e);return}r.idle=!1,e.idleTimer=5,e.camera.panning=!1,e.touchController.clearMotion();let a=W.clone(r.pos),n=W.fromValues(r.pos[0]+t,r.pos[1]+o),i=W.fromValues(r.pos[0]+2*t,r.pos[1]+2*o),s=e.gameMap.cells.atVec(a),l=e.gameMap.cells.atVec(n),f=e.gameMap.cells.atVec(i),u=e.gameMap.guards.find(e=>e.pos.equals(n)&&e.mode!==K.Unconscious);if(u){l.type===el.PortcullisEW||l.type===el.PortcullisNS||!r.hasVaultKey&&aH(e.gameMap,n)?ab(e,t,o,1):u.mode===K.ChaseVisibleTarget?(!function(e,t){let o=W.clone(t.pos);W.copy(t.pos,e.player.pos);let r=[{pt0:W.clone(o).subtract(e.player.pos),pt1:W.create(),duration:.2,fn:U.easeOutQuad}];t.animation=new z(r,[])}(e,u),ab(e,t,o,1)):(aC(e),u.mode=K.Unconscious,u.modeTimeout=Math.max(1,40-2*e.level)+e.rng.randomInRange(20),(u.hasPurse||u.hasVaultKey)&&aS(e,r,u,a),r.pickTarget=null,++e.levelStats.numKnockouts,e.sounds.hitGuard.play(.25),aE(e),ay(e,t,o),av(e,t,o));return}if(s.type===el.GroundWater||i[0]<0||i[1]<0||i[0]>=e.gameMap.cells.sizeX||i[1]>=e.gameMap.cells.sizeY||l.blocksPlayerMove||(l.type===el.DoorNS||l.type===el.DoorEW)&&e.gameMap.items.find(e=>e.pos.equals(n)&&e_(e.type))||l.type==el.OneWayWindowE&&i[0]<=a[0]||l.type==el.OneWayWindowW&&i[0]>=a[0]||l.type==el.OneWayWindowN&&i[1]<=a[1]||l.type==el.OneWayWindowS&&i[1]>=a[1]){ab(e,t,o,1);return}let c=function(e,t){if((t[0]<0||t[0]>=e.gameMap.cells.sizeX||t[1]<0||t[1]>=e.gameMap.cells.sizeY)&&!e.finishedLevel)return!1;let o=e.gameMap.cells.atVec(t);if(o.blocksPlayerMove||aI(o.type))return!1;for(let o of e.gameMap.items.filter(e=>e.pos.equals(t)))switch(o.type){case ec.DrawersShort:case ec.VaultTreasureBox:case ec.EmptyVaultTreasureBox:case ec.LootedVaultTreasureBox:case ec.TorchUnlit:case ec.TorchLit:case ec.PortcullisEW:case ec.PortcullisNS:case ec.TreasureLock:case ec.TreasurePlinth:case ec.TreasureA:case ec.TreasureB:case ec.TreasureC:case ec.TreasureD:case ec.TreasureE:return!1}return!e.gameMap.guards.find(e=>e.pos.equals(t))}(e,n),d=e.gameMap.guards.find(e=>e.pos.equals(i));if(!am(e,i)){c?void 0!==d&&d.overheadIcon()===eu.Alerted&&f.type!==el.PortcullisEW&&f.type!==el.PortcullisNS&&(r.hasVaultKey||!aH(e.gameMap,i))?function(e,t,o,r,a,n,i,s){aC(e),ah(e,i,s),W.copy(t.pos,i),++e.numLeapMoves,o.mode=K.Unconscious,o.modeTimeout=Math.max(1,40-2*e.level)+e.rng.randomInRange(20),(o.hasPurse||o.hasVaultKey)&&aS(e,t,o,i,.15),t.pickTarget=null,++e.levelStats.numKnockouts,e.sounds.hitGuard.play(.25);let l=e.gameMap.cells.atVec(i);l.identified=!0;let f=W.clone(n).subtract(i),u=W.clone(s).subtract(i).scale(.5).add(W.fromValues(0,.25)),c=W.create(),d=r<0?on.playerTiles.left:r>0?on.playerTiles.right:a>0?on.playerTiles.up:on.playerTiles.down,p=t.hidden(e.gameMap),h=[{pt0:f,pt1:u,duration:.15,fn:U.easeInQuad},{pt0:u,pt1:c,duration:.1,fn:U.easeOutQuad},{pt0:c,pt1:c,duration:a>0&&!p?.5:.1,fn:U.easeOutQuad}];a>0&&!p&&h.push({pt0:c,pt1:c,duration:.1,fn:U.easeOutQuad});let m=p?on.playerTiles.hidden:d;t.animation=new z(h,[d,m,m,on.playerTiles.left]),l.type===el.GroundWoodCreaky?aL(e.gameMap,t,e.popups,0,0,-1,e.sounds):l.type===el.GroundWater&&aL(e.gameMap,t,e.popups,1,0,0,e.sounds),av(e,r,a),aL(e.gameMap,t,e.popups,2,r,a,e.sounds),aE(e),ax(e,e.gameMap.cells.atVec(n),l)}(e,r,d,t,o,a,n,i):ab(e,t,o,2):ab(e,t,o,1);return}void 0!==d&&(d.hasPurse||d.hasVaultKey)?r.pickTarget=d:r.pickTarget=null,aC(e),ah(e,n,i);let p=e.gameMap.items.find(e=>e.pos.equals(n)&&e.type===ec.TorchLit);if(void 0!==p?(e.sounds.douse.play(.05),p.type=ec.TorchUnlit,r.itemUsed=p):c&&l.type!==el.GroundWoodCreaky&&++e.levelStats.steppableLeaps,i[0]<0||i[1]<0||i[0]>=e.gameMap.cells.sizeX||i[1]>=e.gameMap.cells.sizeY){ad(e);let n=W.create(),s=W.clone(i).subtract(a),l=n.add(s).scale(.5).add(W.fromValues(0,.25)),f=t<0?on.playerTiles.left:t>0?on.playerTiles.right:o>0?on.playerTiles.up:on.playerTiles.down,u=[{pt0:n,pt1:l,duration:.1,fn:U.easeInQuad},{pt0:l,pt1:s,duration:.1,fn:U.easeOutQuad},{pt0:s,pt1:s,duration:o>0?.5:.1,fn:U.easeOutQuad}];r.animation=new z(u,[f,f,f]);return}W.copy(r.pos,i),++e.numLeapMoves,f.identified=!0;let h=W.clone(a).subtract(i),m=W.create(),g=h.add(m).scale(.5).add(W.fromValues(0,.25)),x=t<0?on.playerTiles.left:t>0?on.playerTiles.right:o>0?on.playerTiles.up:on.playerTiles.down,y=r.hidden(e.gameMap),_=[{pt0:h,pt1:g,duration:.1,fn:U.easeInQuad},{pt0:g,pt1:m,duration:.1,fn:U.easeOutQuad},{pt0:m,pt1:m,duration:o>0&&!y?.5:.1,fn:U.easeOutQuad}];o>0&&!y&&_.push({pt0:m,pt1:m,duration:.1,fn:U.easeOutQuad});let S=y?on.playerTiles.hidden:x;r.animation=new z(_,[x,S,S,on.playerTiles.left]);let v=l.type===el.PortcullisNS||l.type===el.PortcullisEW;v?e.hasEnteredMansion=!0:0!==e.gameMapRoughPlans[e.level].level||e.hasEnteredMansion||(e.experiencedPlayer=!0),ah(e,i,i),f.type===el.GroundWoodCreaky?aL(e.gameMap,r,e.popups,0,0,-1,e.sounds):f.type===el.GroundWater&&aL(e.gameMap,r,e.popups,1,0,0,e.sounds),aE(e),aw(e,a),ax(e,e.gameMap.cells.atVec(a),f),v&&e.sounds.gate.play(.3)}function aH(e,t){return e.items.some(e=>e.pos.equals(t)&&(e.type===ec.LockedDoorEW||e.type===ec.LockedDoorNS))}function aI(e){switch(e){case el.OneWayWindowE:case el.OneWayWindowW:case el.OneWayWindowN:case el.OneWayWindowS:return!0;default:return!1}}function aL(e,t,o,r,a,n,i,s=23,l=!1){switch(t.noisy=!0,t.noiseOffset[0]=a,t.noiseOffset[1]=n,r){case 0:i.footstepCreaky.play(.6),o.setNotification("Creak!",t.pos);break;case 1:i.splash.play(.5),o.setNotification("Splash!",t.pos);break;case 2:o.setNotification("Thud!",t.pos);break;case 3:i.treasureAlarm.play(1);let f=W.fromValues(t.pos[0]+a,t.pos[1]+n);o.setNotificationHold("ALARM! ALARM! ALARM!",f);break;case 4:i.thump.play(.5),o.setNotification("Thud!",t.pos)}let u=!1;for(let o of e.guardsInEarshot(t.pos,s))o.heardThief=!0,u||(u=!0,o.heardThiefClosest=!0,o.heardAlarm=3===r),l&&(o.angry=!0,o.mode===K.Unconscious&&(o.modeTimeout=0))}function aC(e){e.player.noisy=!1,e.player.damagedLastTurn=!1,e.player.itemUsed=null,e.player.lightActive=!1,e.popups.updateNotification()}function aE(e){let t=e.player.health;if(e.player.preNoisy=!1,++e.turns,++e.totalTurns,e.gameMap.cells.atVec(e.player.pos).type==el.GroundWater?e.player.turnsRemainingUnderwater>0&&(--e.player.turnsRemainingUnderwater,e.player.turnsRemainingUnderwater<=0&&e.sounds.waterExit.play(.25)):e.player.turnsRemainingUnderwater=7,e.gameMap.computeLighting(e.player),!function(e){let t=e.gameMap,o=e.player;for(let e of t.guards)e.modePrev=e.mode,e.heardGuard=e.hearingGuard,e.hearingGuard=!1,e.speaking=!1,e.hasMoved=!1;t.guards.sort((e,t)=>{let o=4===e.mode;return o!==(4===t.mode)?o?-1:1:t.patrolPath.length-e.patrolPath.length});let r=[],a=[];for(let o of t.guards){let t=W.clone(o.pos);o.act(e,r),o.hasMoved=!0,t.equals(o.pos)||a.push([o.pos,t])}t.computeLighting(o);let n=[];for(let a of t.guards)a.postActSense(t,o,e.levelStats,r,n,e.rng);if(r.length>0){r.sort((e,t)=>{if(e.speechType<t.speechType)return -1;if(e.speechType>t.speechType)return 1;let r=e.speaker.pos,a=t.speaker.pos,n=W.squaredDistance(r,o.pos),i=W.squaredDistance(a,o.pos);return n<i?-1:+(n>i)});let t=r[0],a=function(e){switch(e){case G.Damage:return"guardDamage";case G.GuardChase:return"guardChase";case G.GuardSeeThief:return"guardSeeThief";case G.GuardHearThief:return"guardHearThief";case G.GuardHearGuard:return"guardHearGuard";case G.GuardSpotDownedGuard:return"guardSpotDownedGuard";case G.GuardSeeTorchLit:return"guardSeeTorchLit";case G.GuardSeeUnlitTorch:return"guardSeeUnlitTorch";case G.GuardDownWarning:return"guardDownWarning";case G.GuardAwakesWarning:return"guardAwakesWarning";case G.GuardWarningResponse:return"guardWarningResponse";case G.GuardInvestigate:return"guardInvestigate";case G.GuardEndChase:return"guardEndChase";case G.GuardFinishInvestigating:return"guardFinishInvestigating";case G.GuardFinishLooking:return"guardFinishLooking";case G.GuardFinishListening:return"guardFinishListening";case G.GuardFinishLightingTorch:return"guardFinishLightingTorch";case G.GuardFinishLookingAtLitTorch:return"guardFinishLookingAtLitTorch";case G.GuardStirring:return"guardStirring";case G.GuardSeeTorchDoused:return"guardSeeTorchDoused";case G.GuardSpotStolenTreasure:return"guardSpotStolenTreasure";case G.GuardExamineStolenTreasure:return"guardExamineStolenTreasure"}}(t.speechType),n=Math.max(Math.min((t.speaker.pos[0]-o.pos[0])/12,1),0),i=Math.max(1-t.speaker.pos.distance(o.pos)/12,0),s=e.subtitledSounds[a].play(.3+.3*i,n),l=r[0].speaker,f=l.pos[1]>=o.pos[1];e.popups.setSpeech(s.subtitle,l,f),l.speaking=!0}for(let e of n)(function(e,t){for(let o of e.guardsInEarshot(t.posShouter,25))15!==o.mode&&(o.pos.equals(t.posShouter)||(o.hearingGuard=!0,t.angry&&(o.angry=!0),W.copy(o.heardGuardPos,t.posGoal)))})(t,e);null!==o.pickTarget&&o.pickTarget instanceof $&&(4===o.pickTarget.mode||!o.pickTarget.cardinallyAdjacentTo(o.pos))&&(o.pickTarget=null);let i=function(e,t,o){let r;let a=o.cells,n=o.items.filter(e=>e.type>=ec.DoorNS&&e.type<=ec.PortcullisEW);return function e(o,i,s,l){let f=[];for(let e of[[1,0],[0,1],[-1,0],[0,-1]]){let s=i.add(W.fromValues(e[0],e[1]));if(o.has(s[1]*a.sizeX+s[0]))continue;o.add(s[1]*a.sizeX+s[0]);let u=a.atVec(s);if(u.type===el.DoorEW||u.type===el.DoorNS||u.type===el.PortcullisEW||u.type===el.PortcullisNS){let e=n.find(e=>e.pos.equals(s)),i=t.find(e=>e[0].equals(s));if(void 0!==e&&i){let t=i[1],n=t[1]*a.sizeX+t[0];if(!o.has(n))switch(e.type){case ec.DoorEW:case ec.DoorNS:r=["doorOpen",s];break;case ec.LockedDoorEW:case ec.LockedDoorNS:r=["doorOpenLocked",s];break;case ec.PortcullisEW:case ec.PortcullisNS:r=["gate",s]}}if(void 0!==r||e&&!l)return}(u.type<el.Wall0000||u.type>el.Wall1111)&&f.push(s)}if(s>0&&void 0===r)for(let t of f)e(o,t,s-1,!1)}(new Set,e,20,!0),r}(e.player.pos,a,e.gameMap);if(i){let[t,r]=i,a=Math.max(Math.min((r[0]-o.pos[0])/12,1),0),n=Math.max(1-r.distance(o.pos)/12,0);e.sounds[t].play(.2+.3*n,a)}}(e),e.gameMap.recomputeVisibility(e.player.pos),J(e),aF(e),t>e.player.health&&(e.sounds.hitPlayer.play(.5),e.player.health<=0)){setTimeout(()=>e.sounds.gameOverJingle.play(.5),1e3),function(e){if(e.gameMapRoughPlans[e.level].played)return;e.gameMapRoughPlans[e.level].played=!0;let t=10*e.lootStolen+5*e.levelStats.extraFoodCollected;e.gameStats.totalScore+=t,e.gameStats.turns=e.totalTurns,e.gameStats.numLevels=e.gameMapRoughPlans.length,e.gameStats.numCompletedLevels=e.level,e.gameStats.numInjuries+=e.levelStats.damageTaken,e.gameStats.numKnockouts+=e.levelStats.numKnockouts,e.gameStats.numSpottings+=e.levelStats.numSpottings,e.gameStats.daily=e.dailyRun,e.gameStats.timeEnded=Date.now()}(e),e.persistedStats.bestScore=Math.max(e.persistedStats.bestScore,e.gameStats.totalScore);let t={score:e.gameStats.totalScore,date:ne(),turns:e.totalTurns,level:e.level+1};e.persistedStats.scores.push(t),e.dailyRun&&(e.persistedStats.currentDailyBestScore=Math.max(e.persistedStats.currentDailyBestScore,e.gameStats.totalScore),e.persistedStats.lastPlayedDailyGame=structuredClone(e.gameStats)),aJ(e.persistedStats)}ai(e,"turnEnd")}function aF(e){let t=e.gameMap.allSeen(),o=e.lootStolen>=e.lootAvailable;t&&o&&(e.finishedLevel||(e.sounds.levelRequirementJingle.play(.5),e.popups.setNotification("Escape!",e.player,3,5)),e.finishedLevel=!0);let r=al(e);if(e.level>0&&(e.turns===Math.floor(.75*r)||e.turns===r-10&&r>100)&&(e.popups.setNotification("Tick tock!",e.player,3,5),e.sounds.clockTick.play(1)),e.turns===r+1){let t=[],o=!1;for(let r of(e.gameMap.items=e.gameMap.items.filter(e=>e.type!==ec.VaultTreasureBox||(t.push(e),o=!0,!1)),t)){e.gameMap.items.push({type:ec.EmptyVaultTreasureBox,pos:r.pos,topLayer:!1});let t=new O(on.vaultGoldAnimationTiles,.2,0,1);t.removeOnFinish=!0,e.particles.push({pos:W.clone(r.pos),animation:t})}o?(e.popups.setNotification("Late!\nVaults were cleared.",e.player,3,5),e.sounds.coinRattle.play(1),e.sounds.clockChime.play(.5)):e.level>0&&(e.popups.setNotification("Late!",e.player,3,5),e.sounds.clockChime.play(1))}}function ak(e,t,o){e.popups.setNotification("Leap: Shift+"+aP(t,o),e.player.pos)}function aP(e,t){return e>0?"\x1a":e<0?"\x1b":t>0?"\x18":t<0?"\x19":"\x07"}function aD(e){e.healthBarState.enlargeTimeRemaining=1}function aW(e,t){t<0||t>=e.healthBarState.heartFlashRemaining.length||(e.healthBarState.heartFlashRemaining[t]=1,e.healthBarState.damageDisplayTimer=.5,e.healthBarState.healing=t<e.player.health)}function aG(e){e.healthBarState.damageDisplayTimer=0,e.healthBarState.healing=!1,e.healthBarState.enlargeTimeRemaining=0,e.healthBarState.size=1,e.healthBarState.heartFlashRemaining.length=e.player.healthMax,e.healthBarState.heartFlashRemaining.fill(0)}function aV(e,t){return new Promise((o,r)=>{t.onload=()=>o(t),t.onerror=r,t.src=e})}function aU(e,t,o,r){if(0==o.size)return e;if(!r)return 0;let a=0;for(let e of[...o])a+=t[e];return e**(1+a/o.size)}function aB(e,t,o){let r=(o.at(e,t).lit?1:.1)/4,a=o.at(e-1,t-1).litAnim,n=o.at(e,t-1).litAnim,i=o.at(e+1,t-1).litAnim,s=o.at(e-1,t).litAnim,l=o.at(e,t).litAnim,f=o.at(e+1,t).litAnim,u=o.at(e-1,t+1).litAnim,c=o.at(e,t+1).litAnim;return[r*(a+n+s+l),r*(i+n+f+l),r*(u+c+s+l),r*(o.at(e+1,t+1).litAnim+c+f+l)]}function aN(e,t){switch(e){case es.Manor:return t.itemTiles;case es.ManorRed:return t.redWallItemTiles;case es.Mansion:return t.manseItemTiles;case es.Fortress:return t.fortressItemTiles;case es.Warrens:return t.redWallItemTiles}}function aO(e,t,o){let r=aN(e.gameMapRoughPlans[e.level].levelType,t.entityTileSet);for(let a of e.gameMap.items.filter(e=>e.topLayer===o)){let o=a.pos[0],n=a.pos[1],i=e.gameMap.cells.at(o,n);if(!i.seen&&!e.seeAll)continue;let s=i.type,l=aB(o,n,e.gameMap.cells);if(s===el.PortcullisEW||s===el.PortcullisNS){if(e.gameMap.guards.find(e=>e.pos[0]===o&&e.pos[1]===n)){let e=r[a.type];void 0!==e.textureIndex&&(e={textureIndex:e.textureIndex+1,color:e.color,unlitColor:e.unlitColor}),t.addGlyphLit4(o,n,o+1,n+1,e,l)}else t.addGlyphLit4(o,n,o+1,n+1,r[a.type],l)}else if(s===el.DoorEW||s===el.DoorNS)e.gameMap.guards.find(e=>e.pos[0]===o&&e.pos[1]===n)||e.player.pos[0]===o&&e.player.pos[1]===n||t.addGlyphLit4(o,n,o+1,n+1,r[a.type],l);else if(a.type>=ec.TreasureA)t.addGlyph(o,n+.5,o+1,n+1.5,r[a.type]),a.animation&&t.addGlyph(o,n+.5,o+1,n+1.5,a.animation.currentTile());else if(a.type===ec.VaultTreasureBox)t.addGlyph(o,n,o+1,n+1,r[a.type]),a.animation&&t.addGlyph(o,n,o+1,n+1,a.animation.currentTile());else if(a.type===ec.Coin)t.addGlyph(o,n,o+1,n+1,r[a.type]),a.animation&&t.addGlyph(o,n,o+1,n+1,a.animation.currentTile());else{let e=a.animation?a.animation.currentTile():r[a.type];if(a.animation instanceof z){let e=a.animation.offset;o+=e[0],n+=e[1]}t.addGlyphLit4(o,n,o+1,n+1,e,l)}}}function az(e,t){let o={position:W.create(),velocity:W.create(),joltOffset:W.create(),joltVelocity:W.create(),zoom:t,zoomVelocity:0,scale:Math.pow(1.1892,t),anchor:W.create(),snapped:!1,zoomed:!1,panning:!1};return W.copy(o.position,e),W.zero(o.velocity),o}function aq(e,t){e.soundVolume=t,C.volume(t),window.localStorage.setItem("LLL/soundVolume",t.toString())}function aY(e){return e.volumeMute||!document.hasFocus()}function aX(e,t){e.volumeMute=t,C.mute(aY(e)),window.localStorage.setItem("LLL/volumeMute",t?"true":"false")}function aj(e,t){for(let o in e.guardMute=t,window.localStorage.setItem("LLL/guardMute",t?"true":"false"),e.subtitledSounds)e.subtitledSounds[o].mute=t}function aK(e){let t=window.localStorage.getItem("LLL/stat/"+e);if(null!=t&&"undefined"!==t)return JSON.parse(String(t))}function a$(e,t){let o=JSON.stringify(t);window.localStorage.setItem("LLL/stat/"+e,o)}function aQ(){return{scores:aK("highScores")??[],lastPlayedDailyGame:aK("lastPlayedDailyGame")??null,currentDailyGameId:aK("currentDailyGameId")??"",currentDailyPlays:aK("currentDailyPlays")??0,currentDailyWins:aK("currentDailyWins")??0,currentDailyBestScore:aK("currentDailyBestScore")??0,currentDailyWinFirstTry:aK("currentDailyWinFirstTry")??0,bestScore:aK("bestScore")??0,totalPlays:aK("totalPlays")??0,totalWins:aK("totalWins")??0,totalGhosts:aK("totalGhosts")??0,allDailyPlays:aK("allDailyPlays")??0,allDailyWins:aK("allDailyWins")??0,allDailyWinsFirstTry:aK("allDailyWinsFirstTry")??0,achievementGhosty:aK("achievementGhosty")??0,achievementZippy:aK("achievementZippy")??0,achievementHungry:aK("achievementHungry")??0,achievementThumpy:aK("achievementThumpy")??0,achievementSofty:aK("achievementSofty")??0,achievementNoisy:aK("achievementNoisy")??0,achievementLeapy:aK("achievementLeapy")??0,achievementSteppy:aK("achievementSteppy")??0,achievementHurty:aK("achievementHurty")??0,achievementVictory:aK("achievementVictory")??0,achievementHealthy:aK("achievementHealthy")??0,achievementTreasure:aK("achievementTreasure")??0,achievementMapping:aK("achievementMapping")??0,achievementFaceless:aK("achievementFaceless")??0}}function aJ(e){a$("currentDailyGameId",e.currentDailyGameId),a$("currentDailyPlays",e.currentDailyPlays),a$("currentDailyWins",e.currentDailyWins),a$("currentDailyBestScore",e.currentDailyBestScore),a$("currentDailyWinFirstTry",e.currentDailyWinFirstTry),a$("lastPlayedDailyGame",e.lastPlayedDailyGame),a$("allDailyPlays",e.allDailyPlays),a$("allDailyWins",e.allDailyWins),a$("allDailyWinsFirstTry",e.allDailyWinsFirstTry),a$("scores",e.scores),a$("bestScore",e.bestScore),a$("totalPlays",e.totalPlays),a$("totalWins",e.totalWins),a$("totalGhosts",e.totalGhosts),a$("achievementGhosty",e.achievementGhosty),a$("achievementZippy",e.achievementZippy),a$("achievementHungry",e.achievementHungry),a$("achievementThumpy",e.achievementThumpy),a$("achievementSofty",e.achievementSofty),a$("achievementNoisy",e.achievementNoisy),a$("achievementLeapy",e.achievementLeapy),a$("achievementSteppy",e.achievementSteppy),a$("achievementHurty",e.achievementHurty),a$("achievementHealthy",e.achievementHealthy),a$("achievementTreasure",e.achievementTreasure),a$("achievementMapping",e.achievementMapping),a$("achievementFaceless",e.achievementFaceless)}function aZ(e,t){let o=t.gameMapRoughPlans[t.level].levelType,r=1;for(let t of e.cells.values)t.type===el.GroundWater&&(t.animation=new O(function(e,t){switch(e){case es.Manor:case es.ManorRed:return t.waterAnimation;case es.Mansion:return t.manseWaterAnimation;case es.Fortress:return t.fortressWaterAnimation;case es.Warrens:return t.waterAnimation}}(o,oa),1,1369*r%4),r++)}function a0(e,t){for(let t of e.items){let e=on.itemGlows[t.type];if(void 0!==e){let o=t.type===ec.Coin?.75:1.25;t.animation=new q(e,0,o)}}}function a1(e,t){let o=0;if(on.candleAnimation.length>=3){let r=on.stoveAnimation.slice(0,2).map(e=>[e,.5]),a=r[0][0],n=r[0][0],i=on.candleAnimation.slice(0,3).map(e=>[e,.5]),s=on.candleAnimation.at(-2),l=on.candleAnimation.at(-1);for(let f of e.items)f.type===ec.Stove?(f.animation=new j(X.idle,o,t.lightStates,f,r,a,n),o++):f.type===ec.TorchLit?(f.animation=new j(X.idle,o,t.lightStates,f,i,s,l),o++):f.type===ec.TorchUnlit&&(f.animation=new j(X.off,o,t.lightStates,f,i,s,l),o++)}if(on.torchAnimation.length>=3){let r=on.torchAnimation.slice(0,3).map(e=>[e,.5]),a=on.torchAnimation.at(-2),n=on.torchAnimation.at(-1);for(let i of e.guards)i.hasTorch&&(i.torchAnimation=new j(X.idle,o,t.lightStates,null,r,a,n),o++)}if(on.playerTorchAnimation.length>=2){let e=on.playerTorchAnimation.slice(0,2).map(e=>[e,.5]),r=on.playerTorchAnimation.at(-2),a=on.playerTorchAnimation.at(-1);t.player.torchAnimation=new j(X.idle,o,t.lightStates,null,e,r,a),o++}}function a2(e){e.gameMode=rA.Mansion,e.hasStartedGame||(e.persistedStats.totalPlays++,a$("totalPlays",e.persistedStats.totalPlays),e.hasStartedGame=!0),ag(e)}function a3(e){let t=null!==e.dailyRun;t?e.gameMapRoughPlans=function(e){let t=eP(10,100,e,void 0),o=3+e.randomInRange(2),r=5+e.randomInRange(2),a=7+e.randomInRange(3);return[t[o],t[r],t[a]]}(e.rng):e.gameMapRoughPlans=eP(r8.numGameMaps,r8.totalGameLoot,e.rng,r7),e.level=Math.min(e.gameMapRoughPlans.length-1,0),e.persistedStats.totalPlays++,a$("totalPlays",e.persistedStats.totalPlays),t&&(e.persistedStats.currentDailyPlays++,a$("currentDailyPlays",e.persistedStats.currentDailyPlays),e.persistedStats.allDailyPlays++,a$("allDailyPlays",e.persistedStats.allDailyPlays)),e.gameStats={totalScore:0,turns:0,numLevels:0,numCompletedLevels:0,numGhostedLevels:0,numSpottings:0,numInjuries:0,numKnockouts:0,daily:e.dailyRun,timeStarted:Date.now(),timeEnded:0};let o=eD(e.gameMapRoughPlans[e.level]);e.player=new ep(o.playerStartPos,t),e.lightStates=Array(o.lightCount).fill(0),a1(o,e),aZ(o,e),a0(o,e),e.gameMode=rA.Mansion,e.hintMessage="",aG(e),e.numStepMoves=0,e.numLeapMoves=0,e.numWaitMoves=0,e.numZoomMoves=0,e.hasEnteredMansion=!1,e.experiencedPlayer=t||!1,e.finishedLevel=!1,e.turns=0,e.totalTurns=0,e.lootStolen=0,e.lootAvailable=e.gameMapRoughPlans[e.level].totalLoot,e.treasureStolen=0,an(e.levelStats),ai(e,"gameStart"),e.ambience=rw.Outdoor,e.camera=az(o.playerStartPos,e.zoomLevel),e.gameMap=o,e.activeSoundPool.empty(),e.ambientSoundPool.empty(),e.popups.reset(),J(e),aF(e),aw(e,e.player.pos),C.stop(),ag(e)}function a5(e){let t=ne();e.rng=new eL("Daily "+t),e.dailyRun=t,a3(e)}function a4(e,t,o,r,a,n){let i=W.create(),s=W.create();(function(e,t,o,r,a,n){let i,s,l,f;let u=16*a9(t),c=t[0],d=t[1]-u,p=Math.min(80,Math.floor(Math.min(c,d)/5))/(16*o),h=c/(16*o),m=d/(16*o);i=h/2,s=e[0]-h/2,r&&c>d&&(i-=2*p,s+=2*p),i>s&&(i=s=e[0]/2),l=m/2,f=e[1]-m/2,r&&c<=d&&(l-=2*p,f+=2*p),l>f&&(l=f=e[1]/2),a[0]=i,a[1]=l,n[0]=s,n[1]=f})(e,t,o,r,i,s),a[0]=Math.max(i[0],Math.min(s[0],n[0]+.5)),a[1]=Math.max(i[1],Math.min(s[1],n[1]+.5))}function a8(e,t){return[e[0]/(16*t),e[1]/(16*t)]}function a9(e){return Math.floor(2*Math.min(Math.max(1,e[0]/448),Math.max(1,e[1]/400)))/2}function a6(e,t,o){let r=255&e,a=e>>8&255,n=e>>16&255,i=e>>24&255;return Math.max(0,Math.min(255,Math.trunc(r+((255&t)-r)*o)))+(Math.max(0,Math.min(255,Math.trunc(a+((t>>8&255)-a)*o)))<<8)+(Math.max(0,Math.min(255,Math.trunc(n+((t>>16&255)-n)*o)))<<16)+(Math.max(0,Math.min(255,Math.trunc(i+((t>>24&255)-i)*o)))<<24)}function a7(e,t,o,r){for(let a=0;a<o.length;++a){let n=o.charCodeAt(a);10===n&&(n=32),e.addGlyph(t,0,t+1,1,{textureIndex:n,color:r}),++t}}function ne(e=null,t=!0){let o=e??new Date,r=t?o.getUTCFullYear():o.getFullYear(),a=1+(t?o.getUTCMonth():o.getMonth()),n=t?o.getUTCDate():o.getDate(),i=String(r),s=String(a).padStart(2,"0"),l=String(n).padStart(2,"0");return`${i}/${s}/${l}`}
//# sourceMappingURL=index.6b7d6e8b.js.map
